<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Â≠¶‰π†Java JUCÊâÄ‰ΩúÁ¨îËÆ∞Ôºå‰ªé‰ΩøÁî®Âà∞Ê∫êÁ†ÅÂ∫îÊúâÂ∞ΩÊúâ'><title>JUCÂπ∂ÂèëÁºñÁ®ã-‰ªéÂÖ•Èó®Âà∞ÂçïÁ∫øÁ®ã</title>

<link rel='canonical' href='https://geniusBlog.github.io/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/'>

<link rel="stylesheet" href="/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css"><meta property='og:title' content='JUCÂπ∂ÂèëÁºñÁ®ã-‰ªéÂÖ•Èó®Âà∞ÂçïÁ∫øÁ®ã'>
<meta property='og:description' content='Â≠¶‰π†Java JUCÊâÄ‰ΩúÁ¨îËÆ∞Ôºå‰ªé‰ΩøÁî®Âà∞Ê∫êÁ†ÅÂ∫îÊúâÂ∞ΩÊúâ'>
<meta property='og:url' content='https://geniusBlog.github.io/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/'>
<meta property='og:site_name' content='Genius'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='JUC' /><meta property='article:tag' content='Java' /><meta property='article:published_time' content='2022-09-08T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2022-09-08T00:00:00&#43;00:00'/><meta property='og:image' content='https://geniusBlog.github.io/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/bk1.jpg' />
<meta name="twitter:site" content="@genius">
    <meta name="twitter:creator" content="@genius"><meta name="twitter:title" content="JUCÂπ∂ÂèëÁºñÁ®ã-‰ªéÂÖ•Èó®Âà∞ÂçïÁ∫øÁ®ã">
<meta name="twitter:description" content="Â≠¶‰π†Java JUCÊâÄ‰ΩúÁ¨îËÆ∞Ôºå‰ªé‰ΩøÁî®Âà∞Ê∫êÁ†ÅÂ∫îÊúâÂ∞ΩÊúâ"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://geniusBlog.github.io/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/bk1.jpg' />
    <link rel="shortcut icon" href="/img/Genius.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/Genius_hua95d8fe85c65c73f01d0951a42335663_30321_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üé¨</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Genius</a></h1>
            <h2 class="site-description">&#34;Áé∞Âú®ÊàëÁî®Ê≤âÈùôÁöÑÁõÆÂÖâËßÅÂà∞ ÊÅ∞ÊòØÈÇ£Âè∞Êú∫Âô®ËÑâÂÜ≤ÁöÑÈ¢§Ë∑≥&#34;</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://gitee.com/sbg-genius'
                        target="_blank"
                        title="Gitee"
                    >
                        
                        
                            <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="24px" height="24px" viewBox="0 0 24 24" enable-background="new 0 0 24 24" xml:space="preserve">  <image id="image0" width="24" height="24" x="0" y="0"
    href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAABGdBTUEAALGPC/xhBQAAACBjSFJN
AAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACZ1BMVEUAAAD/AADcABHbABPZ
ABLZABPZABPbABH/AADZABPbABPZABKqAADZABHaABPZBBbaBRjaBRjZBRfbBhjZBhfYABLZARTZ
ABDWAADWAADWAADYABXbAA/dABLbABLaARPnXGjsgInsgYrhLDvcAAvbAxjfAA3ZABLeABLZAhPY
AAvjTFb409bsgInaAADbBhjZABPXAAfthpDVAADaABPdABLcABPZAA/64OLzsLbXAAfdAxXZAxbX
AAHnX2vZABDaABPYABHeABLaBRfZABHZABLaBBjXAAjZAhXaBBfbBRjYABPZBRjlU2HXAATZAxXd
BBf3yczZARHsfonZABTsgov51tnjS1bYAArZARTbAAvhLDzmWWXaARTaABLYABTYABLkABPdABLb
ABLZABPmABPZARPaBRfnBRjbABPWAAPVAADZAADZAAvWAAfaDyHqeYLsf4nrfoj////lWWT9/Pzn
BRncGCb++/v9/v31wMXysLbzs7jysrfzsbbiRFL+/f3++/z+/v7mY27ZDRfZBxraCBraBxnaBxrZ
BxnZBRjUAADqeoT2zM/aCx3XAAvWAAbXAAnXAAjXAAfYABT0vsLaECHWAQjgO0nvlp3vmJ/umJ/v
maDgOEf1wMTbEyTshI7shY7+/Pz98/T++vrrfYfaECLWAAjvlp7xp6788fL9+/v0vcHZCRzYABDX
AArVAAHZBhj2ztH+///qd4H2y8/cGSrYAxLZCBrkU1/99/f+/f7sfoj9+fn1wcbyr7Tysbf0vML8
9vb+/P3ZEBroBBj++fn98vP++fr89vfgOkfqeILaDR+weo5OAAAAYXRSTlMAAixptNjyaQEok/ID
WOX7/f775Vhw+f3+/flvVP3+/P7+/P79VCjn/vz+/v78/ueT/v75Ke/8/f7+/fz7/v7+/vv9/f3Y
/v7+/f3y+/7++/z+/f75/P7+/vz9/v78/nBvjqLsXwAAAAFiS0dEc0EJPc4AAAAHdElNRQfmCQgN
IifODXi5AAAB2ElEQVQoz2NgAAJGBgYmZhZWNjZWFnYmMBcCOBg4ubgTk5JTUpKTErm5OIECYMDD
wMuXmsYvIAgEAkLpGcIiQCGwetHMJDHxLAmJ7GwglpTKyZUG6eFgkJGVk8/LVygoLCosLFQsKlJS
VlEFyaipa2hqaesUI4Cunr4a0AaDVDHDktLiUoSEkXGZAQ+DiamZeblFcUVlVXUNCNTWWdZbWZua
MDAn2tjaNTQ2Nbe0trV3tLd3tnXZOzgmMjOwODl39zQ19fb190+YOAkIJk7un+LixMLgmukmUdhU
PHXa9BkzZ82eM2f2rJlz3T0yXRnYUjyzi4qb5s3vXgCzfGG3VwobUEIgu7C4GC6xaPGSpdmeKd5A
owQlCoE6li0HGjVnxcpVq5sKJdyARrE4CXQDdaxZu279hInrN2zctLlpS7cz0HLmRB8JxeKmrdu2
t7W172jZuWt3g6+fP9C5JqYBknuK9y7atx/ouwMHDx0uDjwSZAb0II/BUePgY8dPQF3UVHzylHtI
KjBIGNT09UIR4bQ5LDwiUkNdDRTsqlHRSkVFisAwLyo8HXMmLzZOVgYSIfG5OVKS2ZCIyhIXS8pM
gEQuD4OIcEa6ECRq+dNS+XghUYs7MWBPPgB7urAPCsOxQQAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAy
Mi0wOS0wOFQxMTozNDozOSswMjowMO4S2dMAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjItMDktMDhU
MTE6MzQ6MzkrMDI6MDCfT2FvAAAAAElFTkSuQmCC" />
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/969025903'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫éGenius</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/">
                <img src="/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/bk1_hud8899dd775ae54c80ca0b524db7840c0_28684_800x0_resize_q75_box.jpg"
                        srcset="/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/bk1_hud8899dd775ae54c80ca0b524db7840c0_28684_800x0_resize_q75_box.jpg 800w, /p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/bk1_hud8899dd775ae54c80ca0b524db7840c0_28684_1600x0_resize_q75_box.jpg 1600w"
                        width="800" 
                        height="451" 
                        loading="lazy"
                        alt="Featured image of post JUCÂπ∂ÂèëÁºñÁ®ã-‰ªéÂÖ•Èó®Âà∞ÂçïÁ∫øÁ®ã" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/java/" style="background-color: #2a9d8f; color: #fff;">
                Java
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/juc%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%8D%95%E7%BA%BF%E7%A8%8B/">JUCÂπ∂ÂèëÁºñÁ®ã-‰ªéÂÖ•Èó®Âà∞ÂçïÁ∫øÁ®ã</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Â≠¶‰π†Java JUCÊâÄ‰ΩúÁ¨îËÆ∞Ôºå‰ªé‰ΩøÁî®Âà∞Ê∫êÁ†ÅÂ∫îÊúâÂ∞ΩÊúâ
        </h3>
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 08, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    91 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <h1 id="Âπ∂Âèëjuc">Âπ∂ÂèëJUC</h1>
<h2 id="1-Âπ∂ÂèëÁºñÁ®ã">1 Âπ∂ÂèëÁºñÁ®ã</h2>
<h3 id="11-Âπ∂ÂèëÁºñÁ®ãÁöÑ‰ºòÁº∫ÁÇπ">1.1 Âπ∂ÂèëÁºñÁ®ãÁöÑ‰ºòÁº∫ÁÇπ</h3>
<h4 id="‰ºòÁÇπ">‰ºòÁÇπÔºö</h4>
<ul>
<li>Âà©Áî®Â§öÊ†∏CPUÊèêÈ´òËÆ°ÁÆóËÉΩÂäõÔºåÊèêÈ´òÁ®ãÂ∫èËøêË°åÈÄüÂ∫¶</li>
<li>ÂèØ‰ª•Â∞Ü‰∏Ä‰∏™‰∫ãÊÉÖÊãÜÊàêÂ§öÈÉ®ÂàÜÔºå‰∫§Áªô‰∏çÂêåÁöÑÁ∫øÁ®ãÊù•ÂàÜÂà´ËøêË°åÔºåÊèêÈ´ò‰∏öÂä°ÂÆåÊàêÊïàÁéáÔºåÊèêÈ´òÁ®ãÂ∫èÊÄßËÉΩ„ÄÇ</li>
</ul>
<h4 id="Áº∫ÁÇπ">Áº∫ÁÇπÔºö</h4>
<ul>
<li>‰∏ä‰∏ãÊñáÂàáÊç¢ÂØºËá¥ÁöÑÂéüÂ≠êÊÄßÁ†¥Âùè</li>
<li>ÂÜÖÂ≠òÊ≥ÑÊºè</li>
<li>Á∫øÁ®ãÂÆâÂÖ®</li>
<li>Á∫øÁ®ãÊ≠ªÈîÅ</li>
</ul>
<h3 id="12-Âπ∂ÂèëÁºñÁ®ã‰∏âË¶ÅÁ¥†">1.2 Âπ∂ÂèëÁºñÁ®ã‰∏âË¶ÅÁ¥†</h3>
<h4 id="Âπ∂ÂèëÁºñÁ®ã‰∏âË¶ÅÁ¥†">Âπ∂ÂèëÁºñÁ®ã‰∏âË¶ÅÁ¥†</h4>
<ul>
<li>ÂéüÂ≠êÊÄßÔºöÂç≥‰∏Ä‰∏™ÂæÆÁ≤í‰∏çÂèØÂÜçÂàÜÔºå‰∏Ä‰∏™ÊàñËÄÖÂ§ö‰∏™Êìç‰ΩúË¶Å‰πàÂÖ®ÈÉ®ÊâßË°åÊàêÂäüË¶Å‰πàÂÖ®ÈÉ®ÊâßË°åÂ§±Ë¥•</li>
<li>ÊúâÂ∫èÊÄßÔºöÁ®ãÂ∫èÊåâÁÖß‰ª£Á†ÅÂùóÈ°∫Â∫èÊâßË°å</li>
<li>ÂèØËßÅÊÄßÔºöÂÖ∂‰ªñÁ∫øÁ®ãÂèØ‰ª•ÂØπÂÖ±‰∫´ÂèòÈáèÁöÑ‰øÆÊîπÔºåËøõË°åÂèäÊó∂ËßÇÊµã„ÄÇ</li>
</ul>
<h4 id="Âá∫Áé∞ÂÆâÂÖ®ÈóÆÈ¢òÁöÑÂéüÂõ†">Âá∫Áé∞ÂÆâÂÖ®ÈóÆÈ¢òÁöÑÂéüÂõ†Ôºö</h4>
<ul>
<li>Á∫øÁ®ãÂàáÊç¢Â∏¶Êù•ÁöÑÂéüÂ≠êÊÄßÈóÆÈ¢ò</li>
<li>ÁºìÂ≠òÂØºËá¥ÁöÑÂèØËßÅÊÄßÈóÆÈ¢ò</li>
<li>ÁºñËØë‰ºòÂåñÂ∏¶Êù•ÁöÑÊúâÂ∫èÊÄßÈóÆÈ¢ò</li>
</ul>
<h4 id="‰∏ä‰∏ãÊñáÂàáÊç¢">‰∏ä‰∏ãÊñáÂàáÊç¢</h4>
<p>Á∫øÁ®ãÈúÄË¶ÅÂ∞ÜCPUÁöÑ‰ΩøÁî®ÊùÉÂäõ‰∫§ÁªôÂÖ∂‰ªñÁ∫øÁ®ãÊó∂Ôºå‰ºöÂØπËá™Ë∫´Á∫øÁ®ã‰ªªÂä°‰øùÂ≠òÔºå‰ª•‰æø‰∏ãÊ¨°ÂÜçÂàáÊç¢ÂõûËøô‰∏™‰ªªÂä°Êó∂ÂèØ‰ª•ÂÜçÊ¨°Âä†ËΩΩËøô‰∏™‰ªªÂä°Áä∂ÊÄÅ</p>
<h3 id="13-‰ªÄ‰πàÊòØÂ§öÁ∫øÁ®ã">1.3 ‰ªÄ‰πàÊòØÂ§öÁ∫øÁ®ã</h3>
<p><strong>Â§öÁ∫øÁ®ãÊåáÁöÑÂ∞±ÊòØÂú®‰∏Ä‰∏™Á®ãÂ∫èÂåÖÂê´Â§ö‰∏™ÊâßË°åÊµÅÔºåÂèØ‰ª•Áî®Â§ö‰∏™‰∏çÂêåÁ∫øÁ®ãÂÆåÊàêÂ§ö‰∏™‰∏çÂêå‰∫ãÊÉÖ</strong></p>
<h2 id="2-ËøõÁ®ã‰∏éÁ∫øÁ®ãÁöÑ‰ªãÁªç">2 ËøõÁ®ã‰∏éÁ∫øÁ®ãÁöÑ‰ªãÁªç</h2>
<h3 id="21-ËøõÁ®ã‰∏éÁ∫øÁ®ã">2.1 ËøõÁ®ã‰∏éÁ∫øÁ®ã</h3>
<h4 id="ËøõÁ®ã">ËøõÁ®ã</h4>
<ul>
<li>ËøõÁ®ãÊòØ‰∏Ä‰∏™Á®ãÂ∫èÁöÑ‰ª£Á†Å‰ªéÁ£ÅÁõòÂä†ËΩΩËá≥ÂÜÖÂ≠òËøêË°åÁöÑËøáÁ®ã</li>
<li>Á®ãÂ∫èÊòØÁî±Êåá‰ª§ÂíåÊï∞ÊçÆÁªÑÂêàËÄåÊàêÁöÑÔºåÊåá‰ª§ÊÉ≥Ë¶ÅËøêË°åÔºåÊï∞ÊçÆÈúÄË¶ÅËØªÂÜôÔºåÂ∞±ÈúÄË¶ÅÊääÊåá‰ª§Âä†ËΩΩËá≥CPUÔºåÊï∞ÊçÆÂä†ËΩΩËá≥ÂÜÖÂ≠ò„ÄÇËøõÁ®ãÂàôÊòØÁî®Êù•Âä†ËΩΩÊåá‰ª§ÔºåÁÆ°ÁêÜÂÜÖÂ≠òÔºåÁÆ°ÁêÜIO</li>
<li>ËøõÁ®ãÂèØ‰ª•ËßÜ‰∏∫Á®ãÂ∫èÁöÑÂÆû‰æãÔºå‰∏Ä‰∏™Á®ãÂ∫èÂèØ‰ª•ÂØπÂ∫îÂ§ö‰∏™ËøõÁ®ã</li>
</ul>
<h4 id="Á∫øÁ®ã">Á∫øÁ®ã</h4>
<ul>
<li>‰∏Ä‰∏™ËøõÁ®ãÂèØ‰ª•ÂàÜ‰∏∫‰∏ÄÂà∞Â§ö‰∏™Á∫øÁ®ã</li>
<li>‰∏Ä‰∏™Á∫øÁ®ãÂ∞±ÊòØ‰∏Ä‰∏™Êåá‰ª§ÊµÅÔºåÊåá‰ª§ÊµÅ‰∏≠ÁöÑ‰∏ÄÊù°Êù°Êåá‰ª§‰∫§ÁªôCPUÊù•ÊâßË°å</li>
<li>Âú®Java‰∏≠ÔºåÁ∫øÁ®ã‰Ωú‰∏∫ÊúÄÂ∞èÁöÑË∞ÉÂ∫¶Âçï‰ΩçÔºåËøõÁ®ã‰Ωú‰∏∫ÊúÄÂ∞èÁöÑËµÑÊ∫êÂàÜÈÖçÂçï‰ΩçÔºåwindows‰∏≠ËøõÁ®ã‰∏çÊ¥ªÂä®ÔºåÂè™‰Ωú‰∏∫Á∫øÁ®ãÁöÑÂÆπÂô®</li>
</ul>
<h4 id="ËøõÁ®ã‰∏éÁ∫øÁ®ãÁöÑÂå∫Âà´">ËøõÁ®ã‰∏éÁ∫øÁ®ãÁöÑÂå∫Âà´</h4>
<p>Á∫øÁ®ãÂÖ∑ÊúâËÆ∏Â§ö‰º†ÁªüËøõÁ®ãÊâÄÂÖ∑ÊúâÁöÑÁâπÂæÅÔºåÊïÖÂèàÁß∞‰∏∫ËΩªÂûãËøõÁ®ã(Light‚ÄîWeight Process)ÊàñËøõÁ®ãÂÖÉÔºõËÄåÊää‰º†ÁªüÁöÑËøõÁ®ãÁß∞‰∏∫ÈáçÂûãËøõÁ®ã(Heavy‚ÄîWeight Process)ÔºåÂÆÉÁõ∏ÂΩì‰∫éÂè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãÁöÑ‰ªªÂä°„ÄÇÂú®ÂºïÂÖ•‰∫ÜÁ∫øÁ®ãÁöÑÊìç‰ΩúÁ≥ªÁªü‰∏≠ÔºåÈÄöÂ∏∏‰∏Ä‰∏™ËøõÁ®ãÈÉΩÊúâËã•Âπ≤‰∏™Á∫øÁ®ãÔºåËá≥Â∞ëÂåÖÂê´‰∏Ä‰∏™Á∫øÁ®ã„ÄÇ</p>
<ul>
<li>
<p>**Ê†πÊú¨Âå∫Âà´Ôºö**ËøõÁ®ãÊòØÊìç‰ΩúÁ≥ªÁªüËµÑÊ∫êÂàÜÈÖçÁöÑÂü∫Êú¨Âçï‰ΩçÔºåËÄåÁ∫øÁ®ãÊòØÂ§ÑÁêÜÂô®‰ªªÂä°Ë∞ÉÂ∫¶ÂíåÊâßË°åÁöÑÂü∫Êú¨Âçï‰Ωç</p>
</li>
<li>
<p>**ËµÑÊ∫êÂºÄÈîÄÔºö**ÊØè‰∏™ËøõÁ®ãÈÉΩÊúâÁã¨Á´ãÁöÑ‰ª£Á†ÅÂíåÊï∞ÊçÆÁ©∫Èó¥ÔºàÁ®ãÂ∫è‰∏ä‰∏ãÊñáÔºâÔºåÁ®ãÂ∫è‰πãÈó¥ÁöÑÂàáÊç¢‰ºöÊúâËæÉÂ§ßÁöÑÂºÄÈîÄÔºõÁ∫øÁ®ãÂèØ‰ª•ÁúãÂÅöËΩªÈáèÁ∫ßÁöÑËøõÁ®ãÔºåÂêå‰∏ÄÁ±ªÁ∫øÁ®ãÂÖ±‰∫´‰ª£Á†ÅÂíåÊï∞ÊçÆÁ©∫Èó¥ÔºåÊØè‰∏™Á∫øÁ®ãÈÉΩÊúâËá™Â∑±Áã¨Á´ãÁöÑËøêË°åÊ†àÂíåÁ®ãÂ∫èËÆ°Êï∞Âô®ÔºàPCÔºâÔºåÁ∫øÁ®ã‰πãÈó¥ÂàáÊç¢ÁöÑÂºÄÈîÄÂ∞è„ÄÇ</p>
</li>
<li>
<p>**ÂåÖÂê´ÂÖ≥Á≥ªÔºö**Â¶ÇÊûú‰∏Ä‰∏™ËøõÁ®ãÂÜÖÊúâÂ§ö‰∏™Á∫øÁ®ãÔºåÂàôÊâßË°åËøáÁ®ã‰∏çÊòØ‰∏ÄÊù°Á∫øÁöÑÔºåËÄåÊòØÂ§öÊù°Á∫øÔºàÁ∫øÁ®ãÔºâÂÖ±ÂêåÂÆåÊàêÁöÑÔºõÁ∫øÁ®ãÊòØËøõÁ®ãÁöÑ‰∏ÄÈÉ®ÂàÜÔºåÊâÄ‰ª•Á∫øÁ®ã‰πüË¢´Áß∞‰∏∫ËΩªÊùÉËøõÁ®ãÊàñËÄÖËΩªÈáèÁ∫ßËøõÁ®ã„ÄÇ</p>
</li>
<li>
<p>**ÂÜÖÂ≠òÂàÜÈÖçÔºö**Âêå‰∏ÄËøõÁ®ãÁöÑÁ∫øÁ®ãÂÖ±‰∫´Êú¨ËøõÁ®ãÁöÑÂú∞ÂùÄÁ©∫Èó¥ÂíåËµÑÊ∫êÔºåËÄåËøõÁ®ã‰πãÈó¥ÁöÑÂú∞ÂùÄÁ©∫Èó¥ÂíåËµÑÊ∫êÊòØÁõ∏‰∫íÁã¨Á´ãÁöÑ</p>
</li>
<li>
<p>**ÂΩ±ÂìçÂÖ≥Á≥ªÔºö**‰∏Ä‰∏™ËøõÁ®ãÂ¥©Ê∫ÉÂêéÔºåÂú®‰øùÊä§Ê®°Âºè‰∏ã‰∏ç‰ºöÂØπÂÖ∂‰ªñËøõÁ®ã‰∫ßÁîüÂΩ±ÂìçÔºå‰ΩÜÊòØ‰∏Ä‰∏™Á∫øÁ®ãÂ¥©Ê∫ÉÊï¥‰∏™ËøõÁ®ãÈÉΩÊ≠ªÊéâ„ÄÇÊâÄ‰ª•Â§öËøõÁ®ãË¶ÅÊØîÂ§öÁ∫øÁ®ãÂÅ•Â£Æ„ÄÇ</p>
</li>
<li>
<p>**ÊâßË°åËøáÁ®ãÔºö**ÊØè‰∏™Áã¨Á´ãÁöÑËøõÁ®ãÊúâÁ®ãÂ∫èËøêË°åÁöÑÂÖ•Âè£„ÄÅÈ°∫Â∫èÊâßË°åÂ∫èÂàóÂíåÁ®ãÂ∫èÂá∫Âè£„ÄÇ‰ΩÜÊòØÁ∫øÁ®ã‰∏çËÉΩÁã¨Á´ãÊâßË°åÔºåÂøÖÈ°ª‰æùÂ≠òÂú®Â∫îÁî®Á®ãÂ∫è‰∏≠ÔºåÁî±Â∫îÁî®Á®ãÂ∫èÊèê‰æõÂ§ö‰∏™Á∫øÁ®ãÊâßË°åÊéßÂà∂Ôºå‰∏§ËÄÖÂùáÂèØÂπ∂ÂèëÊâßË°å</p>
</li>
</ul>
<h4 id="‰∫åËÄÖÂØπÊØî">‰∫åËÄÖÂØπÊØî</h4>
<ul>
<li>
<p>ËøõÁ®ãÂü∫Êú¨‰∏äÁõ∏‰∫íÁã¨Á´ãÔºåÁ∫øÁ®ãÊòØËøõÁ®ãÁöÑÂ≠êÈõÜ</p>
</li>
<li>
<p>ËøõÁ®ãÊã•ÊúâÂÖ±‰∫´ÁöÑËµÑÊ∫êÔºåÂÜÖÂ≠òÁ©∫Èó¥Ôºå‰æõËøõÁ®ãÂ≠êÈõÜ‰ΩøÁî®</p>
</li>
<li>
<p>ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°ËæÉ‰∏∫Â§çÊùÇ</p>
<ul>
<li>
<p>Êú¨Êú∫ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°Áß∞‰∏∫IPC</p>
</li>
<li>
<p>‰∏çÂêåËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°ÂàôÈúÄË¶Å‰ΩøÁî®ÁΩëÁªúÔºåÂπ∂‰∏îÈÅµÂÆàÈÄöËÆØÂçèËÆÆÔºå‰æãÂ¶ÇHTTP</p>
</li>
</ul>
</li>
<li>
<p>ËøõÁ®ã‰πãÈó¥ÈÄö‰ø°ËæÉ‰∏∫ÁÆÄÂçïÔºåÂõ†‰∏∫ÂÖ±‰∫´ËøõÁ®ã‰∏≠ÁöÑÂÜÖÂ≠ò„ÄÇ</p>
</li>
<li>
<p>Á∫øÁ®ãÊõ¥Âä†ËΩªÈáèÔºåÁ∫øÁ®ã‰∏ä‰∏ãÊñáÂàáÊç¢ÊàêÊú¨‰∏ÄËà¨Ë¶ÅÊØîËøõÁ®ã‰∏ä‰∏ãÊñáÂàáÊç¢‰Ωé(‰∏ä‰∏ãÊñáÂàáÊç¢ÈúÄË¶ÅÊ∂àËÄóÊó∂Èó¥)</p>
</li>
</ul>
<h3 id="22-Âπ∂Ë°åÂíåÂπ∂Âèë">2.2 Âπ∂Ë°åÂíåÂπ∂Âèë</h3>
<h4 id="Âπ∂Ë°å">Âπ∂Ë°å</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220312194921322.png"
	
	
	
	loading="lazy"
	
		alt="image-20220312194921322"
	
	
></p>
<p>‰∏§‰∏™Á∫øÁ®ãÊàñÂ§ö‰∏™Á∫øÁ®ãÂêåÊó∂ÂºÄÂßãÔºåÂêåÊó∂ÊâßË°å</p>
<h4 id="Âπ∂Âèë">Âπ∂Âèë</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220312194931459.png"
	
	
	
	loading="lazy"
	
		alt="image-20220312194931459"
	
	
></p>
<p>‰∏§‰∏™Á∫øÁ®ãÊàñÂ§ö‰∏™Á∫øÁ®ãÂêåÊó∂ÂºÄÂßãÔºåÊåâÁÖßË∞ÉÂ∫¶ÁÆóÊ≥ïËΩÆÊµÅÊâßË°å</p>
<h3 id="23-ÂêåÊ≠•‰∏éÂºÇÊ≠•">2.3 ÂêåÊ≠•‰∏éÂºÇÊ≠•</h3>
<h4 id="ÂêåÊ≠•">ÂêåÊ≠•</h4>
<p>ÈúÄË¶ÅÁ≠âÂæÖÁªìÊûúËøîÂõûÔºåÊâçËÉΩÁªßÁª≠ËøêË°åÂ∞±ÊòØÂêåÊ≠•</p>
<p>**Ê≥®Ôºö**Âú®Â§öÁ∫øÁ®ã‰∏≠ÔºåÂêåÊ≠•ËøòÊúâ‰∏Ä‰∏™ÊÑèÊÄùÊòØËÆ©Á∫øÁ®ãÊ≠•Ë∞É‰∏ÄËá¥</p>
<h4 id="ÂºÇÊ≠•">ÂºÇÊ≠•</h4>
<p>‰∏çÈúÄË¶ÅÁ≠âÂæÖÁªìÊûúËøîÂõûÔºåÂ∞±ËÉΩÁªßÁª≠ËøêË°åÂ∞±ÊòØÂºÇÊ≠•</p>
<h3 id="24-ÊÄùËÄÉ">2.4 ÊÄùËÄÉ</h3>
<h4 id="Â§öÁ∫øÁ®ã‰∏ÄÂÆöËÉΩÊèêÂçáÁ®ãÂ∫èËøêË°åÊïàÁéáÂêó">Â§öÁ∫øÁ®ã‰∏ÄÂÆöËÉΩÊèêÂçáÁ®ãÂ∫èËøêË°åÊïàÁéáÂêóÔºü</h4>
<p>1Ôºå<strong>ÂçïÊ†∏CPU‰∏ã</strong>ÔºåÂçïÊ†∏CPU‰∏ãÂ§öÁ∫øÁ®ãÂπ∂‰∏çËÉΩÊèêÂçáÁ®ãÂ∫èËøêË°åÊïàÁéáÔºåÂè™ÊòØËÉΩÂ§üÂú®‰∏çÂêåÁ∫øÁ®ã‰∏≠ËøõË°åÂàáÊç¢ÔºåÂèçËÄåÂú®Êüê‰∫õÊÉÖÂÜµ‰∏ãÔºåÂ§öÁ∫øÁ®ãÁöÑËøêË°åÊïàÁéáÊòØ‰Ωé‰∫éÂçïÁ∫øÁ®ãÁöÑÔºàÂõ†‰∏∫‰∏ä‰∏ãÊñáÂàáÊç¢ÊòØÈúÄË¶ÅËÄóË¥πÊó∂Èó¥ÁöÑ)</p>
<p>2Ôºå<strong>Â§öÊ†∏CPU‰∏ã</strong>ÔºåÂ§öÊ†∏CPUÂèØ‰ª•Âπ∂Ë°åËøêË°åÂ§ö‰∏™Á∫øÁ®ãÔºå‰ΩÜÊòØËÉΩÂê¶ÊèêÈ´òÁ®ãÂ∫èËøêË°åÊïàÁéáËøòÊòØË¶ÅÂàÜÊÉÖÂÜµÁöÑ</p>
<ul>
<li>Êúâ‰∫õ‰ªªÂä°ÔºåÁªèËøáËøõË°åËÆæËÆ°Ôºå‰ªªÂä°ÊãÜÂàÜÔºåÂèØ‰ª•ÊèêÈ´òËøêË°åÊïàÁéáÔºå‰ΩÜÊòØÂπ∂‰∏çÊòØÊâÄÊúâÁöÑËÆ°ÁÆó‰ªªÂä°ÈÉΩËÉΩËøõË°åÊãÜÂàÜ</li>
</ul>
<p>3ÔºåIOÊìç‰Ωú‰∏çÂç†Áî®CPUÔºåËøôÊó∂ÁöÑÁ∫øÁ®ãÊó†ÈúÄ‰ΩøÁî®CPUÔºå‰ΩÜÂç¥Ë¶Å‰∏ÄÁõ¥Á≠âÂæÖIOÁªìÊùüÔºå‰∏çËÉΩÂÖÖÂàÜÂà©Áî®Á∫øÁ®ãÔºå‰ΩÜÊòØÂèØ‰ª•Áî®<strong>NIO</strong>Ôºå‰ª•Âèä<strong>AIO</strong>ËøõË°å‰ºòÂåñ</p>
<h2 id="3-javaÁ∫øÁ®ã">3 JavaÁ∫øÁ®ã</h2>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220908175513859.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h3 id="31-ÂàõÂª∫ÂíåËøêË°åÁ∫øÁ®ã">3.1 ÂàõÂª∫ÂíåËøêË°åÁ∫øÁ®ã</h3>
<h4 id="threadÂàõÂª∫">ThreadÂàõÂª∫</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Thread</span> <span class="nf">createThreadByThread</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">name</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="runnableÂàõÂª∫">RunnableÂàõÂª∫</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Thread</span> <span class="nf">createThreadByRunnable</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="lambdaÁÆÄÂåñ">LambdaÁÆÄÂåñ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Thread</span> <span class="nf">createThreadByLambda</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;{</span><span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);};</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="futuretaskÂàõÂª∫">FutureTaskÂàõÂª∫</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">createThreadFutureTask</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;hello&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">100</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">task</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>FutureTaskÂíåCallableÊé•Âè£ÁªìÂêàÔºåÂç≥ÂèØËøîÂõû‰∏Ä‰∏™‰ªªÊÑèÁ±ªÂûãÁöÑÂÄº</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="n">createThreadFutureTask</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">task</span><span class="o">,</span><span class="s">&#34;Genius4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;result:{}&#34;</span><span class="o">,</span><span class="n">task</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âõ†‰∏∫FutureTask‰ΩøÁî®‰∫ÜrunnableÊé•Âè£ÔºåÊâÄ‰ª•ÂèØ‰ª•Â∞Ütask‰Ωú‰∏∫ThreadÁöÑÂàùÂßãÂåñÂèÇÊï∞ÔºåÂπ∂‰∏îÂèØ‰ª•‰ΩøÁî®task.getËé∑ÂèñËøîÂõûÁöÑÂÄº</p>
<h4 id="runnableÂíåcallableÁöÑÂå∫Âà´">RunnableÂíåCallableÁöÑÂå∫Âà´</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * When an object implementing interface &lt;code&gt;Runnable&lt;/code&gt; is used
</span></span></span><span class="line"><span class="cl"><span class="cm">     * to create a thread, starting the thread causes the object&#39;s
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;code&gt;run&lt;/code&gt; method to be called in that separately executing
</span></span></span><span class="line"><span class="cl"><span class="cm">     * thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The general contract of the method &lt;code&gt;run&lt;/code&gt; is that it may
</span></span></span><span class="line"><span class="cl"><span class="cm">     * take any action whatsoever.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @see     java.lang.Thread#run()
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Computes a result, or throws an exception if unable to do so.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return computed result
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @throws Exception if unable to compute a result
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">V</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>Runnable‰∏≠ÁöÑrunÊó†ËøîÂõûÂÄºÔºõCallableÊé•Âè£‰∏≠ÁöÑcall‰ºöËøîÂõûËøîÂõûÂÄºÔºåÂèØ‰ª•ÈÖçÂêàFutureTaskÂÆåÊàêÂºÇÊ≠•Êìç‰Ωú„ÄÇ</p>
</li>
<li>
<p>runÊñπÊ≥ïÂè™ËÉΩÊäõÂá∫ËøêË°åÊó∂ÂºÇÂ∏∏Êó†Ê≥ïÊçïËé∑Â§ÑÁêÜÂºÇÂ∏∏ÔºåËÄåCallableÂèØ‰ª•Ëé∑ÂèñÂºÇÂ∏∏‰ø°ÊÅØ„ÄÇ</p>
</li>
</ul>
<p>Callable‰∏≠ÁöÑËøîÂõûÁªìÊûúÈÄöËøáFutureTask.get()Ëé∑ÂæóÔºåÊ≠§Êó∂‰∏ªÁ∫øÁ®ã‰ºöËøõÂÖ•ÈòªÂ°ûÁä∂ÊÄÅ„ÄÇ</p>
<h3 id="32-threadrunnableÊ∫êÁ†ÅÂéüÁêÜ">3.2 ThreadÔºåRunnableÊ∫êÁ†ÅÂéüÁêÜ</h3>
<h4 id="new-thread">new Thread()</h4>
<ul>
<li><strong>Thread() -&gt; init() -&gt; this.target = target(runnable)</strong></li>
</ul>
<p>1ÔºåËã•Thread‰∏≠name ‰∏∫Á©∫Âàô‰ºöË∞ÉÁî®nextThreadNum()Ê†πÊçÆÂΩìÂâçÁöÑÁ∫øÁ®ãÊï∞ÈáèÊù•ÂëΩÂêçÔºåÂÖ∂‰∏≠threadInitNumber‰∏∫ÂÖ®Â±ÄÂèòÈáè‰∏îÂØπnextThreadNum()ÊñπÊ≥ïÂä†ÈîÅÔºåÈò≤Ê≠¢Á∫øÁ®ãÈîôËØØ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Thread</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">target</span><span class="o">,</span> <span class="n">AccessControlContext</span> <span class="n">acc</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">init</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">target</span><span class="o">,</span> <span class="s">&#34;Thread-&#34;</span> <span class="o">+</span> <span class="n">nextThreadNum</span><span class="o">(),</span> <span class="n">0</span><span class="o">,</span> <span class="n">acc</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">threadInitNumber</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">nextThreadNum</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">threadInitNumber</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2ÔºåÈÄöËøáÂ§öÊ¨°init()ÊñπÊ≥ïÁöÑÂµåÂ•óÔºåÂ∞ÜtargetËµãÂÄºÁªôÂΩìÂâçÁöÑThread target</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">ThreadGroup</span> <span class="n">g</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">target</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                      <span class="kt">long</span> <span class="n">stackSize</span><span class="o">,</span> <span class="n">AccessControlContext</span> <span class="n">acc</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                      <span class="kt">boolean</span> <span class="n">inheritThreadLocals</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;name cannot be null&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">SecurityManager</span> <span class="n">security</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">g</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Determine if it&#39;s an applet or not */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* If there is a security manager, ask the security manager
</span></span></span><span class="line"><span class="cl"><span class="cm">               what to do. */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">g</span> <span class="o">=</span> <span class="n">security</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* If the security doesn&#39;t have a strong opinion of the matter
</span></span></span><span class="line"><span class="cl"><span class="cm">               use the parent thread group. */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">g</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">g</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* checkAccess regardless of whether or not threadgroup is
</span></span></span><span class="line"><span class="cl"><span class="cm">           explicitly passed in. */</span>
</span></span><span class="line"><span class="cl">        <span class="n">g</span><span class="o">.</span><span class="na">checkAccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Do we have the required permissions?
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">isCCLOverridden</span><span class="o">(</span><span class="n">getClass</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">security</span><span class="o">.</span><span class="na">checkPermission</span><span class="o">(</span><span class="n">SUBCLASS_IMPLEMENTATION_PERMISSION</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">g</span><span class="o">.</span><span class="na">addUnstarted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">group</span> <span class="o">=</span> <span class="n">g</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">daemon</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">isDaemon</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">priority</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">getPriority</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">security</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">isCCLOverridden</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getClass</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">contextClassLoader</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">getContextClassLoader</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">contextClassLoader</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">contextClassLoader</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">inheritedAccessControlContext</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">acc</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">acc</span> <span class="o">:</span> <span class="n">AccessController</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">setPriority</span><span class="o">(</span><span class="n">priority</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">inheritThreadLocals</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">.</span><span class="na">inheritableThreadLocals</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">inheritableThreadLocals</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">ThreadLocal</span><span class="o">.</span><span class="na">createInheritedMap</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">inheritableThreadLocals</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Stash the specified stack size in case the VM cares */</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">stackSize</span> <span class="o">=</span> <span class="n">stackSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Set thread ID */</span>
</span></span><span class="line"><span class="cl">        <span class="n">tid</span> <span class="o">=</span> <span class="n">nextThreadID</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3ÔºåÈÄöËøárun()ÊñπÊ≥ïË∞ÉÁî®target‰∏≠ÁöÑrunÊñπÊ≥ï</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="33-javaËøõÁ®ãÊü•Áúã">3.3 JavaËøõÁ®ãÊü•Áúã</h3>
<h4 id="windowsËøõÁ®ãÊü•ÁúãÂëΩ‰ª§">WindowsËøõÁ®ãÊü•ÁúãÂëΩ‰ª§</h4>
<ul>
<li>tasklist Êü•ÁúãÊâÄÊúâÁöÑ</li>
<li>taskkill /F /PID {pid} ÊùÄÊ≠ªËøõÁ®ã</li>
<li>jps Êü•ÁúãjavaËøõÁ®ã</li>
</ul>
<h4 id="‰ΩøÁî®jconsoleÊù•ËøõË°åËøõÁ®ãÊü•ÁúãËøõÁ®ã‰ø°ÊÅØ">‰ΩøÁî®JconsoleÊù•ËøõË°åËøõÁ®ãÊü•ÁúãËøõÁ®ã‰ø°ÊÅØ</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220313003942146.png"
	
	
	
	loading="lazy"
	
		alt="image-20220313003942146"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220313003959070.png"
	
	
	
	loading="lazy"
	
		alt="image-20220313003959070"
	
	
></p>
<h3 id="34-Á∫øÁ®ãËøêË°åÂéüÁêÜ">3.4 Á∫øÁ®ãËøêË°åÂéüÁêÜ</h3>
<h4 id="Ê†àÂ∏ß‰∏çÂ§öËØ¥‰∫ÜcsdnÊúâÁ¨îËÆ∞">Ê†àÂ∏ß‰∏çÂ§öËØ¥‰∫ÜÔºåCSDNÊúâÁ¨îËÆ∞</h4>
<p>‰∏çÂêåÁöÑÁ∫øÁ®ãÊúâ‰∏çÂêåÁöÑÁ∫øÁ®ãÊ†àÔºå‰∫í‰∏çÂπ≤Êâ∞„ÄÇ</p>
<h4 id="Á∫øÁ®ã‰∏ä‰∏ãÊñáÂàáÊç¢">Á∫øÁ®ã‰∏ä‰∏ãÊñáÂàáÊç¢</h4>
<p>Âõ†‰∏∫Êüê‰∫õÂéüÂõ†ÔºåCPU‰∏çÂÜçÊâßË°åÂΩìÂâçÁöÑÁ∫øÁ®ãÔºåËÄåÊòØÂéªÊâßË°åÂè¶‰∏Ä‰∏™Á∫øÁ®ãÔºö</p>
<ul>
<li>ÂûÉÂúæÂõûÊî∂</li>
<li>Á∫øÁ®ãÊó∂Èó¥ÁâáÁî®ÂÆå</li>
<li>Êúâ‰ºòÂÖàÁ∫ßÊõ¥È´òÁ∫ßÁöÑÁ∫øÁ®ãÈúÄË¶ÅÊâßË°å</li>
<li>Á∫øÁ®ãË∞ÉÁî®‰∫Üsleep,yield,wait,join,park,synchronized,lockÁ≠âÊñπÊ≥ï</li>
</ul>
<p>ÂΩìContext SwitchÂèëÁîüÊó∂ÔºåÈúÄË¶ÅÊìç‰ΩúÁ≥ªÁªü‰øùÂ≠òÁ∫øÁ®ãÂΩìÂâçÁä∂ÊÄÅÔºåÂÜçjava‰∏≠ÂØπÂ∫îÁöÑÊ¶ÇÂøµÂàôÊòØ<strong>Á®ãÂ∫èËÆ°Êï∞Âô®</strong>„ÄÇ</p>
<p>È¢ëÁπÅÁöÑ‰∏ä‰∏ãÊñáÂàáÊç¢ÂΩ±ÂìçÊÄßËÉΩ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314112822680.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314112822680"
	
	
></p>
<p>Â¶Ç‰∏äÂõæÊâÄÁ§∫ÔºåÂΩìmainÁ∫øÁ®ãÊó∂Èó¥ÁâáÁî®ÂÆåÔºåÂàôÂ∞ÜCPUÁöÑÊìç‰ΩúÊùÉÈôêËÆ©Áªôt1ÔºåÂêåÊó∂‰øùÂ≠òmainÁ∫øÁ®ã‰∏≠ÊâÄÊúâÁä∂ÊÄÅ‰ø°ÊÅØ„ÄÇ</p>
<h3 id="35-Á∫øÁ®ãÊñπÊ≥ïËØ¶Ëß£start--run">3.5 Á∫øÁ®ãÊñπÊ≥ïËØ¶Ëß£:start &amp; run</h3>
<h4 id="runÊñπÊ≥ï">runÊñπÊ≥ï</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span><span class="o">(</span><span class="n">topic</span> <span class="o">=</span> <span class="s">&#34;c.start_run&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">start_run</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="s">&#34;t1&#34;</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="s">&#34;t2&#34;</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;main running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314113735349.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314113735349"
	
	
></p>
<h4 id="startÊñπÊ≥ï">startÊñπÊ≥ï</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">@Slf4j(topic = &#34;c.start_run&#34;)
</span></span><span class="line"><span class="cl">public class start_run {
</span></span><span class="line"><span class="cl">    public static void main(String[] args) {
</span></span><span class="line"><span class="cl">        Thread t1 = new Thread(&#34;t1&#34;){
</span></span><span class="line"><span class="cl">            @Override
</span></span><span class="line"><span class="cl">            public void run(){
</span></span><span class="line"><span class="cl">                log.debug(&#34;running&#34;);
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        };
</span></span><span class="line"><span class="cl">        Thread t2 = new Thread(&#34;t2&#34;){
</span></span><span class="line"><span class="cl">            @Override
</span></span><span class="line"><span class="cl">            public void run(){
</span></span><span class="line"><span class="cl">                log.debug(&#34;running2&#34;);
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        };
</span></span><span class="line"><span class="cl">        t1.start();
</span></span><span class="line"><span class="cl">        t2.start();
</span></span><span class="line"><span class="cl">        log.debug(&#34;main running&#34;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314113803454.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314113803454"
	
	
></p>
<p>ÂèØ‰ª•ÂæàÊòéÊòæÁöÑÁúãÂà∞ÔºåÂΩìË∞ÉÁî®runÊñπÊ≥ïÊó∂ÔºåÁ∫øÁ®ãÂ§ÑÁêÜÂÆûÈôÖ‰∏äÊòØmainÁ∫øÁ®ãÔºåÊâÄ‰ª•Âπ∂Ê≤°ÊúâÊÄßËÉΩÊèêÂçá„ÄÇ</p>
<p>myThread.start() -&gt; ÁªßÊâøËá™ThreadÁ±ªÁöÑstart()ÊñπÊ≥ï -&gt; start0() -&gt; private native void start0() -&gt; cppÂ∫ïÂ±ÇÂéªÊâæÂΩìÂâçÁ∫øÁ®ãÁ±ªÁöÑrunÊñπÊ≥ï -&gt; myThreadÁöÑrunÊñπÊ≥ï</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314191902410.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314191902410"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314191853071.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314191853071"
	
	
></p>
<p>Áî±‰∏ä‰æãÁöÑËæìÂá∫ÂèØÁü•ÔºåË∞ÉÁî®runÊñπÊ≥ïÁ∫øÁ®ãÂπ∂Ê≤°ÊúâË¢´Ë∞ÉÁî®ÔºåËÄåÂè™ÊòØË∞ÉÁî®javaÔºåmainÂáΩÊï∞‰∏≠ÁöÑÊñπÊ≥ï</p>
<h4 id="start0Â∫ïÂ±ÇÊ∫êÁ†Å"><strong>start0Â∫ïÂ±ÇÊ∫êÁ†Å</strong></h4>
<p>[Thread.c] start0() -&gt; [Jvm.cpp] JVM_StartThread -&gt;new JavaThread -&gt; thread_entry -&gt;vmSymbols run_method_name() -&gt; &ldquo;run&rdquo;</p>
<p>ÊâæÂà∞openJdk‰∏≠ÁöÑThread.c</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Copyright (c) 1994, 2012, Oracle and/or its affiliates. All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This code is free software; you can redistribute it and/or modify it
</span></span></span><span class="line"><span class="cl"><span class="cm"> * under the terms of the GNU General Public License version 2 only, as
</span></span></span><span class="line"><span class="cl"><span class="cm"> * published by the Free Software Foundation.  Oracle designates this
</span></span></span><span class="line"><span class="cl"><span class="cm"> * particular file as subject to the &#34;Classpath&#34; exception as provided
</span></span></span><span class="line"><span class="cl"><span class="cm"> * by Oracle in the LICENSE file that accompanied this code.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This code is distributed in the hope that it will be useful, but WITHOUT
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
</span></span></span><span class="line"><span class="cl"><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
</span></span></span><span class="line"><span class="cl"><span class="cm"> * version 2 for more details (a copy is included in the LICENSE file that
</span></span></span><span class="line"><span class="cl"><span class="cm"> * accompanied this code).
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * You should have received a copy of the GNU General Public License version
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2 along with this work; if not, write to the Free Software Foundation,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
</span></span></span><span class="line"><span class="cl"><span class="cm"> * or visit www.oracle.com if you need additional information or have any
</span></span></span><span class="line"><span class="cl"><span class="cm"> * questions.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*-
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      Stuff for dealing with threads.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *      originally in threadruntime.c, Sun Sep 22 12:09:39 1991
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;jni.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;jvm.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;java_lang_Thread.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define THD &#34;Ljava/lang/Thread;&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define OBJ &#34;Ljava/lang/Object;&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STE &#34;Ljava/lang/StackTraceElement;&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define STR &#34;Ljava/lang/String;&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define ARRAY_LENGTH(a) (sizeof(a)/sizeof(a[0]))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">JNINativeMethod</span> <span class="n">methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;start0&#34;</span><span class="p">,</span>           <span class="s">&#34;()V&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_StartThread</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;stop0&#34;</span><span class="p">,</span>            <span class="s">&#34;(&#34;</span> <span class="n">OBJ</span> <span class="s">&#34;)V&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_StopThread</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;isAlive&#34;</span><span class="p">,</span>          <span class="s">&#34;()Z&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_IsThreadAlive</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;suspend0&#34;</span><span class="p">,</span>         <span class="s">&#34;()V&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_SuspendThread</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;resume0&#34;</span><span class="p">,</span>          <span class="s">&#34;()V&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_ResumeThread</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;setPriority0&#34;</span><span class="p">,</span>     <span class="s">&#34;(I)V&#34;</span><span class="p">,</span>       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_SetThreadPriority</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;yield&#34;</span><span class="p">,</span>            <span class="s">&#34;()V&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_Yield</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;sleep&#34;</span><span class="p">,</span>            <span class="s">&#34;(J)V&#34;</span><span class="p">,</span>       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_Sleep</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;currentThread&#34;</span><span class="p">,</span>    <span class="s">&#34;()&#34;</span> <span class="n">THD</span><span class="p">,</span>     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_CurrentThread</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;countStackFrames&#34;</span><span class="p">,</span> <span class="s">&#34;()I&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_CountStackFrames</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;interrupt0&#34;</span><span class="p">,</span>       <span class="s">&#34;()V&#34;</span><span class="p">,</span>        <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_Interrupt</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;isInterrupted&#34;</span><span class="p">,</span>    <span class="s">&#34;(Z)Z&#34;</span><span class="p">,</span>       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_IsInterrupted</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;holdsLock&#34;</span><span class="p">,</span>        <span class="s">&#34;(&#34;</span> <span class="n">OBJ</span> <span class="s">&#34;)Z&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_HoldsLock</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;getThreads&#34;</span><span class="p">,</span>        <span class="s">&#34;()[&#34;</span> <span class="n">THD</span><span class="p">,</span>   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_GetAllThreads</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;dumpThreads&#34;</span><span class="p">,</span>      <span class="s">&#34;([&#34;</span> <span class="n">THD</span> <span class="s">&#34;)[[&#34;</span> <span class="n">STE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_DumpThreads</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s">&#34;setNativeName&#34;</span><span class="p">,</span>    <span class="s">&#34;(&#34;</span> <span class="n">STR</span> <span class="s">&#34;)V&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">JVM_SetNativeThreadName</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#undef THD
</span></span></span><span class="line"><span class="cl"><span class="cp">#undef OBJ
</span></span></span><span class="line"><span class="cl"><span class="cp">#undef STE
</span></span></span><span class="line"><span class="cl"><span class="cp">#undef STR
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="n">JNICALL</span>
</span></span><span class="line"><span class="cl"><span class="nf">Java_java_lang_Thread_registerNatives</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">cls</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">RegisterNatives</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">ARRAY_LENGTH</span><span class="p">(</span><span class="n">methods</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂØπÊ≠§Êàë‰ª¨ÂèØÁü•start0ÁöÑÊ∫êÁ†ÅÂú®Jvm.cppÊñá‰ª∂‰∏≠ÔºåJVM_StartThreadÊ∫êÁ†ÅÂ¶Ç‰∏ã</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">JVM_ENTRY</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">JVM_StartThread</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">jthread</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">JVMWrapper</span><span class="p">(</span><span class="s">&#34;JVM_StartThread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">JavaThread</span> <span class="o">*</span><span class="n">native_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">//ÂàõÂª∫‰∏Ä‰∏™ÂºïÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// We cannot hold the Threads_lock when we throw an exception,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// due to rank ordering issues. Example:  we might need to grab the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Heap_lock while we construct the exception.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">throw_illegal_thread_state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// We must release the Threads_lock before we can post a jvmti event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// in Thread::start.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ensure that the C++ Thread and OSThread structures aren&#39;t freed before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// we operate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MutexLocker</span> <span class="nf">mu</span><span class="p">(</span><span class="n">Threads_lock</span><span class="p">);</span> <span class="c1">//Âä†‰∫Ü‰∏ÄÊääÁ∫øÁ®ãÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Since JDK 5 the java.lang.Thread threadStatus is used to prevent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// re-starting an already started thread, so we should usually find
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// that the JavaThread is null. However for a JNI attached thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// there is a small window between the Thread object being created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (with its JavaThread set) and the update to its threadStatus, so we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// have to check for this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">java_lang_Thread</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve_non_null</span><span class="p">(</span><span class="n">jthread</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">throw_illegal_thread_state</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">//ÊäõÂºÇÂ∏∏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>   <span class="c1">//‰∏ãÈù¢ÁöÑÊòØÈáçÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// We could also check the stillborn flag to see if this thread was already stopped, but
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// for historical reasons we let the thread detect that itself when it starts running
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 	  <span class="c1">// ËÆ°ÁÆóÂàõÂª∫Á∫øÁ®ãÊâÄÈúÄË¶ÅÁöÑÂ§ßÂ∞è
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">jlong</span> <span class="n">size</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">             <span class="n">java_lang_Thread</span><span class="o">::</span><span class="n">stackSize</span><span class="p">(</span><span class="n">JNIHandles</span><span class="o">::</span><span class="n">resolve_non_null</span><span class="p">(</span><span class="n">jthread</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Allocate the C++ Thread structure and create the native thread.  The
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// stack size retrieved from java is signed, but the constructor takes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// size_t (an unsigned type), so avoid passing negative values which would
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// result in really large stacks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">size_t</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span> <span class="nl">size</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//ÁîüÊàê‰∏Ä‰∏™JavaThreadÁöÑÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">native_thread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JavaThread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_entry</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// At this point it may be possible that no osthread was created for the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// JavaThread due to lack of memory. Check for this situation and throw
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// an exception if necessary. Eventually we may want to change this so
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// that we only grab the lock if the thread was created successfully -
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// then we can also do this check and throw the exception in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// JavaThread constructor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">native_thread</span><span class="o">-&gt;</span><span class="n">osthread</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Note: the current thread is not being used within &#34;prepare&#34;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">native_thread</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">jthread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ëøô‰∏ÄÂè•new JavaThread()Ëá≥ÂÖ≥ÈáçË¶Å</p>
<p>ÂÖ∂‰∏≠thread_entryÊòØJavaThreadÁöÑÁ¨¨‰∏Ä‰∏™ÂèÇÊï∞Ôºåthread_entryÊ∫êÁ†ÅÂ¶Ç‰∏ã</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">thread_entry</span><span class="p">(</span><span class="n">JavaThread</span><span class="o">*</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">HandleMark</span> <span class="n">hm</span><span class="p">(</span><span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Handle</span> <span class="n">obj</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">threadObj</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">JavaValue</span> <span class="n">result</span><span class="p">(</span><span class="n">T_VOID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">JavaCalls</span><span class="o">::</span><span class="n">call_virtual</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">obj</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">KlassHandle</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="n">SystemDictionary</span><span class="o">::</span><span class="n">Thread_klass</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                          <span class="n">vmSymbols</span><span class="o">::</span><span class="n">run_method_name</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                          <span class="n">vmSymbols</span><span class="o">::</span><span class="n">void_method_signature</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                          <span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âú®thread_entryÈáåÈù¢Êúâ‰∏Ä‰∏™run_method_name()ÊñπÊ≥ï</p>
<p>Êàë‰ª¨ÂèØ‰ª•Âú®vmSymbols‰∏≠ÁúãÂà∞ËØ•ÊñπÊ≥ïÂØπÂ∫îÁöÑjavaÂêç</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314191245041.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314191245041"
	
	
></p>
<p>ÂØπÂ∫îÁöÑÂ∞±ÊòØjava‰∏≠ÁöÑrunÊñπÊ≥ï</p>
<h3 id="36-Á∫øÁ®ãÊñπÊ≥ïËØ¶Ëß£-sleep‰∏éyield">3.6 Á∫øÁ®ãÊñπÊ≥ïËØ¶Ëß£: sleep‰∏éyield</h3>
<h4 id="sleep-Ê∫êÁ†ÅËß£Êûê">sleep Ê∫êÁ†ÅËß£Êûê</h4>
<ul>
<li>Ë∞ÉÁî®sleep‰ºö‰ªé<strong>running</strong>Áä∂ÊÄÅËøõÂÖ•<strong>Timed Waiting</strong>Áä∂ÊÄÅ</li>
<li>Áù°Áú†ÂêéÁöÑÁ∫øÁ®ãÊú™ÂøÖÁõ¥Êé•ËøêË°å</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span><span class="k">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="s">&#34;t1&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="err">@</span><span class="n">Override</span>
</span></span><span class="line"><span class="cl">            <span class="k">public</span> <span class="kt">void</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#34;running&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#34;wake up....&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">t1</span><span class="p">.</span><span class="n">getState</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="p">.</span><span class="n">interrupt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>TimeUnitÊõø‰ª£Thread.sleep</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="s">&#34;t1&#34;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;wake up....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314231632577.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314231632577"
	
	
></p>
<p>Ë∞ÉÁî®Interrupt‰ºöÊâìÊñ≠sleeping ÂêåÊó∂ÊäõÂá∫ÂºÇÂ∏∏</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220314212243181.png"
	
	
	
	loading="lazy"
	
		alt="image-20220314212243181"
	
	
></p>
<h4 id="yield-Ê∫êÁ†ÅËß£Êûê">yield Ê∫êÁ†ÅËß£Êûê</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">JVM_ENTRY</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">JVM_Yield</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">threadClass</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">JVMWrapper</span><span class="p">(</span><span class="s">&#34;JVM_Yield&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">::</span><span class="n">dont_yield</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef USDT2
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">HS_DTRACE_PROBE0</span><span class="p">(</span><span class="n">hotspot</span><span class="p">,</span> <span class="n">thread__yield</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else </span><span class="cm">/* USDT2 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">HOTSPOT_THREAD_YIELD</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="cm">/* USDT2 */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="c1">// When ConvertYieldToSleep is off (default), this matches the classic VM use of yield.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Critical for similar threading behaviour
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">ConvertYieldToSleep</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">::</span><span class="n">sleep</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">MinSleepInterval</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">::</span><span class="n">yield</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">os</span><span class="o">::</span><span class="n">YieldResult</span> <span class="n">os</span><span class="o">::</span><span class="n">NakedYield</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Use either SwitchToThread() or Sleep(0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Consider passing back the return value from SwitchToThread().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">::</span><span class="n">Kernel32Dll</span><span class="o">::</span><span class="n">SwitchToThreadAvailable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">SwitchToThread</span><span class="p">()</span> <span class="o">?</span> <span class="n">os</span><span class="o">::</span><span class="nl">YIELD_SWITCHED</span> <span class="p">:</span> <span class="n">os</span><span class="o">::</span><span class="n">YIELD_NONEREADY</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">os</span><span class="o">::</span><span class="n">YIELD_UNKNOWN</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">os</span><span class="o">::</span><span class="n">yield</span><span class="p">()</span> <span class="p">{</span>  <span class="n">os</span><span class="o">::</span><span class="n">NakedYield</span><span class="p">();</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Áî±‰∏äÂõæÂèØ‰ª•ÁúãÂá∫ÔºåThread.yield()Ë∞ÉÁî®ËøáÁ®ã‰∏∫ yield()-&gt;JVM_Yield()-&gt;NakedYield()</p>
<p>ÂêåÊó∂Âú®ËøôÈáå‰ΩøÁî®‰∫ÜSwitchToThread Âíå Sleep(0) ‰∏§‰∏™ÊñπÊ≥ï</p>
<p>**Sleep(0)Ôºö**Âè™‰ºöÂ∞ÜÊó∂Èó¥ÁâáËÆ©Áªô‰ºòÂÖàÁ∫ßÁõ∏ÂêåÊàñËÄÖÊõ¥È´òÁöÑÁ∫øÁ®ã</p>
<p>‚Äã    ÂØπ‰∫éC++‰∏≠Sleep(timeout)ÊñπÊ≥ïÂèØ‰ª•Ëøô‰πàÁêÜËß£Ôºö
‚Äã    <strong>ÂΩìtimeout = 0Êó∂</strong>Ôºö‰ºöÂ∞ÜËØ•Á∫øÁ®ãËÆ©ÁªôÊØîËá™Â∑±‰ºòÂÖàÁ∫ßÊõ¥È´òÊàñËÄÖÁõ∏Á≠âÁöÑÁ∫øÁ®ãÂéªËøêË°å</p>
<p>‚Äã    <strong>ÂΩìtimeout &gt; 0Êó∂</strong>Ôºö‰ºöÂºïÂèë‰∏ä‰∏ãÊñáÂàáÊç¢ÔºåË∞ÉÁî®Á∫øÁ®ã‰ºö‰ªéÁ∫øÁ®ãË∞ÉÂ∫¶Âô®ÁöÑÂèØËøêË°åÈòüÂàóÁßªÈô§‰∏ÄÊÆµÊó∂Èó¥</p>
<p>**SwitchToThread()Ôºö**Âè™Ë¶ÅÊúâÂèØË∞ÉÂ∫¶ÁöÑÁ∫øÁ®ãÔºåÊó†ËÆ∫‰ºòÂÖàÁ∫ßÔºåÈÉΩ‰ºöËÆ©ÂÖ∂Ë∞ÉÂ∫¶ÔºåÂπ∂‰∏îËøîÂõûÈùû0ÂÄºÔºåËã•Êó†Á∫øÁ®ãÂèØË∞ÉÂ∫¶ÂàôËøîÂõûFalse</p>
<h4 id="Âú®java‰∏≠sleepÂíåyieldÁöÑÂå∫Âà´"><strong>Âú®Java‰∏≠SleepÂíåyieldÁöÑÂå∫Âà´</strong></h4>
<ul>
<li>sleep‰ºöÊäõÂá∫ÂºÇÂ∏∏ÔºåËÄåyield‰∏ç‰ºöÊäõÂá∫ÂºÇÂ∏∏„ÄÇ</li>
<li>yieldÂ∞ÜCPUÁöÑ‰ΩøÁî®ÊùÉËÆ©ÁªôÊØîËá™Â∑±‰ºòÂÖàÁ∫ßÊõ¥È´òÊàñËÄÖÁõ∏ÂêåÁöÑÁ∫øÁ®ãÔºåsleepÊòØËØ•Á∫øÁ®ã‰ªéÂèØËøêË°åÈòüÂàóÁßªÈô§‰∏ÄÊÆµÊó∂Èó¥ËøõË°å‰∏ä‰∏ãÊñáÂàáÊç¢</li>
<li>sleepËøõÂÖ•Time_waitÁä∂ÊÄÅÔºåËÄåyieldËøõÂÖ•Â∞±Áª™ÊÄÅ„ÄÇ</li>
<li>sleep()ÊñπÊ≥ïÊØîyield()ÊñπÊ≥ïÔºàË∑üÊìç‰ΩúÁ≥ªÁªüCPUË∞ÉÂ∫¶Áõ∏ÂÖ≥ÔºâÂÖ∑ÊúâÊõ¥Â•ΩÁöÑÂèØÁßªÊ§çÊÄß„ÄÇ</li>
</ul>
<h4 id="Á∫øÁ®ã‰ºòÂÖàÁ∫ß">Á∫øÁ®ã‰ºòÂÖàÁ∫ß</h4>
<p>ÂΩìCPUËæÉ‰∏∫ÁπÅÂøôÔºå‰ºòÂÖàÁ∫ßÈ´òÁöÑÁ∫øÁ®ã‰ºöËé∑ÂæóÊõ¥Â§öÊó∂Èó¥ÁâáÔºåCPUËæÉ‰∏∫Á©∫Èó≤Êó∂Ôºå‰ºòÂÖàÁ∫ßÂá†‰πéÊ≤°‰ΩúÁî®Ôºå‰ºòÂÖàÁ∫ß‰ªÖ‰ªÖÂè™ÊòØ‰∏Ä‰∏™ÊèêÁ§∫</p>
<h3 id="37-Ê°à‰æã-Èò≤Ê≠¢cpuÂç†Áî®100">3.7 Ê°à‰æã-Èò≤Ê≠¢CPUÂç†Áî®100%</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">50</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂèØ‰ª•Áî®sleepËÆ©Âá∫cpu‰ΩøÁî®ÊùÉÔºåÈò≤Ê≠¢Á©∫ËΩ¨CPUÔºåÂêåÊó∂‰πüÂèØ‰ª•‰ΩøÁî®waitÊàñÊù°‰ª∂ÂèòÈáèËææÂà∞(ÈúÄË¶ÅÂä†ÈîÅ,ÈÄÇÁî®‰∫éÂêåÊ≠•Âú∫ÊôØ)Ôºåsleep‰∏çÈúÄË¶ÅÂä†ÈîÅ</p>
<h3 id="38-join">3.8 Join</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315201613121.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315201613121"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315201620643.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315201620643"
	
	
></p>
<p>Áî±‰∏äÂõæÂèØ‰ª•ÂæóÁü•ÔºåÂõ†‰∏∫‰∏ªÊñπÊ≥ïÂíåÁ∫øÁ®ãt1ÊòØÂπ∂Ë°åÁöÑÔºåÊâÄ‰ª•Âú®Á∫øÁ®ãt1.sleepÂêéÔºårÂ∞±Â∑≤ÁªèË¢´‰∏ªÁ∫øÁ®ãËæìÂá∫‰∫Ü„ÄÇ</p>
<h4 id="ËÉΩ‰∏çËÉΩÁî®sleep‰∏∫‰ªÄ‰πà">ËÉΩ‰∏çËÉΩÁî®sleepÔºü‰∏∫‰ªÄ‰πàÔºü</h4>
<p>ËÉΩÔºå‰ΩÜÊòØÂ¶ÇÊûúmillisÊòØÂèòÈáèÈÇ£ÂÖ∑‰Ωìt1Á∫øÁ®ãË¶Å‰ªÄ‰πàsleepÂ§öÂ∞ëÊó∂Èó¥ÊòØ‰∏çÁü•ÈÅìÁöÑ</p>
<h4 id="join">Join</h4>
<p>**ÊèèËø∞Ôºö**Á≠âÂæÖÊüê‰∏ÄÁ∫øÁ®ãËøêË°åÂÆåÔºåÊâçÂºÄÂßãËøêË°å(ÂêåÊ≠•)</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315205621335.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315205621335"
	
	
></p>
<h4 id="joinÂéüÁêÜ">JoinÂéüÁêÜ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">join</span><span class="o">(</span><span class="kt">long</span> <span class="n">millis</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">millis</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;timeout value is negative&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">millis</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">wait</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">millis</span> <span class="o">-</span> <span class="n">now</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">delay</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">wait</span><span class="o">(</span><span class="n">delay</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">base</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>join<strong>ÈááÁî®ÁöÑÊòØ‰øùÊä§ÊÄßÊöÇÂÅúËÆæËÆ°Ê®°ÂºèÁöÑÂéüÁêÜ</strong>Ôºå<strong>Â¶ÇÊûúmillis = 0 Â∞±‰ºö‰∏ÄÁõ¥Á≠âÂæÖËØ•Á∫øÁ®ãÊâßË°åÁªìÊùüÂêéÊâç‰ºöÂÅúÊ≠¢Âæ™ÁéØÔºåÂ∫ïÂ±ÇË∞ÉÁî®ÁöÑÊòØwaitÊñπÊ≥ï</strong>Ôºåsynchronzied‰∏∫ÈúÄË¶ÅÁ≠âÂæÖÂÆåÊàêÁöÑthisÁ∫øÁ®ãËøõË°åÂä†ÈîÅÔºåÂÖ∂‰ªñÁ∫øÁ®ãË∞ÉÁî®joinÊñπÊ≥ïÊó∂Ôºå‰ºöËøõÂÖ•ËØ•ÂêåÊ≠•‰ª£Á†ÅÂùóÔºåÂπ∂‰∏îË∞ÉÁî®waitÊñπÊ≥ïÔºåËøõÂÖ•ÈòªÂ°ûÁä∂ÊÄÅÔºå<strong>ÂêåÊó∂thisÁ∫øÁ®ã‰πü‰ºöÂèò‰∏∫ÈáçÈáèÁ∫ßÈîÅ„ÄÇ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">JUC.a_JavaThread.join$1 object internals:
</span></span><span class="line"><span class="cl">OFF  SZ                                        TYPE DESCRIPTION                             VALUE
</span></span><span class="line"><span class="cl">  0   4                                             (object header: mark)                   0x026ccfe6 (fat lock: 0x026ccfe6)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="39-interrupt-ÊñπÊ≥ïËØ¶Ëß£">3.9 interrupt ÊñπÊ≥ïËØ¶Ëß£</h3>
<h4 id="ÊâìÊñ≠sleepwaitjoinÁ∫øÁ®ã">ÊâìÊñ≠sleepÔºåwaitÔºåjoinÁ∫øÁ®ã</h4>
<p><strong>ÈòªÂ°ûÊâìÊñ≠Ôºö</strong></p>
<p>ÊâìÊñ≠sleepÁöÑÁ∫øÁ®ãÔºåÊäõÂá∫ÂºÇÂ∏∏ÔºåÂπ∂‰∏îÂú®ÊäõÂá∫ÂºÇÂ∏∏ÂêéÁ´ãÂç≥Â∞ÜÁ∫øÁ®ã‰∏≠Êñ≠Ê†áÁ§∫‰ΩçÊ∏ÖÊ•öÔºåÈáçÊñ∞ËÆæÁΩÆ‰∏∫falseÔºåÊäõÂá∫ÂºÇÂ∏∏ÊòØ‰∏∫‰∫ÜËÆ©Á∫øÁ®ã‰ªéÈòªÂ°ûÁä∂ÊÄÅÈÜíËøáÊù•ÔºåÂπ∂‰∏îÂú®Á∫øÁ®ãÁªìÊùüÂâçËÆ©Á®ãÂ∫èÂëòÊúâË∂≥Â§üÁöÑÊó∂Èó¥Êù•Â§ÑÁêÜ‰∏≠Êñ≠ËØ∑Ê±Ç</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span><span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;sleep...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">           <span class="k">try</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">5000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">               <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;interrupt&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{}&#34;</span><span class="o">,</span><span class="n">t1</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315211854345.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315211854345"
	
	
></p>
<p><strong>ËøêË°åÊâìÊñ≠Ôºö</strong></p>
<p>ÊâìÊñ≠ËøêË°åÁöÑÁ∫øÁ®ãÔºå‰∏ç‰ºöÊ∏ÖÁ©∫ÊâìÊñ≠Áä∂ÊÄÅÔºåËøîÂõûfalse</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span><span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;t2 {}&#34;</span><span class="o">,</span><span class="n">t1</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t2</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315214537725.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315214537725"
	
	
></p>
<h3 id="310-‰∏§Èò∂ÊÆµÁªàÊ≠¢Ê®°Âºè">3.10 ‰∏§Èò∂ÊÆµÁªàÊ≠¢Ê®°Âºè</h3>
<p>Â¶Ç‰ΩïÂú®T1Á∫øÁ®ã‰∏≠‰ºòÈõÖÁöÑÁªàÊ≠¢Á∫øÁ®ãT2Ôºü</p>
<h4 id="ÈîôËØØÊÄùË∑Ø">ÈîôËØØÊÄùË∑Ø</h4>
<ul>
<li><strong>‰ΩøÁî®stop()ÊñπÊ≥ïÂÅúÊ≠¢Á∫øÁ®ã</strong></li>
</ul>
<p>stopÊñπÊ≥ï‰ºöÊùÄÊ≠ªÁ∫øÁ®ãÔºåËøôÊó∂Â¶ÇÊûúÁ∫øÁ®ãÈîÅ‰Ωè‰∫ÜÂÖ±‰∫´ËµÑÊ∫êÔºåÈÇ£‰πàË¢´ÊùÄÊ≠ªÂêéÂ∞±ÂÜç‰πüÊ≤°ÊúâÊú∫‰ºöÈáäÊîæÈîÅÔºåÂÖ∂‰ªñÁ∫øÁ®ãÊ∞∏ËøúÊó†Ê≥ïËé∑ÂèñÈîÅ</p>
<ul>
<li><strong>‰ΩøÁî®System.exit(init) ÊñπÊ≥ïÂÅúÊ≠¢Á∫øÁ®ã</strong></li>
</ul>
<p>Ëøô‰∏™ÊñπÊ≥ï‰ºöËÆ©Á®ãÂ∫èÂÅúÊ≠¢</p>
<h4 id="Ê≠£Á°ÆÊÄùË∑Ø">Ê≠£Á°ÆÊÄùË∑Ø</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220315215652051.png"
	
	
	
	loading="lazy"
	
		alt="image-20220315215652051"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Thread</span> <span class="n">monitor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">TwoPhaseInterrput</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">current</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÊñôÁêÜÂêé‰∫ã&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÁõëÊéß‰∏≠&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">current</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span> <span class="c1">//Áî±‰∫ésleep‰ºöÊ∏ÖÈô§InterruptÊ†áËÆ∞,ÈáçÊñ∞ÊâìÊñ≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@SneakyThrows</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="n">monitor</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;stop&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TwoPhaseInterrput</span> <span class="n">twoPhaseInterrput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TwoPhaseInterrput</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">twoPhaseInterrput</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">twoPhaseInterrput</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316130132899.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316130132899"
	
	
></p>
<p>Âú®sleep‰∏≠ÔºåÊâìÊñ≠Ê†áËÆ∞‰ºöË¢´Ê∏ÖÈô§ÔºåÊâÄ‰ª•Â∫îËØ•Âú®catch‰∏≠ÂÜçÊâìÊñ≠‰∏ÄÊ¨°</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316130712873.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316130712873"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316130719256.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316130719256"
	
	
></p>
<h3 id="311-parkunpark">3.11 Park&amp;UnPark</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;start..&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;park...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;resume...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unpark....&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">18:43:35.503 [t1] DEBUG JUC.a_JavaThread.parkThread - start..
</span></span><span class="line"><span class="cl">18:43:36.507 [main] DEBUG JUC.a_JavaThread.parkThread - unpark....
</span></span><span class="line"><span class="cl">18:43:37.518 [t1] DEBUG JUC.a_JavaThread.parkThread - park...
</span></span><span class="line"><span class="cl">18:43:37.518 [t1] DEBUG JUC.a_JavaThread.parkThread - resume...
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÁâπÁÇπ">ÁâπÁÇπ</h4>
<p><strong>‰∏éObjectÁöÑwait&amp;notifyÁõ∏ÊØîÔºö</strong></p>
<ul>
<li>parkÂíåunparkÊó†ÈúÄÂú®ÂêåÊ≠•‰ª£Á†ÅÂùó‰∏≠‰ΩøÁî®,waitÔºånotifyÂíånotifyAllÂøÖÈ°ªÈÖçÂêàObject Monitor‰∏ÄËµ∑‰ΩøÁî®</li>
<li>park &amp; unpark ÊòØ‰ª•Á∫øÁ®ãÂçï‰ΩçÊù•„ÄêÈòªÂ°û„ÄëÂíå„ÄêÂî§ÈÜí„ÄëÁ∫øÁ®ãÔºåËÄånotifyÂè™ËÉΩÈöèÊú∫Âî§ÈÜí‰∏Ä‰∏™Á∫øÁ®ãÔºåÊØînotifyÊõ¥Âä†Á≤æÁ°Æ</li>
<li>park &amp; unpark ÂèØ‰ª•ÂÖà unparkÔºå‰ΩÜÊòØ wait &amp; notify‰∏çËÉΩÂÖànotify</li>
</ul>
<p>ËØ•ÊñπÊ≥ï‰ºö‰ΩøÁ∫øÁ®ãÂÅúÊ≠¢ÔºåÂèØ‰ª•Áî®interruptÊâìÊñ≠parkÁä∂ÊÄÅÔºå‰ΩÜÊ≠§Êó∂ÊâìÊñ≠Ê†áËÆ∞‰∏∫tureÔºå‰∏ã‰∏ÄÊ¨°Ë∞ÉÁî®parkÊñπÊ≥ï‰ºöÊ†πÊçÆÊâìÊñ≠Ê†áËÆ∞ÊòØÂê¶‰∏∫falseÊù•Âà§Êñ≠ÊòØÂê¶ÂÅúÊ≠¢Á∫øÁ®ã„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;park...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unpark...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÊâìÊñ≠Áä∂ÊÄÅ:{}&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unpark...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÊâìÊñ≠Áä∂ÊÄÅ:{}&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unpark&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316132557295.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316132557295"
	
	
></p>
<h4 id="ÂéüÁêÜ">ÂéüÁêÜ</h4>
<h5 id="park">park()</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">park</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">UNSAFE</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">0L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="parkobject-blocker">park(Object blocker)</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">park</span><span class="o">(</span><span class="n">Object</span> <span class="n">blocker</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">setBlocker</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">blocker</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">UNSAFE</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">0L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">setBlocker</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ÊñπÊ≥ïÂàÜÊûêÔºö</strong></p>
<ul>
<li>ËøôÈáåÁöÑblocker ÊòØÊåáË¢´ÈòªÂ°ûÁöÑÂØπË±°ÔºåÁî®‰∫é‰πãÂêéÁöÑÁ∫øÁ®ãÁõëÊéßÂíåÂàÜÊûêÂ∑•ÂÖ∑Êù•ÂÆö‰Ωç</li>
</ul>
<h5 id="public-native-void-parkboolean-isabsolute-long-time">public native void park(boolean isAbsolute, long time)</h5>
<ul>
<li>isAbsolut = trueÔºömsÂÆöÊó∂,isAbsolut=falseÔºönsÂÆöÊó∂</li>
</ul>
<p>Âú®LinuxÁ≥ªÁªü‰∏ãÔºåÊòØÁî®ÁöÑPosixÁ∫øÁ®ãÂ∫ìpthreadÁßçÁöÑmutex(‰∫íÊñ•Èáè)Ôºåcondition(Êù°‰ª∂ÂèòÈáè) Êù•ÂÆûÁé∞ÁöÑ„ÄÇ</p>
<p><strong>mutexÂíåcondition‰øùÊä§‰∫Ü‰∏Ä‰∏™_counterÁöÑÂèòÈáèÔºåÂΩìparkÊó∂ÔºåËøô‰∏™ÂèòÈáèË¢´ËÆæÁΩÆ‰∏∫0ÔºåÂΩìunparkÊó∂ÔºåËøô‰∏™ÂèòÈáèË¢´ËÆæÁΩÆ‰∏∫1„ÄÇ</strong></p>
<p><strong>conditionÊù°‰ª∂</strong>ÂèòÈáèË¢´Áî®Êù•ÈòªÂ°û‰∏Ä‰∏™Á∫øÁ®ãÔºåÂΩìÊù°‰ª∂‰∏çÊª°Ë∂≥Êó∂ÔºåÁ∫øÁ®ãÂæÄÂæÄËß£ÂºÄÁõ∏Â∫îÁöÑ‰∫íÊñ•ÈîÅÂπ∂Á≠âÂæÖÊù°‰ª∂ÂèëÁîüÂèòÂåñ„ÄÇ‰∏ÄÊó¶ÂÖ∂‰ªñÁöÑÊüê‰∏™Á∫øÁ®ãÊîπÂèò‰∫ÜÊù°‰ª∂ÂèòÈáèÔºåÂÆÉÂ∞ÜÈÄöÁü•Áõ∏Â∫îÁöÑÊù°‰ª∂ÂèòÈáèÂî§ÈÜí‰∏Ä‰∏™ÊàñÂ§ö‰∏™Ê≠£Ë¢´Ê≠§Êù°‰ª∂ÂèòÈáèÈòªÂ°ûÁöÑÁ∫øÁ®ãÔºåËøô‰∫õÁ∫øÁ®ãÂ∞ÜÈáçÊñ∞ÈîÅÂÆö‰∫íÊñ•ÈîÅÂπ∂ÈáçÊñ∞ÊµãËØïÊù°‰ª∂ÊòØÂê¶Êª°Ë∂≥„ÄÇ</p>
<p><strong>ÊØè‰∏™JavaÁ∫øÁ®ãÈÉΩÊúâ‰∏Ä‰∏™ParkerÂÆû‰æãÔºåParkerÁ±ªÊòØËøôÊ†∑ÂÆö‰πâÁöÑ</strong></p>
<h5 id="parkÁ±ªÂÆö‰πâ">ParkÁ±ªÂÆö‰πâ</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/* In the future we&#39;ll want to think about eliminating Parker and using
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ParkEvent instead.  There&#39;s considerable duplication between the two
</span></span></span><span class="line"><span class="cl"><span class="cm"> * services.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">*Â∞ÜÊù•Êàë‰ª¨‰ºöËÄÉËôëÈô§ÊéâParkerÔºåÁî®ParkEvent‰ª£Êõø„ÄÇ‰∏§ËÄÖ‰πãÈó¥ÊúâÁõ∏ÂΩìÂ§öÁöÑÈáçÂ§çÊúçÂä°„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Parker</span> <span class="o">:</span> <span class="k">public</span> <span class="n">os</span><span class="o">::</span><span class="n">PlatformParker</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">_counter</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Parker</span> <span class="o">*</span> <span class="n">FreeNext</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">JavaThread</span> <span class="o">*</span> <span class="n">AssociatedWith</span> <span class="p">;</span> <span class="c1">// Current association
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">Parker</span><span class="p">()</span> <span class="o">:</span> <span class="n">PlatformParker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_counter</span>       <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FreeNext</span>       <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AssociatedWith</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">~</span><span class="n">Parker</span><span class="p">()</span> <span class="p">{</span> <span class="n">ShouldNotReachHere</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// For simplicity of interface with Java, all forms of park (indefinite,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// relative, and absolute) are multiplexed into one call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="n">park</span><span class="p">(</span><span class="kt">bool</span> <span class="n">isAbsolute</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">unpark</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Lifecycle operators
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">static</span> <span class="n">Parker</span> <span class="o">*</span> <span class="nf">Allocate</span> <span class="p">(</span><span class="n">JavaThread</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="kt">void</span> <span class="nf">Release</span> <span class="p">(</span><span class="n">Parker</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="n">Parker</span> <span class="o">*</span> <span class="k">volatile</span> <span class="n">FreeList</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">ListLock</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="os-platformparker">os:: PlatformParker</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PlatformParker</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CHeapObj</span><span class="o">&lt;</span><span class="n">mtInternal</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">enum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">REL_INDEX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ABS_INDEX</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">_cur_index</span><span class="p">;</span>  <span class="c1">// which cond is in use: -1, 0, 1  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pthread_mutex_t</span> <span class="n">_mutex</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pthread_cond_t</span>  <span class="n">_cond</span>  <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">;</span> <span class="c1">// one for relative times and one for abs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>       <span class="c1">// TODO-FIXME: make dtor private
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">~</span><span class="n">PlatformParker</span><span class="p">()</span> <span class="p">{</span> <span class="n">guarantee</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">)</span> <span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">PlatformParker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_cond_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">REL_INDEX</span><span class="p">],</span> <span class="n">os</span><span class="o">::</span><span class="n">Linux</span><span class="o">::</span><span class="n">condAttr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert_status</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&#34;cond_init rel&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_cond_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">ABS_INDEX</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert_status</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&#34;cond_init abs&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_init</span> <span class="p">(</span><span class="n">_mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert_status</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&#34;mutex_init&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_cur_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// mark as unused
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="parkÊ∫êÁ†Å">ParkÊ∫êÁ†Å</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Parker</span><span class="o">::</span><span class="n">park</span><span class="p">(</span><span class="kt">bool</span> <span class="n">isAbsolute</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">time</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">//ÂéüÂ≠ê‰∫§Êç¢ÔºåÂ¶ÇÊûú_counter &gt; 0,ÂàôÂ∞Ü_counterÁΩÆ‰∏∫0ÔºåÁõ¥Êé•ËøîÂõûÔºåÂê¶Âàô_counter‰∏∫0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">xchg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_counter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Ëé∑ÂèñÂΩìÂâçÁ∫øÁ®ã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Thread</span><span class="o">*</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">::</span><span class="n">current</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">is_Java_thread</span><span class="p">(),</span> <span class="s">&#34;Must be JavaThread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//‰∏ãËΩ¨Âûã‰∏∫javaÁ∫øÁ®ã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">JavaThread</span> <span class="o">*</span><span class="n">jt</span> <span class="o">=</span> <span class="p">(</span><span class="n">JavaThread</span> <span class="o">*</span><span class="p">)</span><span class="kr">thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">//Â¶ÇÊûúÂΩìÂâçÁ∫øÁ®ãËÆæÁΩÆ‰∫Ü‰∏≠Êñ≠Ê†áÂøóÔºåË∞ÉÁî®parkÂàôÁõ¥Êé•ËøîÂõûÔºåÊâÄ‰ª•Â¶ÇÊûúÂú®park‰πãÂâçË∞ÉÁî®‰∫Ü
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//interruptÂ∞±‰ºöÁõ¥Êé•ËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Thread</span><span class="o">::</span><span class="n">is_interrupted</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">// È´òÁ≤æÂ∫¶ÁªùÂØπÊó∂Èó¥ÂèòÈáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">timespec</span> <span class="n">absTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Â¶ÇÊûútimeÂ∞è‰∫é0ÔºåÊàñËÄÖisAbsoluteÊòØtrueÂπ∂‰∏îtimeÁ≠â‰∫é0ÂàôÁõ¥Êé•ËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">isAbsolute</span> <span class="o">&amp;&amp;</span> <span class="n">time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span> <span class="c1">// don&#39;t wait at all
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Â¶ÇÊûútimeÂ§ß‰∫é0ÔºåÂàôÊ†πÊçÆÊòØÂê¶ÊòØÈ´òÁ≤æÂ∫¶ÂÆöÊó∂ËÆ°ÁÆóÂÆöÊó∂Êó∂Èó¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">unpackTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">absTime</span><span class="p">,</span> <span class="n">isAbsolute</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">//ËøõÂÖ•ÂÆâÂÖ®ÁÇπÈÅøÂÖçÊ≠ªÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ThreadBlockInVM</span> <span class="nf">tbivm</span><span class="p">(</span><span class="n">jt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">//Â¶ÇÊûúÂΩìÂâçÁ∫øÁ®ãËÆæÁΩÆ‰∫Ü‰∏≠Êñ≠Ê†áÂøóÔºåÊàñËÄÖËé∑Âèñmutex‰∫íÊñ•ÈîÅÂ§±Ë¥•ÂàôÁõ¥Êé•ËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//Áî±‰∫éParkerÊòØÊØè‰∏™Á∫øÁ®ãÈÉΩÊúâÁöÑÔºåÊâÄ‰ª•_counter cond mutexÈÉΩÊòØÊØè‰∏™Á∫øÁ®ãÈÉΩÊúâÁöÑÔºå
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//‰∏çÊòØÊâÄÊúâÁ∫øÁ®ãÂÖ±‰∫´ÁöÑÊâÄ‰ª•Âä†ÈîÅÂ§±Ë¥•Âè™Êúâ‰∏§ÁßçÊÉÖÂÜµÔºåÁ¨¨‰∏ÄparkÂ∑≤ÁªèÂä†ÈîÅËøôÊó∂Âè™ÈúÄË¶ÅËøîÂõûÂç≥ÂèØÔºå
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//Á¨¨‰∫åË∞ÉÁî®Ë∞ÉÁî®pthread_mutex_trylockÂá∫Èîô„ÄÇÂØπ‰∫éÁ¨¨‰∏ÄÁßçÊÉÖÂÜµÂ∞±Á±ª‰ººÊòØunparkÂÖàË∞ÉÁî®ÁöÑÊÉÖÂÜµÔºåÊâÄ‰ª•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//Áõ¥Êé•ËøîÂõû„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Thread</span><span class="o">::</span><span class="n">is_interrupted</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">||</span> <span class="n">pthread_mutex_trylock</span><span class="p">(</span><span class="n">_mutex</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">status</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Â¶ÇÊûú_counterÂ§ß‰∫é0ÔºåËØ¥ÊòéunparkÂ∑≤ÁªèË∞ÉÁî®ÂÆåÊàê‰∫ÜÂ∞Ü_counterÁΩÆ‰∏∫‰∫Ü1Ôºå
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//Áé∞Âú®Âè™ÈúÄÂ∞Ü_counterÁΩÆ0ÔºåËß£ÈîÅÔºåËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span> <span class="c1">// no wait needed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="n">OSThreadWaitState</span> <span class="nf">osts</span><span class="p">(</span><span class="kr">thread</span><span class="o">-&gt;</span><span class="n">osthread</span><span class="p">(),</span> <span class="nb">false</span> <span class="cm">/* not Object.wait() */</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">jt</span><span class="o">-&gt;</span><span class="n">set_suspend_equivalent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// cleared by handle_special_suspend_equivalent_condition() or java_suspend_self()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_cur_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Â¶ÇÊûútimeÁ≠â‰∫é0ÔºåËØ¥ÊòéÊòØÁõ∏ÂØπÊó∂Èó¥‰πüÂ∞±ÊòØisAbsoluteÊòØfasle(Âê¶ÂàôÂâçÈù¢Â∞±Áõ¥Êé•ËøîÂõû‰∫Ü),ÂàôÁõ¥Êé•ÊåÇËµ∑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_cur_index</span> <span class="o">=</span> <span class="n">REL_INDEX</span><span class="p">;</span> <span class="c1">// arbitrary choice when not timed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_cond_wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">_cur_index</span><span class="p">],</span> <span class="n">_mutex</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//Â¶ÇÊûútimeÈùû0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//Âà§Êñ≠isAbsoluteÊòØfalseËøòÊòØtrueÔºåfalseÁöÑËØù‰ΩøÁî®_cond[0]ÔºåÂê¶ÂàôÁî®_cond[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_cur_index</span> <span class="o">=</span> <span class="n">isAbsolute</span> <span class="o">?</span> <span class="nl">ABS_INDEX</span> <span class="p">:</span> <span class="n">REL_INDEX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//‰ΩøÁî®Êù°‰ª∂ÂèòÈáè‰ΩøÂæóÂΩìÂâçÁ∫øÁ®ãÊåÇËµ∑„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">::</span><span class="n">Linux</span><span class="o">::</span><span class="n">safe_cond_timedwait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">_cur_index</span><span class="p">],</span> <span class="n">_mutex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">absTime</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Â¶ÇÊûúÊåÇËµ∑Â§±Ë¥•ÂàôÈîÄÊØÅÂΩìÂâçÁöÑÊù°‰ª∂ÂèòÈáèÈáçÊñ∞ÂàùÂßãÂåñ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">WorkAroundNPTLTimedWaitHang</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pthread_cond_destroy</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">_cur_index</span><span class="p">])</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pthread_cond_init</span>    <span class="p">(</span><span class="o">&amp;</span><span class="n">_cond</span><span class="p">[</span><span class="n">_cur_index</span><span class="p">],</span> <span class="n">isAbsolute</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">os</span><span class="o">::</span><span class="n">Linux</span><span class="o">::</span><span class="n">condAttr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">//Â¶ÇÊûúpthread_cond_waitÊàêÂäüÂàô‰ª•‰∏ã‰ª£Á†ÅÈÉΩÊòØÁ∫øÁ®ãË¢´Âî§ÈÜíÂêéÊâßË°åÁöÑ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_cur_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert_status</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="n">EINTR</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span> <span class="o">==</span> <span class="n">ETIME</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="n">ETIMEDOUT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span><span class="p">,</span> <span class="s">&#34;cond_timedwait&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef ASSERT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="n">pthread_sigmask</span><span class="p">(</span><span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldsigs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="c1">//Â∞Ü_counterÂèòÈáèÈáçÊñ∞ÁΩÆ‰∏∫0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_counter</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Ëß£ÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="n">_mutex</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert_status</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ‰ΩøÁî®ÂÜÖÂ≠òÂ±èÈöú‰Ωø_counterÂØπÂÖ∂ÂÆÉÁ∫øÁ®ãÂèØËßÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="c1">// Â¶ÇÊûúÂú®parkÁ∫øÁ®ãÊåÇËµ∑ÁöÑÊó∂ÂÄôË∞ÉÁî®‰∫ÜstopÊàñËÄÖsuspendÂàôËøòÈúÄË¶ÅÂ∞ÜÁ∫øÁ®ãÊåÇËµ∑‰∏çËÉΩËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">jt</span><span class="o">-&gt;</span><span class="n">handle_special_suspend_equivalent_condition</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">jt</span><span class="o">-&gt;</span><span class="n">java_suspend_self</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÆûÈôÖ‰∏äParkerÁ±ªÁî®PosixÁöÑmutexÔºåconditionÊù•ÂÆûÁé∞ÁöÑÈòªÂ°ûÂî§ÈÜí„ÄÇÂèØ‰ª•ÁÆÄÂçïÁêÜËß£‰∏∫mutexÂ∞±ÊòØJavaÈáåÁöÑsynchronizedÔºåconditionÂ∞±ÊòØObjectÈáåÁöÑwait/notifyÊìç‰Ωú„ÄÇ</p>
<p>parkÊñπÊ≥ïÈáåË∞ÉÁî®pthread_mutex_trylockÊñπÊ≥ïÔºåÂ∞±Áõ∏ÂΩì‰∫éJavaÁ∫øÁ®ãËøõÂÖ•JavaÁöÑÂêåÊ≠•‰ª£Á†ÅÂùóÔºåÁÑ∂ÂêéÂÜçÊ¨°Âà§Êñ≠_counterÊòØÂê¶Â§ß‰∫éÈõ∂ÔºåÂ¶ÇÊûúÂ§ß‰∫éÈõ∂ÂàôÂ∞Ü_counterËÆæÁΩÆ‰∏∫Èõ∂„ÄÇÊúÄÂêéË∞ÉÁî®pthread_mutex_unlockËß£ÈîÅÔºåÁõ∏ÂΩì‰∫éJavaÊâßË°åÂÆåÈÄÄÂá∫ÂêåÊ≠•‰ª£Á†ÅÂùó„ÄÇÂ¶ÇÊûú_counter‰∏çÂ§ß‰∫éÈõ∂ÔºåÂàôÁªßÁª≠ÂæÄ‰∏ãÊâßË°åpthread_cond_waitÊñπÊ≥ïÔºåÂÆûÁé∞ÂΩìÂâçÁ∫øÁ®ãÁöÑÈòªÂ°û„ÄÇ</p>
<ul>
<li>ÂΩìË∞ÉÁî®parkÊó∂ÔºåÂÖàÂ∞ùËØïÁõ¥Êé•ÊòØÂê¶ËÉΩÊãøÂà∞_counter,Âç≥counter&gt;0ÔºåÂ¶ÇÊûúÊàêÂäüÂàôcounter=0,ËøîÂõû</li>
<li>Âê¶ÂàôÔºåÂÜçÂà§Êñ≠Á≠âÂæÖÊó∂Èó¥ÔºåÁÑ∂ÂêéÂÜçË∞ÉÁî®pthread_cond_waitÂáΩÊï∞Á≠âÂæÖÔºåÂ¶ÇÊûúÁ≠âÂæÖËøîÂõûÔºåÂàôÊääcounterËÆæÁΩÆ‰∏∫0Ôºåunlock mutexËøîÂõû</li>
</ul>
<blockquote>
<p><strong>ÊµÅÁ®ãÔºö</strong></p>
<p>1, AtomÂéüÂ≠êÂà§Êñ≠ _count&gt;0  (count=0ÂæÄ‰∏ã)</p>
<p>2, Âà§Êñ≠Êó∂Èó¥ÊòØÂê¶‰∏∫ÁªùÂØπÊó∂Èó¥Ôºå‰ª•ÂèäÊó∂Èó¥ÊòØÂê¶ÂêàÊ≥ï (ÂêàÊ≥ïÂæÄ‰∏ã)</p>
<p>3, Âà§Êñ≠Á∫øÁ®ã‰∏≠ÈÄîÊòØÂê¶Ë¢´ÊâìÊñ≠ÔºåË∞ÉÁî®pthread_mutex_trylockËøõÂÖ•ÂêåÊ≠•‰ª£Á†ÅÂùóÔºåÂπ∂Âä†ÈîÅÔºåÂà§Êñ≠ÊòØÂê¶count&gt;0 (Ê≤°Ë¢´ÊâìÊñ≠Ôºåcount=0 ÂæÄ‰∏ã)</p>
<p>4, Â¶ÇÊûúcount&gt;0 Â∞Ücount=0 ÂêåÊó∂Ë∞ÉÁî®pthread_cond_unlock Ëß£ÈîÅÔºåÈÄÄÂá∫ÂêåÊ≠•‰ª£Á†ÅÂùó (count=0 ÂæÄ‰∏ã)</p>
<p>5, Ë∞ÉÁî®pthread_cond_wait()ËÆæÁΩÆÁ∫øÁ®ãÁä∂ÊÄÅ‰∏∫Á≠âÂæÖÔºåÂ∞ÜÁ∫øÁ®ãÈòªÂ°ûËøõÂÖ•cond</p>
</blockquote>
<h5 id="threadblockinvm-tbivmjt">ThreadBlockInVM tbivm(jt)</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ThreadBlockInVM</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ThreadStateTransition</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">ThreadBlockInVM</span><span class="p">(</span><span class="n">JavaThread</span> <span class="o">*</span><span class="kr">thread</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">:</span> <span class="n">ThreadStateTransition</span><span class="p">(</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Once we are blocked vm expects stack to be walkable    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">frame_anchor</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">make_walkable</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//ÊääÁ∫øÁ®ãÁî±ËøêË°åÁä∂ÊÄÅËΩ¨ÊàêÈòªÂ°ûÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">trans_and_fence</span><span class="p">(</span><span class="n">_thread_in_vm</span><span class="p">,</span> <span class="n">_thread_blocked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="unpark">unpark</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Parker</span><span class="o">::</span><span class="n">unpark</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">s</span><span class="o">,</span> <span class="n">status</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Âä†‰∫íÊñ•ÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_lock</span><span class="o">(</span><span class="n">_mutex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">)</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">s</span> <span class="o">=</span> <span class="n">_counter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_counter</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span> <span class="c1">//Â∞Ü_counterÁΩÆ1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//Â¶ÇÊûú_counterÊòØ0ÂàôËØ¥ÊòéË∞ÉÁî®‰∫ÜparkÊàñËÄÖÊ≤°Ë∞ÉÁî®(ÂàùÂßã‰∏∫counter0Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//Ëøô‰πüËØ¥ÊòéparkÂíåunparkË∞ÉÁî®Ê≤°ÊúâÂÖàÂêéÈ°∫Â∫è„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËØ¥ÊòéÂΩìÂâçparkerÂØπÂ∫îÁöÑÁ∫øÁ®ãÊåÇËµ∑‰∫ÜÔºåÂõ†‰∏∫_cur_indexÂàùÂßãÊòØ-1ÔºåÂπ∂‰∏îÁ≠âÂæÖÊù°‰ª∂ÂèòÈáèÁöÑÁ∫øÁ®ãË¢´Âî§ÈÜí
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//Âêé‰πü‰ºöÂ∞Ü_cur_indexÈáçÁΩÆ-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">_cur_index</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//Â¶ÇÊûúËÆæÁΩÆ‰∫ÜWorkAroundNPTLTimedWaitHangÂÖàË∞ÉÁî®signalÂÜçË∞ÉÁî®unlockÔºåÂê¶ÂàôÁõ∏Âèç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//Ëøô‰∏§‰∏™ÂÖàÂêéÈ°∫Â∫èÈÉΩÂèØ‰ª•ÔºåÂú®hotspotÂú®Linux‰∏ãÈªòËÆ§‰ΩøÁî®ËøôÁßçÊñπÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//Âç≥ÂÖàË∞ÉÁî®signalÂÜçË∞ÉÁî®unlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">WorkAroundNPTLTimedWaitHang</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_cond_signal</span> <span class="o">(&amp;</span><span class="n">_cond</span><span class="o">[</span><span class="n">_cur_index</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_unlock</span><span class="o">(</span><span class="n">_mutex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_mutex_unlock</span><span class="o">(</span><span class="n">_mutex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_cond_signal</span> <span class="o">(&amp;</span><span class="n">_cond</span><span class="o">[</span><span class="n">_cur_index</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="c1">//Â¶ÇÊûú_cur_index == -1ËØ¥ÊòéÁ∫øÁ®ãÊ≤°Âú®Á≠âÂæÖÊù°‰ª∂ÂèòÈáèÔºåÂàôÁõ¥Êé•Ëß£ÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">pthread_mutex_unlock</span><span class="o">(</span><span class="n">_mutex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">)</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span><span class="c1">//Â¶ÇÊûú_counter == 1,ËØ¥ÊòéÁ∫øÁ®ãË∞ÉÁî®‰∫Ü‰∏ÄÊ¨°ÊàñÂ§öÊ¨°unpark‰ΩÜÊòØÊ≤°Ë∞ÉÁî®parkÔºåÂàôÁõ¥Êé•Ëß£ÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pthread_mutex_unlock</span><span class="o">(</span><span class="n">_mutex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">0</span><span class="o">,</span> <span class="s">&#34;invariant&#34;</span><span class="o">)</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>**unparkÂÆûÈôÖ‰∏äÂ∞±ÊòØÂ∞Ü_counterËÆæ‰∏∫1Ôºå**Â¶ÇÊûús&lt;1&amp;&amp;_cur_index!=-1(ÈªòËÆ§cur_index=1)ÂàôËÆ§‰∏∫Á∫øÁ®ãÊúâÈòªÂ°û ,‰æøÂ∞ÜÁ∫øÁ®ãÂî§ÈÜíÔºåsÔºû1ÂàôÁõ¥Êé•ÈÄÄÂá∫</p>
<h4 id="ÊµÅÁ®ãÂõæ">ÊµÅÁ®ãÂõæ</h4>
<h5 id="Ë∞ÉÁî®park">Ë∞ÉÁî®park()</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326232855163.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326232855163"
	
	
></p>
<ul>
<li>Ë∞ÉÁî®Unsafe.parkÊñπÊ≥ï</li>
<li>Âà§Êñ≠_counterÊòØÂê¶‰∏∫0</li>
<li>Â¶ÇÊûú_counter‰∏∫0ÂàôÂ∞ÜÁ∫øÁ®ãÊîæÂÖ• _cond‰∏≠ÈòªÂ°û</li>
<li>Âπ∂‰∏îÂÜçÊ¨°ËÆæÁΩÆ_counter=0</li>
</ul>
<h5 id="Ë∞ÉÁî®unpark">Ë∞ÉÁî®unpark</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326233050805.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326233050805"
	
	
></p>
<ul>
<li>Ë∞ÉÁî®Unsafe.unparkÊñπÊ≥ï</li>
<li>Â∞Ü _counterËÆæÁΩÆ‰∏∫1</li>
<li>Êü•Áúãcond‰∏≠ Á∫øÁ®ãÊòØÂê¶Ë¢´ÈòªÂ°û</li>
<li>Â¶ÇÊûúË¢´ÈòªÂ°ûÂàôÂî§ÈÜíËøêË°å Âπ∂‰∏îÂ∞Ü_counterËÆæ‰∏∫0</li>
</ul>
<h5 id="ÂÖàË∞ÉÁî®unparkÂÜçË∞ÉÁî®park">ÂÖàË∞ÉÁî®unparkÂÜçË∞ÉÁî®park</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326233538199.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326233538199"
	
	
></p>
<ul>
<li>Â∞ÜÁ∫øÁ®ãÁöÑcounterËÆæÁΩÆ‰∏∫1</li>
<li>parkÊü•ÁúãÁ∫øÁ®ãÁöÑcounterÊòØÂê¶‰∏∫1</li>
<li>Â¶ÇÊûú‰∏∫1ÂàôËÆæÁΩÆ‰∏∫0</li>
<li>Thread-0ÁªßÁª≠ËøêË°å</li>
</ul>
<h3 id="312-ÂÆàÊä§Á∫øÁ®ã">3.12 ÂÆàÊä§Á∫øÁ®ã</h3>
<h6 id="ÂÆàÊä§Êüê‰∏Ä‰∏™Á∫øÁ®ãÂΩìË¢´ÂÆàÊä§ÁöÑÁ∫øÁ®ãÁªìÊùüÂêéÂÆàÊä§Á∫øÁ®ãÊó†Êù°‰ª∂ÁªàÊ≠¢‰∏ç‰ºöÁ≠âÂæÖÂÖ∂Â§ÑÁêÜÂÆå">ÂÆàÊä§Êüê‰∏Ä‰∏™Á∫øÁ®ãÔºåÂΩìË¢´ÂÆàÊä§ÁöÑÁ∫øÁ®ãÁªìÊùüÂêéÔºåÂÆàÊä§Á∫øÁ®ãÊó†Êù°‰ª∂ÁªàÊ≠¢Ôºå‰∏ç‰ºöÁ≠âÂæÖÂÖ∂Â§ÑÁêÜÂÆå„ÄÇ</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(!</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;end!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">     <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">     <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;main end!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316134148187.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316134148187"
	
	
></p>
<blockquote>
<p><strong>Ê≥®ÊÑèÔºö</strong></p>
<ul>
<li>ÂûÉÂúæÂõûÊî∂Âô®Á∫øÁ®ãÂ∞±ÊòØ‰∏ÄÁßçÂÆàÊä§Á∫øÁ®ã</li>
<li>Tomcat‰∏≠ÁöÑAcceptorÂíåPollerÁ∫øÁ®ãÈÉΩÊòØÂÆàÊä§Á∫øÁ®ã</li>
</ul>
</blockquote>
<h4 id="ÂÆàÊä§Á∫øÁ®ãÂíåÁî®Êà∑Á∫øÁ®ãÊúâ‰ªÄ‰πàÂå∫Âà´Âë¢">ÂÆàÊä§Á∫øÁ®ãÂíåÁî®Êà∑Á∫øÁ®ãÊúâ‰ªÄ‰πàÂå∫Âà´Âë¢Ôºü</h4>
<ul>
<li>
<p>**Áî®Êà∑ (User) Á∫øÁ®ãÔºö**ËøêË°åÂú®ÂâçÂè∞ÔºåÊâßË°åÂÖ∑‰ΩìÁöÑ‰ªªÂä°ÔºåÂ¶ÇÁ®ãÂ∫èÁöÑ‰∏ªÁ∫øÁ®ã„ÄÅËøûÊé•ÁΩëÁªúÁöÑÂ≠êÁ∫øÁ®ãÁ≠âÈÉΩÊòØÁî®Êà∑Á∫øÁ®ã</p>
</li>
<li>
<p>**ÂÆàÊä§ (Daemon) Á∫øÁ®ãÔºö**ËøêË°åÂú®ÂêéÂè∞Ôºå‰∏∫ÂÖ∂‰ªñÂâçÂè∞Á∫øÁ®ãÊúçÂä°„ÄÇ‰πüÂèØ‰ª•ËØ¥ÂÆàÊä§Á∫øÁ®ãÊòØ JVM ‰∏≠ÈùûÂÆàÊä§Á∫øÁ®ãÁöÑ ‚Äú‰Ω£‰∫∫‚Äù„ÄÇ‰∏ÄÊó¶ÊâÄÊúâÁî®Êà∑Á∫øÁ®ãÈÉΩÁªìÊùüËøêË°åÔºåÂÆàÊä§Á∫øÁ®ã‰ºöÈöè JVM ‰∏ÄËµ∑ÁªìÊùüÂ∑•‰Ωú</p>
</li>
</ul>
<p>main ÂáΩÊï∞ÊâÄÂú®ÁöÑÁ∫øÁ®ãÂ∞±ÊòØ‰∏Ä‰∏™Áî®Êà∑Á∫øÁ®ãÂïäÔºåmain ÂáΩÊï∞ÂêØÂä®ÁöÑÂêåÊó∂Âú® JVM ÂÜÖÈÉ®ÂêåÊó∂ËøòÂêØÂä®‰∫ÜÂ•ΩÂ§öÂÆàÊä§Á∫øÁ®ãÔºåÊØîÂ¶ÇÂûÉÂúæÂõûÊî∂Á∫øÁ®ã„ÄÇ</p>
<p>ÊØîËæÉÊòéÊòæÁöÑÂå∫Âà´‰πã‰∏ÄÊòØÁî®Êà∑Á∫øÁ®ãÁªìÊùüÔºåJVM ÈÄÄÂá∫Ôºå‰∏çÁÆ°Ëøô‰∏™Êó∂ÂÄôÊúâÊ≤°ÊúâÂÆàÊä§Á∫øÁ®ãËøêË°å„ÄÇËÄåÂÆàÊä§Á∫øÁ®ã‰∏ç‰ºöÂΩ±Âìç JVM ÁöÑÈÄÄÂá∫„ÄÇ</p>
<h3 id="313-Á∫øÁ®ãÁä∂ÊÄÅ">3.13 Á∫øÁ®ãÁä∂ÊÄÅ</h3>
<h4 id="‰∫îÁßçÁä∂ÊÄÅ">‰∫îÁßçÁä∂ÊÄÅ</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316135550576.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316135550576"
	
	
></p>
<p><strong>ÂàùÂßãÊÄÅÔºåÂ∞±Áª™ÊÄÅÔºåËøêË°åÊÄÅÔºåÈòªÂ°ûÔºåÁªàÊ≠¢</strong></p>
<ul>
<li>„ÄêÂàùÂßãÁä∂ÊÄÅ„Äë‰ªÖÂú®ËØ≠Ë®ÄÂ±ÇÈù¢‰∏äÂàõÂª∫‰∫ÜÂØπË±°ÔºåËøòÊ≤°ÂíåÊìç‰ΩúÁ≥ªÁªüÁ∫øÁ®ãÂÖ≥ËÅî</li>
<li>„ÄêÂ∞±Áª™Áä∂ÊÄÅ„ÄëÁ∫øÁ®ãÂ∑≤ÁªèË¢´ÂàõÂª∫ÔºåÂèØ‰ª•Áî±CPUË∞ÉÂ∫¶ÊâßË°å</li>
<li>„ÄêËøêË°åÁä∂ÊÄÅ„ÄëËé∑Âèñ‰∫ÜCPUÊó∂Èó¥ÁâáËøêË°å‰∏≠ÁöÑÁä∂ÊÄÅ
<ul>
<li>ÂΩìÊó∂Èó¥ÁâáÁî®ÂÆåÂ∞±‰ºö‰ªé„ÄêËøêË°åÁä∂ÊÄÅ„ÄëËΩ¨Êç¢‰∏∫„ÄêÂèØËøêË°åÁä∂ÊÄÅ„ÄëÔºåÂØºËá¥Á∫øÁ®ã‰∏ä‰∏ãÊñáÂàáÊç¢</li>
</ul>
</li>
<li>„ÄêÈòªÂ°ûÁä∂ÊÄÅ„Äë</li>
</ul>
<h4 id="ÂÖ≠ÁßçÁä∂ÊÄÅ">ÂÖ≠ÁßçÁä∂ÊÄÅ</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316190519924.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316190519924"
	
	
></p>
<p>**Ê≥®Ôºö**RUNNABLEÊ∂µÁõñ‰∫ÜÊìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑ„ÄêËøêË°åÁä∂ÊÄÅÔºåÈòªÂ°ûÁä∂ÊÄÅÔºåÂèØËøêË°åÁä∂ÊÄÅ„Äë</p>
<p>Êìç‰ΩúÁ≥ªÁªüÁöÑÈòªÂ°ûÁä∂ÊÄÅÔºå‰æãÂ¶ÇÔºöÊìç‰ΩúÁ≥ªÁªüÁ∫øÁ®ãÊâßË°åBIOÔºåÊ≠§Êó∂ÁöÑÊìç‰ΩúÁ≥ªÁªüÁöÑÁ∫øÁ®ãÁä∂ÊÄÅÊòØÈòªÂ°ûÁöÑÔºå‰ΩÜÊòØÂú®Java‰∏≠ËøòÊòØ‰øùÊåÅËøêË°åÁöÑ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;t1 running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t0&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// NEW
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;t1 running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//TERMINATED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;t2 running&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//RUNNABLE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">ThreadState</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//TIME_WAITING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">ThreadState</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">10000000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">t4</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//BLOCKED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">t5</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">       <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">},</span><span class="s">&#34;t5&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">t5</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//WAITING
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">State</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a thread which has not yet started.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">NEW</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a runnable thread.  A thread in the runnable
</span></span></span><span class="line"><span class="cl"><span class="cm">     * state is executing in the Java virtual machine but it may
</span></span></span><span class="line"><span class="cl"><span class="cm">     * be waiting for other resources from the operating system
</span></span></span><span class="line"><span class="cl"><span class="cm">     * such as processor.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">RUNNABLE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a thread blocked waiting for a monitor lock.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A thread in the blocked state is waiting for a monitor lock
</span></span></span><span class="line"><span class="cl"><span class="cm">     * to enter a synchronized block/method or
</span></span></span><span class="line"><span class="cl"><span class="cm">     * reenter a synchronized block/method after calling
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Object#wait() Object.wait}.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLOCKED</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a waiting thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A thread is in the waiting state due to calling one of the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * following methods:
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link Object#wait() Object.wait} with no timeout&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link #join() Thread.join} with no timeout&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link LockSupport#park() LockSupport.park}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;/ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;p&gt;A thread in the waiting state is waiting for another thread to
</span></span></span><span class="line"><span class="cl"><span class="cm">     * perform a particular action.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * For example, a thread that has called &lt;tt&gt;Object.wait()&lt;/tt&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * on an object is waiting for another thread to call
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;tt&gt;Object.notify()&lt;/tt&gt; or &lt;tt&gt;Object.notifyAll()&lt;/tt&gt; on
</span></span></span><span class="line"><span class="cl"><span class="cm">     * that object. A thread that has called &lt;tt&gt;Thread.join()&lt;/tt&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * is waiting for a specified thread to terminate.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">WAITING</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a waiting thread with a specified waiting time.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * A thread is in the timed waiting state due to calling one of
</span></span></span><span class="line"><span class="cl"><span class="cm">     * the following methods with a specified positive waiting time:
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link #sleep Thread.sleep}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link Object#wait(long) Object.wait} with timeout&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link #join(long) Thread.join} with timeout&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link LockSupport#parkNanos LockSupport.parkNanos}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     *   &lt;li&gt;{@link LockSupport#parkUntil LockSupport.parkUntil}&lt;/li&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     * &lt;/ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TIMED_WAITING</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Thread state for a terminated thread.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The thread has completed execution.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TERMINATED</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Áî±javaÊ∫êÁ†ÅÂèØ‰ª•ÂèëÁé∞ÔºåJava API‰∏≠ÂØπÁ∫øÁ®ãÁä∂ÊÄÅÁöÑÊèèËø∞Êúâ6Áßç</p>
<h5 id="javaËÆ°ÁÆóÁ∫øÁ®ãÁä∂ÊÄÅ">JavaËÆ°ÁÆóÁ∫øÁ®ãÁä∂ÊÄÅ</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">State</span> <span class="nf">toThreadState</span><span class="o">(</span><span class="kt">int</span> <span class="n">var0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">4</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="na">RUNNABLE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">1024</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="na">BLOCKED</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">16</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="na">WAITING</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">32</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="na">TIMED_WAITING</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">2</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">State</span><span class="o">.</span><span class="na">TERMINATED</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">var0</span> <span class="o">&amp;</span> <span class="n">1</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span> <span class="o">?</span> <span class="n">State</span><span class="o">.</span><span class="na">NEW</span> <span class="o">:</span> <span class="n">State</span><span class="o">.</span><span class="na">RUNNABLE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>JavaThreadÁöÑÁä∂ÊÄÅÂØπÂ∫îJvmÁöÑÁä∂ÊÄÅ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// Java Thread Status for JVMTI and M&amp;M use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// This thread status info is saved in threadStatus field of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// java.lang.Thread java class.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">enum</span> <span class="n">ThreadStatus</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NEW</span>                      <span class="o">=</span> <span class="n">0</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">RUNNABLE</span>                 <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// runnable / running
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_RUNNABLE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">SLEEPING</span>                 <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// Thread.sleep()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_WAITING</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_SLEEPING</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN_OBJECT_WAIT</span>           <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// Object.wait()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_WAITING</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_WAITING_INDEFINITELY</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_IN_OBJECT_WAIT</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN_OBJECT_WAIT_TIMED</span>     <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// Object.wait(long)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_WAITING</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_IN_OBJECT_WAIT</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">PARKED</span>                   <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// LockSupport.park()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_WAITING</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_WAITING_INDEFINITELY</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_PARKED</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">PARKED_TIMED</span>             <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// LockSupport.park(long)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_WAITING</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                               <span class="n">JVMTI_THREAD_STATE_PARKED</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLOCKED_ON_MONITOR_ENTER</span> <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_ALIVE</span> <span class="o">+</span>          <span class="c1">// (re-)entering a synchronization block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                               <span class="n">JVMTI_THREAD_STATE_BLOCKED_ON_MONITOR_ENTER</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">TERMINATED</span>               <span class="o">=</span> <span class="n">JVMTI_THREAD_STATE_TERMINATED</span>
</span></span><span class="line"><span class="cl">  <span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:left">Thread State Flags</th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Constant</td>
<td style="text-align:left">Value</td>
<td style="text-align:left">Description</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_ALIVE</code></td>
<td style="text-align:left">0x0001</td>
<td style="text-align:left">Thread is alive. Zero if thread is new (not started) or terminated.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_TERMINATED</code></td>
<td style="text-align:left">0x0002</td>
<td style="text-align:left">Thread has completed execution.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_RUNNABLE</code></td>
<td style="text-align:left">0x0004</td>
<td style="text-align:left">Thread is runnable.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_BLOCKED_ON_MONITOR_ENTER</code></td>
<td style="text-align:left">0x0400</td>
<td style="text-align:left">Thread is waiting to enter a synchronization block/method or, after an <code>Object.wait()</code>, waiting to re-enter a             synchronization block/method.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_WAITING</code></td>
<td style="text-align:left">0x0080</td>
<td style="text-align:left">Thread is waiting.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_WAITING_INDEFINITELY</code></td>
<td style="text-align:left">0x0010</td>
<td style="text-align:left">Thread is waiting without a timeout.   For example, <code>Object.wait()</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT</code></td>
<td style="text-align:left">0x0020</td>
<td style="text-align:left">Thread is waiting with a maximum time to wait specified.             For example, <code>Object.wait(long)</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_SLEEPING</code></td>
<td style="text-align:left">0x0040</td>
<td style="text-align:left">Thread is sleeping &ndash; <code>Thread.sleep(long)</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_IN_OBJECT_WAIT</code></td>
<td style="text-align:left">0x0100</td>
<td style="text-align:left">Thread is waiting on an object monitor &ndash; <code>Object.wait</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_PARKED</code></td>
<td style="text-align:left">0x0200</td>
<td style="text-align:left">Thread is parked, for example: <code>LockSupport.park</code>,             <code>LockSupport.parkUtil</code> and <code>LockSupport.parkNanos</code>.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_SUSPENDED</code></td>
<td style="text-align:left">0x100000</td>
<td style="text-align:left">Thread suspended.        <code>java.lang.Thread.suspend()</code>        or a JVM TI suspend function             (such as <a class="link" href="file:///home/alanjin/gitspace/jdk10/hotspot/src/share/vm/prims/jvmti.xml#SuspendThread" ><code>SuspendThread</code></a>)             has been called on the thread. If this bit         is set, the other bits refer to the thread state before suspension.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_INTERRUPTED</code></td>
<td style="text-align:left">0x200000</td>
<td style="text-align:left">Thread has been interrupted.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_IN_NATIVE</code></td>
<td style="text-align:left">0x400000</td>
<td style="text-align:left">Thread is in native code&ndash;that is, a native method is running             which has not called back into the VM or Java programming             language code.                          This flag is not set when running VM compiled Java programming             language code nor is it set when running VM code or   VM support code. Native VM interface functions, such as JNI and             JVM TI functions, may be implemented as VM code.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_VENDOR_1</code></td>
<td style="text-align:left">0x10000000</td>
<td style="text-align:left">Defined by VM vendor.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_VENDOR_2</code></td>
<td style="text-align:left">0x20000000</td>
<td style="text-align:left">Defined by VM vendor.</td>
</tr>
<tr>
<td style="text-align:left"><code>JVMTI_THREAD_STATE_VENDOR_3</code></td>
<td style="text-align:left">0x40000000</td>
<td style="text-align:left">Defined by VM vendor.</td>
</tr>
</tbody>
</table></div>
<p><strong>‰ªéc++Â±ÇÈù¢Áúãc++Á∫øÁ®ãÁöÑÁä∂ÊÄÅ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">enum</span> <span class="n">JavaThreadState</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_thread_uninitialized</span>     <span class="o">=</span>  <span class="n">0</span><span class="o">,</span> <span class="c1">// should never happen (missing initialization)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_new</span>               <span class="o">=</span>  <span class="n">2</span><span class="o">,</span> <span class="c1">// just starting up, i.e., in process of being initialized
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_new_trans</span>         <span class="o">=</span>  <span class="n">3</span><span class="o">,</span> <span class="c1">// corresponding transition state (not used, included for completness)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_native</span>         <span class="o">=</span>  <span class="n">4</span><span class="o">,</span> <span class="c1">// running in native code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_native_trans</span>   <span class="o">=</span>  <span class="n">5</span><span class="o">,</span> <span class="c1">// corresponding transition state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_vm</span>             <span class="o">=</span>  <span class="n">6</span><span class="o">,</span> <span class="c1">// running in VM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_vm_trans</span>       <span class="o">=</span>  <span class="n">7</span><span class="o">,</span> <span class="c1">// corresponding transition state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_Java</span>           <span class="o">=</span>  <span class="n">8</span><span class="o">,</span> <span class="c1">// running in Java or in stub code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_in_Java_trans</span>     <span class="o">=</span>  <span class="n">9</span><span class="o">,</span> <span class="c1">// corresponding transition state (not used, included for completness)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_blocked</span>           <span class="o">=</span> <span class="n">10</span><span class="o">,</span> <span class="c1">// blocked in vm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_blocked_trans</span>     <span class="o">=</span> <span class="n">11</span><span class="o">,</span> <span class="c1">// corresponding transition state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_thread_max_state</span>         <span class="o">=</span> <span class="n">12</span>  <span class="c1">// maximum thread state+1 - used for statistics allocation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>_thread_new:</strong> Êñ∞ÂàõÂª∫ÁöÑÁ∫øÁ®ã</p>
<p><strong>_thread_in_Java:</strong> Âú®ËøêË°åJava‰ª£Á†Å</p>
<p><strong>_thread_in_vm:</strong> Âú®ËøêË°åJVMÊú¨Ë∫´ÁöÑ‰ª£Á†Å</p>
<p><strong>_thread_in_native:</strong> Âú®ËøêË°ånative‰ª£Á†Å</p>
<p><strong>_thread_blocked:</strong> Á∫øÁ®ãË¢´ÈòªÂ°û‰∫ÜÔºåÂåÖÊã¨Á≠âÂæÖ‰∏Ä‰∏™ÈîÅÔºåÁ≠âÂæÖ‰∏Ä‰∏™Êù°‰ª∂ÔºåsleepÔºåÊâßË°å‰∏Ä‰∏™ÈòªÂ°ûÁöÑIOÁ≠â</p>
<h4 id="javaÈááÁî®ÁöÑÁ∫øÁ®ãË∞ÉÂ∫¶ÁÆóÊ≥ï">JavaÈááÁî®ÁöÑÁ∫øÁ®ãË∞ÉÂ∫¶ÁÆóÊ≥ï</h4>
<p>**‰∏§ÁßçË∞ÉÂ∫¶Ê®°ÂûãÔºö**ÂàÜÊó∂Ë∞ÉÂ∫¶Ê®°ÂûãÂíåÊä¢Âç†ÂºèË∞ÉÂ∫¶Ê®°Âûã</p>
<p><strong>javaÈááÁî®ÁöÑÊòØÊä¢Âç†ÂºèË∞ÉÂ∫¶Ê®°ÂûãÔºåÂç≥‰ºòÂÖàÁ∫ßË∂äÈ´òÁöÑÁ∫øÁ®ãÂç†Áî®CPU</strong></p>
<h4 id="‰ªÄ‰πàÊòØÁ∫øÁ®ãË∞ÉÂ∫¶Âô®thread-schedulerÂíåÊó∂Èó¥ÂàÜÁâátime-slicing-">‰ªÄ‰πàÊòØÁ∫øÁ®ãË∞ÉÂ∫¶Âô®(Thread Scheduler)ÂíåÊó∂Èó¥ÂàÜÁâá(Time Slicing )Ôºü</h4>
<p>Á∫øÁ®ãË∞ÉÂ∫¶Âô®ÊòØ‰∏Ä‰∏™Êìç‰ΩúÁ≥ªÁªüÊúçÂä°ÔºåÂÆÉË¥üË¥£‰∏∫ Runnable Áä∂ÊÄÅÁöÑÁ∫øÁ®ãÂàÜÈÖç CPU Êó∂Èó¥„ÄÇ‰∏ÄÊó¶Êàë‰ª¨ÂàõÂª∫‰∏Ä‰∏™Á∫øÁ®ãÂπ∂ÂêØÂä®ÂÆÉÔºåÂÆÉÁöÑÊâßË°å‰æø‰æùËµñ‰∫éÁ∫øÁ®ãË∞ÉÂ∫¶Âô®ÁöÑÂÆûÁé∞„ÄÇ</p>
<p>Êó∂Èó¥ÂàÜÁâáÊòØÊåáÂ∞ÜÂèØÁî®ÁöÑ CPU Êó∂Èó¥ÂàÜÈÖçÁªôÂèØÁî®ÁöÑ Runnable Á∫øÁ®ãÁöÑËøáÁ®ã„ÄÇÂàÜÈÖç CPU Êó∂Èó¥ÂèØ‰ª•Âü∫‰∫éÁ∫øÁ®ã‰ºòÂÖàÁ∫ßÊàñËÄÖÁ∫øÁ®ãÁ≠âÂæÖÁöÑÊó∂Èó¥„ÄÇ</p>
<p>Á∫øÁ®ãË∞ÉÂ∫¶Âπ∂‰∏çÂèóÂà∞ Java ËôöÊãüÊú∫ÊéßÂà∂ÔºåÊâÄ‰ª•Áî±Â∫îÁî®Á®ãÂ∫èÊù•ÊéßÂà∂ÂÆÉÊòØÊõ¥Â•ΩÁöÑÈÄâÊã©Ôºà‰πüÂ∞±ÊòØËØ¥‰∏çË¶ÅËÆ©‰Ω†ÁöÑÁ®ãÂ∫è‰æùËµñ‰∫éÁ∫øÁ®ãÁöÑ‰ºòÂÖàÁ∫ßÔºâ„ÄÇ</p>
<h2 id="4-ÂÖ±‰∫´Ê®°Âûã‰πãÁÆ°Á®ã">4 ÂÖ±‰∫´Ê®°Âûã‰πãÁÆ°Á®ã</h2>
<h3 id="41-‰∏ä‰∏ãÊñáÂàáÊç¢ÈóÆÈ¢ò">4.1 ‰∏ä‰∏ãÊñáÂàáÊç¢ÈóÆÈ¢ò</h3>
<p>ÂΩìËÆ©‰∏§‰∏™Á∫øÁ®ãÂàÜÂà´ÂØπ static int a = 0 ÂÅö a++,a&ndash;;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">contextSwitch</span><span class="o">()</span><span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t0&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t0</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÈÇ£ÈÅìÁêÜÊúÄÂêéÁöÑÁªìÊûúaÂ∫îËØ•‰∏∫0‰ΩÜÊòØ Âç¥Âá∫Áé∞‰∫ÜËøôÁßçÊÉÖÂÜµ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316231530549.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316231530549"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220316230546613.png"
	
	
	
	loading="lazy"
	
		alt="image-20220316230546613"
	
	
></p>
<p>Âú®Á∫øÁ®ã1ËøòÊ≤°ÊâßË°åistroe_1Êó∂Ë¢´Á∫øÁ®ã2Êä¢Âç†ÔºåÁî±‰∫éi++ÊòØÂÖàÊîπÂèòÂèòÈáèË°®‰∏≠ÁöÑÂÄºÔºåÂú®ËøîÂõûÊìç‰ΩúÊï∞Ê†àÁöÑÂéüÊú¨ÂÄºÔºåËøô‰∏™Êó∂ÂÄôËøòÊ≤°ËøîÂõûÂÄºÁ∫øÁ®ã2ÂèñËµ∞‰∫ÜÂéüÊú¨ÂèòÈáèË°®‰∏≠ÁöÑÂÄºÁÑ∂ÂêéËøõË°åÊìç‰ΩúÂ∞±‰ºöÂØºËá¥ÂéüÊú¨‰∏∫0ÁöÑÂÄºÊîπÂèò„ÄÇ</p>
<h3 id="42-‰∏¥ÁïåÂå∫critical-section">4.2 ‰∏¥ÁïåÂå∫Critical Section</h3>
<ul>
<li>
<p>‰∏Ä‰∏™Á®ãÂ∫èËøêË°åÂ§ö‰∏™Á∫øÁ®ãÊú¨Ë∫´ÊòØÊ≤°ÊúâÈóÆÈ¢òÁöÑ</p>
</li>
<li>
<p>ÈóÆÈ¢òÂá∫Áé∞Âú®Á∫øÁ®ãËÆøÈóÆÁöÑ<strong>ÂÖ±‰∫´ËµÑÊ∫ê</strong></p>
<p>Â§ö‰∏™Á∫øÁ®ãÂØπÂÖ±‰∫´ËµÑÊ∫êÁöÑËØªÂÜôÊìç‰ΩúÂèëÁîüÊåá‰ª§‰∫§ÈîôÔºåÂ∞±‰ºöÂá∫Áé∞ÈóÆÈ¢ò</p>
</li>
<li>
<p>‰∏ÄÊÆµ‰ª£Á†ÅÂùóÂÜÖÂ¶ÇÊûúÂ≠òÂú®ÂØπ<strong>ÂÖ±‰∫´ËµÑÊ∫ê</strong>ÁöÑÂ§öÁ∫øÁ®ãËØªÂÜôÊìç‰ΩúÔºåÁß∞ËøôÊÆµ‰ª£Á†ÅÂùó‰∏∫<strong>‰∏¥ÁïåÂå∫</strong></p>
</li>
</ul>
<h4 id="Á´ûÊÄÅÊù°‰ª∂">Á´ûÊÄÅÊù°‰ª∂</h4>
<p>Â§ö‰∏™Á∫øÁ®ãÂú®‰∏¥ÁïåÂå∫ÂÜÖÊâßË°åÔºåÁî±‰∫é‰ª£Á†ÅÁöÑ<strong>ÊâßË°åÂ∫èÂàó‰∏çÂêå</strong>ËÄåÂØºËá¥ÁªìÊûúÊó†Ê≥ïÈ¢ÑÊµãÔºåÂ∞±Âè´ÂÅöÁ´ûÊÄÅÊù°‰ª∂</p>
<h3 id="43-synchronized-Ëß£ÂÜ≥ÊñπÊ°à">4.3 synchronized Ëß£ÂÜ≥ÊñπÊ°à</h3>
<p>‰∏∫‰∫ÜÈÅøÂÖç‰∏¥ÁïåÂå∫ÁöÑÁ´ûÊÄÅÊù°‰ª∂ÂèëÁîüÔºåÊúâÂ§öÁßçÊâãÊÆµÂèØ‰ª•ËææÂà∞ÁõÆÁöÑ„ÄÇ</p>
<ul>
<li>ÈòªÂ°ûÂºèÁöÑËß£ÂÜ≥ÊñπÊ°àÔºösynchronizedÔºåLock</li>
<li>ÈùûÈòªÂ°ûÂºèÁöÑËß£ÂÜ≥ÊñπÊ°àÔºöÂéüÂ≠êÂèòÈáè</li>
</ul>
<p>synchronized‰øóÁß∞„ÄêÂØπË±°ÈîÅ„ÄëÔºåÂÆÉÈááÁî®‰∫íÊñ•ÁöÑÊñπÂºèËÆ©Âêå‰∏ÄÊó∂ÂàªËá≥Â§öÂè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãËÉΩÊåÅÊúâ„ÄêÂØπË±°ÈîÅ„ÄëÔºåÂÖ∂‰ªñÁ∫øÁ®ãÊÉ≥Ëé∑ÂèñËØ•ÂØπË±°Êó∂‰ºöË¢´ÈòªÂ°û‰Ωè„ÄÇËøôÊ†∑Â∞±ÂèØ‰ª•‰∏çÁî®ÊãÖÂøÉ‰∏ä‰∏ãÊñáÂàáÊç¢ÔºåÂÆâÂÖ®ÁöÑÊâßË°å‰∏¥ÁïåÂå∫‰∏≠ÁöÑËµÑÊ∫ê„ÄÇy</p>
<p>synchronized‰ª£Á†ÅÊ†ºÂºè</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">synchronized</span> <span class="o">(</span><span class="c1">//ÈîÅÂØπË±°) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//‰ª£Á†ÅÂùó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Á§∫‰æãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">synchronization</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span><span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">1000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">1000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t2</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t1</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËæìÂá∫Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">RUNNABLE
</span></span><span class="line"><span class="cl">RUNNABLE
</span></span><span class="line"><span class="cl">0Êàñ1
</span></span></code></pre></td></tr></table>
</div>
</div><p>„ÄêÊ≥®„ÄëÔºöËøô<strong>ÈáåÁªìÊûú‰∏∫‰ªÄ‰πà‰ºöÊúâ1Âë¢ÔºåÂõ†‰∏∫Ëé∑Âèñ1ÁöÑÊó∂ÂÄôÊ≤°ÊúâÂä†ÈîÅ</strong>Ôºå<strong>Á∫øÁ®ãËé∑ÂèñÂØπË±°ÈîÅÂπ∂‰∏çÊòØËÉΩ‰∏ÄÁõ¥ÊâßË°å‰∏ãÂéªÔºåÂΩìÁ∫øÁ®ãÁöÑÊó∂Èó¥Áâá‰ΩøÁî®ÂÆåÊó∂Ôºå‰ªñËøòÊòØ‰ºöË¢´Ë∏¢Âá∫CPUÊàøÈó¥</strong>Ôºå‰ΩÜÊòØÊâã‰∏≠‰∏ÄÁõ¥ÊãøÁùÄÊàøÈó¥Èí•ÂåôÔºåÊ≤°ÊúâÈí•ÂåôÁöÑ‰∫∫ÊòØÊó†Ê≥ïËøõÂÖ•ËøêË°å‰∏îÊó†Ê≥ïË¢´ ÔºåÂΩì‰∏ãÊ¨°ËΩÆÂà∞ËØ•Á∫øÁ®ãÊó∂ÔºåÂç≥ÂèØËøõÂÖ•Á∫øÁ®ãÁªßÁª≠Â∑•‰ΩúÔºåÂè™ÊúâÂΩì‰ª£Á†ÅÂùóÊâßË°åÂÆåÊó∂ÔºåÊâç‰ºöÊääÈîÅËÆ©Âá∫ÔºåÂî§ÈÜíÈòªÂ°ûÁ∫øÁ®ã„ÄÇ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220319174358728.png"
	
	
	
	loading="lazy"
	
		alt="image-20220319174358728"
	
	
></p>
<p>synchronized ÂÆûÈôÖÊòØÁî®<strong>ÂØπË±°ÈîÅ</strong>‰øùËØÅ‰∫Ü<strong>‰∏¥ÁïåÂå∫ÂÜÖ‰ª£Á†ÅÁöÑÂéüÂ≠êÊÄß</strong>Ôºå‰∏¥ÁïåÂå∫ÁöÑ‰ª£Á†ÅÊòØÂØπÂ§ñ‰∏çÂèØÂàÜÁöÑÔºå‰∏ç‰ºöË¢´Á∫øÁ®ãÂàáÊç¢ÊâÄÊâìÊñ≠„ÄÇ</p>
<p>**ÊÄùËÄÉ **</p>
<ul>
<li><strong>Â¶ÇÊûúÊääsynchronized(obj)ÊîæÂú®forÂæ™ÁéØÂ§ñÔºå‰ºöÊÄé‰πàÊ†∑Ôºü</strong></li>
</ul>
<blockquote>
<p>‚Äã         ËøòÊòØÂ§Ñ‰∫éÂä†ÈîÅÁä∂ÊÄÅÔºå‰∏ç‰ºöÂá∫Áé∞‰∏ä‰∏ãÊñáÂàáÊç¢ÈóÆÈ¢ò</p>
</blockquote>
<ul>
<li><strong>Â¶ÇÊûút1 synchronized(obj1) ËÄå t2 synchronized(obj2) ‰ºöÊÄé‰πàÊ†∑Ôºü</strong></li>
</ul>
<blockquote>
<p>Áî±‰∫ét1Âíåt2Ëé∑ÂèñÁöÑÊòØ‰∏çÂêåÁöÑÈîÅÔºåÊòØÁªô‰∏çÂêåÁöÑÂØπË±°Âä†ÈîÅÔºåÊâÄ‰ª•‰ºöÂá∫Áé∞‰∏ä‰∏ãÊñáÂàáÊç¢ÈóÆÈ¢ò</p>
</blockquote>
<ul>
<li><strong>Â¶ÇÊûút1 synchronized(obj) ËÄå t2Ê≤°ÊúâÂä†ÈîÅ‰ºöÊÄé‰πàÊ†∑Ôºü</strong></li>
</ul>
<blockquote>
<p>Áî±‰∫ét2Ê≤°ÊúâËé∑ÂèñÂØπË±°ÈîÅÔºåÊâÄ‰ª•‰∏ç‰ºöË¢´ÈòªÂ°ûÔºåËøòÊòØ‰ºöËøõÂÖ•CPUËøêË°åÔºå‰ºöÂá∫Áé∞‰∏ä‰∏ãÊñáÂàáÊç¢ÈóÆÈ¢ò</p>
</blockquote>
<h5 id="synchronized-‰ΩøÁî®Âú®ÊñπÊ≥ï‰∏ä">synchronized ‰ΩøÁî®Âú®ÊñπÊ≥ï‰∏ä</h5>
<p>Áî®Âú®static‰∏äÈù¢ÊòØÈîÅ‰ΩèÂΩìÂâçclassÁöÑÂ≠óËäÇÁ†ÅÊñá‰ª∂</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//Á≠â‰ª∑‰∫é
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span><span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//Á≠â‰ª∑‰∫é
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span><span class="o">(</span><span class="n">Test</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="44-ÂèòÈáèÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÂàÜÊûê">4.4 ÂèòÈáèÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÂàÜÊûê</h3>
<p><strong>ÊàêÂëòÂèòÈáèÂíåÈùôÊÄÅÂèòÈáèÊòØÂê¶Á∫øÁ®ãÂÆâÂÖ®Ôºü</strong></p>
<ul>
<li>Â¶ÇÊûúÊó†ÂÖ±‰∫´ÔºåÂàôÁ∫øÁ®ãÂçÅÂàÜÂÆâÂÖ®</li>
<li>Â¶ÇÊûúÊúâÂÖ±‰∫´ÔºåÊ†πÊçÆÁä∂ÊÄÅÊòØÂê¶ËÉΩÂ§üÊîπÂèòÊù•ÂàÜ‰∏§ÁßçÊÉÖÂÜµ</li>
</ul>
<blockquote>
<p>‚Äã     Â¶ÇÊûúÂè™ÊúâÂè™ËØªÊìç‰ΩúÔºåÂàôÂÆâÂÖ®</p>
<p>‚Äã     Â¶ÇÊûúÊúâÂè™ËØªÂíåÂè™ÂÜôÊìç‰ΩúÔºåÂàôÁ∫øÁ®ã‰∏çÂÆâÂÖ®</p>
</blockquote>
<ul>
<li>Â±ÄÈÉ®ÂèòÈáèÊòØÁ∫øÁ®ãÂÆâÂÖ®ÁöÑ</li>
<li>Â±ÄÈÉ®ÂèòÈáèÂºïÁî®ÁöÑÂØπË±°‰∏ç‰∏ÄÂÆöÂÆâÂÖ®</li>
</ul>
<blockquote>
<p>‚Äã      ÂΩìÂ±ÄÈÉ®ÂèòÈáè‰∏≠ÁöÑÂºïÁî®ÂØπË±°Ë¢´ÂÖ∂‰ªñÁ∫øÁ®ãÂÖ±‰∫´Ôºå‰πüÂ∞±ÊòØÂ§ö‰∏™Á∫øÁ®ãÂêåÊó∂‰ΩøÁî®‰∏Ä‰∏™Â±ÄÈÉ®ÂèòÈáèÊó∂ÔºåÂ∞±‰ºöÂØºËá¥Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò</p>
</blockquote>
<h4 id="Â±ÄÈÉ®ÂèòÈáèÁ∫øÁ®ãÂÆâÂÖ®ÂàÜÊûê">Â±ÄÈÉ®ÂèòÈáèÁ∫øÁ®ãÂÆâÂÖ®ÂàÜÊûê</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>‰∏äÈù¢Ëøô‰∏™ÊñπÊ≥ï‰∏≠ÁöÑiÊòØ‰∏ç‰ºöÂá∫Áé∞Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢òÁöÑ</strong></p>
<blockquote>
<p>Âõ†‰∏∫Âú®JvmËôöÊãüÊú∫‰∏≠ÔºåÊØèË∞ÉÁî®‰∏Ä‰∏™ÊñπÊ≥ïÂ∞±‰ºöÁîüÊàê‰∏Ä‰∏™Ê†àÂ∏ßÔºåËÄåÊØè‰∏™Á∫øÁ®ã‰∏≠ÁöÑÊ†àÂ∏ßÊòØ‰∫í‰∏çÂÖ±‰∫´ÁöÑÔºå‰πüÂ∞±ÊòØËØ¥ÔºåÊØè‰∏Ä‰∏™Á∫øÁ®ã‰ºöÂú®Ëá™Â∑±ÁöÑjavaËôöÊãüÊú∫Ê†à‰∏≠ÁöÑÂ±ÄÈÉ®ÂèòÈáèË°®ÁîüÊàê‰∏Ä‰∏™ÂèòÈáèi</p>
</blockquote>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220319221818683.png"
	
	
	
	loading="lazy"
	
		alt="image-20220319221818683"
	
	
></p>
<p><strong>Ê°à‰æãÔºö</strong></p>
<p>ÊàêÂëòÂèòÈáè</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ThreadUnsafe</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(</span><span class="kt">int</span> <span class="n">loopNumber</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">loopNumber</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">method2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">method3</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(){</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">method3</span><span class="o">(){</span><span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadUnsafe</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadUnsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">Thread_Number</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">test</span><span class="o">.</span><span class="na">method1</span><span class="o">(</span><span class="n">Loop_Number</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;Thread&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Exception in thread &#34;Thread1&#34; java.lang.IndexOutOfBoundsException: Index: 0, Size: 1
</span></span><span class="line"><span class="cl">	at java.util.ArrayList.rangeCheck(ArrayList.java:653)
</span></span><span class="line"><span class="cl">	at java.util.ArrayList.remove(ArrayList.java:492)
</span></span><span class="line"><span class="cl">	at JUC.b_shareProblems.ThreadUnsafe.method3(ThreadSecurity.java:48)
</span></span><span class="line"><span class="cl">	at JUC.b_shareProblems.ThreadUnsafe.method1(ThreadSecurity.java:42)
</span></span><span class="line"><span class="cl">	at JUC.b_shareProblems.ThreadSecurity.lambda$test2$0(ThreadSecurity.java:18)
</span></span><span class="line"><span class="cl">	at java.lang.Thread.run(Thread.java:748)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Áî±‰∫éÊâÄÊúâÁ∫øÁ®ãÈÉΩÂè™ËÆøÈóÆÂ†Ü‰∏≠ÁöÑ‰∏Ä‰∏™ÊàêÂëòÂèòÈáèÔºåÂØºËá¥ËµÑÊ∫êÂÖ±‰∫´ÔºåÊâÄ‰ª•‰ºöÂá∫Áé∞Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢òËÄåÊä•Èîô</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220319223343207.png"
	
	
	
	loading="lazy"
	
		alt="image-20220319223343207"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220321200950432.png"
	
	
	
	loading="lazy"
	
		alt="image-20220321200950432"
	
	
></p>
<p>Â±ÄÈÉ®ÂèòÈáè</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ThreadSafe</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(</span><span class="kt">int</span> <span class="n">loopNumber</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">loopNumber</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">method2</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">method3</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">method3</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span><span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadSafe</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadSafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">Thread_Number</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">test</span><span class="o">.</span><span class="na">method1</span><span class="o">(</span><span class="n">Loop_Number</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;Thread&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220319223453960.png"
	
	
	
	loading="lazy"
	
		alt="image-20220319223453960"
	
	
></p>
<p><strong>Â±ÄÈÉ®ÂèòÈáèÁ∫øÁ®ã‰∏çÂÆâÂÖ®Ê°à‰æã</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ThreadSafe</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(</span><span class="kt">int</span> <span class="n">loopNumber</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">loopNumber</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">method2</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">method3</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span><span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method3</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span><span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ThreadsubSafeClass</span> <span class="kd">extends</span> <span class="n">ThreadSafe</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method3</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test4</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadsubSafeClass</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadsubSafeClass</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">Thread_Number</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">test</span><span class="o">.</span><span class="na">method1</span><span class="o">(</span><span class="n">Loop_Number</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;Thread&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Exception in thread &#34;Thread-18115&#34; java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
</span></span><span class="line"><span class="cl">	at java.util.ArrayList.rangeCheck(ArrayList.java:653)
</span></span><span class="line"><span class="cl">	at java.util.ArrayList.remove(ArrayList.java:492)
</span></span><span class="line"><span class="cl">	at JUC.b_shareProblems.ThreadsubSafeClass.lambda$method3$0(ThreadSecurity.java:77)
</span></span><span class="line"><span class="cl">	at java.lang.Thread.run(Thread.java:748)
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂèØ‰ª•ÁúãÂá∫ Âú®Â≠êÁ±ªThreadsubSafeClass‰∏≠ÔºåÈáçÂÜô‰∫ÜÁà∂Á±ªÁöÑmethod3ÊñπÊ≥ïÔºåÂπ∂‰∏îÂºÄËæü‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÁ∫øÁ®ãÔºåÊ≠§Êó∂Ëøô‰∏™Êñ∞ÁöÑÁ∫øÁ®ã‰∏étest4ÊñπÊ≥ïÂºÄËæüÁöÑÁ∫øÁ®ãÂÖ±‰∫´‰∏Ä‰∏™listÂ±ÄÈÉ®ÂèòÈáèÔºåËøôÂ∞±‰ºöÂØºËá¥Á∫øÁ®ã‰∏çÂÆâÂÖ®ÈóÆÈ¢ò„ÄÇ</p>
<p>„ÄêÊ≥®„ÄëÔºöÊñπÊ≥ï‰øÆÈ•∞Á¨¶ÔºåÊòØÂèØ‰ª•Âú®‰∏ÄÂÆöÁ®ãÂ∫¶‰∏äÈò≤Ê≠¢Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢òÁöÑÔºåÊØîÂ¶Çprivate,finalÊñπÊ≥ïÂ∞±ÂèØ‰ª•ËÆ©Â≠êÁ±ªÊó†Ê≥ïÈáçÂÜôÂá∫Áé∞ÂÆâÂÖ®ÈóÆÈ¢ò„ÄÇ</p>
<h3 id="45-Â∏∏ËßÅÁöÑÁ∫øÁ®ãÂÆâÂÖ®Á±ª">4.5 Â∏∏ËßÅÁöÑÁ∫øÁ®ãÂÆâÂÖ®Á±ª</h3>
<ul>
<li>String</li>
<li>Integer</li>
<li>StringBuffer</li>
<li>Random</li>
<li>Vector</li>
<li>Hashtable</li>
<li>java.util.comcurrentÂåÖ‰∏ãÁöÑÁ±ª</li>
</ul>
<p>ËøôÈáåÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÊåáÁöÑÊòØÔºåÂ§ö‰∏™Á∫øÁ®ãË∞ÉÁî®ÂÆÉ‰ª¨Âêå‰∏Ä‰∏™ÂÆû‰æãÊñπÊ≥ïÊòØÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÔºå<strong>‰πüÂ∞±ÊòØËØ¥‰ªñ‰ª¨ÁöÑÊØè‰∏™ÊñπÊ≥ïÊòØÂéüÂ≠êÁöÑÔºå‰ΩÜÊòØÂÆÉ‰ª¨Â§ö‰∏™ÊñπÊ≥ïÁöÑÁªÑÂêà‰∏çÊòØÂéüÂ≠êÁöÑ</strong></p>
<h4 id="‰∏çÂèØÂèòÁ±ªÁ∫øÁ®ãÂÆâÂÖ®ÊÄß">‰∏çÂèØÂèòÁ±ªÁ∫øÁ®ãÂÆâÂÖ®ÊÄß</h4>
<blockquote>
<p>StringÔºåIntegerÁ≠âÈÉΩÊòØ‰∏çÂèØÂèòÁ±ªÔºåÂõ†‰∏∫ÂÖ∂ÂÜÖÈÉ®ÁöÑÁä∂ÊÄÅ‰∏çÂèØ‰ª•ÊîπÂèòÔºåÊâÄ‰ª•ÊñπÊ≥ïÈÉΩÊòØÁ∫øÁ®ãÂÆâÂÖ®ÁöÑ</p>
</blockquote>
<p>‰æãÂ¶ÇÔºöString.class Êúâ finalÂ≠óÁ¨¶‰øÆÈ•∞ Êù•Ë°®Á§∫StringÂ≠óÁ¨¶‰∏≤‰∏çÂèØÂèò„ÄÇ</p>
<p>String.substring()ÊñπÊ≥ï ‰πüÊòØÂàõÂª∫‰∏Ä‰∏™<strong>Êñ∞ÁöÑÂ≠óÁ¨¶‰∏≤ÂèòÈáè</strong>ÔºåËÄå‰∏çÊòØ‰øÆÊîπËá™Ë∫´ÂÄºÂ±ûÊÄß„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">substring</span><span class="o">(</span><span class="kt">int</span> <span class="n">beginIndex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">beginIndex</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">StringIndexOutOfBoundsException</span><span class="o">(</span><span class="n">beginIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">subLen</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">beginIndex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">subLen</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">StringIndexOutOfBoundsException</span><span class="o">(</span><span class="n">subLen</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">(</span><span class="n">beginIndex</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="k">this</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">beginIndex</span><span class="o">,</span> <span class="n">subLen</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="46-Ê°à‰æã">4.6 Ê°à‰æã</h3>
<h4 id="Èì∂Ë°åËΩ¨Èí±">Èì∂Ë°åËΩ¨Èí±</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">JUC.b_shareProblems</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">bank</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Account</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Account</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Account</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Account</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">1000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">a</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="n">randomAmount</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">1000</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">b</span><span class="o">.</span><span class="na">transfer</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">randomAmount</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÊÄªÈáëÈ¢ù:{}&#34;</span><span class="o">,</span><span class="n">a</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()+</span><span class="n">b</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">Random</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">randomAmount</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">5</span><span class="o">)+</span><span class="n">1</span><span class="o">;}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Account</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Account</span><span class="o">(</span><span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">money</span> <span class="o">=</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getMoney</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMoney</span><span class="o">(</span><span class="kt">int</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">money</span> <span class="o">=</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">(</span><span class="n">Account</span> <span class="n">target</span><span class="o">,</span><span class="kt">int</span> <span class="n">money</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">money</span> <span class="o">&gt;</span> <span class="n">money</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">money</span><span class="o">-</span><span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span><span class="o">.</span><span class="na">setMoney</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">getMoney</span><span class="o">()+</span><span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">21:28:02.747 [main] DEBUG JUC.b_shareProblems.bank - ÊÄªÈáëÈ¢ù:938
</span></span></code></pre></td></tr></table>
</div>
</div><p>Áî±ËæìÂá∫ÂèØ‰ª•ÁúãÂá∫ ÂéüÊú¨Â∫îËØ•ÊÄªÈáëÈ¢ù‰∏∫1000ÔºåÁé∞Âú®ÂèçËÄåËøòÂáèÂ∞ë‰∫ÜÔºåËØ¥ÊòéÁî±‰∫éÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢òÔºåÂØºËá¥‰∏ä‰∏ãÊñáÂàáÊç¢Âá∫Áé∞ÈóÆÈ¢ò„ÄÇ</p>
<p>Â¶ÇÊûúÂä†ÈîÅÊàë‰ª¨Â∫îËØ•ÊÄé‰πàÂä†Ôºü</p>
<ul>
<li><strong>ÂØπtransferÊñπÊ≥ïÂä†‰∏äsynchronizedÔºü</strong></li>
</ul>
<p>Â¶ÇÊûúÊàë‰ª¨ÂØπtransferÊñπÊ≥ïÂä†‰∏äsynchronized‰øÆÈ•∞Á¨¶ÔºåÂè™‰ºöÂØπÁ±ªÂÆû‰æãÊú¨Ë∫´ËøõË°åÂä†ÈîÅ(this)ÔºåÁî±‰∫éË¥¶Êà∑AÂíåË¥¶Êà∑BÊòØ‰∏çÂêåÁöÑÁ±ªÔºåÊâÄ‰ª•Êó†Ê≥ïÊîæÂú®Á∫øÁ®ãA,BÁöÑ‰∏ä‰∏ãÊñáÂàáÊç¢</p>
<ul>
<li><strong>ÂØπAccount.classÂä†ÈîÅÔºü</strong></li>
</ul>
<p>ÂèØ‰ª•Èò≤Ê≠¢Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢òÔºå‰ΩÜÊòØ‰ºöÊòØÁöÑÊï¥‰∏™Á±ªË¢´Â∞ÅÈîÅÔºåËÄåÂØºËá¥ÊÄßËÉΩ‰∏ãÈôç</p>
<h3 id="47-monitorÊ¶ÇÂøµ">4.7 MonitorÊ¶ÇÂøµ</h3>
<h4 id="javaÂØπË±°Â§¥">JavaÂØπË±°Â§¥</h4>
<p>Integer : 8(ÂØπË±°Â§¥)+4(ÂÄº)+2(Ë°•‰Ωç Ë¶ÅÊ±Ç8‰ΩçÊï∞ÁöÑÂÄçÊï∞)</p>
<p>int: 4</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220321213336713.png"
	
	
	
	loading="lazy"
	
		alt="image-20220321213336713"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220321213446004.png"
	
	
	
	loading="lazy"
	
		alt="image-20220321213446004"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220321213554440.png"
	
	
	
	loading="lazy"
	
		alt="image-20220321213554440"
	
	
></p>
<h4 id="monitorÈîÅ">Monitor(ÈîÅ)</h4>
<p>MonitorÊòØÊìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑ‰∏Ä‰∏™ÁõëÁÆ°ËÄÖ</p>
<blockquote>
<p>‰∏Ä‰∏™monitorÂØπË±°ÂåÖÊã¨Ëøô‰πàÂá†‰∏™ÂÖ≥ÈîÆÂ≠óÊÆµÔºöcxqÔºà‰∏ãÂõæ‰∏≠ÁöÑContentionListÔºâÔºåEntryList ÔºåWaitSetÔºåowner„ÄÇ</p>
<p>ÂÖ∂‰∏≠cxq ÔºåEntryList ÔºåWaitSetÈÉΩÊòØÁî±ObjectWaiterÁöÑÈìæË°®ÁªìÊûÑÔºåownerÊåáÂêëÊåÅÊúâÈîÅÁöÑÁ∫øÁ®ã„ÄÇ</p>
</blockquote>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220712184945639.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="‰∏äÈîÅÊµÅÁ®ã">‰∏äÈîÅÊµÅÁ®ã</h5>
<ul>
<li>ÂΩìÊúâ‰∏Ä‰∏™‰∏¥ÁïåÂå∫‰ª£Á†ÅË¢´‰∏äÈîÅÊó∂Ôºå‰∏äÈîÅÂØπË±°obj‰∏≠ÁöÑMarkWordÂ∞ÜÊîπÂèò‰∏∫<strong>HeavyLockÁä∂ÊÄÅ</strong>ÔºåÂπ∂‰∏îÊåáÂêë‰∏Ä‰∏™MonitorÈîÅ</li>
<li>ÂΩìThread-2 Ë¶Å‰ΩøÁî®‰∏¥ÁïåÂå∫‰ª£Á†ÅÊó∂Ôºå<strong>‰ºöÊü•ÁúãË¢´‰∏äÈîÅÁöÑÂØπË±°objÂØπÂ∫îÁöÑMonitorÈîÅ</strong>ÔºåÊü•ÁúãOwnerÊòØÂê¶‰∏∫Á©∫Ôºå<strong>Â¶ÇÊûú‰∏∫Á©∫ÂàôÊàê‰∏∫MonitorÁöÑOwnerÂπ∂‰ΩøÁî®‰∏¥ÁïåÂå∫‰ª£Á†Å</strong></li>
<li>ÂΩìThread-1Êù•ËÆøÈóÆ‰∏¥ÁïåÂå∫‰ª£Á†ÅÊó∂Ôºå‰ºöÊü•ÁúãË¢´‰∏äÈîÅÁöÑÂØπË±°objÂØπÂ∫îÁöÑMonitorÈîÅÔºåÊü•ÁúãOwnerÊòØÂê¶‰∏∫Á©∫Ôºå<strong>Ê≠§Êó∂Owner‰∏ç‰∏∫Á©∫ÁöÑËØùÔºåÂ∞ÜThread-1ÊîæÂÖ•EntryList‰∏≠ÔºåÂπ∂‰∏îÂ∞ÜÁä∂ÊÄÅËÆæÁΩÆ‰∏∫BLOCKED</strong></li>
<li>ÂΩìThread-3 Êù•ËÆøÈóÆ‰∏¥ÁïåÂå∫‰ª£Á†ÅÊó∂ÔºåÈáçÂ§ç‰∏äËø∞Ê≠•È™§ÔºåÂπ∂‰∏îÊîæÂÖ•Thread-1‰πãÂêé(ÈìæË°®ÁªìÊûÑ)</li>
<li>ÂΩìThread-2‰ΩøÁî®ÂÆå‰∏¥ÁïåÂå∫‰ª£Á†ÅÊó∂Ôºå<strong>Â∞ÜÂî§ÈÜíEntryList‰∏≠ÁöÑBLOCKEDÈòüÂàóÂπ∂‰∏îËøõË°åÈîÅÁ´û‰∫âÔºàÈùûÂÖ¨Âπ≥ÔºâÔºåÊù•Êàê‰∏∫MonitorÁöÑOwner</strong></li>
<li>Â¶ÇÊûúThread-1‰πãÂâçËé∑ÂèñËøáÈîÅÔºå‰ΩÜÊù°‰ª∂‰∏çÊª°Ë∂≥ÂàôËøõÂÖ•WatingÁä∂ÊÄÅ</li>
</ul>
<h4 id="synchronizedÂ≠óËäÇÁ†ÅËß£Êûê">synchronizedÂ≠óËäÇÁ†ÅËß£Êûê</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Monitor</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">counter</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220321221508374.png"
	
	
	
	loading="lazy"
	
		alt="image-20220321221508374"
	
	
></p>
<p>Âú®synchronizedÂä†ÈîÅÁöÑ‰ª£Á†ÅÂùó‰∏≠„ÄÇ</p>
<p><strong>0: getstatic</strong> Ëé∑Âèñlock‰ª£Á†ÅÁöÑÂºïÁî®</p>
<p><strong>1: astore_1</strong> Âπ∂Â∞Ülock‰ª£Á†ÅÁöÑÂºïÁî®Âä†ÂÖ•ÂØºÂ±ÄÈÉ®ÂèòÈáèÊßΩ‰∏≠</p>
<p><strong>5: monitorenter</strong> Â∞ÜlockÂØπË±°MarkWordÂèò‰∏∫MonitorÊåáÈíà</p>
<p><strong>14:</strong> <strong>aload_1</strong> Â∞ÜlockÂºïÁî®Âä†ËΩΩÂà∞Êìç‰ΩúÊï∞Ê†à‰∏≠</p>
<p><strong>15: monitorexit</strong> Â∞ÜlockÂØπË±°MarkWordÈáçÁΩÆÔºåÂî§ÈÜíEntryList</p>
<p><strong>19~23</strong> ‰ª£Á†ÅÊòØÂΩìsynchronized‰∏≠ÁöÑ‰ª£Á†ÅÂùóÂá∫Áé∞ÂºÇÂ∏∏Êó∂ÔºåËøõË°åÂºÇÂ∏∏ÊäõÂá∫Âπ∂‰∏îÈáçÁΩÆÈîÅÂØπË±°</p>
<h3 id="48-ËΩªÈáèÁ∫ßÈîÅ">4.8 ËΩªÈáèÁ∫ßÈîÅ</h3>
<p>**ËΩªÈáèÁ∫ßÈîÅÁöÑ‰ΩøÁî®Âú∫ÊôØÔºö**Â¶ÇÊûú‰∏Ä‰∏™ÂØπË±°ÊúâÂ§ö‰∏™Á∫øÁ®ãËÆøÈóÆÔºå‰ΩÜÊòØÁ∫øÁ®ãËÆøÈóÆÊó∂Èó¥ÈîôÂºÄÔºàÊ≤°ÊúâÁ´û‰∫âÔºâÔºåÈÇ£‰πàÂèØ‰ª•‰ΩøÁî®ËΩªÈáèÁ∫ßÈîÅÊù•‰ºòÂåñ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">method1</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">object</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">method2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">object</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;LightWeightLock&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂàõÂª∫ÈîÅËÆ∞ÂΩï(Lock Record)ÂØπË±°ÔºåÊØè‰∏™Á∫øÁ®ãÁöÑÊ†àÂ∏ßÈÉΩ‰ºöÂåÖÂê´‰∏Ä‰∏™ÈîÅËÆ∞ÂΩïÁªìÊûÑÔºåÂÜÖÈÉ®ÂèØ‰ª•Â≠òÂÇ®ÈîÅÂØπË±°ÁöÑMarkWord</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322204732367.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322204732367"
	
	
></p>
<ul>
<li>ËÆ©ÈîÅËÆ∞ÂΩï‰∏≠ÁöÑObject reference ÊåáÂêëÈîÅÂØπË±°ÔºåÂπ∂‰∏îËÆ©cas ÊõøÊç¢ Object ÁöÑ Mark WordÔºåÂ∞ÜMark WordÁöÑÂÄºÂ≠òÂÖ•ÈîÅËÆ∞ÂΩï</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322211122103.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322211122103"
	
	
></p>
<ul>
<li>Â¶ÇÊûúcasÊõøÊç¢ÊàêÂäüÔºåÂØπË±°Â§¥‰∏≠Â≠òÂÇ®‰∫Ü<strong>ÈîÅËÆ∞ÂΩïÂú∞ÂùÄÂíåÁä∂ÊÄÅ00</strong>ÔºåË°®Á§∫ÊúâËØ•Á∫øÁ®ãÁªôÂØπË±°Âä†ÈîÅÔºåËøôÊó∂ÂõæÁ§∫Â¶Ç‰∏ã</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322212151746.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322212151746"
	
	
></p>
<ul>
<li>Â¶ÇÊûúcasÂ§±Ë¥•ÔºåÊúâ‰∏§ÁßçÊÉÖÂÜµ</li>
</ul>
<p>‚Äã    1,Â¶ÇÊûúÊòØÂÖ∂ÂÆÉÁöÑÁ∫øÁ®ãÂ∑≤ÁªèÊåÅÊúâ‰∫ÜËØ•ObjectÁöÑËΩªÈáèÁ∫ßÈîÅÔºåËøôÊó∂Ë°®ÊòéÊúâÁ´û‰∫âÔºåËøõÂÖ•ÈîÅËÜ®ËÉÄ</p>
<p>‚Äã     2,Â¶ÇÊûúÊòØËá™Â∑±ÊâßË°å‰∫ÜsynchronizedÈîÅÈáçÂÖ•ÔºåÈÇ£‰πàÂÜçÊ∑ªÂä†‰∏ÄÊù°Lock record‰Ωú‰∏∫ÈáçÂÖ•ÁöÑËÆ°Êï∞</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322212943855.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322212943855"
	
	
></p>
<ul>
<li>Ëß£ÈîÅËøáÁ®ãÔºåÂ¶ÇÊûúThread-0‰∏≠ÊúâËÆ∞ÂΩï‰∏∫nullÁöÑÈîÅËÆ∞ÂΩïÔºåÂàôË°®Á§∫ÊúâÈáçÂÖ•ÔºåÂ∞ÜÈîÅËÆ∞ÂΩïÁßªÈô§ÔºåÂπ∂Â∞ÜÈáçÂÖ•-1Ôºõ</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322212151746.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322212151746"
	
	
></p>
<ul>
<li>
<p>ÂΩìÈÄÄÂá∫ÈîÅËøáÁ®ã‰∏≠ÔºåLock RecordËÆ∞ÂΩï‰∏≠‰∏ç‰∏∫NullÔºåÂàôÂà©Áî®casÂ∞ÜMarkWordÂØπË±°ÊÅ¢Â§ç</p>
<p>1ÔºåÊàêÂäüÔºåËß£ÈîÅÊàêÂäü</p>
<p>2ÔºåÂ§±Ë¥•ÔºåËØ¥ÊòéÈîÅËÜ®ËÉÄ‰∏∫ÈáçÈáèÁ∫ßÈîÅÔºåËøõÂÖ•ÈáçÈáèÁ∫ßÈîÅËß£ÈîÅÊµÅÁ®ã</p>
</li>
</ul>
<h3 id="49-ÈîÅËÜ®ËÉÄ">4.9 ÈîÅËÜ®ËÉÄ</h3>
<p>Â¶ÇÊûúÂÜçÂ∞ùËØïÂä†ËΩªÈáèÁ∫ßÈîÅÁöÑËøáÁ®ã‰∏≠ÔºåCASÊìç‰ΩúÊó†Ê≥ïÊàêÂäüÔºåËøôÊó∂ÁöÑ‰∏ÄÁßçÊÉÖÂÜµÂ∞±ÊòØÊúâÂÖ∂‰ªñÁöÑÁ∫øÁ®ã‰∏∫Ê≠§ÂØπË±°Âä†‰∏ä‰∫ÜËΩªÈáèÁ∫ßÈîÅ(ÊúâÁ´û‰∫â)ÔºåËøôÊó∂ÈúÄË¶ÅËøõË°åÈîÅËÜ®ËÉÄÔºåÂ∞ÜËΩªÈáèÁ∫ßÈîÅÂèò‰∏∫ÈáçÈáèÁ∫ßÈîÅ</p>
<ul>
<li>ÂΩìThread-1 ËÆøÈóÆObjectÂØπË±°Êó∂ÔºåËøõË°åcas‰∫§Êç¢ÔºåÂèëÁé∞ObjectÂØπË±°Â∑≤ÁªèË¢´Ëµã‰∏äËΩªÈáèÁ∫ßÈîÅÔºåÂàôËøõÂÖ•ÈîÅËÜ®ËÉÄ</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322220646392.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322220646392"
	
	
></p>
<ul>
<li>Thread-1Âä†ÈîÅÂ§±Ë¥•ÔºåËøõÂÖ•ÈîÅËÜ®ËÉÄÊµÅÁ®ã</li>
</ul>
<p>‚Äã    1Ôºå‰∏∫ObjectÂØπË±°Áî≥ËØ∑MonitorÔºåËÆ©ObjectÊåáÂêëÈáçÈáèÁ∫ßÈîÅÂú∞ÂùÄ</p>
<p>‚Äã    2ÔºåÁÑ∂ÂêéËá™Â∑±ËøõÂÖ•MonitorÁöÑEntryList BLOCKED</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322221533904.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322221533904"
	
	
></p>
<ul>
<li>ÂΩìThread-0ÈÄÄÂá∫ÂêåÊ≠•ÂùóËß£ÈîÅÊó∂Ôºå‰ΩøÁî®casÂ∞ÜMarkWordÁöÑÂÄºÊÅ¢Â§çÁªôÂØπË±°Â§¥ÔºåÂ§±Ë¥•„ÄÇËøôÊó∂‰ºöËøõÂÖ•ÈáçÈáèÁ∫ßËß£ÈîÅÊµÅÁ®ãÔºåÂç≥ÊåâÁÖßMonitorÂú∞ÂùÄÊâæÂà∞MonitorÂØπË±°ÔºåËÆæÁΩÆOwner‰∏∫NullÔºåÂî§ÈÜíEntryList‰∏≠ÁöÑBLOCKEDÁ∫øÁ®ã</li>
</ul>
<h3 id="410-Ëá™Êóã‰ºòÂåñÂ§öÊ†∏cpu">4.10 Ëá™Êóã‰ºòÂåñ(Â§öÊ†∏CPU)</h3>
<p>ÈáçÈáèÁ∫ßÈîÅÁ´û‰∫âÁöÑÊó∂ÂÄôÔºåËøòÂèØ‰ª•‰ΩøÁî®Ëá™ÊóãÊù•ËøõË°å‰ºòÂåñÔºåÂ¶ÇÊûúÂΩìÂâçÁ∫øÁ®ãËá™ÊóãÊàêÂäüÔºàÂç≥ËøôÊó∂ÂÄôÊåÅÈîÅÁ∫øÁ®ãÂ∑≤ÁªèÈÄÄÂá∫‰∫ÜÂêåÊ≠•ÂùóÔºåÈáäÊîæ‰∫ÜÈîÅÔºâÔºåËøôÊó∂ÂΩìÂâçÁ∫øÁ®ãÂ∞±ÂèØ‰ª•ÈÅøÂÖçÈòªÂ°û„ÄÇ(ÂèØ‰ª•Èò≤Ê≠¢‰∏ä‰∏ãÊñáÂàáÊç¢ÔºåÊèêÈ´òÊÄßËÉΩ)</p>
<p><strong>Ëá™ÊóãÊàêÂäüÁöÑÊÉÖÂÜµ</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220322223354746.png"
	
	
	
	loading="lazy"
	
		alt="image-20220322223354746"
	
	
></p>
<p><strong>Ëá™ÊóãÂ§±Ë¥•ÁöÑÊÉÖÂÜµ</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220323195519375.png"
	
	
	
	loading="lazy"
	
		alt="image-20220323195519375"
	
	
></p>
<ul>
<li>Âú®Java6‰πãÂêéËá™ÊóãÈîÅÊòØËá™ÈÄÇÂ∫îÁöÑÔºåÊØîÂ¶ÇÂàöÂàöÂØπË±°Ëá™ÊóãÊàêÂäüÁöÑËØùÔºåÂ∞±‰ºöËÆ§‰∏∫ËøôÊ¨°Ëá™ÊóãÊàêÂäüÁöÑÂèØËÉΩÊÄß‰ºöÈ´òÔºåÂ∞±Â§öËá™ÊóãÂá†Ê¨°ÔºõÂèç‰πãÔºåÂ∞±ÂáèÂ∞ëËá™ÊóãÁîöËá≥‰∏çËá™Êóã</li>
<li><strong>Ëá™ÈÄÇÂ∫îËá™ÊóãËß£ÂÜ≥ÁöÑÊòØ‚ÄúÈîÅÁ´û‰∫âÊó∂Èó¥‰∏çÁ°ÆÂÆö‚ÄùÁöÑÈóÆÈ¢ò</strong></li>
<li>Ëá™Êóã‰ºöÂç†Áî®CPUÊó∂Èó¥ÔºåÂçïÊ†∏CPUËá™ÊóãÁ≠â‰∫éÊµ™Ë¥πÊó∂Èó¥</li>
</ul>
<h3 id="411-ÂÅèÂêëÈîÅ">4.11 ÂÅèÂêëÈîÅ</h3>
<p>ËΩªÈáèÁ∫ßÈîÅÂú®Êó†ÂÆûÈôÖÈîÅÁ´û‰∫âÊó∂ÔºåÊØèÊ¨°ÁöÑÈîÅÈáçÂÖ•ÈÉΩË¶ÅËøõË°åÊó†ÊÑè‰πâÁöÑcasÊìç‰ΩúÔºå‰∫éÊòØÊàë‰ª¨ÂèØ‰ª•ÂØπÂÖ∂ËøõË°å‰ºòÂåñ„ÄÇ</p>
<p>Java 6‰∏≠ÂºïÂÖ•‰∫ÜÂÅèÂêëÈîÅÊù•ÂÅöËøõ‰∏ÄÊ≠•‰ºòÂåñÔºõÂè™ÊúâÁ¨¨‰∏ÄÊ¨°‰ΩøÁî®CASÂ∞ÜÁ∫øÁ®ãIDËÆæÁΩÆÂà∞ÂØπË±°ÁöÑMarkWordÂ§¥Ôºå‰πãÂêéÂèëÁé∞Ëøô‰∏™Á∫øÁ®ãIDÊòØËá™Â∑±ÁöÑÂ∞±Ë°®Á§∫Ê≤°ÊúâÁ´û‰∫âÔºå‰∏çÁî®ÈáçÊñ∞CASÔºå‰ª•ÂêéÂè™Ë¶Å‰∏çÂèëÁîüÁ´û‰∫âÔºåËøô‰∏™ÂØπË±°Â∞±ÂΩíËØ•Á∫øÁ®ãÊâÄÊúâ„ÄÇ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220323200911602.png"
	
	
	
	loading="lazy"
	
		alt="image-20220323200911602"
	
	
></p>
<h4 id="ÂÅèÂêëÈîÅËé∑ÂèñËøáÁ®ã">ÂÅèÂêëÈîÅËé∑ÂèñËøáÁ®ã</h4>
<p>ÂåøÂêçÂÅèÂêëÁä∂ÊÄÅÔºåÂç≥MarkWordÔºåThreadIdÈÉ®ÂàÜ‰∏∫0ÔºåË°®Èù¢Â§Ñ‰∫éÂÅèÂêëÁä∂ÊÄÅÔºå‰ΩÜÊòØ‰∏∫ÂÅèÂêë‰ªª‰ΩïÈîÅ„ÄÇ</p>
<ul>
<li>Á∫øÁ®ãAËøõÂÖ•ÂêåÊ≠•‰ª£Á†ÅÂùóÔºåÈ¶ñÂÖàÊ£ÄÊü•markword Â§¥ÈÉ®ÂàÜÊòØÂê¶‰∏∫ 01 Âç≥ÂÅèÂêëÈîÅÊàñÊó†ÈîÅÁä∂ÊÄÅÔºåËã•ÊòØÂàôËøõÂÖ•‰∏ã‰∏ÄÊ≠•</li>
<li>Á∫øÁ®ãAÊü•Áúãbiased_lockÁöÑÊï∞ÂÄºÔºåÂ¶ÇÊûú‰∏∫0ÔºåÂàô‰ª£Ë°®ËØ•ÂØπË±°Á¶ÅÁî®ÂÅèÂêëÈîÅÔºå‰∏çCASÁõ¥Êé•ËøõË°åÈîÅÂçáÁ∫ßÔºåÂ¶ÇÊûú‰∏∫1ÔºåÂàôËøõÂÖ•ÂÅèÂêëÈîÅÂä†ÈîÅÁéØÂ¢É</li>
<li>Ê≠§Êó∂Á∫øÁ®ãAÊü•ÁúãThreadIdÁöÑÊï∞ÂÄº</li>
</ul>
<blockquote>
<ul>
<li>‰∏∫Ëá™Ë∫´IDÔºåÂàô‰∏çËøõË°åCASÔºåËÄåÊòØÁõ¥Êé•Âú®Ê†àÂ∏ß‰∏≠Âä†‰∏ÄÊù°Ëá™Â∑±ÁöÑÈîÅËÆ∞ÂΩï</li>
<li>‰∏ç‰∏∫Ëá™Ë∫´IDÔºåID‰∏∫0ÔºåÂàô‰ª£Ë°®Êó†ÂÅèÂêëÔºåÊ≠§Êó∂ËøõË°åCASÔºåCASÊàêÂäüÂàôÂÅèÂêëÊàêÂäü</li>
<li>‰∏ç‰∏∫Ëá™Ë∫´IDÔºåID‰∏∫ÂÖ∂‰ªñÂÄºÔºåÂàô‰ª£Ë°®Â∑≤ÁªèÊúâÂÅèÂêëÔºåÊ≠§Êó∂ËøõË°åCASÂ§±Ë¥•ÔºåÂçáÁ∫ß‰∏∫ËΩªÈáèÁ∫ßÈîÅ</li>
</ul>
</blockquote>
<h4 id="ÂÅèÂêëÁä∂ÊÄÅ">ÂÅèÂêëÁä∂ÊÄÅ</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220323203531014.png"
	
	
	
	loading="lazy"
	
		alt="image-20220323203531014"
	
	
></p>
<p>‰∏Ä‰∏™ÂØπË±°ÂàõÂª∫Êó∂Ôºö</p>
<ul>
<li>(java 17)ÈªòËÆ§Á¶ÅÁî®ÂÅèÂêëÈîÅÔºåÂ¶ÇÊûúÈªòËÆ§ÂºÄÂêØÂÅèÂêëÈîÅ(ÈªòËÆ§ÂºÄÂêØ)ÔºåÈÇ£‰πàÂØπË±°ÂàõÂª∫Âêé,markwordÂÄº‰∏∫0x05Âç≥ÊúÄÂêé‰∏â‰Ωç‰∏∫101ÔºåËøôÊó∂ÂÆÉÁöÑThread,epoch,ageÈÉΩËÆæÁΩÆ‰∏∫0</li>
<li>ÂÅèÂêëÈîÅÊòØÈªòËÆ§Âª∂ËøüÁöÑÔºå‰∏ç‰ºöÂÜçÁ®ãÂ∫èÂêØÂä®Êó∂Á´ãÂç≥ÁîüÊïàÔºåËã•ÊÉ≥ÈÅøÂÖçÂª∂ËøüÔºåÂèØ‰ª•Âä†VMÂèÇÊï∞</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-XX:BiasedLockingStarupDelay=0
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ÂéüÂõ†ÊòØ JVM ÂÜÖÈÉ®ÁöÑ‰ª£Á†ÅÊúâÂæàÂ§öÂú∞ÊñπÁî®Âà∞‰∫ÜsynchronizedÔºåÂ¶ÇÊûúÁõ¥Êé•ÂºÄÂêØÂÅèÂêëÔºå‰∫ßÁîüÁ´û‰∫âÂ∞±Ë¶ÅÊúâÈîÅÂçáÁ∫ßÔºå‰ºöÂ∏¶Êù•È¢ùÂ§ñÁöÑÊÄßËÉΩÊçüËÄóÔºåÊâÄ‰ª•Â∞±Êúâ‰∫ÜÂª∂ËøüÁ≠ñÁï•„ÄÇ</p>
</blockquote>
<p><img src="http://inews.gtimg.com/newsapp_bt/0/14383522992/641"
	
	
	
	loading="lazy"
	
		alt="ÂõæÁâá"
	
	
></p>
<p>**Ê≥®Ôºö**ÂΩìÊú™ÂºÄÂêØÊó†Âª∂ËøüÁöÑÂÅèÂêëÈîÅÊó∂Ôºå‰∏ÄÂºÄÂßãÁöÑÈîÅÂØπË±°‰∏∫non-biasable; Ë∞ÉÁî®synchronized‰ºöÁõ¥Êé•ÂèòÊàêthin Lock</p>
<ul>
<li>Â¶ÇÊûúÊ≤°ÊúâÂºÄÂêØÂÅèÂêëÈîÅÔºåÈÇ£‰πàÂØπË±°ÂàõÂª∫ÂêéÔºåmarkwordÁöÑÂÄº‰∏∫0x01Âç≥ÊúÄÂêé3‰Ωç‰∏∫001Ôºå<strong>ËøôÊó∂‰ªñÁöÑhashcodeÔºåageÈÉΩ‰∏∫0ÔºåÁ¨¨‰∏ÄÊ¨°Áî®Âà∞hashcodeÊó∂Êâç‰ºöËµãÂÄº</strong></li>
<li>**Java17ÁßªÈô§ÂéüÂõ†Ôºö**ÂÅèÂêëÈîÅÁªô JVM Â¢ûÂä†‰∫ÜÂ∑®Â§ßÁöÑÂ§çÊùÇÊÄßÔºåÂè™ÊúâÂ∞ëÊï∞ÈùûÂ∏∏ÊúâÁªèÈ™åÁöÑÁ®ãÂ∫èÂëòÊâçËÉΩÁêÜËß£Êï¥‰∏™ËøáÁ®ãÔºåÁª¥Êä§ÊàêÊú¨ÂæàÈ´òÔºåÂ§ßÂ§ßÈòªÁ¢ç‰∫ÜÂºÄÂèëÊñ∞ÁâπÊÄßÁöÑËøõÁ®ã</li>
</ul>
<p><strong>ÂΩìÊàë‰ª¨ÁöÑÈ°πÁõÆÊú¨Ë∫´ÊòØ‰∏Ä‰∏™Â§öÁ∫øÁ®ãÈ´òÁ´û‰∫âÁöÑÈ°πÁõÆÔºåÊàë‰ª¨ÂÜç‰ΩøÁî®ÂÅèÂêëÈîÅ‰ºöÂØºËá¥ÊÄßËÉΩÈôç‰ΩéÔºåÊ≠§Êó∂Êàë‰ª¨‰æøË¶ÅÁ¶ÅÁî®ÂÅèÂêëÈîÅ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-XX:-UserBiasedLocking
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÂÅèÂêëÈîÅÊí§ÈîÄ">ÂÅèÂêëÈîÅÊí§ÈîÄ</h4>
<p><strong>ÂÅèÂêëÈîÅÁöÑÊí§ÈîÄÔºåË¶ÅÁ≠âÂæÖÂÖ®Â±ÄÂÆâÂÖ®ÁÇπÊâçËÉΩËøõË°åÔºåÂà∞ËææÂÖ®Â±ÄÂÆâÂÖ®ÁÇπÔºåÊåÅÊúâÂÅèÂêëÈîÅÁöÑÁ∫øÁ®ãB‰πüÂÅúÊ≠¢‰∫Ü</strong></p>
<ul>
<li>Êü•ÁúãÁ∫øÁ®ãBÊòØÂê¶ËøòÂ≠òÊ¥ª‰∏îËøòÂú®ÊâßË°åÂêåÊ≠•‰ª£Á†ÅÂùóÁöÑ‰ª£Á†Å</li>
</ul>
<blockquote>
<ul>
<li><strong>Á∫øÁ®ãBÂ≠òÊ¥ª</strong>ÔºåÂàôÂ∞ÜÂÅèÂêëÈîÅÂçáÁ∫ß‰∏∫ËΩªÈáèÁ∫ßÈîÅÔºåÂπ∂‰∏îÁªßÁª≠ÊåÅÊúâÈîÅÂêë‰∏ãÊâßË°å</li>
<li><strong>Á∫øÁ®ãB‰∏çÂ≠òÊ¥ª</strong>ÔºåÂàôÊü•ÁúãÂÅèÂêëÈîÅÊòØÂê¶ÂÖÅËÆ∏ÈáçÂÅèÂêë</li>
</ul>
<blockquote>
<ul>
<li>ÂÖÅËÆ∏ÈáçÂÅèÂêëÔºåÂàôËÆæÁΩÆÈîÅ‰∏∫ÂåøÂêçÁä∂ÊÄÅÔºåÁ∫øÁ®ãAËøõË°åCASËé∑ÂèñÂÅèÂêëÈîÅ</li>
<li>‰∏çÂÖÅËÆ∏ÈáçÂÅèÂêëÔºåÂàôËÆæÁΩÆÈîÅ‰∏∫Êó†ÈîÅÁä∂ÊÄÅÔºåËøõË°åÈîÅÂçáÁ∫ßÔºåCASÁ´û‰∫âÈîÅ</li>
</ul>
</blockquote>
</blockquote>
<h5 id="1Êí§ÈîÄ-Ë∞ÉÁî®hashcode">1ÔºåÊí§ÈîÄ-Ë∞ÉÁî®hashcode</h5>
<blockquote>
<p>ÂΩìÂØπÂØπË±°‰ΩøÁî®HashCodeÊó∂Ôºå‰ºöÁ¶ÅÁî®ÂÅèÂêëÈîÅÔºåÂõ†‰∏∫hashcodeË¶ÜÁõñ‰∫ÜÁ∫øÁ®ãÁöÑÂú∞ÂùÄ</p>
<p><strong>‰∏∫‰ªÄ‰πàËΩªÈáèÁ∫ßÈîÅÂíåÈáçÈáèÁ∫ßÈîÅË∞ÉÁî®HashCode‰∏ç‰ºöÊí§ÈîÄÈîÅÁä∂ÊÄÅÂë¢?</strong></p>
<ul>
<li>Âõ†‰∏∫ËΩªÈáèÁ∫ßÈîÅÁöÑmarkwordÊòØ‰øùÂ≠òÂú®Âä†ÈîÅÁ∫øÁ®ã‰∏äÁöÑ</li>
<li>ËÄåÈáçÈáèÁ∫ßÈîÅÁöÑmarkwordÊòØ‰øùÂ≠òËá≥monitor‰∏≠ÁöÑ</li>
</ul>
</blockquote>
<h5 id="2Êí§ÈîÄ-ÂÖ∂ÂÆÉÁ∫øÁ®ã‰ΩøÁî®ÂØπË±°">2ÔºåÊí§ÈîÄ-ÂÖ∂ÂÆÉÁ∫øÁ®ã‰ΩøÁî®ÂØπË±°</h5>
<p>ÂΩìÊúâÂÖ∂ÂÆÉÁ∫øÁ®ã‰ΩøÁî®ÂÅèÂêëÈîÅÂØπË±°Êó∂Ôºå‰ºöÂ∞ÜÂÅèÂêëÈîÅÂçáÁ∫ß‰∏∫ËΩªÈáèÁ∫ßÈîÅ</p>
<h5 id="3Êí§ÈîÄ-Ë∞ÉÁî®waitnotify">3ÔºåÊí§ÈîÄ-Ë∞ÉÁî®wait/notify</h5>
<h4 id="ÊâπÈáèÈáçÂÅèÂêë">ÊâπÈáèÈáçÂÅèÂêë</h4>
<p>Thread-1ÂØπObjÂä†‰∏äÂÅèÂêëÈîÅÔºåÂΩìThread-2ËÆøÈóÆObjÊó∂Ôºå‰ºöÊí§ÈîÄÂÅèÂêëÈîÅÔºåËΩ¨Âåñ‰∏∫ËΩªÈáèÁ∫ßÈîÅÔºå‰ΩÜÊòØÂΩì‰πãÂêéObjÁî±Thread-2Â§öÊ¨°ËÆøÈóÆÊó∂(ÈòàÂÄº20Ê¨°)ÔºåJVMÂ∞±‰ºöËÄÉËôëÊòØÂê¶Âä†ÈîôÂÅèÂêëÈîÅÔºå‰∫éÊòØÂØπObjÁöÑÂÅèÂêëÊåáÂêëThread-2„ÄÇ</p>
<p><strong>ÊâπÈáèÈáçÂÅèÂêëÊòØÊåáÔºåÂΩìÊúâ30‰∏™ÂØπË±°Ë¢´Thread-1Âä†ÈîÅÔºåÈÇ£ÂΩìThread-2ËÆøÈóÆËøô30‰∏™ÂØπË±°Êó∂ÔºåÂâç19‰∏™ÂØπË±°‰ºöË¢´ÂçáÁ∫ß‰∏∫ËΩªÈáèÁ∫ßÈîÅÔºåÂêé11‰∏™ÂØπË±°(ËØ•Á±ªÁõ¥Êé•ÈáçÂÅèÂêë)ÁºñÁ®ãÂÅèÂêëThread-2ÁöÑÂÅèÂêëÈîÅ</strong></p>
<h4 id="ÊâπÈáèÊí§ÈîÄ">ÊâπÈáèÊí§ÈîÄ</h4>
<p>ÂΩìÊí§ÈîÄÂÅèÂêëÈîÅÁöÑÈòàÂÄºË∂ÖËøá40Ê¨°ÂêéÔºåjvm‰ºöÊÄÄÁñë‰∫∫ÁîüÔºåÂÜ≥ÂÆöËá™Â∑±‰∏çÂ∫îËØ•ÂÅèÂêëË∞ÅÔºå‰∫éÊòØÂ∞±‰∏çÂÅèÂêëÔºåÊääÊï¥‰∏™Á±ªÁöÑÊâÄÊúâÂØπË±°ÈÉΩËÆæ‰∏∫‰∏çÂèØÂÅèÂêëÔºå<strong>Êñ∞Âª∫ÁöÑÂØπË±°‰πüÊòØ‰∏çÂèØÂÅèÂêë</strong></p>
<h3 id="412-ÈîÅÁ≤óÂåñ">4.12 ÈîÅÁ≤óÂåñ</h3>
<blockquote>
<p>ÈÄöÂ∏∏ÊÉÖÂÜµ‰∏ãÔºå‰∏∫‰∫Ü‰øùËØÅÂ§öÁ∫øÁ®ãÈó¥ÁöÑÊúâÊïàÂπ∂ÂèëÔºå‰ºöË¶ÅÊ±ÇÊØè‰∏™Á∫øÁ®ãÊåÅÊúâÈîÅÁöÑÊó∂Èó¥Â∞ΩÂèØËÉΩÁü≠Ôºå‰ΩÜÊòØÂ§ßÊüê‰∫õÊÉÖÂÜµ‰∏ãÔºå‰∏Ä‰∏™Á®ãÂ∫èÂØπÂêå‰∏Ä‰∏™ÈîÅ‰∏çÈó¥Êñ≠„ÄÅÈ´òÈ¢ëÂú∞ËØ∑Ê±Ç„ÄÅÂêåÊ≠•‰∏éÈáäÊîæÔºå‰ºöÊ∂àËÄóÊéâ‰∏ÄÂÆöÁöÑÁ≥ªÁªüËµÑÊ∫êÔºåÂõ†‰∏∫ÈîÅÁöÑËÆ≤Ê±Ç„ÄÅÂêåÊ≠•‰∏éÈáäÊîæÊú¨Ë∫´‰ºöÂ∏¶Êù•ÊÄßËÉΩÊçüËÄóÔºåËøôÊ†∑È´òÈ¢ëÁöÑÈîÅËØ∑Ê±ÇÂ∞±ÂèçËÄå‰∏çÂà©‰∫éÁ≥ªÁªüÊÄßËÉΩÁöÑ‰ºòÂåñ‰∫ÜÔºåËôΩÁÑ∂ÂçïÊ¨°ÂêåÊ≠•Êìç‰ΩúÁöÑÊó∂Èó¥ÂèØËÉΩÂæàÁü≠„ÄÇ<strong>ÈîÅÁ≤óÂåñÂ∞±ÊòØÂëäËØâÊàë‰ª¨‰ªª‰Ωï‰∫ãÊÉÖÈÉΩÊúâ‰∏™Â∫¶ÔºåÊúâ‰∫õÊÉÖÂÜµ‰∏ãÊàë‰ª¨ÂèçËÄåÂ∏åÊúõÊääÂæàÂ§öÊ¨°ÈîÅÁöÑËØ∑Ê±ÇÂêàÂπ∂Êàê‰∏Ä‰∏™ËØ∑Ê±ÇÔºå‰ª•Èôç‰ΩéÁü≠Êó∂Èó¥ÂÜÖÂ§ßÈáèÈîÅËØ∑Ê±Ç„ÄÅÂêåÊ≠•„ÄÅÈáäÊîæÂ∏¶Êù•ÁöÑÊÄßËÉΩÊçüËÄó„ÄÇ</strong></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomethingMethod</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//do some thing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ËøôÊòØËøòÊúâ‰∏Ä‰∫õ‰ª£Á†ÅÔºåÂÅöÂÖ∂ÂÆÉ‰∏çÈúÄË¶ÅÂêåÊ≠•ÁöÑÂ∑•‰ΩúÔºå‰ΩÜËÉΩÂæàÂø´ÊâßË°åÂÆåÊØï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//do other thing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰∏äÈù¢ÁöÑ‰ª£Á†ÅÊòØÊúâ‰∏§ÂùóÈúÄË¶ÅÂêåÊ≠•Êìç‰ΩúÁöÑÔºå‰ΩÜÂú®Ëøô‰∏§ÂùóÈúÄË¶ÅÂêåÊ≠•Êìç‰ΩúÁöÑ‰ª£Á†Å‰πãÈó¥ÔºåÈúÄË¶ÅÂÅö‰∏Ä‰∫õÂÖ∂ÂÆÉÁöÑÂ∑•‰ΩúÔºåËÄåËøô‰∫õÂ∑•‰ΩúÂè™‰ºöËä±Ë¥πÂæàÂ∞ëÁöÑÊó∂Èó¥ÔºåÈÇ£‰πàÊàë‰ª¨Â∞±ÂèØ‰ª•ÊääËøô‰∫õÂ∑•‰Ωú‰ª£Á†ÅÊîæÂÖ•ÈîÅÂÜÖÔºåÂ∞Ü‰∏§‰∏™ÂêåÊ≠•‰ª£Á†ÅÂùóÂêàÂπ∂Êàê‰∏Ä‰∏™Ôºå‰ª•Èôç‰ΩéÂ§öÊ¨°ÈîÅËØ∑Ê±Ç„ÄÅÂêåÊ≠•„ÄÅÈáäÊîæÂ∏¶Êù•ÁöÑÁ≥ªÁªüÊÄßËÉΩÊ∂àËÄóÔºåÂêàÂπ∂ÂêéÁöÑ‰ª£Á†ÅÂ¶Ç‰∏ã:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomethingMethod</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//do some thing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">‰∏Ä‰∫õÂæàÂø´Â∞±ËÉΩÊâßË°åÂÆåÁöÑ‰ª£Á†Å</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//do other thing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âè¶‰∏ÄÁßçÈúÄË¶ÅÈîÅÁ≤óÂåñÁöÑÊûÅÁ´ØÁöÑÊÉÖÂÜµÊòØÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰∏äÈù¢‰ª£Á†ÅÊØèÊ¨°Âæ™ÁéØÈÉΩ‰ºöËøõË°åÈîÅÁöÑËØ∑Ê±Ç„ÄÅÂêåÊ≠•‰∏éÈáäÊîæÔºåÁúãËµ∑Êù•Ë≤å‰ººÊ≤°‰ªÄ‰πàÈóÆÈ¢òÔºå‰∏îÂú®jdkÂÜÖÈÉ®‰ºöÂØπËøôÁ±ª‰ª£Á†ÅÈîÅÁöÑËØ∑Ê±ÇÂÅö‰∏Ä‰∫õ‰ºòÂåñÔºå‰ΩÜÊòØËøò‰∏çÂ¶ÇÊääÂä†ÈîÅ‰ª£Á†ÅÂÜôÂú®Âæ™ÁéØ‰ΩìÁöÑÂ§ñÈù¢ÔºåËøôÊ†∑‰∏ÄÊ¨°ÈîÅÁöÑËØ∑Ê±ÇÂ∞±ÂèØ‰ª•ËææÂà∞Êàë‰ª¨ÁöÑË¶ÅÊ±ÇÔºåÈô§ÈùûÊúâÁâπÊÆäÁöÑÈúÄË¶ÅÔºöÂæ™ÁéØÈúÄË¶ÅËä±ÂæàÈïøÊó∂Èó¥Ôºå‰ΩÜÂÖ∂ÂÆÉÁ∫øÁ®ãÁ≠â‰∏çËµ∑ÔºåË¶ÅÁªôÂÆÉ‰ª¨ÊâßË°åÁöÑÊú∫‰ºö„ÄÇ</p>
<p>ÈîÅÁ≤óÂåñÂêéÁöÑ‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">synchronized</span><span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="413-ÈîÅÊ∂àÈô§">4.13 ÈîÅÊ∂àÈô§</h3>
<p>ÂΩì‰Ω†ÁöÑÈîÅÂØπË±°Â§Ñ‰∫é‰∏Ä‰∏™Êó†Ê≥ïË¢´ÂÖ∂‰ªñÁ∫øÁ®ãËÆøÈóÆÂà∞ÁöÑÁä∂ÊÄÅÊó∂ÔºåÂ∞±‰ºöÈªòËÆ§ËØ•Âä†ÈîÅÊó†ÊÑè‰πâÔºå‰∫éÊòØÂú®JITÂç≥Êó∂ÁºñËØëÊó∂‰æø‰ºö‰ΩøÁî®ÈîÅÊ∂àÈô§ÔºåÂç≥ÈªòËÆ§‰Ω†Ê≤°ÊúâÂä†ÈîÅÔºå‰ª•ÊèêÂçáÊÄßËÉΩÊïàÁéáÔºà‰ΩÜÊòØÊàëÊ≤°ÊµãËØïÂá∫Êù•Ôºâ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">num</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">a</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;test3 time {}ms&#34;</span><span class="o">,</span><span class="n">endTime</span><span class="o">-</span><span class="n">startTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test4</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">num</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">obj</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">a</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;test4 time {}ms&#34;</span><span class="o">,</span><span class="n">endTime</span><span class="o">-</span><span class="n">startTime</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Â¶ÇÊûúÊ≤°Êúâ‰ΩøÁî®ÈîÅÊ∂àÈô§ÊÄßËÉΩÂ∑ÆÂà´ÂçÅÂàÜ‰πãÂ§ß</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">23:10:33.602 [main] DEBUG JUC.c_monitor.LockClear - test3 time 1ms
</span></span><span class="line"><span class="cl">23:10:33.625 [main] DEBUG JUC.c_monitor.LockClear - test4 time 17ms
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="414-Ê¥ªË∑ÉÊÄß">4.14 Ê¥ªË∑ÉÊÄß</h3>
<h4 id="Ê≠ªÈîÅ">Ê≠ªÈîÅ</h4>
<p>Ê≠ªÈîÅÊòØÊåá‰∏§‰∏™Êàñ‰∏§‰∏™‰ª•‰∏äÁöÑËøõÁ®ãÂú®ÊâßË°åËøáÁ®ã‰∏≠ÔºåÁî±‰∫éÁ´û‰∫âËµÑÊ∫êÊàñËÄÖÁî±‰∫éÂΩºÊ≠§ÈÄö‰ø°ËÄåÈÄ†ÊàêÁöÑ‰∏ÄÁßçÈòªÂ°ûÁöÑÁé∞Ë±°ÔºåËã•Êó†Â§ñÂäõ‰ΩúÁî®ÔºåÂÆÉ‰ª¨ÈÉΩÂ∞ÜÊó†Ê≥ïÁªßÁª≠ËøêË°å„ÄÇÊ≠§Êó∂Áß∞Á≥ªÁªüÂ§Ñ‰∫éÊ≠ªÈîÅÁä∂ÊÄÅÊàñÁ≥ªÁªü‰∫ßÁîü‰∫ÜÊ≠ªÈîÅÔºåËøô‰∫õÊ∞∏ËøúÂú®‰∫íÁõ∏Á≠âÂæÖÁöÑËøõÁ®ãÁß∞‰∏∫Ê≠ªÈîÅËøõÁ®ã„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">deadLock</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">static</span> <span class="n">Object</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">   <span class="kd">static</span> <span class="n">Object</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">b</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;lock b&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">a</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;lock a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">a</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;lock a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">b</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;lock a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="Âì≤Â≠¶ÂÆ∂ÈóÆÈ¢ò">Âì≤Â≠¶ÂÆ∂ÈóÆÈ¢ò</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220328230132533.png"
	
	
	
	loading="lazy"
	
		alt="image-20220328230132533"
	
	
></p>
<h5 id="Âì≤Â≠¶ÂÆ∂ÈóÆÈ¢òËß£ÂÜ≥">Âì≤Â≠¶ÂÆ∂ÈóÆÈ¢òËß£ÂÜ≥</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">JUC.e_ReentrantLock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">JUC.util.Sleeper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">famliyEating</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Chopstick</span> <span class="n">c1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chopstick</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Chopstick</span> <span class="n">c2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chopstick</span><span class="o">(</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Chopstick</span> <span class="n">c3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chopstick</span><span class="o">(</span><span class="s">&#34;3&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Chopstick</span> <span class="n">c4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chopstick</span><span class="o">(</span><span class="s">&#34;4&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Chopstick</span> <span class="n">c5</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Chopstick</span><span class="o">(</span><span class="s">&#34;5&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Famliy</span><span class="o">(</span><span class="s">&#34;Áà∏Áà∏&#34;</span><span class="o">,</span><span class="n">c1</span><span class="o">,</span><span class="n">c2</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Famliy</span><span class="o">(</span><span class="s">&#34;Â¶àÂ¶à&#34;</span><span class="o">,</span><span class="n">c2</span><span class="o">,</span><span class="n">c3</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Famliy</span><span class="o">(</span><span class="s">&#34;ÂÑøÂ≠ê&#34;</span><span class="o">,</span><span class="n">c3</span><span class="o">,</span><span class="n">c4</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Famliy</span><span class="o">(</span><span class="s">&#34;Áà∑Áà∑&#34;</span><span class="o">,</span><span class="n">c4</span><span class="o">,</span><span class="n">c5</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Famliy</span><span class="o">(</span><span class="s">&#34;Â•∂Â•∂&#34;</span><span class="o">,</span><span class="n">c5</span><span class="o">,</span><span class="n">c1</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Famliy</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Chopstick</span> <span class="n">left</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Chopstick</span> <span class="n">right</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Famliy</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">Chopstick</span> <span class="n">left</span><span class="o">,</span> <span class="n">Chopstick</span> <span class="n">right</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">left</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">right</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Chopstick</span> <span class="nf">getLeft</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">left</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Chopstick</span> <span class="nf">getRight</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">right</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eat</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;[{}]Ê≠£Âú®ÂêÉÈ•≠&#34;</span><span class="o">,</span><span class="n">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Sleeper.sleep(1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>             <span class="k">if</span><span class="o">(</span><span class="n">left</span><span class="o">.</span><span class="na">tryLock</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                 <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                     <span class="c1">//log.debug(&#34;[{}] ÊãøÂà∞Â∑¶ÊâãÁ≠∑Â≠ê[{}]&#34;,getName(),getLeft().getName());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                     <span class="k">if</span><span class="o">(</span><span class="n">right</span><span class="o">.</span><span class="na">tryLock</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                         <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                             <span class="c1">//log.debug(&#34;[{}] ÊãøÂà∞Âè≥ÊâãÁ≠∑Â≠ê[{}]&#34;,getName(),getRight().getName());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                             <span class="n">eat</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                         <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                             <span class="c1">//log.debug(&#34;[{}] Êîæ‰∏ãÂè≥ÊâãÁ≠∑Â≠ê[{}]&#34;,getName(),getRight().getName());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                             <span class="n">right</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                         <span class="o">}</span>
</span></span><span class="line"><span class="cl">                     <span class="o">}</span>
</span></span><span class="line"><span class="cl">                 <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                     <span class="c1">//log.debug(&#34;[{}] Êîæ‰∏ãÂ∑¶ÊâãÁ≠∑Â≠ê[{}]&#34;,getName(),getLeft().getName());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                     <span class="n">left</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                 <span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Chopstick</span> <span class="kd">extends</span> <span class="n">ReentrantLock</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Chopstick</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="Ê¥ªÈîÅ">Ê¥ªÈîÅ</h4>
<p>Ê¥ªÈîÅÊòØÊåá‰∏§‰∏™Êàñ‰∏§‰∏™‰ª•‰∏äÁöÑËøõÁ®ãÂú®ÊâßË°åËøáÁ®ã‰∏≠ÔºåÁî±‰∫éËµÑÊ∫êÂÖ±‰∫´Ôºå‰∏çÊñ≠Êõ¥ÊîπÂÖ∂‰ªñÁ∫øÁ®ãÁöÑÁªìÊùüÊù°‰ª∂ÔºåËôΩÁÑ∂Áä∂ÊÄÅÂèØ‰ª•ÊîπÂèòÔºåÂç¥Ê≤°ÊúâÂÆûË¥®ÁöÑËøõÂ±ïÔºåÂØºËá¥Á∫øÁ®ã‰∏ÄÁõ¥ËøêË°å‰∏ãÂéª</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">aliveLock</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span><span class="o">(</span><span class="n">i</span><span class="o">&gt;</span><span class="n">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;i:{}&#34;</span><span class="o">,</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span>
</span></span><span class="line"><span class="cl">         <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span><span class="o">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">20</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">i</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;i:{}&#34;</span><span class="o">,</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span>
</span></span><span class="line"><span class="cl">         <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="È••È•ø">È••È•ø</h4>
<p>Áî±‰∫éÁ∫øÁ®ã‰ºòÂÖàÁ∫ßÂàÜÈÖç‰∏çÂêàÁêÜÔºå‰∏Ä‰∏™Á∫øÁ®ãÂú®Êó†ÈôêÂú∞Á≠âÂæÖÂè¶Â§ñ‰∏§‰∏™ÊàñÂ§ö‰∏™Á∫øÁ®ãÁõ∏‰∫í‰º†ÈÄí‰ΩøÁî®Âπ∂‰∏îÁî®‰∏ç‰ºöÈáäÊîæÁöÑËµÑÊ∫ê„ÄÇ</p>
<h3 id="415-‰ªéÊ∫êÁ†ÅÂéªÁúãsynchronized">4.15 ‰ªéÊ∫êÁ†ÅÂéªÁúãsynchronized</h3>
<h4 id="monitorÁªìÊûÑ">monitorÁªìÊûÑ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ObjectMonitor</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="n">ObjectMonitor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_header</span>       <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">//markOopÂØπË±°Â§¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_count</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">    <span class="n">_waiters</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1">//Á≠âÂæÖÁ∫øÁ®ãÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_recursions</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">//ÈáçÂÖ•Ê¨°Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_object</span>       <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">_owner</span>        <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="c1">//Ëé∑ÂæóObjectMonitorÂØπË±°ÁöÑÁ∫øÁ®ã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_WaitSet</span>      <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="c1">//Â§Ñ‰∫éwaitÁä∂ÊÄÅÁöÑÁ∫øÁ®ãÔºå‰ºöË¢´Âä†ÂÖ•Âà∞waitSet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_WaitSetLock</span>  <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_Responsible</span>  <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_succ</span>         <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_cxq</span>          <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FreeNext</span>      <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_EntryList</span>    <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span> <span class="c1">//Â§Ñ‰∫éÁ≠âÂæÖÈîÅBLOCKEDÁä∂ÊÄÅÁöÑÁ∫øÁ®ã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_SpinFreq</span>     <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>   
</span></span><span class="line"><span class="cl">    <span class="n">_SpinClock</span>    <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">OwnerIsThread</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">_previous_owner_tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//ÁõëËßÜÂô®Ââç‰∏Ä‰∏™Êã•ÊúâÁ∫øÁ®ãÁöÑID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>synchronized‰∏äÈîÅÊó∂ÂàÜÂà´Ë∞ÉÁî®‰∫Ü monitorenterÔºåmonitorexit‰∏§‰∏™ÂáΩÊï∞ÔºåÁî±Ê≠§Êàë‰ª¨ÈÄöËøáËøô‰∏§‰∏™ÂáΩÊï∞Êù•Êé¢Á¥¢synchronized</strong></p>
<h4 id="monitorenterinterpeterruntimecpp">monitorenter(interpeterRuntime.cpp)</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">IRT_ENTRY_NO_ASYNC</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">InterpreterRuntime</span><span class="o">::</span><span class="n">monitorenter</span><span class="p">(</span><span class="n">JavaThread</span><span class="o">*</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">BasicObjectLock</span><span class="o">*</span> <span class="n">elem</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef ASSERT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">().</span><span class="n">interpreter_frame_verify_monitor</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">PrintBiasedLockingStatistics</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Atomic</span><span class="o">::</span><span class="n">inc</span><span class="p">(</span><span class="n">BiasedLocking</span><span class="o">::</span><span class="n">slow_path_entry_count_addr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">Handle</span> <span class="nf">h_obj</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">UseBiasedLocking</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Retry fast entry if bias is revoked to avoid unnecessary inflation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">fast_enter</span><span class="p">(</span><span class="n">h_obj</span><span class="p">,</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">(),</span> <span class="nb">true</span><span class="p">,</span> <span class="n">CHECK</span><span class="p">);</span><span class="c1">//ÂÅèÂêëÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">slow_enter</span><span class="p">(</span><span class="n">h_obj</span><span class="p">,</span> <span class="n">elem</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">(),</span> <span class="n">CHECK</span><span class="p">);</span><span class="c1">//ËΩªÈáèÁ∫ßÈîÅ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">Universe</span><span class="o">::</span><span class="n">heap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_in_reserved_or_null</span><span class="p">(</span><span class="n">elem</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;must be NULL or an object&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef ASSERT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="kr">thread</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">().</span><span class="n">interpreter_frame_verify_monitor</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">IRT_END</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ÂΩìÂºÄÂêØÂÅèÂêëÈîÅÊó∂ÔºåËøõÂÖ•fast_enterÔºåÂÅèÂêëÈîÅÂä†ÈîÅÊµÅÁ®ã</p>
<p>ÂΩìÊú™ÂºÄÂêØÂÅèÂêëÈîÅÔºåËøõÂÖ•slow_enterÔºåËΩªÈáèÁ∫ßÈîÅÂä†ÈîÅÊµÅÁ®ã</p>
</blockquote>
<h4 id="ÂÅèÂêëÈîÅÁéØËäÇ">ÂÅèÂêëÈîÅÁéØËäÇ</h4>
<h5 id="fast_enter">fast_enter</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">fast_enter</span><span class="p">(</span><span class="n">Handle</span> <span class="n">obj</span><span class="p">,</span> <span class="n">BasicLock</span><span class="o">*</span> <span class="n">lock</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">attempt_rebias</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="n">UseBiasedLocking</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//Âà§Êñ≠ÊòØÂê¶ÂºÄÂêØ‰∫ÜÂÅèÂêëÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SafepointSynchronize</span><span class="o">::</span><span class="n">is_at_safepoint</span><span class="p">())</span> <span class="p">{</span> <span class="c1">//Â¶ÇÊûú‰∏çÂ§Ñ‰∫éÂÖ®Â±ÄÂÆâÂÖ®ÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//ÈÄöËøá`revoke_and_rebias`Ëøô‰∏™ÂáΩÊï∞Â∞ùËØïËé∑ÂèñÂÅèÂêëÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">Condition</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">revoke_and_rebias</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attempt_rebias</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">==</span> <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">BIAS_REVOKED_AND_REBIASED</span><span class="p">)</span> <span class="p">{</span><span class="c1">//Â¶ÇÊûúÊòØÊí§ÈîÄ‰∏éÈáçÂÅèÂêëÁõ¥Êé•ËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="c1">//Â¶ÇÊûúÂú®ÂÆâÂÖ®ÁÇπÔºåÊí§ÈîÄÂÅèÂêëÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">attempt_rebias</span><span class="p">,</span> <span class="s">&#34;can not rebias toward VM thread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">revoke_at_safepoint</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">has_bias_pattern</span><span class="p">(),</span> <span class="s">&#34;biases should be revoked by now&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">slow_enter</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">)</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1ÔºåÂà§Êñ≠ÊòØÂê¶ÂºÄÂêØÂÅèÂêëÈîÅ</p>
<p>2ÔºåÂà§Êñ≠ËØ•ÁÇπÊòØÂê¶‰∏∫ÂÖ®Â±ÄÂÆâÂÖ®ÁÇπ</p>
<p>3ÔºåÂê¶ÔºåËøõË°åÊí§ÈîÄÂπ∂ÈáçÊñ∞ÂÅèÂêëÔºåÊàêÂäüÂàôËøîÂõûÔºå‰∏çÊòØÂàôËΩªÈáèÁ∫ßÈîÅËé∑Âèñ</p>
<p>4ÔºåÊòØÔºåÂàôÊí§ÈîÄÂÅèÂêëÈîÅÔºåÂπ∂‰∏îËøõË°åËΩªÈáèÁ∫ßÈîÅËé∑Âèñ</p>
</blockquote>
<h5 id="revoke_at_safepoint">revoke_at_safepoint</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">BiasedLocking</span><span class="o">::</span><span class="n">revoke_at_safepoint</span><span class="p">(</span><span class="n">Handle</span> <span class="n">h_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">SafepointSynchronize</span><span class="o">::</span><span class="n">is_at_safepoint</span><span class="p">(),</span> <span class="s">&#34;must only be called while at safepoint&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">oop</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">h_obj</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//Êõ¥Êñ∞Êí§ÈîÄÂÅèÂêëÈîÅËÆ°Êï∞ÔºåÂπ∂ËøîÂõûÂÅèÂêëÈîÅÊí§ÈîÄÊ¨°Êï∞ÂíåÂÅèÂêëÊ¨°Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">HeuristicsResult</span> <span class="n">heuristics</span> <span class="o">=</span> <span class="n">update_heuristics</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">heuristics</span> <span class="o">==</span> <span class="n">HR_SINGLE_REVOKE</span><span class="p">)</span> <span class="p">{</span><span class="c1">//ÂèØÂÅèÂêë‰∏îÊú™ËææÂà∞ÊâπÈáèÂ§ÑÁêÜÁöÑÈòàÂÄº(‰∏ãÈù¢‰ºöÂçïÁã¨Ëß£Èáä)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">revoke_bias</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">//Êí§ÈîÄÂÅèÂêëÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">((</span><span class="n">heuristics</span> <span class="o">==</span> <span class="n">HR_BULK_REBIAS</span><span class="p">)</span> <span class="o">||</span> 
</span></span><span class="line"><span class="cl">             <span class="p">(</span><span class="n">heuristics</span> <span class="o">==</span> <span class="n">HR_BULK_REVOKE</span><span class="p">))</span> <span class="p">{</span><span class="c1">//Â¶ÇÊûúÊòØÂ§öÊ¨°Êí§ÈîÄÊàñËÄÖÂ§öÊ¨°ÂÅèÂêë
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ÊâπÈáèÊí§ÈîÄ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">bulk_revoke_or_rebias_at_safepoint</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">heuristics</span> <span class="o">==</span> <span class="n">HR_BULK_REBIAS</span><span class="p">),</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">clean_up_cached_monitor_info</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>JVMÂÜÖÈÉ®‰∏∫ÊØè‰∏™Á±ªÁª¥Êä§‰∫Ü‰∏Ä‰∏™ÂÅèÂêëÈîÅrevokeËÆ°Êï∞Âô®ÔºåÂØπÂÅèÂêëÈîÅÊí§ÈîÄËøõË°åËÆ°Êï∞ÔºåÂΩìËøô‰∏™ÂÄºËææÂà∞ÊåáÂÆöÈòàÂÄºÊó∂ÔºåJVM‰ºöËÆ§‰∏∫Ëøô‰∏™Á±ªÁöÑÂÅèÂêëÈîÅÊúâÈóÆÈ¢òÔºåÈúÄË¶ÅÈáçÊñ∞ÂÅèÂêë(rebias),ÂØπÊâÄÊúâÂ±û‰∫éËøô‰∏™Á±ªÁöÑÂØπË±°ËøõË°åÈáçÂÅèÂêëÁöÑÊìç‰ΩúÊàê‰∏∫ ÊâπÈáèÈáçÂÅèÂêë(bulk rebias)„ÄÇÂú®ÂÅöbulk rebiasÊó∂Ôºå‰ºöÂØπËøô‰∏™Á±ªÁöÑepochÁöÑÂÄºÂÅöÈÄíÂ¢ûÔºåËøô‰∏™epoch‰ºöÂ≠òÂÇ®Âú®ÂØπË±°Â§¥‰∏≠ÁöÑepochÂ≠óÊÆµ„ÄÇÂú®Âà§Êñ≠Ëøô‰∏™ÂØπË±°ÊòØÂê¶Ëé∑ÂæóÂÅèÂêëÈîÅÁöÑÊù°‰ª∂ÊòØ:markwordÁöÑ biased_lock:1„ÄÅlock:01„ÄÅthreadidÂíåÂΩìÂâçÁ∫øÁ®ãidÁõ∏Á≠â„ÄÅepochÂ≠óÊÆµÂíåÊâÄÂ±ûÁ±ªÁöÑepochÂÄºÁõ∏ÂêåÔºåÂ¶ÇÊûúepochÁöÑÂÄº‰∏ç‰∏ÄÊ†∑ÔºåË¶Å‰πàÂ∞±ÊòØÊí§ÈîÄÂÅèÂêëÈîÅ„ÄÅË¶Å‰πàÂ∞±ÊòØrebiasÔºõ Â¶ÇÊûúËøô‰∏™Á±ªÁöÑrevokeËÆ°Êï∞Âô®ÁöÑÂÄºÁªßÁª≠Â¢ûÂä†Âà∞‰∏Ä‰∏™ÈòàÂÄºÔºåÈÇ£‰πàjvm‰ºöËÆ§‰∏∫Ëøô‰∏™Á±ª‰∏çÈÄÇÂêàÂÅèÂêëÈîÅÔºåÂ∞±ÈúÄË¶ÅËøõË°åbulk revokeÊìç‰Ωú</p>
</blockquote>
<h4 id="ËΩªÈáèÁ∫ßÈîÅÁéØËäÇ">ËΩªÈáèÁ∫ßÈîÅÁéØËäÇ</h4>
<h5 id="slow_enter">slow_enter</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">slow_enter</span><span class="p">(</span><span class="n">Handle</span> <span class="n">obj</span><span class="p">,</span> <span class="n">BasicLock</span><span class="o">*</span> <span class="n">lock</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">markOop</span> <span class="n">mark</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_bias_pattern</span><span class="p">(),</span> <span class="s">&#34;should not see bias pattern here&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">())</span> <span class="p">{</span> <span class="c1">//Â¶ÇÊûúÂΩìÂâçÂØπË±°‰∏∫Êó†ÈîÅÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lock</span><span class="o">-&gt;</span><span class="n">set_displaced_header</span><span class="p">(</span><span class="n">mark</span><span class="p">);</span> <span class="c1">//Â§çÂà∂‰∏Ä‰ªΩlock record ÂåÖÂê´ markword
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="n">obj</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">cas_set_mark</span><span class="p">((</span><span class="n">markOop</span><span class="p">)</span> <span class="n">lock</span><span class="p">,</span> <span class="n">mark</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// ËøõË°åCASÂπ∂Â∞Ülock recordÊîæÂÖ•Ê†àÂ∏ß
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">TEVENT</span><span class="p">(</span><span class="nl">slow_enter</span><span class="p">:</span> <span class="n">release</span> <span class="n">stacklock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_locker</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">             <span class="n">THREAD</span><span class="o">-&gt;</span><span class="n">is_lock_owned</span><span class="p">((</span><span class="n">address</span><span class="p">)</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">locker</span><span class="p">()))</span> <span class="p">{</span> <span class="c1">//Â¶ÇÊûúÂΩìÂâçÂØπË±°Â∑≤ÁªèÊúâÈîÅÔºå‰∏îÈîÅÂØπË±°‰∏∫Ëá™Â∑±ÔºåÂàôËøõË°åÈîÅÈáçÂÖ•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="n">mark</span><span class="o">-&gt;</span><span class="n">locker</span><span class="p">(),</span> <span class="s">&#34;must not re-lock the same lock&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">lock</span> <span class="o">!=</span> <span class="p">(</span><span class="n">BasicLock</span><span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">(),</span> <span class="s">&#34;don&#39;t relock with same BasicLock&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">-&gt;</span><span class="n">set_displaced_header</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> <span class="c1">//Â§çÂà∂‰∏Ä‰ªΩ null ÁöÑ lock record ÊîæÂÖ•Ê†àÂ∏ß
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">lock</span><span class="o">-&gt;</span><span class="n">set_displaced_header</span><span class="p">(</span><span class="n">markOopDesc</span><span class="o">::</span><span class="n">unused_mark</span><span class="p">());</span> <span class="c1">//Â∞Ümark wordÂêé‰∏â‰ΩçËÆæÁΩÆ‰∏∫ GC ÂõûÊî∂Ê†áÂøó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ËøõÂÖ•ÈîÅËÜ®ËÉÄ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">inflate</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">obj</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                              <span class="n">inflate_cause_monitor_enter</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enter</span><span class="p">(</span><span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>ËΩªÈáèÁ∫ßÈîÅÁöÑÈáäÊîæËøáÁ®ã</em></p>
<p><em>monitorexit-&gt;slow_exit-&gt;fast_exitÔºåËøôÈáåË∑≥ËøáÂâç‰∏§‰∏™Ê≠•È™§Áõ¥Êé•Â±ïÁ§∫fast_exit</em></p>
<h5 id="fast_exit">fast_exit</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">fast_exit</span><span class="p">(</span><span class="n">oop</span> <span class="n">object</span><span class="p">,</span> <span class="n">BasicLock</span><span class="o">*</span> <span class="n">lock</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">markOop</span> <span class="n">mark</span> <span class="o">=</span> <span class="n">object</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="n">markOopDesc</span><span class="o">::</span><span class="n">INFLATING</span><span class="p">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">         <span class="o">!</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_bias_pattern</span><span class="p">(),</span> <span class="s">&#34;should not see bias pattern here&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">markOop</span> <span class="n">dhw</span> <span class="o">=</span> <span class="n">lock</span><span class="o">-&gt;</span><span class="n">displaced_header</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Â¶ÇÊûú‰∏∫ÈáçÂÖ•ÈîÅÂàô‰ªÄ‰πàÈÉΩ‰∏çÂÅö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">dhw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef PRODUCT
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">!=</span> <span class="n">markOopDesc</span><span class="o">::</span><span class="n">INFLATING</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_locker</span><span class="p">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">             <span class="n">THREAD</span><span class="o">-&gt;</span><span class="n">is_lock_owned</span><span class="p">((</span><span class="n">address</span><span class="p">)</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">locker</span><span class="p">()),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_monitor</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectMonitor</span> <span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="n">mark</span><span class="o">-&gt;</span><span class="n">monitor</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(((</span><span class="n">oop</span><span class="p">)(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">()))</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()</span> <span class="o">==</span> <span class="n">mark</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">is_entered</span><span class="p">(</span><span class="n">THREAD</span><span class="p">),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//Â¶ÇÊûúmarkword == displaced mark wordÂç≥ËΩªÈáèÁ∫ßÈîÅÔºåcasÊõøÊç¢ÂØπË±°Â§¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="p">(</span><span class="n">markOop</span><span class="p">)</span> <span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">dhw</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">cas_set_mark</span><span class="p">(</span><span class="n">dhw</span><span class="p">,</span> <span class="n">mark</span><span class="p">)</span> <span class="o">==</span> <span class="n">mark</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="nl">fast_exit</span><span class="p">:</span> <span class="n">release</span> <span class="n">stack</span><span class="o">-</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">inflate</span><span class="p">(</span><span class="n">THREAD</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">object</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">inflate_cause_vm_internal</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÈáçÈáèÁ∫ßÈîÅÁéØËäÇ">ÈáçÈáèÁ∫ßÈîÅÁéØËäÇ</h4>
<h5 id="inflate">inflate</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">ObjectMonitor</span><span class="o">*</span> <span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">inflate</span><span class="p">(</span><span class="n">Thread</span> <span class="o">*</span> <span class="n">Self</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="n">oop</span> <span class="n">object</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                     <span class="k">const</span> <span class="n">InflateCause</span> <span class="n">cause</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">Universe</span><span class="o">::</span><span class="n">verify_in_progress</span><span class="p">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">         <span class="o">!</span><span class="n">SafepointSynchronize</span><span class="o">::</span><span class="n">is_at_safepoint</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">EventJavaMonitorInflate</span> <span class="n">event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">markOop</span> <span class="n">mark</span> <span class="o">=</span> <span class="n">object</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_bias_pattern</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The mark can be in one of the following states:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *  Inflated     - just return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *  Stack-locked - coerce it to inflated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *  INFLATING    - busy wait for conversion to complete
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *  Neutral      - aggressively inflate the object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// *  BIASED       - Illegal.  We should never see this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="c1">//Â¶ÇÊûúÊîπÂØπË±°Â∑≤Áªè‰∏∫ÈáçÈáèÁ∫ßÈîÅÔºåÂàôÁõ¥Êé•ËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_monitor</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectMonitor</span> <span class="o">*</span> <span class="n">inf</span> <span class="o">=</span> <span class="n">mark</span><span class="o">-&gt;</span><span class="n">monitor</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">()</span> <span class="o">==</span> <span class="n">object</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">ObjectSynchronizer</span><span class="o">::</span><span class="n">verify_objmon_isinpool</span><span class="p">(</span><span class="n">inf</span><span class="p">),</span> <span class="s">&#34;monitor is invalid&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">inf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//Â¶ÇÊûúÊîπÂØπË±°Ê≠£Âú®ËÜ®ËÉÄÔºåÂàôËá™ÊóãÁ≠âÂæÖ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">==</span> <span class="n">markOopDesc</span><span class="o">::</span><span class="n">INFLATING</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="nl">Inflate</span><span class="p">:</span> <span class="n">spin</span> <span class="k">while</span> <span class="n">INFLATING</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ËØ•ÊñπÊ≥ï‰∏≠ËøõË°åËá™Êóã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ReadStableMark</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//Â¶ÇÊûúÂ∑≤ÁªèÊã•ÊúâÈîÅÔºåÂç≥ËΩªÈáèÁ∫ßÈîÅÁä∂ÊÄÅÔºåÂàôÂàùÂßãÂåñmonitor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">has_locker</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ÂàõÂª∫monitor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ObjectMonitor</span> <span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="n">omAlloc</span><span class="p">(</span><span class="n">Self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">Recycle</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">_Responsible</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ËÆæÁΩÆÈáçÂÖ•Ê¨°Êï∞‰∏∫0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">m</span><span class="o">-&gt;</span><span class="n">_recursions</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">_SpinDuration</span> <span class="o">=</span> <span class="n">ObjectMonitor</span><span class="o">::</span><span class="n">Knob_SpinLimit</span><span class="p">;</span>   <span class="c1">// Consider: maintain by type/class
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Â∞ÜmarkÂ§¥ËÆæÁΩÆ‰∏∫Ê≠£Âú®ËÜ®ËÉÄÔºåINFLAGTING(0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">markOop</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">object</span><span class="o">-&gt;</span><span class="n">cas_set_mark</span><span class="p">(</span><span class="n">markOopDesc</span><span class="o">::</span><span class="n">INFLATING</span><span class="p">(),</span> <span class="n">mark</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">!=</span> <span class="n">mark</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">omRelease</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="p">;</span>       <span class="c1">// Interference -- just retry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//Ê†à‰∏≠ÁöÑdisplaced_mark_word
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">markOop</span> <span class="n">dmw</span> <span class="o">=</span> <span class="n">mark</span><span class="o">-&gt;</span><span class="n">displaced_mark_helper</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">dmw</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ËÆæÁΩÆmonitorÂ≠óÊÆµÔºåÊääÂØπË±°markword‰ø°ÊÅØ‰øùÂ≠òÂú® monitor‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_header</span><span class="p">(</span><span class="n">dmw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Êäämark‰∏≠ÁöÑÁ∫øÁ®ãlock recordËÆæÁΩÆ‰∏∫ownerÔºåÊâÄ‰ª•ËøôÈáåownerÊåáÂêëÁöÑÊòØÁ∫øÁ®ã‰∏≠ÁöÑlock recordÊàñËÄÖ Á∫øÁ®ãÊú¨Ë∫´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_owner</span><span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">locker</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ËÆæÁΩÆ monitorÂØπË±°‰∏∫Âä†ÈîÅÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_object</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">guarantee</span><span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()</span> <span class="o">==</span> <span class="n">markOopDesc</span><span class="o">::</span><span class="n">INFLATING</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Â∞ÜÈîÅÂØπË±°ËÆæÁΩÆ‰∏∫ÈáçÈáèÁ∫ßÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">object</span><span class="o">-&gt;</span><span class="n">release_set_mark</span><span class="p">(</span><span class="n">markOopDesc</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="n">m</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">OM_PERFDATA_OP</span><span class="p">(</span><span class="n">Inflations</span><span class="p">,</span> <span class="n">inc</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="nl">Inflate</span><span class="p">:</span> <span class="n">overwrite</span> <span class="n">stacklock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">log_is_enabled</span><span class="p">(</span><span class="n">Debug</span><span class="p">,</span> <span class="n">monitorinflation</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">is_instance</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">ResourceMark</span> <span class="n">rm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">log_debug</span><span class="p">(</span><span class="n">monitorinflation</span><span class="p">)(</span><span class="s">&#34;Inflating object &#34;</span> <span class="n">INTPTR_FORMAT</span> <span class="s">&#34; , mark &#34;</span> <span class="n">INTPTR_FORMAT</span> <span class="s">&#34; , type %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">p2i</span><span class="p">(</span><span class="n">object</span><span class="p">),</span> <span class="n">p2i</span><span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">object</span><span class="o">-&gt;</span><span class="n">klass</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">external_name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">should_commit</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">post_monitor_inflate_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">object</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//Êó†Áä∂ÊÄÅÈîÅÔºå‰πüÊòØÁõ¥Êé•ÂàùÂßãÂåñÈîÅÔºåËøõË°åÈîÅËÜ®ËÉÄ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">is_neutral</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObjectMonitor</span> <span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="n">omAlloc</span><span class="p">(</span><span class="n">Self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">Recycle</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_header</span><span class="p">(</span><span class="n">mark</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_owner</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_object</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">_recursions</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">_Responsible</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span><span class="o">-&gt;</span><span class="n">_SpinDuration</span> <span class="o">=</span> <span class="n">ObjectMonitor</span><span class="o">::</span><span class="n">Knob_SpinLimit</span><span class="p">;</span>       <span class="c1">// consider: keep metastats by type/class
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      <span class="c1">//Â∞ÜÈîÅÊîπ‰∏∫ÈáçÈáèÁ∫ßÈîÅÔºåÂ¶ÇÊûúÂ§±Ë¥•ËØ¥ÊòéÊúâÂè¶‰∏Ä‰∏™Á∫øÁ®ãÂÜçinflateÔºåÂàôÈáäÊîæmonitor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">cas_set_mark</span><span class="p">(</span><span class="n">markOopDesc</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">mark</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mark</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_object</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_owner</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span><span class="o">-&gt;</span><span class="n">Recycle</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">omRelease</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">OM_PERFDATA_OP</span><span class="p">(</span><span class="n">Inflations</span><span class="p">,</span> <span class="n">inc</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">TEVENT</span><span class="p">(</span><span class="nl">Inflate</span><span class="p">:</span> <span class="n">overwrite</span> <span class="n">neutral</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">log_is_enabled</span><span class="p">(</span><span class="n">Debug</span><span class="p">,</span> <span class="n">monitorinflation</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">is_instance</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ResourceMark</span> <span class="n">rm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_debug</span><span class="p">(</span><span class="n">monitorinflation</span><span class="p">)(</span><span class="s">&#34;Inflating object &#34;</span> <span class="n">INTPTR_FORMAT</span> <span class="s">&#34; , mark &#34;</span> <span class="n">INTPTR_FORMAT</span> <span class="s">&#34; , type %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">p2i</span><span class="p">(</span><span class="n">object</span><span class="p">),</span> <span class="n">p2i</span><span class="p">(</span><span class="n">object</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">object</span><span class="o">-&gt;</span><span class="n">klass</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">external_name</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">should_commit</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">post_monitor_inflate_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">object</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>inflate</code>‰∏≠ÊòØ‰∏Ä‰∏™forÂæ™ÁéØÔºå‰∏ªË¶ÅÊòØ‰∏∫‰∫ÜÂ§ÑÁêÜÂ§öÁ∫øÁ®ãÂêåÊó∂Ë∞ÉÁî®inflateÁöÑÊÉÖÂÜµ„ÄÇÁÑ∂Âêé‰ºöÊ†πÊçÆÈîÅÂØπË±°ÁöÑÁä∂ÊÄÅËøõË°å‰∏çÂêåÁöÑÂ§ÑÁêÜÔºö</p>
<blockquote>
<p>1.Â∑≤ÁªèÊòØÈáçÈáèÁ∫ßÁä∂ÊÄÅÔºåËØ¥ÊòéËÜ®ËÉÄÂ∑≤ÁªèÂÆåÊàêÔºåÁõ¥Êé•ËøîÂõû</p>
<p>2.Â¶ÇÊûúÊòØËΩªÈáèÁ∫ßÈîÅÂàôÈúÄË¶ÅËøõË°åËÜ®ËÉÄÊìç‰Ωú</p>
<p>3.Â¶ÇÊûúÊòØËÜ®ËÉÄ‰∏≠Áä∂ÊÄÅÔºåÂàôËøõË°åÂøôÁ≠âÂæÖ</p>
<p>4.Â¶ÇÊûúÊòØÊó†ÈîÅÁä∂ÊÄÅÂàôÈúÄË¶ÅËøõË°åËÜ®ËÉÄÊìç‰Ωú5 wait notify</p>
</blockquote>
<p><strong>ËΩªÈáèÁ∫ßÈîÅËÜ®ËÉÄ</strong></p>
<blockquote>
<p>1ÔºåË∞ÉÁî®omAllocÂàÜÈÖç‰∏Ä‰∏™monitorÂØπË±°Âú®<code>omAlloc</code>ÊñπÊ≥ï‰∏≠‰ºöÂÖà‰ªéÁ∫øÁ®ãÁßÅÊúâÁöÑ<code>monitor</code>ÈõÜÂêà<code>omFreeList</code>‰∏≠ÂàÜÈÖçÂØπË±°ÔºåÂ¶ÇÊûú<code>omFreeList</code>‰∏≠Â∑≤ÁªèÊ≤°Êúâ<code>monitor</code>ÂØπË±°ÔºåÂàô‰ªéJVMÂÖ®Â±ÄÁöÑ<code>gFreeList</code>‰∏≠ÂàÜÈÖç‰∏ÄÊâπ<code>monitor</code>Âà∞<code>omFreeList</code>‰∏≠„ÄÇ</p>
<p>2ÔºåÂàùÂßãÂåñmonitorÂØπË±°</p>
<p>3ÔºåÂ∞ÜÁä∂ÊÄÅËÆæÁΩÆ‰∏∫INFLATING</p>
<p>4ÔºåheaderÂ≠óÊÆµ‰∏∫displaced mark wordÔºåownerÂ≠óÊÆµ‰∏∫lock recordÔºåobjÂ≠óÊÆµ‰∏∫ÈîÅÂØπË±°</p>
<p>5ÔºåËÆæÁΩÆ‰∏∫ÈáçÈáèÁ∫ßÈîÅÔºåÊåáÂêëÁ¨¨‰∏ÄÊ≠•ÂàÜÈÖçÁöÑmonitorÂØπË±°</p>
</blockquote>
<p><strong>Êó†ÈîÅÁä∂ÊÄÅËÜ®ËÉÄ</strong></p>
<blockquote>
<p>1.Ë∞ÉÁî®<code>omAlloc</code>ÂàÜÈÖç‰∏Ä‰∏™<code>ObjectMonitor</code>ÂØπË±°(‰ª•‰∏ãÁÆÄÁß∞monitor)</p>
<p>2.ÂàùÂßãÂåñ<code>monitor</code>ÂØπË±°</p>
<p>3.ËÆæÁΩÆ<code>monitor</code>ÁöÑheaderÂ≠óÊÆµ‰∏∫<code> mark word</code>ÔºåownerÂ≠óÊÆµ‰∏∫<code>null</code>ÔºåobjÂ≠óÊÆµ‰∏∫ÈîÅÂØπË±°</p>
<p>4.ËÆæÁΩÆÈîÅÂØπË±°Â§¥ÁöÑ<code>mark word</code>‰∏∫ÈáçÈáèÁ∫ßÈîÅÁä∂ÊÄÅÔºåÊåáÂêëÁ¨¨‰∏ÄÊ≠•ÂàÜÈÖçÁöÑ<code>monitor</code>ÂØπË±°</p>
</blockquote>
<p><strong>INFLATINGÂ≠òÂú®ÁöÑÂéüÂõ†</strong></p>
<blockquote>
<p>1ÔºåÂª∂ËøüÊã•ÊúâÈîÅÁöÑÁ∫øÁ®ãAÔºåÈáäÊîæÈîÅÁöÑÊó∂Èó¥ÔºåÂõ†‰∏∫Â∞ÜÈîÅÁä∂ÊÄÅËÆæÁΩÆ‰∏∫INFLATINGÊó∂ÔºåÁ∫øÁ®ãA‰ºöËß£ÈîÅÂ§±Ë¥•ÔºåÊ≠§Êó∂ÂèòÂåñËÜ®ËÉÄËøõÂÖ•INFLATINGËá™Êóã</p>
<p>2ÔºåÈò≤Ê≠¢hashcodeÈó™ÁÉÅÔºà‰∏çÂ§™ÊòéÁôΩÔºâ</p>
</blockquote>
<p>ÂΩìÈîÅËÜ®ËÉÄÂÆåÂêéÔºåËøõÂÖ•EnterÁéØËäÇ</p>
<h5 id="enter">Enter</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectMonitor</span><span class="o">::</span><span class="n">enter</span><span class="p">(</span><span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Thread</span> <span class="o">*</span> <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="n">THREAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Â¶ÇÊûúÂΩìÂâçÈîÅÊ≤°Êúâ‰∫∫Ëé∑ÂèñÔºåÂàôÂ∞ùËØïËé∑ÂèñÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="o">*</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span> <span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_owner</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_recursions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//ÈîÅÈáçÂÖ•ÔºåÊ¨°Êï∞+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">cur</span> <span class="o">==</span> <span class="n">Self</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_recursions</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Â¶ÇÊûúË¢´Âä†ÈîÅ‰πãÂâç‰∏∫ËΩªÈáèÁ∫ßÈîÅÔºå‰∏î‰∏∫ËΩªÈáèÁ∫ßÈîÅÁ¨¨‰∏ÄÊ¨°ÈîÅËÜ®ËÉÄËøõÂÖ•enterÊñπÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">is_lock_owned</span> <span class="p">((</span><span class="n">address</span><span class="p">)</span><span class="n">cur</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_recursions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;internal state error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//ÈîÅÈáçÂÖ•+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_recursions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_owner</span> <span class="o">=</span> <span class="n">Self</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">_Stalled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_Stalled</span> <span class="o">=</span> <span class="n">intptr_t</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//ÂÜçË∞ÉÁî®Á≥ªÁªüÂêåÊ≠•Êìç‰ΩúÂâçÔºåÂÖàÂ∞ùËØïËá™ÊóãÔºåËá™ÊóãÊàêÂäüËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">Knob_SpinEarly</span> <span class="o">&amp;&amp;</span> <span class="n">TrySpin</span> <span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_recursions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(((</span><span class="n">oop</span><span class="p">)(</span><span class="n">object</span><span class="p">()))</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">()</span> <span class="o">==</span> <span class="n">markOopDesc</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_Stalled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">is_Java_thread</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">JavaThread</span> <span class="o">*</span> <span class="n">jt</span> <span class="o">=</span> <span class="p">(</span><span class="n">JavaThread</span> <span class="o">*</span><span class="p">)</span> <span class="n">Self</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">SafepointSynchronize</span><span class="o">::</span><span class="n">is_at_safepoint</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">jt</span><span class="o">-&gt;</span><span class="n">thread_state</span><span class="p">()</span> <span class="o">!=</span> <span class="n">_thread_blocked</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_count</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Atomic</span><span class="o">::</span><span class="n">inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">EventJavaMonitorEnter</span> <span class="n">event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">{</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Âú®ËØ•ÊñπÊ≥ï‰∏≠Ë∞ÉÁî®Á≥ªÁªüÂêåÊ≠•ÊñπÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">jt</span><span class="o">-&gt;</span><span class="n">set_suspend_equivalent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ËøõÂÖ•EnterIÁéØËäÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">EnterI</span><span class="p">(</span><span class="n">THREAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ExitSuspendEquivalent</span><span class="p">(</span><span class="n">jt</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">_recursions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">_succ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">exit</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">Self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">jt</span><span class="o">-&gt;</span><span class="n">java_suspend_self</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Self</span><span class="o">-&gt;</span><span class="n">set_current_pending_monitor</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="enteri">EnterI</h5>
<p><strong>EnterIÁöÑÂéüÁêÜÂíåReentrantLockÁöÑÂéüÁêÜÂèäÂÖ∂Áõ∏‰ºº</strong></p>
<blockquote>
<p>‰∏Ä‰∏™<code>ObjectMonitor</code>ÂØπË±°ÂåÖÊã¨Ëøô‰πàÂá†‰∏™ÂÖ≥ÈîÆÂ≠óÊÆµÔºö<strong>cxq</strong>Ôºà‰∏ãÂõæ‰∏≠ÁöÑContentionListÔºâÔºå<strong>EntryList</strong> Ôºå<strong>WaitSet</strong>Ôºå<strong>owner</strong>„ÄÇ</p>
<p>ÂÖ∂‰∏≠cxq ÔºåEntryList ÔºåWaitSetÈÉΩÊòØÁî±ObjectWaiterÁöÑÈìæË°®ÁªìÊûÑÔºåownerÊåáÂêëÊåÅÊúâÈîÅÁöÑÁ∫øÁ®ã„ÄÇ</p>
<p>**ÂΩìÁ∫øÁ®ãÈáäÊîæÈîÅÊó∂Ôºå**‰ºö‰ªécxqÊàñEntryList‰∏≠ÊåëÈÄâ‰∏Ä‰∏™Á∫øÁ®ãÂî§ÈÜíÔºåË¢´ÈÄâ‰∏≠ÁöÑÁ∫øÁ®ãÂè´ÂÅö<code>Heir presumptive</code>Âç≥ÂÅáÂÆöÁªßÊâø‰∫∫_succÔºåÂ∞±ÊòØÂõæ‰∏≠ÁöÑ<code>Ready Thread</code>ÔºåÂÅáÂÆöÁªßÊâø‰∫∫Ë¢´Âî§ÈÜíÂêé‰ºöÂ∞ùËØïËé∑ÂæóÈîÅÔºå‰ΩÜ<code>synchronized</code>ÊòØÈùûÂÖ¨Âπ≥ÁöÑÔºåÊâÄ‰ª•ÂÅáÂÆöÁªßÊâø‰∫∫‰∏ç‰∏ÄÂÆöËÉΩËé∑ÂæóÈîÅÔºàËøô‰πüÊòØÂÆÉÂè´&quot;ÂÅáÂÆö&quot;ÁªßÊâø‰∫∫ÁöÑÂéüÂõ†Ôºâ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectMonitor</span><span class="o">::</span><span class="n">EnterI</span><span class="p">(</span><span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Thread</span> <span class="o">*</span> <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="n">THREAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">Self</span><span class="o">-&gt;</span><span class="n">is_Java_thread</span><span class="p">(),</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(((</span><span class="n">JavaThread</span> <span class="o">*</span><span class="p">)</span> <span class="n">Self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">thread_state</span><span class="p">()</span> <span class="o">==</span> <span class="n">_thread_blocked</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Â∞ùËØïËé∑ÂèñÈîÅÔºåËé∑ÂèñÈîÅÊàêÂäüÂàôËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">TryLock</span> <span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_Responsible</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">DeferredInitialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Â∞ùËØïËá™ÊóãÔºåËá™ÊóãËé∑ÂèñÈîÅÊàêÂäüÂàôËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">TrySpin</span> <span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_Responsible</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_Responsible</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Â∞ÜÁ∫øÁ®ãÂ∞ÅË£ÖÊàêObjectWaiterÔºåÊèíÂÖ•Âà∞_cxq‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ObjectWaiter</span> <span class="nf">node</span><span class="p">(</span><span class="n">Self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_ParkEvent</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">node</span><span class="p">.</span><span class="n">_prev</span>   <span class="o">=</span> <span class="p">(</span><span class="n">ObjectWaiter</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0xBAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">node</span><span class="p">.</span><span class="n">TState</span>  <span class="o">=</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">cg</span>
</span></span><span class="line"><span class="cl">  <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">nxt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//ÂÖàÂ∞ùËØïÂ∞ÜnodeÊèíÂÖ•Âà∞_cxqÂ§¥ÈÉ®ÔºåÂ¶ÇÊûúÊú™ÊàêÂäüÔºåÂàôCAS‰∏ÄÈÅçÔºåÂáèÂ∞ëÊèíÂÖ•Ê¨°Êï∞ÂíåÊï∞Èáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">node</span><span class="p">.</span><span class="n">_next</span> <span class="o">=</span> <span class="n">nxt</span> <span class="o">=</span> <span class="n">_cxq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_cxq</span><span class="p">,</span> <span class="n">nxt</span><span class="p">)</span> <span class="o">==</span> <span class="n">nxt</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TryLock</span> <span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">_Responsible</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//Âà§Êñ≠ÊòØÂê¶ËøòÊúâÁ∫øÁ®ãÂú®Á≠âÂæÖÔºåËã•Ê≤°ÊúâÂàôÂ∞Ü_ResponsibleËÆæÁΩÆÊú™Ëá™Â∑±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="n">SyncFlags</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nxt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">_EntryList</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_Responsible</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">enter</span> <span class="o">-</span> <span class="n">Contention</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nWakeups</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">recheckInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">TryLock</span><span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//Â¶ÇÊûú_Responsible==NullÂàôËÆæÁΩÆ‰∏∫Ëá™Â∑±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">SyncFlags</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_Responsible</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_Responsible</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//Â¶ÇÊûú_Responsible‰∏∫Ëá™Â∑± ÂàôÁ≠âÂæÖ‰∏ÄÂÆöÊó∂Èó¥Èó¥Èöî
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_Responsible</span> <span class="o">==</span> <span class="n">Self</span> <span class="o">||</span> <span class="p">(</span><span class="n">SyncFlags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">enter</span> <span class="o">-</span> <span class="n">park</span> <span class="n">TIMED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_ParkEvent</span><span class="o">-&gt;</span><span class="n">park</span><span class="p">((</span><span class="n">jlong</span><span class="p">)</span> <span class="n">recheckInterval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">recheckInterval</span> <span class="o">*=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">recheckInterval</span> <span class="o">&gt;</span> <span class="n">MAX_RECHECK_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">recheckInterval</span> <span class="o">=</span> <span class="n">MAX_RECHECK_INTERVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Â¶ÇÊûú_Responsible‰∏ç‰∏∫Ëá™Â∑±ÔºåÂàôÁõ¥Êé•park
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">enter</span> <span class="o">-</span> <span class="n">park</span> <span class="n">UNTIMED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_ParkEvent</span><span class="o">-&gt;</span><span class="n">park</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//Â∞ùËØïËé∑ÂèñÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">TryLock</span><span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">enter</span> <span class="o">-</span> <span class="n">Futile</span> <span class="n">wakeup</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">OM_PERFDATA_OP</span><span class="p">(</span><span class="n">FutileWakeups</span><span class="p">,</span> <span class="n">inc</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">++</span><span class="n">nWakeups</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">//Â∞ùËØïËá™ÊóãËé∑ÂèñÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">Knob_SpinAfterFutile</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">TrySpin</span><span class="p">(</span><span class="n">Self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">Knob_ResetEvent</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_ParkEvent</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Self</span><span class="o">-&gt;</span><span class="n">_ParkEvent</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//Ëøô‰∏ÄËΩÆËøòÊ≤°Ëµ∞Âá∫ÂéªÂàôÂèñÊ∂àÂÅáÂÆöÂÄôÈÄâ‰∫∫ËµÑÊ†ºÔºåÊ¥óÁâåÈáçÊñ∞Êù•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_succ</span> <span class="o">==</span> <span class="n">Self</span><span class="p">)</span> <span class="n">_succ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Ëµ∞Âá∫ËØ•Âæ™ÁéØ‰ª£Ë°®Â∑≤ÁªèËé∑ÂèñÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">object</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜÂΩìÂâçÁ∫øÁ®ãÁöÑnode‰ªécxqÊàñEntryList‰∏≠ÁßªÈô§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">UnlinkAfterAcquire</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_succ</span> <span class="o">==</span> <span class="n">Self</span><span class="p">)</span> <span class="n">_succ</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="n">Self</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_Responsible</span> <span class="o">==</span> <span class="n">Self</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Responsible</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span> <span class="c1">// Dekker pivot-point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">SyncFlags</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">OrderAccess</span><span class="o">::</span><span class="n">fence</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1ÔºåÂ∞ùËØïËé∑ÂèñÈîÅÂíåËá™Êóã</p>
<p>2ÔºåÁ∫øÁ®ãÂ∞ÅË£ÖÊ∑ªÂä†Âà∞_cxqÈòüÈ¶ñÔºåËØ•ËøáÁ®ã‰πü‰ºöÂ∞ùËØïËé∑ÂèñÈîÅ</p>
<p>3ÔºåËøõÂÖ•Âæ™ÁéØparkÔºå‰∏≠ÈÄî‰πü‰ºöÂ∞ùËØïËé∑ÂèñÈîÅÂíåËá™Êóã</p>
<p>4ÔºåË¢´Âî§ÈÜíÂêéÔºåÂÜçÊ¨°Â∞ùËØïËé∑ÂèñÈîÅ</p>
<p>5ÔºåÂ¶ÇÊûúËé∑ÂèñÈîÅÔºåÂàôÂ∞Ünode‰ªé_cxqÊàñËÄÖentryList‰∏≠ÁßªÈô§ÔºåÊÉÖÂÜµËá™Â∑±ÊâÄÂú®ÁöÑ ResponsibleÂíå succ</p>
<p><strong>Ê≥®Ôºö</strong></p>
<p>ÂΩìÁ´û‰∫âÂèëÁîüÊó∂ÔºåÈÄâÂèñ‰∏Ä‰∏™Á∫øÁ®ã‰Ωú‰∏∫<code>_Responsible</code>Ôºå<code>_Responsible</code>Á∫øÁ®ãË∞ÉÁî®ÁöÑÊòØÊúâÊó∂Èó¥ÈôêÂà∂ÁöÑ<code>park</code>ÊñπÊ≥ïÔºåÂÖ∂ÁõÆÁöÑÊòØÈò≤Ê≠¢Âá∫Áé∞<code>ÊêÅÊµÖ</code>Áé∞Ë±°„ÄÇ</p>
</blockquote>
<h5 id="exit">Exit</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ObjectMonitor</span><span class="o">::</span><span class="n">exit</span><span class="p">(</span><span class="kt">bool</span> <span class="n">not_suspended</span><span class="p">,</span> <span class="n">TRAPS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Thread</span> <span class="o">*</span> <span class="k">const</span> <span class="n">Self</span> <span class="o">=</span> <span class="n">THREAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//Â¶ÇÊûúÊ≠§Êó∂ËØ•Á∫øÁ®ã‰∏ç‰∏∫ÊåÅÊúâÈîÅÁöÑÁ∫øÁ®ã ‰ºöÊúâ‰ª•‰∏ã‰∏§ÁßçÊÉÖÂÜµ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">THREAD</span> <span class="o">!=</span> <span class="n">_owner</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//Âõ†‰∏∫Ëá™Â∑±ÊòØËΩªÈáèÁ∫ßÈîÅÔºåÈîÅËÜ®ËÉÄÂêéËøòÊ≤°Êù•ÂæóÂèä Enter ÂØºËá¥Á∫øÁ®ãÊ≤°ÂàáÊç¢ËøáÊù•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">THREAD</span><span class="o">-&gt;</span><span class="n">is_lock_owned</span><span class="p">((</span><span class="n">address</span><span class="p">)</span> <span class="n">_owner</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">_recursions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_owner</span> <span class="o">=</span> <span class="n">THREAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">_recursions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ÁúüÁöÑ‰∏çÊòØËá™Â∑±ÔºåÂ∞±È©¨‰∏äÁ¶ªÂºÄ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">TEVENT</span><span class="p">(</span><span class="n">Exit</span> <span class="o">-</span> <span class="n">Throw</span> <span class="n">IMSX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">&#34;Non-balanced monitor enter/exit! Likely JNI locking&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//ÈîÅÈáçÂÖ•ÊÉÖÂÜµÔºårecursion--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">_recursions</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_recursions</span><span class="o">--</span><span class="p">;</span>        <span class="c1">// this is simple recursive enter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">recursive</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//_ResponsibleËÆæÁΩÆ‰∏∫Null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="n">SyncFlags</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Responsible</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if INCLUDE_TRACE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">not_suspended</span> <span class="o">&amp;&amp;</span> <span class="n">Tracing</span><span class="o">::</span><span class="n">is_event_enabled</span><span class="p">(</span><span class="n">TraceJavaMonitorEnterEvent</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_previous_owner_tid</span> <span class="o">=</span> <span class="n">THREAD_TRACE_ID</span><span class="p">(</span><span class="n">Self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">THREAD</span> <span class="o">==</span> <span class="n">_owner</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">Knob_ExitPolicy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//code 1:ÂÖàÈáäÊîæÈîÅÔºåÈùûÂÖ¨Âπ≥ÈîÅÁöÑ‰ºòÂåñÔºåÊ≠§Êó∂Â¶ÇÊûúÊúâÁ∫øÁ®ãËøõÂÖ•ÂèØ‰ª•Áõ¥Êé•Ëé∑ÂèñÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">OrderAccess</span><span class="o">::</span><span class="n">release_store_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_owner</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">      <span class="n">OrderAccess</span><span class="o">::</span><span class="n">storeload</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//code 2: Â¶ÇÊûúÊ≤°ÊúâÁ≠âÂæÖÁöÑÁ∫øÁ®ãÔºåÊàñËÄÖÂ∑≤ÁªèÊúâÂÅáÂÆöÂÄôÈÄâ‰∫∫‰∫ÜÁõ¥Êé•ÂºÄÊ∫ú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">((</span><span class="n">intptr_t</span><span class="p">(</span><span class="n">_EntryList</span><span class="p">)</span><span class="o">|</span><span class="n">intptr_t</span><span class="p">(</span><span class="n">_cxq</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">_succ</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">simple</span> <span class="n">egress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Ê≠§Êó∂ËøõË°åÂêéÁª≠Ê≠•È™§ÈúÄË¶ÅÈáçÊñ∞Ëé∑ÂèñÈîÅÔºåÂ¶ÇÊûúËé∑ÂèñÈîÅÂ§±Ë¥•ÂàôËØ¥ÊòéÂ∑≤ÁªèÊúâÂ§ñÁïåÁ∫øÁ®ãÂç†Áî®ÈîÅÔºåÂàôÈÄÄÂá∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span> <span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_owner</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">TEVENT</span><span class="p">(</span><span class="n">Exit</span> <span class="o">-</span> <span class="n">Reacquired</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">((</span><span class="n">intptr_t</span><span class="p">(</span><span class="n">_EntryList</span><span class="p">)</span><span class="o">|</span><span class="n">intptr_t</span><span class="p">(</span><span class="n">_cxq</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">_succ</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">OrderAccess</span><span class="o">::</span><span class="n">release_store_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_owner</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>   <span class="c1">// drop the lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">OrderAccess</span><span class="o">::</span><span class="n">storeload</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_cxq</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">_succ</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">simple</span> <span class="n">egress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span> <span class="p">(</span><span class="n">THREAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_owner</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">reacquired</span> <span class="n">succeeded</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">reacquired</span> <span class="n">failed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">complex</span> <span class="n">egress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">guarantee</span><span class="p">(</span><span class="n">_owner</span> <span class="o">==</span> <span class="n">THREAD</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">w</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">QMode</span> <span class="o">=</span> <span class="n">Knob_QMode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// code 4ÔºöÊ†πÊçÆQModeÁöÑ‰∏çÂêå‰ºöÊúâ‰∏çÂêåÁöÑÂî§ÈÜíÁ≠ñÁï•ÔºåÈªòËÆ§‰∏∫0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">QMode</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">_cxq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// QMode == 2 : cxq‰∏≠ÁöÑÁ∫øÁ®ãÊúâÊõ¥È´ò‰ºòÂÖàÁ∫ßÔºåÁõ¥Êé•Âî§ÈÜícxqÁöÑÈòüÈ¶ñÁ∫øÁ®ã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">w</span> <span class="o">=</span> <span class="n">_cxq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">ExitEpilog</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">QMode</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">_cxq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â∞Ücxq‰∏≠ÁöÑÂÖÉÁ¥†ÊèíÂÖ•Âà∞EntryListÁöÑÊú´Â∞æ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">w</span> <span class="o">=</span> <span class="n">_cxq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">ObjectWaiter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_cxq</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">guarantee</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">=</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">Tail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">Tail</span> <span class="o">=</span> <span class="n">_EntryList</span><span class="p">;</span> <span class="n">Tail</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">Tail</span><span class="o">-&gt;</span><span class="n">_next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">           <span class="n">Tail</span> <span class="o">=</span> <span class="n">Tail</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">Tail</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_EntryList</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Tail</span><span class="o">-&gt;</span><span class="n">_next</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">Tail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">QMode</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">_cxq</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â∞ÜcxqÊèíÂÖ•Âà∞EntryListÁöÑÈòüÈ¶ñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">w</span> <span class="o">=</span> <span class="n">_cxq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">ObjectWaiter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_cxq</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">guarantee</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">=</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">_EntryList</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span><span class="o">-&gt;</span><span class="n">_next</span> <span class="o">=</span> <span class="n">_EntryList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_EntryList</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">_EntryList</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">w</span> <span class="o">=</span> <span class="n">_EntryList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Â¶ÇÊûúEntryList‰∏ç‰∏∫Á©∫ÂàôÂî§ÈÜíÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">assert</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">ExitEpilog</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">w</span> <span class="o">=</span> <span class="n">_cxq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">ObjectWaiter</span> <span class="o">*</span><span class="p">)</span> <span class="n">Atomic</span><span class="o">::</span><span class="n">cmpxchg_ptr</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_cxq</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">w</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">TEVENT</span><span class="p">(</span><span class="n">Inflated</span> <span class="n">exit</span> <span class="o">-</span> <span class="n">drain</span> <span class="n">cxq</span> <span class="n">into</span> <span class="n">EntryList</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">_EntryList</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">QMode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// QMode == 1 : Â∞Ücxq‰∏≠ÁöÑÂÖÉÁ¥†ËΩ¨ÁßªÂà∞EntryListÔºåÂπ∂ÂèçËΩ¨È°∫Â∫è
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">t</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">u</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">guarantee</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">=</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">u</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="o">-&gt;</span><span class="n">_next</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">_EntryList</span>  <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// QMode == 0 or QMode == 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="c1">// Â∞Ücxq‰∏≠ÁöÑÂÖÉÁ¥†ËΩ¨ÁßªÂà∞EntryList
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_EntryList</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ObjectWaiter</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">guarantee</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_CXQ</span><span class="p">,</span> <span class="s">&#34;Invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">=</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">_prev</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="c1">// _succ‰∏ç‰∏∫nullÔºåËØ¥ÊòéÂ∑≤ÁªèÊúâ‰∏™ÁªßÊâø‰∫∫‰∫ÜÔºåÊâÄ‰ª•‰∏çÈúÄË¶ÅÂΩìÂâçÁ∫øÁ®ãÂéªÂî§ÈÜíÔºåÂáèÂ∞ë‰∏ä‰∏ãÊñáÂàáÊç¢ÁöÑÊØîÁéá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_succ</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    <span class="n">w</span> <span class="o">=</span> <span class="n">_EntryList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="c1">// Âî§ÈÜíEntryListÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">guarantee</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">TState</span> <span class="o">==</span> <span class="n">ObjectWaiter</span><span class="o">::</span><span class="n">TS_ENTER</span><span class="p">,</span> <span class="s">&#34;invariant&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">ExitEpilog</span><span class="p">(</span><span class="n">Self</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1,‰ºöÂÖàËøõË°åÈîÅÈáçÂÖ•ÔºåÈîÅËÜ®ËÉÄ‰∏Ä‰∫õÂà§Êñ≠ÔºåÂ¶ÇÊûú recursion‰∏∫0 ‰∏î ‰∏∫ÊåÅÈîÅÁ∫øÁ®ã ÂàôËøõË°å‰ª•‰∏ãÊ≠•È™§</p>
<p>2,ÂÖàÈáäÊîæÈîÅÔºåÁªôÂ§ñÁïåÁ∫øÁ®ãËé∑ÂèñÂêåÊ≠•‰ª£Á†ÅÂùóÁöÑÊú∫‰ºö</p>
<p>3,Â¶ÇÊûúÊ≠§Êó∂_cxq‰∏∫Á©∫ ÊàñËÄÖ Â∑≤ÁªèÊúâsucc ‰∫Ü ÂàôÈÄÄÂá∫</p>
<p>4,Â¶ÇÊûúÊ≠§Êó∂_cxq‰∏ç‰∏∫Á©∫Ôºå‰∏îÊ≤°Êúâsucc Âàô‰ºöÈáçÊñ∞Ëé∑ÂèñÈîÅ(ÂØπ cxqÂíåentryListÊìç‰Ωú)</p>
<p>5,Ê†πÊçÆQModeÁöÑ‰∏çÂêåÔºå‰ºöÊâßË°å‰∏çÂêåÁöÑÂî§ÈÜíÁ≠ñÁï•Ôºõ</p>
<p>Ê†πÊçÆQModeÁöÑ‰∏çÂêåÔºåÊúâ‰∏çÂêåÁöÑÂ§ÑÁêÜÊñπÂºèÔºö</p>
<blockquote>
<ol>
<li>QMode = 2‰∏îcxqÈùûÁ©∫ÔºöÂèñcxqÈòüÂàóÈòüÈ¶ñÁöÑObjectWaiterÂØπË±°ÔºåË∞ÉÁî®ExitEpilogÊñπÊ≥ïÔºåËØ•ÊñπÊ≥ï‰ºöÂî§ÈÜíObjectWaiterÂØπË±°ÁöÑÁ∫øÁ®ãÔºåÁÑ∂ÂêéÁ´ãÂç≥ËøîÂõûÔºåÂêéÈù¢ÁöÑ‰ª£Á†Å‰∏ç‰ºöÊâßË°å‰∫ÜÔºõ</li>
<li>QMode = 3‰∏îcxqÈùûÁ©∫ÔºöÊääcxqÈòüÂàóÊèíÂÖ•Âà∞EntryListÁöÑÂ∞æÈÉ®Ôºõ</li>
<li>QMode = 4‰∏îcxqÈùûÁ©∫ÔºöÊääcxqÈòüÂàóÊèíÂÖ•Âà∞EntryListÁöÑÂ§¥ÈÉ®Ôºõ</li>
<li>QMode = 0ÔºöÊöÇÊó∂‰ªÄ‰πàÈÉΩ‰∏çÂÅöÔºåÁªßÁª≠ÂæÄ‰∏ãÁúãÔºõ
<strong>Âè™ÊúâQMode=2ÁöÑÊó∂ÂÄô‰ºöÊèêÂâçËøîÂõûÔºåÁ≠â‰∫é0„ÄÅ3„ÄÅ4ÁöÑÊó∂ÂÄôÈÉΩ‰ºöÁªßÁª≠ÂæÄ‰∏ãÊâßË°åÔºö</strong></li>
</ol>
<p>1.Â¶ÇÊûúEntryListÁöÑÈ¶ñÂÖÉÁ¥†ÈùûÁ©∫ÔºåÂ∞±ÂèñÂá∫Êù•Ë∞ÉÁî®ExitEpilogÊñπÊ≥ïÔºåËØ•ÊñπÊ≥ï‰ºöÂî§ÈÜíObjectWaiterÂØπË±°ÁöÑÁ∫øÁ®ãÔºåÁÑ∂ÂêéÁ´ãÂç≥ËøîÂõûÔºõ
2.Â¶ÇÊûúEntryListÁöÑÈ¶ñÂÖÉÁ¥†‰∏∫Á©∫ÔºåÂ∞±Â∞ÜcxqÁöÑÊâÄÊúâÂÖÉÁ¥†ÊîæÂÖ•Âà∞EntryList‰∏≠ÔºåÁÑ∂ÂêéÂÜç‰ªéEntryList‰∏≠ÂèñÂá∫Êù•ÈòüÈ¶ñÂÖÉÁ¥†ÊâßË°åExitEpilogÊñπÊ≥ïÔºåÁÑ∂ÂêéÁ´ãÂç≥ËøîÂõûÔºõ</p>
</blockquote>
</blockquote>
<h3 id="51-ÂéüÁêÜ‰πã-wait--notify">5.1 ÂéüÁêÜ‰πã wait / notify</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220324201947719.png"
	
	
	
	loading="lazy"
	
		alt="image-20220324201947719"
	
	
></p>
<ul>
<li>OwnerÁ∫øÁ®ãÊñπÊ≥ïËá™Ë∫´Êù°‰ª∂‰∏çË∂≥Êó∂ÔºåË∞ÉÁî®waitÊñπÊ≥ïÔºåÂç≥ÂèØËøõÂÖ•WaitSetÂèò‰∏∫WAITINGÁä∂ÊÄÅ</li>
<li>BLOCKEDÂíåWAITINGÁöÑÁ∫øÁ®ãÈÉΩÂ§Ñ‰∫éÈòªÂ°ûÁä∂ÊÄÅÔºå‰∏çÂç†Áî®CPU</li>
<li>BLOCKEDÁ∫øÁ®ã‰ºöÂú®OwnerÁ∫øÁ®ãËøêË°åÂÆåÊó∂ÔºåÁªôÂî§ÈÜí</li>
<li>WAITINGÁ∫øÁ®ã‰ºöÂú®OwnerÁ∫øÁ®ãË∞ÉÁî®notifyÊàñËÄÖnotifyAllÊó∂Âî§ÈÜíÔºå‰ΩÜÂî§ÈÜíÂπ∂‰∏çÊÑèÂë≥ÁùÄÁ´ãÂàªËé∑ÂæóÈîÅÔºå‰ªçÈúÄËøõÂÖ•EntryListËøõË°åÁ´û‰∫â</li>
</ul>
<h4 id="api‰ªãÁªçÂè™ËÉΩÂú®ÂêåÊ≠•‰ª£Á†ÅÂùó‰ΩøÁî®">API‰ªãÁªçÔºàÂè™ËÉΩÂú®ÂêåÊ≠•‰ª£Á†ÅÂùó‰ΩøÁî®Ôºâ</h4>
<ul>
<li>obj.wait()ËÆ©ËøõÂÖ•objectÁõëËßÜÂô®ÁöÑÁ∫øÁ®ãÂà∞waitSetÁ≠âÂæÖ</li>
<li>obj.notify()Âú®object‰∏äÊ≠£Âú®waitSetÁ≠âÂæÖÁöÑÁ∫øÁ®ã‰∏≠Êåë‰∏Ä‰∏™Âî§ÈÜí</li>
<li>obj.notifyAll() ËÆ©object‰∏äÊ≠£Âú®waitSetÁ≠âÂæÖÁöÑÁ∫øÁ®ãÂÖ®ÈÉ®Âî§ÈÜí</li>
</ul>
<p><strong>Ê≥®Ôºö‰∏çÁÆ°‰ªÄ‰πàÈîÅÔºåÂ¶ÇÊûúÂØπÈîÅÂØπË±°Ë∞ÉÁî®wait()ÊñπÊ≥ïÔºå‰ºöÁõ¥Êé•‰ΩøÈîÅÁä∂ÊÄÅÂèò‰∏∫Fat Lock</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span><span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">lock</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">lock</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">java.lang.Object object internals:
</span></span><span class="line"><span class="cl">OFF  SZ   TYPE DESCRIPTION               VALUE
</span></span><span class="line"><span class="cl">  0   4        (object header: mark)     0x16324c0d (biased: 0x000b1926; epoch: 0; age: 1)
</span></span><span class="line"><span class="cl">  4   4        (object header: class)    0x15691118
</span></span><span class="line"><span class="cl">Instance size: 8 bytes
</span></span><span class="line"><span class="cl">Space losses: 0 bytes internal + 0 bytes external = 0 bytes total
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">java.lang.Object object internals:
</span></span><span class="line"><span class="cl">OFF  SZ   TYPE DESCRIPTION               VALUE
</span></span><span class="line"><span class="cl">  0   4        (object header: mark)     0x15b0ad0e (fat lock: 0x15b0ad0e)
</span></span><span class="line"><span class="cl">  4   4        (object header: class)    0x15691118
</span></span><span class="line"><span class="cl">Instance size: 8 bytes
</span></span><span class="line"><span class="cl">Space losses: 0 bytes internal + 0 bytes external = 0 bytes total
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="‰∏∫‰ªÄ‰πà-wait-notifyÂíå-notifyallÂøÖÈ°ªÂú®ÂêåÊ≠•ÊñπÊ≥ïÊàñËÄÖÂêåÊ≠•Âùó‰∏≠Ë¢´Ë∞ÉÁî®">‰∏∫‰ªÄ‰πà wait(), notify()Âíå notifyAll()ÂøÖÈ°ªÂú®ÂêåÊ≠•ÊñπÊ≥ïÊàñËÄÖÂêåÊ≠•Âùó‰∏≠Ë¢´Ë∞ÉÁî®Ôºü</h4>
<blockquote>
<p>ÂΩì‰∏Ä‰∏™Á∫øÁ®ãÈúÄË¶ÅË∞ÉÁî®ÂØπË±°ÁöÑ wait()ÊñπÊ≥ïÁöÑÊó∂ÂÄôÔºåËøô‰∏™Á∫øÁ®ãÂøÖÈ°ªÊã•ÊúâËØ•ÂØπË±°ÁöÑÈîÅÔºåÊé•ÁùÄÂÆÉÂ∞±‰ºöÈáäÊîæËøô‰∏™ÂØπË±°ÈîÅÂπ∂ËøõÂÖ•Á≠âÂæÖÁä∂ÊÄÅÁõ¥Âà∞ÂÖ∂‰ªñÁ∫øÁ®ãË∞ÉÁî®Ëøô‰∏™ÂØπË±°‰∏äÁöÑ notify()ÊñπÊ≥ï„ÄÇÂêåÊ†∑ÁöÑÔºåÂΩì‰∏Ä‰∏™Á∫øÁ®ãÈúÄË¶ÅË∞ÉÁî®ÂØπË±°ÁöÑ notify()ÊñπÊ≥ïÊó∂ÔºåÂÆÉ‰ºöÈáäÊîæËøô‰∏™ÂØπË±°ÁöÑÈîÅÔºå‰ª•‰æøÂÖ∂‰ªñÂú®Á≠âÂæÖÁöÑÁ∫øÁ®ãÂ∞±ÂèØ‰ª•ÂæóÂà∞Ëøô‰∏™ÂØπË±°ÈîÅ„ÄÇÁî±‰∫éÊâÄÊúâÁöÑËøô‰∫õÊñπÊ≥ïÈÉΩÈúÄË¶ÅÁ∫øÁ®ãÊåÅÊúâÂØπË±°ÁöÑÈîÅÔºåËøôÊ†∑Â∞±Âè™ËÉΩÈÄöËøáÂêåÊ≠•Êù•ÂÆûÁé∞ÔºåÊâÄ‰ª•‰ªñ‰ª¨Âè™ËÉΩÂú®ÂêåÊ≠•ÊñπÊ≥ïÊàñËÄÖÂêåÊ≠•Âùó‰∏≠Ë¢´Ë∞ÉÁî®„ÄÇ</p>
</blockquote>
<h5 id="waitlong-timeout"><strong>wait(long timeout):</strong></h5>
<ul>
<li>**timeout ==0 : **Êó†ÈôêÂà∂Á≠âÂæÖ</li>
<li><strong>timeout &gt; 0:</strong> Âú®ËßÑÂÆöÊó∂Èó¥ËøõË°åÁ≠âÂæÖ</li>
</ul>
<h5 id="waitlong-timeoutint-nanos-ËôΩËØ¥ÊòØÁ∫≥ÁßíÂÆûÈôÖ‰∏äÊòØÂÅáÁ∫≥Áßí">wait(long timeout,int nanos): ËôΩËØ¥ÊòØÁ∫≥ÁßíÂÆûÈôÖ‰∏äÊòØÂÅáÁ∫≥Áßí</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">wait</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nanos</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;timeout value is negative&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">nanos</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span> <span class="n">nanos</span> <span class="o">&gt;</span> <span class="n">999999</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="s">&#34;nanosecond timeout value out of range&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">nanos</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">wait</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="52-wait-notifyÁöÑÊ≠£Á°ÆÂßøÂäø">5.2 wait notifyÁöÑÊ≠£Á°ÆÂßøÂäø</h3>
<h4 id="sleep-Âíå-wait-ÁöÑÂå∫Âà´">sleep() Âíå wait() ÁöÑÂå∫Âà´</h4>
<ol>
<li>sleepÊòØThreadÊñπÊ≥ïÔºåwaitÊòØObjectÊñπÊ≥ï</li>
<li>sleep‰∏ç‰ºöÈáäÊîæÈîÅÔºåËÄåwait‰ºöÈáäÊîæÈîÅÂØπË±°</li>
<li>sleepÊó†ÈúÄÂº∫Âà∂Âíåsynchronized‰ΩøÁî®Ôºå‰ΩÜÊòØwaitÈúÄË¶ÅÂíåsynchronized‰ΩøÁî®</li>
<li>wait‰ºö‰ΩøÈîÅÂº∫Âà∂ÂçáÁ∫ß‰∏∫fat lockÔºåsleep‰∏ç‰ºö</li>
</ol>
<h4 id="ÂÖ±ÂêåÁÇπ">ÂÖ±ÂêåÁÇπÔºö</h4>
<ul>
<li>ÈÉΩÊòØËøõÂÖ•TIME_WAITING</li>
</ul>
<h4 id="step1">step1:</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">step2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">room</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÂºÄÂßãÂ∑•‰Ωú&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="o">(!</span><span class="n">cig</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÊúâÁÉüÊ≤°?[{}]&#34;</span><span class="o">,</span><span class="n">cig</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(!</span><span class="n">cig</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Ê≤°ÊúâÁÉüÔºåÂºÄÊëÜ!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                        room.wait();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(</span><span class="n">cig</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÊúâÁÉü‰∫ÜÔºåÂºÄÂÜ≤!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;ÁÉüÈ¨º&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">5</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">room</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÂºÄÂßãÂ∑•‰Ωú‰∫Ü&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;ÂÖ∂‰ªñ‰∫∫&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//            synchronized (room){
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">cig</span><span class="o">=!</span><span class="n">cig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÁÉüÊù•ÂíØÔºÅ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                room.notify();
</span></span></span><span class="line"><span class="cl"><span class="c1">//            }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">},</span><span class="s">&#34;ÁÉüË¥©Â≠ê&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">00:12:35.351 [ÁÉüÈ¨º] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú
</span></span><span class="line"><span class="cl">00:12:35.358 [ÁÉüÈ¨º] DEBUG c.Wait - ÊúâÁÉüÊ≤°?[false]
</span></span><span class="line"><span class="cl">00:12:35.359 [ÁÉüÈ¨º] DEBUG c.Wait - Ê≤°ÊúâÁÉüÔºåÂºÄÊëÜ!
</span></span><span class="line"><span class="cl">00:12:36.362 [ÁÉüË¥©Â≠ê] DEBUG c.Wait - ÁÉüÊù•ÂíØÔºÅ
</span></span><span class="line"><span class="cl">00:12:37.372 [ÁÉüÈ¨º] DEBUG c.Wait - ÊúâÁÉü‰∫ÜÔºåÂºÄÂÜ≤!
</span></span><span class="line"><span class="cl">00:12:37.372 [ÂÖ∂‰ªñ‰∫∫4] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú‰∫Ü
</span></span><span class="line"><span class="cl">00:12:37.372 [ÂÖ∂‰ªñ‰∫∫3] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú‰∫Ü
</span></span><span class="line"><span class="cl">00:12:37.372 [ÂÖ∂‰ªñ‰∫∫2] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú‰∫Ü
</span></span><span class="line"><span class="cl">00:12:37.372 [ÂÖ∂‰ªñ‰∫∫1] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú‰∫Ü
</span></span><span class="line"><span class="cl">00:12:37.372 [ÂÖ∂‰ªñ‰∫∫0] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú‰∫Ü
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂèØ‰ª•ÁúãÂá∫‰∏äËø∞‰ª£Á†Å‰ΩøÁî®sleepÁöÑËØùÔºå‰ºöÂØºËá¥ÁÉüÈ¨º‰∏ÄÁõ¥ÊëÜÁÉÇÂç†Áî®Á∫øÁ®ãÔºåÂØºËá¥Ê≠£Â∏∏‰∫∫Êó†Ê≥ïÂ∑•‰ΩúÔºåÊïàÁéáÂèò‰Ωé</li>
<li>ËÄå‰∏îÁÉüË¥©Â≠ê‰∏çËÉΩÂä†ÂÖ•Âà∞ÂêåÊ≠•‰ª£Á†ÅÂùó‰∏≠ÔºåÂê¶Âàô‰πü‰ºöÈòªÂ°û„ÄÇ</li>
<li>ÊâÄ‰ª•ËøôÈáåÊàë‰ª¨‰ΩøÁî®wait-notifyÊù•‰ºòÂåñËØ•Á®ãÂ∫è</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">step2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">room</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÂºÄÂßãÂ∑•‰Ωú&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(!</span><span class="n">cig</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Ê≤°ÊúâÁÉüÔºåÂºÄÊëÜ!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">room</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">cig</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÊúâÁÉü‰∫ÜÔºåÂºÄÂÜ≤!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;ÁÉüÈ¨º&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">5</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">room</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÂºÄÂßãÂ∑•‰Ωú‰∫Ü&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;ÂÖ∂‰ªñ‰∫∫&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">room</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">cig</span><span class="o">=!</span><span class="n">cig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÁÉüÊù•ÂíØÔºÅ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">room</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;ÁÉüË¥©Â≠ê&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">00:06:17.739 [ÁÉüÈ¨º] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú
</span></span><span class="line"><span class="cl">00:06:17.744 [ÁÉüÈ¨º] DEBUG c.Wait - Ê≤°ÊúâÁÉüÔºåÂºÄÊëÜ!
</span></span><span class="line"><span class="cl">00:06:18.738 [ÂÖ∂‰ªñ‰∫∫0] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú‰∫Ü
</span></span><span class="line"><span class="cl">00:06:18.739 [ÂÖ∂‰ªñ‰∫∫1] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú‰∫Ü
</span></span><span class="line"><span class="cl">00:06:18.739 [ÂÖ∂‰ªñ‰∫∫2] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú‰∫Ü
</span></span><span class="line"><span class="cl">00:06:18.739 [ÂÖ∂‰ªñ‰∫∫3] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú‰∫Ü
</span></span><span class="line"><span class="cl">00:06:18.739 [ÂÖ∂‰ªñ‰∫∫4] DEBUG c.Wait - ÂºÄÂßãÂ∑•‰Ωú‰∫Ü
</span></span><span class="line"><span class="cl">00:06:20.741 [ÁÉüË¥©Â≠ê] DEBUG c.Wait - ÁÉüÊù•ÂíØÔºÅ
</span></span><span class="line"><span class="cl">00:06:20.741 [ÁÉüÈ¨º] DEBUG c.Wait - ÊúâÁÉü‰∫ÜÔºåÂºÄÂÜ≤!
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ËøôÊ†∑Â≠êÂ∞±ÂèØ‰ª•ÂæàÂ•ΩÁöÑËß£ÂÜ≥ÁÉüÈ¨ºÁ≠âÁÉüÁöÑÈóÆÈ¢òÔºåËÆ©ÁÉüÈ¨ºÊääÈîÅËÆ©Âá∫ÂéªÔºå‰æõÂÖ∂‰ªñÁ∫øÁ®ã‰ΩøÁî®</li>
</ul>
<h6 id="‰ΩÜÊòØ‰∏äËø∞ÊñπÊ≥ïËøòÊòØÂ≠òÂú®ÈóÆÈ¢òÂ¶ÇÊûúËøôÊó∂ÂÄô‰∏çÂè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãÂú®Á≠âÂæÖÊù°‰ª∂ËÄåÊòØÊúâÂ§ö‰∏™Á∫øÁ®ãÊ≠£Âú®Á≠âÂæÖÊù°‰ª∂ËøôÊó∂ÂÄônotify‰ºö‰∫ßÁîüËôöÂÅáÂî§ÈÜíÁöÑÁé∞Ë±°‰πüÂ∞±ÊòØÂ∞ÜÂΩìÂâçÊù°‰ª∂‰∏çÁ¨¶ÂêàÁöÑÁ∫øÁ®ãÁªôÂî§ÈÜí"><strong>‰ΩÜÊòØ‰∏äËø∞ÊñπÊ≥ïËøòÊòØÂ≠òÂú®ÈóÆÈ¢ò</strong>ÔºöÂ¶ÇÊûúËøôÊó∂ÂÄôÔºå‰∏çÂè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãÂú®Á≠âÂæÖÊù°‰ª∂ÔºåËÄåÊòØÊúâÂ§ö‰∏™Á∫øÁ®ãÊ≠£Âú®Á≠âÂæÖÊù°‰ª∂ÔºåËøôÊó∂ÂÄônotify‰ºö‰∫ßÁîü<em>ËôöÂÅáÂî§ÈÜí</em>ÁöÑÁé∞Ë±°Ôºå‰πüÂ∞±ÊòØÂ∞ÜÂΩìÂâçÊù°‰ª∂‰∏çÁ¨¶ÂêàÁöÑÁ∫øÁ®ãÁªôÂî§ÈÜí„ÄÇ</h6>
<ul>
<li><strong>Â¶ÇÊûú‰ΩøÁî®notifyAll()ÂèØ‰ª•Ëß£ÂÜ≥ÈóÆÈ¢òÂêóÔºü</strong></li>
</ul>
<p>‰∏çÂèØ‰ª•Ëß£ÂÜ≥Ôºå‰ΩÜÊòØ‰ºöÊääÊâÄÊúâÁ∫øÁ®ãÂî§ÈÜíÔºå‰∏çÁ¨¶ÂêàËØ•Êù°‰ª∂ÁöÑÁ∫øÁ®ãÈÉΩ‰ºöËøõÂÖ•ÈòªÂ°ûÈòüÂàóÂØºËá¥ÔºåÂÖ∂‰ªñÁ∫øÁ®ãÁöÑËôöÂÅáÂî§ÈÜí</p>
<ul>
<li><strong>‰ΩøÁî®whileÊù•Êó∂ÂàªÊ£ÄÊü•+notifyAll()ÂèØ‰ª•Ëß£ÂÜ≥ÂêóÔºü</strong></li>
</ul>
<p>ÂèØ‰ª•Ëß£ÂÜ≥</p>
<h2 id="ÂêåÊ≠•Ê®°Âºè‰πã‰øùÊä§ÊÄßÊöÇÂÅú">ÂêåÊ≠•Ê®°Âºè‰πã‰øùÊä§ÊÄßÊöÇÂÅú</h2>
<h3 id="ÂÆö‰πâ">ÂÆö‰πâ</h3>
<p>Áî®Âú®‰∏Ä‰∏™Á∫øÁ®ãÁ≠âÂæÖÂè¶‰∏Ä‰∏™Á∫øÁ®ãÁöÑÊâßË°åÁªìÊûú</p>
<h4 id="Ë¶ÅÁÇπ">Ë¶ÅÁÇπ</h4>
<ul>
<li>Êúâ‰∏Ä‰∏™ÁªìÊûúÈúÄË¶Å‰ªé‰∏Ä‰∏™Á∫øÁ®ã‰º†ÈÄíÂà∞Âè¶‰∏Ä‰∏™Á∫øÁ®ãÔºåËÆ©‰ªñ‰ª¨ÂÖ≥ËÅîÂêå‰∏Ä‰∏™Object</li>
<li>Â¶ÇÊûúÊúâÁªìÊûúÊ∫êÊ∫ê‰∏çÊñ≠ÁöÑ‰º†ËæìÔºåÂàô‰ΩøÁî®Ê∂àÊÅØÈòüÂàó</li>
<li><strong>JDK‰∏≠ÔºåjoinÂíåFutureTaskÁöÑÂÆûÁé∞ÔºåÈááÁî®ÁöÑÂ∞±ÊòØÊ≠§Ê®°Âºè‚Äò</strong></li>
<li>Âõ†‰∏∫Ë¶ÅÁ≠âÂæÖÂè¶‰∏ÄÊñπÁöÑÁªìÊûúÊâÄ‰ª•ÂΩí‰∏∫ÂêåÊ≠•Ê®°Âºè</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326142527922.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326142527922"
	
	
></p>
<h3 id="ÂÆûÁé∞">ÂÆûÁé∞</h3>
<h4 id="guardedobjectÁ±ªÂÆûÁé∞">GuardedObjectÁ±ªÂÆûÁé∞</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">GuardedObject</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">get</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">response</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">complete</span><span class="o">(</span><span class="n">Object</span> <span class="n">response</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="‰øùÊä§ÊÄßÊöÇÂÅúÊ®°ÂºèÂÆûÁé∞">‰øùÊä§ÊÄßÊöÇÂÅúÊ®°ÂºèÂÆûÁé∞</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">securityStop</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">GuardedObject</span> <span class="n">guardedObject</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GuardedObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Á≠âÂæÖÁªìÊûú&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">           <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">)</span><span class="n">guardedObject</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;‰∏ãËΩΩÂÜÖÂÆπ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">             <span class="n">list</span> <span class="o">=</span>  <span class="n">Downloader</span><span class="o">.</span><span class="na">download</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">           <span class="n">guardedObject</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;‰∏ãËΩΩÂÆåÊØï&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="‰øùÊä§ÊÄßÊöÇÂÅúÊ®°Âºè‰ºòÂåñ">‰øùÊä§ÊÄßÊöÇÂÅúÊ®°Âºè‰ºòÂåñ</h4>
<p>Â¶ÇÊûú‰∏ãËΩΩÊó∂Èó¥ÁâπÂà´ÈïøÔºåÂ∞±‰ºöÂØºËá¥Á≠âÂæÖÁ∫øÁ®ã‰∏ÄÁõ¥Á≠âÂæÖÔºåË¶ÅÁªô‰ªñËÆæÁΩÆ‰∏Ä‰∏™Á≠âÂæÖÊó∂Èïø</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">public</span> <span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeOut</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">passTime</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">response</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(</span><span class="n">passTime</span> <span class="o">&gt;=</span> <span class="n">timeOut</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Á≠âÂæÖË∂ÖÊó∂&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="n">timeOut</span> <span class="o">-</span> <span class="n">passTime</span><span class="o">);</span> <span class="c1">// Èò≤Ê≠¢ËôöÂÅáÂî§ÈÜíÊÉÖÂÜµ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">passTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()-</span><span class="n">startTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="‰øùÊä§ÊÄßÊöÇÂÅúÊ®°Âºè‰ºòÂåñ2">‰øùÊä§ÊÄßÊöÇÂÅúÊ®°Âºè‰ºòÂåñ2</h4>
<p>‰ΩøÁî®FuturesÊñπÊ≥ï ‰∏Ä‰∏ÄÂØπÂ∫î</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326153814167.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326153814167"
	
	
></p>
<h5 id="futureguardedobject">futureGuardedObject</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">futureGuardedObject</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Object</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">futureGuardedObject</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeOut</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">long</span> <span class="n">passTime</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">response</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(</span><span class="n">passTime</span> <span class="o">&gt;=</span> <span class="n">timeOut</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Á≠âÂæÖË∂ÖÊó∂&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="n">timeOut</span> <span class="o">-</span> <span class="n">passTime</span><span class="o">);</span> <span class="c1">// Èò≤Ê≠¢ËôöÂÅáÂî§ÈÜíÊÉÖÂÜµ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">passTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()-</span><span class="n">startTime</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">complete</span><span class="o">(</span><span class="n">Object</span> <span class="n">response</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="mailbox">MailBox</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Mailboxes</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span><span class="n">futureGuardedObject</span><span class="o">&gt;</span> <span class="n">boxes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hashtable</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">generateId</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">id</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">futureGuardedObject</span> <span class="nf">createGuardedObject</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">futureGuardedObject</span> <span class="n">go</span> <span class="o">=</span> <span class="k">new</span> <span class="n">futureGuardedObject</span><span class="o">(</span><span class="n">generateId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">boxes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">go</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">go</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">go</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">futureGuardedObject</span> <span class="nf">getGuradObject</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">boxes</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">getIds</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">boxes</span><span class="o">.</span><span class="na">keySet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="person">Person</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Person</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">       <span class="n">futureGuardedObject</span> <span class="n">go</span> <span class="o">=</span> <span class="n">Mailboxes</span><span class="o">.</span><span class="na">createGuardedObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">       <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÂºÄÂßãÊî∂‰ø° id{}&#34;</span><span class="o">,</span><span class="n">go</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">       <span class="n">Object</span> <span class="n">mail</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">5000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">       <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Êî∂Âà∞‰ø° id{} ÂÜÖÂÆπ{}&#34;</span><span class="o">,</span><span class="n">go</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">mail</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">   <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="postman">PostMan</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">PostMan</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">mail</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">PostMan</span><span class="o">(</span><span class="n">String</span> <span class="n">mail</span><span class="o">,</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">mail</span> <span class="o">=</span> <span class="n">mail</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÂºÄÂßãÈÄÅ‰ø° id{} ÂÜÖÂÆπ{}&#34;</span><span class="o">,</span><span class="n">id</span><span class="o">,</span><span class="n">mail</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">       <span class="n">futureGuardedObject</span> <span class="n">go</span> <span class="o">=</span> <span class="n">Mailboxes</span><span class="o">.</span><span class="na">getGuradObject</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">       <span class="n">go</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="n">mail</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ËøêË°åÊµãËØï">ËøêË°åÊµãËØï</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">futureSecurityStop</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">3</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Person</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="n">Mailboxes</span><span class="o">.</span><span class="na">getIds</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Integer</span> <span class="n">id</span> <span class="o">:</span> <span class="n">set</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">PostMan</span><span class="o">(</span><span class="s">&#34;‰ø°Â∞Å&#34;</span><span class="o">+</span><span class="n">id</span><span class="o">,</span><span class="n">id</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">16:30:44.541 [Thread-0] DEBUG People - ÂºÄÂßãÊî∂‰ø° id1
</span></span><span class="line"><span class="cl">16:30:44.541 [Thread-2] DEBUG People - ÂºÄÂßãÊî∂‰ø° id2
</span></span><span class="line"><span class="cl">16:30:44.541 [Thread-1] DEBUG People - ÂºÄÂßãÊî∂‰ø° id3
</span></span><span class="line"><span class="cl">16:30:45.554 [Thread-3] DEBUG PostMan - ÂºÄÂßãÈÄÅ‰ø° id3 ÂÜÖÂÆπ‰ø°Â∞Å3
</span></span><span class="line"><span class="cl">16:30:45.554 [Thread-4] DEBUG PostMan - ÂºÄÂßãÈÄÅ‰ø° id2 ÂÜÖÂÆπ‰ø°Â∞Å2
</span></span><span class="line"><span class="cl">16:30:45.554 [Thread-5] DEBUG PostMan - ÂºÄÂßãÈÄÅ‰ø° id1 ÂÜÖÂÆπ‰ø°Â∞Å1
</span></span><span class="line"><span class="cl">16:30:47.562 [Thread-1] DEBUG People - Êî∂Âà∞‰ø° id3 ÂÜÖÂÆπ‰ø°Â∞Å3
</span></span><span class="line"><span class="cl">16:30:47.562 [Thread-2] DEBUG People - Êî∂Âà∞‰ø° id2 ÂÜÖÂÆπ‰ø°Â∞Å2
</span></span><span class="line"><span class="cl">16:30:47.562 [Thread-0] DEBUG People - Êî∂Âà∞‰ø° id1 ÂÜÖÂÆπ‰ø°Â∞Å1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ÂºÇÊ≠•Ê®°Âºè‰πãÁîü‰∫ßËÄÖÊ∂àË¥πËÄÖ">ÂºÇÊ≠•Ê®°Âºè‰πãÁîü‰∫ßËÄÖ/Ê∂àË¥πËÄÖ</h2>
<h3 id="ÂÆö‰πâ-1">ÂÆö‰πâ</h3>
<h4 id="Ë¶ÅÁÇπ-1">Ë¶ÅÁÇπ</h4>
<ul>
<li>‰∏çÈúÄË¶ÅÂÉèGuardedObject‰∏ÄÊ†∑ÔºåÊØèÊúâ‰∏Ä‰∏™Áîü‰∫ßËÄÖÂ∞±ÂØπÂ∫î‰∏Ä‰∏™Ê∂àË¥πËÄÖÔºåÂéª‰∏Ä‰∏ÄÂØπÂ∫î</li>
<li>Áîü‰∫ßËÄÖÊó†ÈúÄÂÖ≥ÂøÉÊï∞ÊçÆÂ§ÑÁêÜÔºåÂè™ÈúÄË¶ÅË¥üË¥£Áîü‰∫ßÂ∞±Ë°åÔºåÊ∂àË¥πËÄÖ‰∏ìÂøÉÂ§ÑÁêÜÁîü‰∫ßËÄÖ‰∫ßÁîüÁöÑÊï∞ÊçÆ</li>
<li><strong>Ê∂àÊÅØÈòüÂàóÂÆπÈáèÊòØÊúâÈôêÂ∫¶ÁöÑ</strong>ÔºåÂΩìÂÆπÈáèÊª°‰∫ÜÁöÑÊó∂ÂÄôÔºåÂ∞±‰∏ç‰ºöÂú®ÂæÄÈáåÈù¢Ê∑ªÂä†Êï∞ÊçÆÔºåÂΩìÂÆπÈáèÁ©∫‰∫ÜÁöÑÊó∂ÂÄôÔºåÊ∂àË¥πËÄÖ‰πü‰∏ç‰ºöÁªßÁª≠Ê∂àËÄóÊï∞ÊçÆ</li>
<li>JDKÂêÑÁßçÈòªÂ°ûÈòüÂàóÈááÁî®ÁöÑÂ∞±ÊòØËøôÁßçÊ®°Âºè</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220326163817796.png"
	
	
	
	loading="lazy"
	
		alt="image-20220326163817796"
	
	
></p>
<p>**Ê≥®Ôºö**ÂºÇÊ≠•ÊòØÂõ†‰∏∫Áîü‰∫ßËÄÖÁöÑÊ∂àÊÅØ‰∏ç‰ºöÁ´ãÂàªË¢´Â§ÑÁêÜ</p>
<h4 id="ÂÆûÁé∞-1">ÂÆûÁé∞</h4>
<h5 id="message">Message</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Message</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Object</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Message</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;Message{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;id=&#34;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;, value=&#34;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="sc">&#39;}&#39;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="messagequeue">MessageQueue</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MessageQueue</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kt">int</span> <span class="n">capcity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="nf">MessageQueue</span><span class="o">(</span><span class="kt">int</span> <span class="n">capcity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="o">.</span><span class="na">capcity</span> <span class="o">=</span> <span class="n">capcity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="n">Message</span> <span class="nf">take</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">         <span class="kd">synchronized</span> <span class="o">(</span><span class="n">list</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">             <span class="k">while</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                 <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                     <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÈòüÂàó‰∏∫Á©∫ÔºåÊöÇÊó†ÈúÄË¶ÅÂ§ÑÁêÜÁöÑÂÜÖÂÆπ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                     <span class="n">list</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                 <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                     <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                 <span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="n">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">             <span class="n">list</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">             <span class="k">return</span> <span class="n">message</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">Message</span> <span class="n">message</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">          <span class="kd">synchronized</span> <span class="o">(</span><span class="n">list</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">              <span class="k">while</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">capcity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                  <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                      <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÈòüÂàóÂ∑≤Êª°ÔºåËØ∑Á®çÂêé&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                      <span class="n">list</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                  <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                  <span class="o">}</span>
</span></span><span class="line"><span class="cl">              <span class="o">}</span>
</span></span><span class="line"><span class="cl">              <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Â∑≤ÁªèÊ∑ªÂä† ‰∫ßÂìÅ id{} ÂÜÖÂÆπ {}&#34;</span><span class="o">,</span><span class="n">message</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">message</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">              <span class="n">list</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">              <span class="n">list</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ËøêË°åÊµãËØï-1">ËøêË°åÊµãËØï</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProducersAndConsumers</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MessageQueue</span> <span class="n">messageQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageQueue</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">5</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Áîü‰∫ßËÄÖ{} ÂºÄÂßãÁîü‰∫ß&#34;</span><span class="o">,</span><span class="n">temp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Message</span><span class="o">(</span><span class="n">temp</span><span class="o">,</span><span class="s">&#34;Â≠¶‰π†ËµÑÊñô&#34;</span><span class="o">+</span><span class="n">temp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">messageQueue</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;Áîü‰∫ßËÄÖ&#34;</span><span class="o">+</span><span class="n">temp</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">Message</span> <span class="n">message</span> <span class="o">=</span>  <span class="n">messageQueue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Â∑≤ÁªèÂ§ÑÁêÜ ‰∫ßÂìÅ id{} ÂÜÖÂÆπ {}&#34;</span><span class="o">,</span><span class="n">message</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">message</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;Ê∂àË¥πËÄÖ&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">17:11:14.080 [Ê∂àË¥πËÄÖ] DEBUG MessageQueue - ÈòüÂàó‰∏∫Á©∫ÔºåÊöÇÊó†ÈúÄË¶ÅÂ§ÑÁêÜÁöÑÂÜÖÂÆπ
</span></span><span class="line"><span class="cl">17:11:14.080 [Áîü‰∫ßËÄÖ3] DEBUG main - Áîü‰∫ßËÄÖ3 ÂºÄÂßãÁîü‰∫ß
</span></span><span class="line"><span class="cl">17:11:14.080 [Áîü‰∫ßËÄÖ4] DEBUG main - Áîü‰∫ßËÄÖ4 ÂºÄÂßãÁîü‰∫ß
</span></span><span class="line"><span class="cl">17:11:14.080 [Áîü‰∫ßËÄÖ1] DEBUG main - Áîü‰∫ßËÄÖ1 ÂºÄÂßãÁîü‰∫ß
</span></span><span class="line"><span class="cl">17:11:14.080 [Áîü‰∫ßËÄÖ2] DEBUG main - Áîü‰∫ßËÄÖ2 ÂºÄÂßãÁîü‰∫ß
</span></span><span class="line"><span class="cl">17:11:14.080 [Áîü‰∫ßËÄÖ0] DEBUG main - Áîü‰∫ßËÄÖ0 ÂºÄÂßãÁîü‰∫ß
</span></span><span class="line"><span class="cl">17:11:16.100 [Áîü‰∫ßËÄÖ2] DEBUG MessageQueue - Â∑≤ÁªèÊ∑ªÂä† ‰∫ßÂìÅ id2 ÂÜÖÂÆπ Â≠¶‰π†ËµÑÊñô2
</span></span><span class="line"><span class="cl">17:11:16.100 [Ê∂àË¥πËÄÖ] DEBUG main - Â∑≤ÁªèÂ§ÑÁêÜ ‰∫ßÂìÅ id2 ÂÜÖÂÆπ Â≠¶‰π†ËµÑÊñô2
</span></span><span class="line"><span class="cl">17:11:16.100 [Áîü‰∫ßËÄÖ1] DEBUG MessageQueue - Â∑≤ÁªèÊ∑ªÂä† ‰∫ßÂìÅ id1 ÂÜÖÂÆπ Â≠¶‰π†ËµÑÊñô1
</span></span><span class="line"><span class="cl">17:11:16.100 [Áîü‰∫ßËÄÖ4] DEBUG MessageQueue - Â∑≤ÁªèÊ∑ªÂä† ‰∫ßÂìÅ id4 ÂÜÖÂÆπ Â≠¶‰π†ËµÑÊñô4
</span></span><span class="line"><span class="cl">17:11:16.100 [Áîü‰∫ßËÄÖ3] DEBUG MessageQueue - Â∑≤ÁªèÊ∑ªÂä† ‰∫ßÂìÅ id3 ÂÜÖÂÆπ Â≠¶‰π†ËµÑÊñô3
</span></span><span class="line"><span class="cl">17:11:16.101 [Áîü‰∫ßËÄÖ0] DEBUG MessageQueue - ÈòüÂàóÂ∑≤Êª°ÔºåËØ∑Á®çÂêé
</span></span><span class="line"><span class="cl">17:11:16.101 [Ê∂àË¥πËÄÖ] DEBUG main - Â∑≤ÁªèÂ§ÑÁêÜ ‰∫ßÂìÅ id1 ÂÜÖÂÆπ Â≠¶‰π†ËµÑÊñô1
</span></span><span class="line"><span class="cl">17:11:16.101 [Áîü‰∫ßËÄÖ0] DEBUG MessageQueue - Â∑≤ÁªèÊ∑ªÂä† ‰∫ßÂìÅ id0 ÂÜÖÂÆπ Â≠¶‰π†ËµÑÊñô0
</span></span><span class="line"><span class="cl">17:11:16.101 [Ê∂àË¥πËÄÖ] DEBUG main - Â∑≤ÁªèÂ§ÑÁêÜ ‰∫ßÂìÅ id4 ÂÜÖÂÆπ Â≠¶‰π†ËµÑÊñô4
</span></span><span class="line"><span class="cl">17:11:16.101 [Ê∂àË¥πËÄÖ] DEBUG main - Â∑≤ÁªèÂ§ÑÁêÜ ‰∫ßÂìÅ id3 ÂÜÖÂÆπ Â≠¶‰π†ËµÑÊñô3
</span></span><span class="line"><span class="cl">17:11:16.101 [Ê∂àË¥πËÄÖ] DEBUG main - Â∑≤ÁªèÂ§ÑÁêÜ ‰∫ßÂìÅ id0 ÂÜÖÂÆπ Â≠¶‰π†ËµÑÊñô0
</span></span><span class="line"><span class="cl">17:11:16.101 [Ê∂àË¥πËÄÖ] DEBUG MessageQueue - ÈòüÂàó‰∏∫Á©∫ÔºåÊöÇÊó†ÈúÄË¶ÅÂ§ÑÁêÜÁöÑÂÜÖÂÆπ
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-Á∫øÁ®ãÂàáÊç¢">6 Á∫øÁ®ãÂàáÊç¢</h2>
<h3 id="61-ÈáçÊñ∞ÁêÜËß£Á∫øÁ®ãÁä∂ÊÄÅËΩ¨Êç¢">6.1 ÈáçÊñ∞ÁêÜËß£Á∫øÁ®ãÁä∂ÊÄÅËΩ¨Êç¢</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220328204903731.png"
	
	
	
	loading="lazy"
	
		alt="image-20220328204903731"
	
	
></p>
<h4 id="ÊÉÖÂÜµ1-new----runnable">ÊÉÖÂÜµ1 NEW &ndash;&gt; RUNNABLE</h4>
<ul>
<li>Ë∞ÉÁî®Thread.startÊñπÊ≥ïÔºåÁî±New&ndash;&gt;Runnable</li>
</ul>
<h4 id="ÊÉÖÂÜµ2-runnable-----waiting">ÊÉÖÂÜµ2 RUNNABLE &lt;&mdash;&gt; WAITING</h4>
<p><strong>tÁ∫øÁ®ãÁî®synchronized(obj)Ëé∑ÂèñÂØπË±°Âêé</strong></p>
<ul>
<li>Ë∞ÉÁî®wait()ÊñπÊ≥ïÔºåËøõÂÖ•<strong>WAITING</strong>Áä∂ÊÄÅ</li>
<li>Ë∞ÉÁî®notify()ÔºånotifyAll()Ôºåinterrupt()Êó∂</li>
</ul>
<blockquote>
<ul>
<li>Á´û‰∫âÊàêÂäüÔºå‰ªé<strong>waiting</strong>ËΩ¨‰∏∫<strong>runnable</strong></li>
<li>Á´û‰∫âÂ§±Ë¥•Ôºå‰ªé<strong>waiting</strong>ËΩ¨‰∏∫<strong>blocked</strong></li>
</ul>
</blockquote>
<h4 id="ÊÉÖÂÜµ3-runnable-----waiting">ÊÉÖÂÜµ3 RUNNABLE &lt;&mdash;&gt; WAITING</h4>
<ul>
<li>ÂΩìÂâçÁ∫øÁ®ãË∞ÉÁî®<strong>t.join()<strong>ÊñπÊ≥ïÊó∂ÔºåÂΩìÂâçÁ∫øÁ®ã‰ªé</strong>RUNNABLE&ndash;&gt;WAITING</strong>ÔºåÂΩìÂâçÁ∫øÁ®ãÂú®tÂØπË±°ÁöÑÁ∫øÁ®ãÁõëËßÜÂô®‰∏äÁ≠âÂæÖ</li>
<li>ÂΩìtÁ∫øÁ®ãÊâßË°åÁªìÊùüÂêéÔºåÊàñËÄÖË∞ÉÁî®‰∫ÜÂΩìÂâçÁ∫øÁ®ãÁöÑ<strong>interrupt()<strong>Êó∂ÔºåÂΩìÂâçÁ∫øÁ®ã‰ªé</strong>WAITING &ndash;&gt; RUNNABLE</strong></li>
</ul>
<h4 id="ÊÉÖÂÜµ4-runnable----waiting">ÊÉÖÂÜµ4 RUNNABLE &lt;&ndash;&gt; WAITING</h4>
<ul>
<li>
<p>ÂΩìÂâçÁ∫øÁ®ã <strong>LockSupport.park()</strong> ÊñπÊ≥ï‰ºöËÆ©ÂΩìÂâçÁ∫øÁ®ã ‰ªé<strong>RUNNABLE &ndash;&gt; WAITING</strong></p>
</li>
<li>
<p>Ë∞ÉÁî® <strong>LockSupport.unpark()</strong> ÊñπÊ≥ï ÊàñËÄÖ Ë∞ÉÁî®‰∫Ü interruptÊñπÊ≥ï ‰ºö‰Ωø <strong>WAITING &ndash;&gt; RUNNABLE</strong></p>
</li>
</ul>
<h4 id="ÊÉÖÂÜµ5-runnable----timed_waiting">ÊÉÖÂÜµ5 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</h4>
<p><strong>tÁ∫øÁ®ãÁî®synchronized(obj)Ëé∑ÂèñÂØπË±°Âêé</strong></p>
<ul>
<li>Ë∞ÉÁî®<strong>wait(time)<strong>ÊñπÊ≥ïÔºåËøõÂÖ•</strong>TIME_WAITING</strong>Áä∂ÊÄÅ</li>
<li>Ë∞ÉÁî®<strong>notify()</strong>Ôºå<strong>notifyAll()</strong>Ôºå<strong>interrupt()</strong>ÔºåÊàñËÄÖwaitÊó∂Èó¥ËÄóÂ∞ΩÊó∂</li>
</ul>
<blockquote>
<ul>
<li>Á´û‰∫âÊàêÂäüÔºå‰ªé<strong>waiting</strong>ËΩ¨‰∏∫<strong>runnable</strong></li>
<li>Á´û‰∫âÂ§±Ë¥•Ôºå‰ªé<strong>waiting</strong>ËΩ¨‰∏∫<strong>blocked</strong></li>
</ul>
</blockquote>
<h4 id="ÊÉÖÂÜµ6-runnable----timed_waiting">ÊÉÖÂÜµ6 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</h4>
<ul>
<li>tÁ∫øÁ®ãË∞ÉÁî®<strong>sleep(time)</strong>ÔºåËøõÂÖ•<strong>TIME_WAITING</strong>Áä∂ÊÄÅ</li>
<li><strong>Ë∂ÖÊó∂ÊàñËÄÖË∞ÉÁî®interrupt‰ªéRUNNABLE&ndash;&gt;TIMED_WAITING</strong></li>
</ul>
<h4 id="ÊÉÖÂÜµ7-runnable----timed_waiting">ÊÉÖÂÜµ7 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</h4>
<ul>
<li>
<p>tÁ∫øÁ®ãË∞ÉÁî®<strong>LockSupport.park(time)</strong>ÔºåËøõÂÖ•<strong>TIME_WAITING</strong>Áä∂ÊÄÅ</p>
</li>
<li>
<p><strong>Ë∂ÖÊó∂ÊàñËÄÖË∞ÉÁî®interrupt‰ªéRUNNABLE&ndash;&gt;TIMED_WAITING</strong></p>
</li>
</ul>
<h4 id="ÊÉÖÂÜµ8-runnable----timed_waiting">ÊÉÖÂÜµ8 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</h4>
<ul>
<li>
<p>tÁ∫øÁ®ãË∞ÉÁî®<strong>join(time)</strong>ÔºåËøõÂÖ•<strong>TIME_WAITING</strong>Áä∂ÊÄÅ</p>
</li>
<li>
<p><strong>Ë∂ÖÊó∂ÊàñËÄÖË∞ÉÁî®interrupt‰ªéRUNNABLE&ndash;&gt;TIMED_WAITING</strong></p>
</li>
</ul>
<h4 id="ÊÉÖÂÜµ9-runnable----terminated">ÊÉÖÂÜµ9 RUNNABLE &lt;&ndash;&gt; TERMINATED</h4>
<p>Á∫øÁ®ãÊâßË°åÂÆåÊØï</p>
<ul>
<li></li>
</ul>
<h2 id="8-ÂêåÊ≠•Ê®°Âºè‰πãÈ°∫Â∫èÊéßÂà∂">8 ÂêåÊ≠•Ê®°Âºè‰πãÈ°∫Â∫èÊéßÂà∂</h2>
<h4 id="Âõ∫ÂÆöËøêË°åÈ°∫Â∫è">Âõ∫ÂÆöËøêË°åÈ°∫Â∫è</h4>
<blockquote>
<p>‰æãÈ¢òÔºöË¶ÅÊ±ÇÁ∫øÁ®ãBÂÖàËæìÂá∫ÂÜçÁ∫øÁ®ãAËæìÂá∫</p>
</blockquote>
<h5 id="wait-notifyÁöÑÊñπÊ≥ïÊù•ÂÖàÂêéËæìÂá∫">wait-notifyÁöÑÊñπÊ≥ïÊù•ÂÖàÂêéËæìÂá∫</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">boolean</span> <span class="n">t2runned</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">A</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">             <span class="k">while</span><span class="o">(!</span><span class="n">t2runned</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">               <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">lock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">               <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                 <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">               <span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">B</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">         <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">             <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">t2runned</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">B</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="park-unparkÁöÑÊñπÊ≥ïÊù•ÂÖàÂêéËæìÂá∫">park-unparkÁöÑÊñπÊ≥ïÊù•ÂÖàÂêéËæìÂá∫</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="‰∫§ÊõøËæìÂá∫">‰∫§ÊõøËæìÂá∫</h4>
<blockquote>
<p>‰æãÈ¢òÔºöÁ∫øÁ®ã1 ËæìÂá∫ a 5Ê¨°ÔºåÁ∫øÁ®ã2 ËæìÂá∫ b 5Ê¨°Ôºå Á∫øÁ®ã3 ËæìÂá∫ c 5Ê¨°„ÄÇÁé∞Âú®Ë¶ÅÊ±ÇËæìÂá∫<strong>abcabcabcabcabc</strong>ÊÄé‰πàÂÆûÁé∞</p>
</blockquote>
<h4 id="wait-notifyÁâàÊú¨">wait-notifyÁâàÊú¨</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">WaitNotify</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">loopNum</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">flag</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">WaitNotify</span><span class="o">(</span><span class="kt">int</span> <span class="n">loopNum</span><span class="o">,</span><span class="kt">int</span> <span class="n">flag</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">loopNum</span> <span class="o">=</span> <span class="n">loopNum</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="n">flag</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nextIndex</span><span class="o">,</span> <span class="n">String</span> <span class="n">word</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">loopNum</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span><span class="o">(</span><span class="n">index</span><span class="o">!=</span><span class="n">flag</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">flag</span> <span class="o">=</span> <span class="n">nextIndex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">WaitNotify</span> <span class="n">waitNotify</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WaitNotify</span><span class="o">(</span><span class="n">5</span><span class="o">,</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">waitNotify</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">1</span><span class="o">,</span><span class="n">2</span><span class="o">,</span><span class="s">&#34;a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">waitNotify</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">2</span><span class="o">,</span><span class="n">3</span><span class="o">,</span><span class="s">&#34;b&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">waitNotify</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">3</span><span class="o">,</span><span class="n">1</span><span class="o">,</span><span class="s">&#34;c&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t3&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">21:25:53.672 [t1] DEBUG JUC.model.WaitNotify - a
</span></span><span class="line"><span class="cl">21:25:53.679 [t2] DEBUG JUC.model.WaitNotify - b
</span></span><span class="line"><span class="cl">21:25:53.679 [t3] DEBUG JUC.model.WaitNotify - c
</span></span><span class="line"><span class="cl">21:25:53.679 [t1] DEBUG JUC.model.WaitNotify - a
</span></span><span class="line"><span class="cl">21:25:53.679 [t2] DEBUG JUC.model.WaitNotify - b
</span></span><span class="line"><span class="cl">21:25:53.679 [t3] DEBUG JUC.model.WaitNotify - c
</span></span><span class="line"><span class="cl">21:25:53.679 [t1] DEBUG JUC.model.WaitNotify - a
</span></span><span class="line"><span class="cl">21:25:53.679 [t2] DEBUG JUC.model.WaitNotify - b
</span></span><span class="line"><span class="cl">21:25:53.679 [t3] DEBUG JUC.model.WaitNotify - c
</span></span><span class="line"><span class="cl">21:25:53.679 [t1] DEBUG JUC.model.WaitNotify - a
</span></span><span class="line"><span class="cl">21:25:53.679 [t2] DEBUG JUC.model.WaitNotify - b
</span></span><span class="line"><span class="cl">21:25:53.679 [t3] DEBUG JUC.model.WaitNotify - c
</span></span><span class="line"><span class="cl">21:25:53.679 [t1] DEBUG JUC.model.WaitNotify - a
</span></span><span class="line"><span class="cl">21:25:53.679 [t2] DEBUG JUC.model.WaitNotify - b
</span></span><span class="line"><span class="cl">21:25:53.679 [t3] DEBUG JUC.model.WaitNotify - c
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="await-signalÁâàÊú¨">await-signalÁâàÊú¨</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AwaitSignal</span> <span class="kd">extends</span> <span class="n">ReentrantLock</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">loopNumber</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">AwaitSignal</span><span class="o">(</span><span class="kt">int</span> <span class="n">loopNumber</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">loopNumber</span> <span class="o">=</span> <span class="n">loopNumber</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="n">Condition</span> <span class="n">condition</span><span class="o">,</span><span class="n">Condition</span> <span class="n">nextCondition</span><span class="o">,</span><span class="n">String</span> <span class="n">word</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">loopNumber</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">condition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">nextCondition</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">AwaitSignal</span> <span class="n">awaitSignal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AwaitSignal</span><span class="o">(</span><span class="n">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Condition</span> <span class="n">condition1</span> <span class="o">=</span> <span class="n">awaitSignal</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Condition</span> <span class="n">condition2</span> <span class="o">=</span> <span class="n">awaitSignal</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Condition</span> <span class="n">condition3</span> <span class="o">=</span> <span class="n">awaitSignal</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">awaitSignal</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">condition1</span><span class="o">,</span><span class="n">condition2</span><span class="o">,</span><span class="s">&#34;a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">awaitSignal</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">condition2</span><span class="o">,</span><span class="n">condition3</span><span class="o">,</span><span class="s">&#34;b&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">awaitSignal</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">condition3</span><span class="o">,</span><span class="n">condition1</span><span class="o">,</span><span class="s">&#34;c&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t3&#34;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">awaitSignal</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">condition1</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">awaitSignal</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">21:48:25.989 [t1] DEBUG JUC.model.AwaitSignal - a
</span></span><span class="line"><span class="cl">21:48:25.995 [t2] DEBUG JUC.model.AwaitSignal - b
</span></span><span class="line"><span class="cl">21:48:25.995 [t3] DEBUG JUC.model.AwaitSignal - c
</span></span><span class="line"><span class="cl">21:48:25.996 [t1] DEBUG JUC.model.AwaitSignal - a
</span></span><span class="line"><span class="cl">21:48:25.996 [t2] DEBUG JUC.model.AwaitSignal - b
</span></span><span class="line"><span class="cl">21:48:25.996 [t3] DEBUG JUC.model.AwaitSignal - c
</span></span><span class="line"><span class="cl">21:48:25.996 [t1] DEBUG JUC.model.AwaitSignal - a
</span></span><span class="line"><span class="cl">21:48:25.996 [t2] DEBUG JUC.model.AwaitSignal - b
</span></span><span class="line"><span class="cl">21:48:25.996 [t3] DEBUG JUC.model.AwaitSignal - c
</span></span><span class="line"><span class="cl">21:48:25.996 [t1] DEBUG JUC.model.AwaitSignal - a
</span></span><span class="line"><span class="cl">21:48:25.996 [t2] DEBUG JUC.model.AwaitSignal - b
</span></span><span class="line"><span class="cl">21:48:25.996 [t3] DEBUG JUC.model.AwaitSignal - c
</span></span><span class="line"><span class="cl">21:48:25.996 [t1] DEBUG JUC.model.AwaitSignal - a
</span></span><span class="line"><span class="cl">21:48:25.996 [t2] DEBUG JUC.model.AwaitSignal - b
</span></span><span class="line"><span class="cl">21:48:25.997 [t3] DEBUG JUC.model.AwaitSignal - c
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ê≥®ÔºöÊ≠§Â§ÑÊúâbugÔºåÂΩìaÂî§ÈÜíbÂêéÔºåÊ≠§Êó∂aÊú™ËøõÂÖ•conditionËøõË°åÁ≠âÂæÖÔºåËÄåÊòØÁõ¥Êé•ËøêË°åbÔºåbÂÜçËøêË°åcÔºåcÂî§ÈÜíaÂêéÔºåÂÜçÊ¨°ËøõÂÖ•cÁÑ∂ÂêéËøõË°åÁ≠âÂæÖÔºåÁÑ∂ÂêéËøêË°åa ËøõË°åÁ≠âÂæÖÔºåÂ∞±‰ºö‰ΩøÂæóaÊó†‰∫∫Âî§ÈÜí„ÄÇ</p>
<h4 id="park-unparkÁâàÊú¨">park-unparkÁâàÊú¨</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public static void test3(int n){
</span></span><span class="line"><span class="cl">        ParkUnPark parkUnPark = new ParkUnPark(n);
</span></span><span class="line"><span class="cl">        t1 = new Thread(()-&gt;{
</span></span><span class="line"><span class="cl">            parkUnPark.print(&#34;a&#34;,t2);
</span></span><span class="line"><span class="cl">        },&#34;3-t1&#34;);
</span></span><span class="line"><span class="cl">        t2 = new Thread(()-&gt;{
</span></span><span class="line"><span class="cl">            parkUnPark.print(&#34;b&#34;,t3);
</span></span><span class="line"><span class="cl">        },&#34;3-t2&#34;);
</span></span><span class="line"><span class="cl">        t3 = new Thread(()-&gt;{
</span></span><span class="line"><span class="cl">            long start = System.currentTimeMillis();
</span></span><span class="line"><span class="cl">            parkUnPark.print(&#34;c&#34;,t1);
</span></span><span class="line"><span class="cl">            long end = System.currentTimeMillis();
</span></span><span class="line"><span class="cl">            log.debug(&#34;ParkUnPark time{} ms&#34;,start-end);
</span></span><span class="line"><span class="cl">        },&#34;3-t3&#34;);
</span></span><span class="line"><span class="cl">        t1.start();
</span></span><span class="line"><span class="cl">        t2.start();
</span></span><span class="line"><span class="cl">        t3.start();
</span></span><span class="line"><span class="cl">        LockSupport.unpark(t1);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">class ParkUnPark{
</span></span><span class="line"><span class="cl">    private int loopNumber;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public void print(String word,Thread next){
</span></span><span class="line"><span class="cl">        for (int i = 0; i &lt;loopNumber ; i++) {
</span></span><span class="line"><span class="cl">            LockSupport.park();
</span></span><span class="line"><span class="cl">            //log.debug(word);
</span></span><span class="line"><span class="cl">            LockSupport.unpark(next);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public ParkUnPark(int loopNumber){
</span></span><span class="line"><span class="cl">        this.loopNumber = loopNumber;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>‰∏â‰∏™ÁâàÊú¨ËøêË°å50000Ê¨°ÈÄüÂ∫¶ÊØîËæÉ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">01:38:15.238 [3-t3] DEBUG JUC.model.alternateControl - ParkUnPark time-13545 ms
</span></span><span class="line"><span class="cl">01:38:16.938 [2-t3] DEBUG JUC.model.alternateControl - AwaitSignal time-15245 ms
</span></span><span class="line"><span class="cl">01:38:20.998 [1-t3] DEBUG JUC.model.alternateControl - WaitNotify time-19289 ms
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ParkUnPark &gt; AwaitSignal &gt; WaitNotify</p>
</blockquote>
<h2 id="9-ÂÖ±‰∫´Ê®°Âûã‰πãÂÜÖÂ≠ò">9 ÂÖ±‰∫´Ê®°Âûã‰πãÂÜÖÂ≠ò</h2>
<h3 id="91-javaÂÜÖÂ≠òÊ®°Âûã">9.1 JavaÂÜÖÂ≠òÊ®°Âûã</h3>
<h4 id="ÁÆÄ‰ªã">ÁÆÄ‰ªã</h4>
<p>JMMÂç≥ Java Memory ModelÔºåÂÆÉÂÆö‰πâ‰∫Ü‰∏ªÂ≠òÔºåÂ∑•‰ΩúÂÜÖÂ≠òÊäΩË±°Ê¶ÇÂøµÔºåÂ∫ïÂ±ÇÂØπÂ∫îÁùÄCPUÂØÑÂ≠òÂô®ÔºåÁºìÂ≠òÔºåÁ°¨‰ª∂ÂÜÖÂ≠òÔºåCPUÊåá‰ª§‰ºòÂåñÁ≠â</p>
<p>JMM‰ΩìÁé∞Âú®‰ª•‰∏ãÂá†‰∏™ÊñπÈù¢Ôºö</p>
<ul>
<li>ÂéüÂ≠êÊÄß-‰øùËØÅÊåá‰ª§‰∏ç‰ºöÂèóÂà∞‰∏ä‰∏ãÊñáÂàáÊç¢ÁöÑÂΩ±Âìç</li>
<li>ÂèØËßÅÊÄß-‰øùËØÅÊåá‰ª§‰∏çÂèóCPUÁºìÂ≠òÁöÑÂΩ±Âìç</li>
<li>ÊúâÂ∫èÊÄß-‰øùËØÅÊåá‰ª§‰∏ç‰ºöCPUÊåá‰ª§Âπ∂Ë°å‰ºòÂåñÁöÑÂΩ±Âìç</li>
</ul>
<h3 id="92-ÂèØËßÅÊÄß">9.2 ÂèØËßÅÊÄß</h3>
<h4 id="ÁÆÄ‰ªã-1"><strong>ÁÆÄ‰ªãÔºö</strong></h4>
<blockquote>
<p>Êàë‰ª¨Áü•ÈÅìÔºåÂú®Áé∞‰ª£ËÆ°ÁÆóÊú∫‰∏≠ÔºåÁî±‰∫é CPU Áõ¥Êé•‰ªé‰∏ªÂÜÖÂ≠ò‰∏≠ËØªÂèñÊï∞ÊçÆÁöÑÊïàÁéá‰∏çÈ´òÔºåÊâÄ‰ª•ÈÉΩ‰ºöÂØπÂ∫îÁöÑ CPU È´òÈÄüÁºìÂ≠òÔºåÂÖàÂ∞Ü‰∏ªÂÜÖÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆËØªÂèñÂà∞ÁºìÂ≠ò‰∏≠ÔºåÁ∫øÁ®ã‰øÆÊîπÊï∞ÊçÆ‰πãÂêéÈ¶ñÂÖàÊõ¥Êñ∞Âà∞ÁºìÂ≠òÔºå‰πãÂêéÊâç‰ºöÊõ¥Êñ∞Âà∞‰∏ªÂÜÖÂ≠ò„ÄÇÂ¶ÇÊûúÊ≠§Êó∂ËøòÊ≤°ÊúâÂ∞ÜÊï∞ÊçÆÊõ¥Êñ∞Âà∞‰∏ªÂÜÖÂ≠òÂÖ∂‰ªñÁöÑÁ∫øÁ®ãÊ≠§Êó∂Êù•ËØªÂèñÂ∞±ÊòØ‰øÆÊîπ‰πãÂâçÁöÑÊï∞ÊçÆ„ÄÇËÄåÂú®Â§öÁ∫øÁ®ãÁöÑÊÉÖÂÜµ‰∏ãÔºåÂèØËÉΩ‰ºöÂØºËá¥ÂèòÈáèÁöÑÂÄºÊîπÂèòÔºå‰∏éÂÆûÈôÖÁöÑÂÄº‰∏çÁ¨¶ÔºåËÄåÁºìÂ≠òÈáåÁöÑÂÄºÊòØ‰∏ç‰ºöÊîπÂèòÁöÑ„ÄÇÊâÄ‰ª•Â∫îÂΩì‰øùËØÅÂú®Â§öÁ∫øÁ®ãÁöÑÊÉÖÂÜµ‰∏ãÔºåÂèòÈáèÁöÑÂÄºÂæóÊîπÂèòË¶ÅÂêåÊ≠•Ôºåvolatile‰øùËØÅ‰∫ÜÊØèÊ¨°ÂÄºÈÉΩ‰ªéÂÜÖÂ≠ò‰∏≠Ëé∑Âèñ„ÄÇ</p>
</blockquote>
<h4 id="ÂÆö‰πâ-2">ÂÆö‰πâ:</h4>
<p>ÂèØËßÅÊÄßÂ∞±ÊòØÊåáÂΩìÂ§ö‰∏™Á∫øÁ®ãËÆøÈóÆÂêå‰∏Ä‰∏™ÂèòÈáèÊó∂Ôºå‰∏Ä‰∏™Á∫øÁ®ã‰øÆÊîπ‰∫ÜËøô‰∏™ÂèòÈáèÁöÑÂÄºÔºåÂÖ∂‰ªñÁ∫øÁ®ãËÉΩÂ§üÁ´ãÂç≥ÁúãÂæóÂà∞‰øÆÊîπÁöÑÂÄº„ÄÇ</p>
<h4 id="ÈóÆÈ¢ò">ÈóÆÈ¢ò</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">boolean</span> <span class="n">runnable</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">runnable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;stop&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//        new Thread(()-&gt;{
</span></span></span><span class="line"><span class="cl"><span class="c1">//            foo();
</span></span></span><span class="line"><span class="cl"><span class="c1">//        }).start();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">foo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="o">(</span><span class="n">runnable</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">             <span class="n">i</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÁªìÊùü i={}&#34;</span><span class="o">,</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÁªìÊûú">ÁªìÊûú</h4>
<p>JDK5 ‰∏≠ ËøêË°å‰∏ç‰ºöÂÅúÊ≠¢</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331154727822.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331154727822"
	
	
></p>
<p>JDK8‰∏≠ ËøêË°åÂÅúÊ≠¢‰∫ÜÔºàËøôÈáåÊòØÂõ†‰∏∫ÊàëÁî®ÁöÑÊòØjdk x86ÁöÑÂéüÂõ† ÂØºËá¥‰∏ç‰ºöÊúâÂèØËßÅÊÄßÂ≠òÂú®Ôºâ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331154758252.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331154758252"
	
	
></p>
<h4 id="ÂéüÁêÜ-1">ÂéüÁêÜ</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331142913212.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331142913212"
	
	
></p>
<p>ÂΩìÂÖ®Â±ÄÂèòÈáèÂÆö‰πâÊó∂ÔºåÊîæÂÖ•Âú®‰∏ªÂÜÖÂ≠òÔºåÊ≠§Êó∂tÁ∫øÁ®ãËØªÂèñ‰∏ªÂÜÖÂ≠òÁöÑrunÔºåËøõÂÖ•Âæ™ÁéØ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331143050864.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331143050864"
	
	
></p>
<p>ÊúâJIT‰ºòÂåñÁöÑÂéüÂõ†Ôºå‰ºöÁªôtÁ∫øÁ®ãÂºÄËæü‰∏Ä‰∏™È´òÈÄüÁºìÂ≠òÔºåÂπ∂Â∞ÜÂèòÈáèrunÂ≠òÂÖ•È´òÈÄüÁºìÂ≠òÔºå‰ª•Â∏ÆÂä©Á∫øÁ®ãÊõ¥Âø´ÁöÑËé∑ÂèñÂèòÈáè</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331143203102.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331143203102"
	
	
></p>
<p>Ê≠§Êó∂‰∏ªÁ∫øÁ®ã‰øÆÊîπ‰∏ªÂÜÖÂ≠ò‰∏≠ÁöÑrunÔºårunË¢´Êîπ‰∏∫falseÔºå‰ΩÜÊòØtÁ∫øÁ®ã‰∏≠ÁöÑrunËøòÊòØ‰ΩøÁî®ÁöÑÈ´òÈÄüÁºìÂ≠òÔºåÂàôÂØºËá¥‰∏çÂèØËßÅÊÄßÔºå</p>
<p>Âæ™ÁéØ‰∏ÄÁõ¥ÊåÅÁª≠„ÄÇ</p>
<h4 id="Ëß£ÂÜ≥ÊñπÊ≥ï">Ëß£ÂÜ≥ÊñπÊ≥ï</h4>
<h5 id="volatileÊòìÂèòÂÖ≥ÈîÆÂ≠ó">volatile(ÊòìÂèòÂÖ≥ÈîÆÂ≠ó)</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">volatile</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="n">runnable</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÆÉÂèØ‰ª•Áî®Êù•‰øÆÈ•∞ÊàêÂëòÂèòÈáèÂíåÈùôÊÄÅÊàêÂëòÂèòÈáèÔºå‰ªñÂèØ‰ª•ÈÅøÂÖçÁ∫øÁ®ã‰ªéËá™Â∑±ÁöÑÁ∫øÁ®ãÁöÑÂ∑•‰ΩúÁºìÂ≠òËé∑ÂèñËµÑÊ∫êÔºåÂøÖÈ°ªÂà∞‰∏ªÂ≠ò‰∏≠Ëé∑ÂèñÂÆÉÁöÑÂÄºÔºåÁ∫øÁ®ãÊìç‰ΩúvolatileÂèòÈáèÈÉΩÊòØÁõ¥Êé•Êìç‰Ωú‰∏ªÂ≠ò</p>
<h5 id="synchronized">synchronized</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">foo2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;stop&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">runnable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">foo2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(!</span><span class="n">runnable</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="‰∏∫‰ªÄ‰πàÂú®whileÂæ™ÁéØ‰∏≠Âä†ÂÖ•systemoutprintln-‰πü‰ºö‰ΩøÂÖ∂ÈÄÄÂá∫Âæ™ÁéØ">‰∏∫‰ªÄ‰πàÂú®whileÂæ™ÁéØ‰∏≠Âä†ÂÖ•System.out.println() ‰πü‰ºö‰ΩøÂÖ∂ÈÄÄÂá∫Âæ™ÁéØÔºü</h6>
<blockquote>
<p>Âõ†‰∏∫Âú®System.out.println()ÁöÑÊ∫êÁ†Å‰∏≠ÔºåËøõË°å‰∫ÜÂä†ÈîÅÊìç‰Ωú</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public void println(String x) {
</span></span><span class="line"><span class="cl">        synchronized (this) {
</span></span><span class="line"><span class="cl">            print(x);
</span></span><span class="line"><span class="cl">            newLine();
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="synchronized-vs-volatile">Synchronized vs Volatile</h4>
<ul>
<li>
<p>volatile‰øùËØÅÂ§ö‰∏™Á∫øÁ®ã‰πãÈó¥Ôºå‰∏Ä‰∏™Á∫øÁ®ãÂØπvolatileÂèòÈáè‰øÆÊîπÔºå‰∏Ä‰∏™Á∫øÁ®ãÂØπvolatileËØªÂèñÔºå<strong>ÂèØ‰ª•‰øùËØÅÂèØËßÅÊÄßÔºå‰ΩÜ‰∏çËÉΩ‰øùËØÅÂéüÂ≠êÊÄß</strong>Ôºå‰ªÖÁî®Âú®‰∏Ä‰∏™Á∫øÁ®ãËØªÂèñ‰∏Ä‰∏™Á∫øÁ®ã‰øÆÊîπÁöÑÊÉÖÂÜµ„ÄÇ</p>
</li>
<li>
<p>synchronized ÂèØ‰ª•‰øùËØÅÂ§ö‰∏™Á∫øÁ®ã‰πãÈó¥ÁöÑËØªÂÜôÈóÆÈ¢òÔºå<strong>Âç≥Êó¢ËÉΩ‰øùËØÅÂéüÂ≠êÊÄß‰πüËÉΩ‰øùËØÅÂèØËßÅÊÄß</strong>Ôºå‰ΩÜÊòØsynchronizedÂ±û‰∫éÈáçÈáèÁ∫ßÊìç‰ΩúÔºåÂçÅÂàÜÊ∂àËÄóÊÄßËÉΩ„ÄÇ</p>
</li>
</ul>
<h4 id="‰ΩøÁî®volatileÁöÑ‰∏§Èò∂ÊÆµÁªàÊ≠¢Ê®°Âºè">‰ΩøÁî®volatileÁöÑ‰∏§Èò∂ÊÆµÁªàÊ≠¢Ê®°Âºè</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Thread</span> <span class="n">monitor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">volatile</span> <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">TwoPhaseInterrput</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">stop</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÊñôÁêÜÂêé‰∫ã&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÁõëÊéß‰∏≠&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//current.interrupt(); //Áî±‰∫ésleep‰ºöÊ∏ÖÈô§InterruptÊ†áËÆ∞,ÈáçÊñ∞ÊâìÊñ≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">4</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">stop</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÂÅúÊ≠¢ÁõëÊéß&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TwoPhaseInterrput</span> <span class="n">twoPhaseInterrput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TwoPhaseInterrput</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">twoPhaseInterrput</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">twoPhaseInterrput</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÂêåÊ≠•Ê®°Âºè‰πãbalking">ÂêåÊ≠•Ê®°Âºè‰πãBalking</h4>
<p>Balking(ÁäπË±´)Ê®°ÂºèÔºåÁî®Âú®‰∏Ä‰∏™Á∫øÁ®ãÂèëÁé∞Âè¶‰∏Ä‰∏™Á∫øÁ®ãÂÅö‰∫ÜÊú¨Á∫øÁ®ãÂ∑≤ÁªèÂÅö‰∫ÜÊüê‰∏Ä‰ª∂Áõ∏ÂêåÁöÑ‰∫ãÔºåÈÇ£‰πàÁ∫øÁ®ãÂàôÊó†ÈúÄÂú®ÂÅö‰∫ÜÔºåÁõ¥Êé•ËøîÂõû</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">TwoPhaseTermination</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Thread</span> <span class="n">monitorThread</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">starting</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">monitorThread</span><span class="o">!=</span><span class="kc">null</span><span class="o">&amp;&amp;</span><span class="n">monitorThread</span><span class="o">.</span><span class="na">getState</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">State</span><span class="o">.</span><span class="na">TERMINATED</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="n">starting</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Âî§ÈÜíÁõëÊéß&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">starting</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÁõëÊéßÂ∑≤ÁªèÂêØÂä®&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">starting</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÂàõÂª∫Êñ∞ÁõëÊéß&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">monitorThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÂêØÂä®ÁõëÊéß&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÁõëÊéßÂÖ≥Èó≠&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">},</span><span class="s">&#34;monitor&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">monitorThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TwoPhaseTermination</span> <span class="n">twoPhaseTermination</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TwoPhaseTermination</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">10</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">twoPhaseTermination</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">500</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">10</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">twoPhaseTermination</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ÁªìÊûú-1">ÁªìÊûú:</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">18:46:18.095 [t1] DEBUG JUC.model.TwoPhaseTermination - ÂàõÂª∫Êñ∞ÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:18.095 [t2] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:18.105 [t2] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:18.106 [monitor] DEBUG JUC.model.TwoPhaseTermination - ÂêØÂä®ÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:18.621 [t1] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:19.113 [monitor] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂÖ≥Èó≠
</span></span><span class="line"><span class="cl">18:46:19.128 [t1] DEBUG JUC.model.TwoPhaseTermination - Âî§ÈÜíÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:19.128 [t1] DEBUG JUC.model.TwoPhaseTermination - ÂàõÂª∫Êñ∞ÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:19.128 [monitor] DEBUG JUC.model.TwoPhaseTermination - ÂêØÂä®ÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:19.635 [t1] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:20.136 [t1] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:20.136 [monitor] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂÖ≥Èó≠
</span></span><span class="line"><span class="cl">18:46:20.649 [t1] DEBUG JUC.model.TwoPhaseTermination - Âî§ÈÜíÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:20.649 [t1] DEBUG JUC.model.TwoPhaseTermination - ÂàõÂª∫Êñ∞ÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:20.649 [monitor] DEBUG JUC.model.TwoPhaseTermination - ÂêØÂä®ÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:21.164 [t1] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:21.664 [monitor] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂÖ≥Èó≠
</span></span><span class="line"><span class="cl">18:46:21.664 [t1] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:22.165 [t1] DEBUG JUC.model.TwoPhaseTermination - Âî§ÈÜíÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:22.165 [t1] DEBUG JUC.model.TwoPhaseTermination - ÂàõÂª∫Êñ∞ÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:22.165 [monitor] DEBUG JUC.model.TwoPhaseTermination - ÂêØÂä®ÁõëÊéß
</span></span><span class="line"><span class="cl">18:46:22.666 [t1] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂ∑≤ÁªèÂêØÂä®
</span></span><span class="line"><span class="cl">18:46:23.165 [monitor] DEBUG JUC.model.TwoPhaseTermination - ÁõëÊéßÂÖ≥Èó≠
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="Â∫îÁî®">Â∫îÁî®Ôºö</h5>
<p>ÂÆûÁé∞Á∫øÁ®ãÂÆâÂÖ®ÁöÑÂçï‰æãÊ®°Âºè</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="93-ÊúâÂ∫èÊÄß">9.3 ÊúâÂ∫èÊÄß</h3>
<h4 id="‰ªÄ‰πàÊòØÊåá‰ª§ÈáçÊéí">‰ªÄ‰πàÊòØ„ÄêÊåá‰ª§ÈáçÊéí„ÄëÔºü</h4>
<p>JVM‰ºöÂú®‰∏çÂΩ±ÂìçÊ≠£Á°ÆÊÄßÁöÑÂâçÊèê‰∏ãÔºåÂèØ‰ª•Ë∞ÉÊï¥ËØ≠Âè•ÁöÑÊâßË°åÈ°∫Â∫è</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">int</span> <span class="n">j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="o">..</span>
</span></span><span class="line"><span class="cl"><span class="n">j</span> <span class="o">=</span> <span class="o">..</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂØπ‰∫é‰ª•‰∏äÁªìÊûúÔºåÂÖàÊâßË°åiÔºåËøòÊòØÂÖàÊâßË°åjÔºåÈÉΩ‰∏ç‰ºöÂØπÊúÄÂêéÁöÑÁªìÊûúÊúâÂΩ±ÂìçÔºåËøôÊ†∑ÁöÑÁâπÊÄßÁß∞‰πã‰∏∫„ÄêÊåá‰ª§ÈáçÊéí„ÄëÔºå‰ΩÜÊòØÂú®Â§öÁ∫øÁ®ã‰∏ã„ÄêÊåá‰ª§ÈáçÊéí‰ºöÂΩ±ÂìçÊ≠£Á°ÆÊÄß„ÄÇ</p>
<h4 id="‰∏∫‰ªÄ‰πàË¶ÅÊúâÊåá‰ª§ÈáçÊéíËøô‰∏ÄÁâπÊÄßÂë¢">‰∏∫‰ªÄ‰πàË¶ÅÊúâ„ÄêÊåá‰ª§ÈáçÊéí„ÄëËøô‰∏ÄÁâπÊÄßÂë¢Ôºü</h4>
<h5 id="Êåá‰ª§ÈáçÊéíÂ∫è‰ºòÂåñ">Êåá‰ª§ÈáçÊéíÂ∫è‰ºòÂåñ</h5>
<p>Áé∞‰ª£Â§ÑÁêÜÂô®‰ºöËÆæËÆ°‰∏∫‰∏Ä‰∏™Êó∂ÈíüÂë®ÊúüÂÆåÊàê‰∏ÄÊù°ÊâßË°åÊó∂Èó¥ÊúÄÈïøÁöÑCPUÊåá‰ª§„ÄÇÊåá‰ª§ÂèØ‰ª•ÂÜçÂàíÂàÜÊàê‰∏Ä‰∏™‰∏™Êõ¥Â∞èÁöÑÈò∂ÊÆµÔºå‰æãÂ¶ÇÔºåÊØèÊù°Êåá‰ª§ÈÉΩÂèØ‰ª•ÂàÜ‰∏∫Ôºö<strong>ÂèñÊåá‰ª§ - Êåá‰ª§ËØëÁ†Å - ÊâßË°åÊåá‰ª§ - ÂÜÖÂ≠òËÆøÈóÆ - Êï∞ÊçÆÂÜôÂõû</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331191315711.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331191315711"
	
	
></p>
<p>Â¶ÇÂÉèÂõæ‰∏äÊìç‰ΩúÁöÑËØùÔºåÂ∞ÜÊµ™Ë¥πÂæàÂ§öÊó∂Èó¥ÔºåÊàë‰ª¨ÂèØ‰ª•Âú®Êåá‰ª§ËØëÁ†ÅÊúüÈó¥ÔºåÊâßË°å‰∏ã‰∏ÄÊù°Êåá‰ª§ÁöÑÂèñÊåá‰ª§„ÄÇÁé∞‰ª£<strong>CPUÊîØÊåÅÂ§öÁ∫ßÊåá‰ª§ÁöÑÊµÅÊ∞¥Á∫øÊìç‰Ωú</strong>Ôºå‰æãÂ¶ÇÂêåÊó∂ÊâßË°å <strong>ÂèñÊåá‰ª§ - Êåá‰ª§ËØëÁ†Å - ÊâßË°åÊåá‰ª§ - ÂÜÖÂ≠òËÆøÈóÆ - Êï∞ÊçÆÂÜôÂõû</strong>  ÁöÑÂ§ÑÁêÜÂô®ÔºåÂ∞±ÂèØ‰ª•Áß∞‰∏∫<strong>‰∫îÁ∫ßÊåá‰ª§ÊµÅÊ∞¥Á∫ø</strong>„ÄÇËøôÊòØCPUÂèØ‰ª•Âú®‰∏Ä‰∏™Êó∂ÈíüÂë®ÊúüÂÜÖÔºå<strong>ÂêåÊó∂ËøêË°å‰∫îÊù°Êåá‰ª§ÁöÑ‰∏çÂêåÈò∂ÊÆµ</strong>ÔºåÊú¨Ë¥®‰∏äÔºå<strong>Â§öÁ∫ßÊåá‰ª§ÊµÅÊ∞¥Á∫øÊìç‰Ωú‰∏çËÉΩÁº©Áü≠ÂçïÊù°Êåá‰ª§ÁöÑËøêË°åÈÄüÂ∫¶Ôºå‰ΩÜÊòØÂèØ‰ª•Â§ßÂ§ßÊèêÈ´òÂêûÂêêÈáè</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220331191655681.png"
	
	
	
	loading="lazy"
	
		alt="image-20220331191655681"
	
	
></p>
<p>Âú®‰∏çÊîπÂèòÁ®ãÂ∫èÁªìÊûúÁöÑÂâçÊèê‰∏ãÔºåËøô‰∫õÊåá‰ª§ÁöÑÂêÑ‰∏™Èò∂ÊÆµÂèØ‰ª•ÈÄöËøá<strong>ÈáçÊéíÂ∫è</strong>Âíå<strong>ÁªÑÂêà</strong>Êù•ÂÆûÁé∞Êåá‰ª§Âπ∂Ë°åÔºåÂ¶Ç‰∏ãÂõæÂ∞±ÊòØÂèØ‰ª•ËøõË°åÊåá‰ª§ÈáçÊéíÂ∫è</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">20</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">20</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ËøôÊòØ‰∏çËÉΩÊåá‰ª§ÈáçÊéíÂ∫èÁöÑ‰æãÂ≠ê</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">10</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">20</span> <span class="o">-</span> <span class="n">a</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ËØ°ÂºÇÁöÑÁªìÊûú">ËØ°ÂºÇÁöÑÁªìÊûú</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// volatile ‰øÆÈ•∞ÁöÑÂèòÈáèÔºåÂèØ‰ª•Á¶ÅÁî®Êåá‰ª§ÈáçÊéí volatile boolean ready = false; ÂèØ‰ª•Èò≤Ê≠¢ÂèòÈáè‰πãÂâçÁöÑ‰ª£Á†ÅË¢´ÈáçÊéíÂ∫è
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">boolean</span> <span class="n">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Á∫øÁ®ã1 ÊâßË°åÊ≠§ÊñπÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor1</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 <span class="k">if</span><span class="o">(</span><span class="n">ready</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="n">num</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span> 
</span></span><span class="line"><span class="cl">	 <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Á∫øÁ®ã2 ÊâßË°åÊ≠§ÊñπÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor2</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 <span class="n">num</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ª•‰∏ä‰ª£Á†Å r1 ‰ºöÊúâÂá†ÁßçÁªìÊûú</p>
<ul>
<li>ÁªìÊûú‰∏ÄÔºöÂÖàÊâßË°åÁ∫øÁ®ã2ÁöÑactor2ÊñπÊ≥ïÔºåÊâßË°åÂÆåÂêéÔºåÊâßË°åÁ∫øÁ®ã1ÔºåÊúÄÂêéÁ≠îÊ°à‰∏∫4</li>
<li>ÁªìÊûú‰∫åÔºöÂÖàÊâßË°åactor1ÊñπÊ≥ïÔºåÊâßË°åÂÆåÂêéÔºåÁ≠îÊ°à‰∏∫1</li>
<li><strong>ÁªìÊûú‰∏â</strong>ÔºöÂõ†‰∏∫ÈáçÊéíÂ∫èÁöÑÂéüÂõ†Ôºå‰ΩøÂæóreadyÂíånumÁöÑ‰ª£Á†ÅÊâßË°åÈ°∫Â∫èÂÄíËΩ¨Ôºå‰ΩøÂæóready = trueÂÖàÊâßË°åÔºå‰ªéËÄåÂØºËá¥Á≠îÊ°à‰∏∫0</li>
</ul>
<h5 id="Ëß£ÂÜ≥">Ëß£ÂÜ≥Ôºö</h5>
<p>ÂØπreadyÂèòÈáèÂä†‰∏Ä‰∏™volatileÔºå‰ΩøÂæóÈáçÊéíÂ∫èÈóÆÈ¢òËß£ÂÜ≥</p>
<h3 id="94-volatile-ÂéüÁêÜ">9.4 volatile ÂéüÁêÜ</h3>
<p><strong>volatileÁöÑÂ∫ïÂ±ÇÂéüÁêÜÊòØÂÜÖÂ≠òÂ±èÈöú</strong></p>
<ul>
<li>ËØªÂ±èÈöúÔºöÂØπvolatileÂèòÈáèÊâßË°åËØªÊåá‰ª§‰ºöÊ∑ªÂä†ËØªÂ±èÈöú</li>
<li>ÂÜôÂ±èÈöúÔºöÂØπvolatileÂèòÈáèÊâßË°åÂÜôÊåá‰ª§‰ºöÊ∑ªÂä†ÂÜôÂ±èÈöú</li>
</ul>
<h4 id="Â¶Ç‰Ωï‰øùËØÅÂèØËßÅÊÄß">Â¶Ç‰Ωï‰øùËØÅÂèØËßÅÊÄß</h4>
<p><strong>ÂÜôÂ±èÈöúÔºö</strong> <strong>Âú®ËØ•Â±èÈöú‰πãÂâç</strong>ÔºåÂØπÂêåÊ≠•Âà∞‰∏ªÂ≠òÂΩì‰∏≠ÔºåÂ∞Ü‰øÆÊîπÁöÑÊï∞ÊçÆ‰øÆÊîπËá≥‰∏ªÂ≠òÂΩì‰∏≠</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor2</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 <span class="n">num</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">//ready ÊòØ volatileËµãÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ÂÜôÂ±èÈöú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ËØªÂ±èÈöúÔºöÂú®ËØ•Â±èÈöú‰πãÂêé</strong>ÔºåÂØπÂÖ±‰∫´ÂèòÈáèÁöÑËØªÂèñÔºå‰ºöÂú®‰∏ªÂ≠òÂΩì‰∏≠ÂéªËØªÂèñ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor1</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ËØªÂ±èÈöú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	 <span class="k">if</span><span class="o">(</span><span class="n">ready</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="n">num</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span> 
</span></span><span class="line"><span class="cl">	 <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402174335491.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402174335491"
	
	
></p>
<h4 id="Â¶Ç‰Ωï‰øùËØÅÊúâÂ∫èÊÄß">Â¶Ç‰Ωï‰øùËØÅÊúâÂ∫èÊÄß</h4>
<p><strong>ÂÜôÂ±èÈöúÔºöÂú®ËØ•Â±èÈöú‰πãÂâçÁöÑ‰ª£Á†Å‰∏ç‰ºöÊéíÂú®ÂÜôÂ±èÈöú‰πãÂêé</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor2</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 <span class="n">num</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="n">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">//ready ÊòØ volatileËµãÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ÂÜôÂ±èÈöú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ËØªÂ±èÈöúÔºöÂú®ËØ•Â±èÈöú‰πãÂêéÁöÑ‰ª£Á†Å‰∏ç‰ºöÊéíÂú®ËØªÂ±èÈöú‰πãÂâç</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">actor1</span><span class="o">(</span><span class="n">I_Result</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ËØªÂ±èÈöú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	 <span class="k">if</span><span class="o">(</span><span class="n">ready</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="n">num</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span> 
</span></span><span class="line"><span class="cl">	 <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	 	<span class="n">r</span><span class="o">.</span><span class="na">r1</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	 <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402175426307.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402175426307"
	
	
></p>
<h5 id="volatileËôΩÁÑ∂ËÉΩËß£ÂÜ≥ÂèØËßÅÊÄßÂíåÊúâÂ∫èÊÄß‰ΩÜÊòØÊó†Ê≥ïËß£ÂÜ≥ÂéüÂ≠êÊÄß‰πüÂ∞±ÊòØÊåá‰ª§‰∫§Èîô">volatileËôΩÁÑ∂ËÉΩËß£ÂÜ≥ÂèØËßÅÊÄßÂíåÊúâÂ∫èÊÄßÔºå‰ΩÜÊòØÊó†Ê≥ïËß£ÂÜ≥ÂéüÂ≠êÊÄßÔºå‰πüÂ∞±ÊòØÊåá‰ª§‰∫§Èîô</h5>
<ul>
<li>ÂÜôÊìç‰ΩúËÉΩ‰øùËØÅÔºå‰∏ªÂ≠ò‰∏≠Êõ¥Êñ∞ÊúÄÊñ∞ÁöÑÊï∞ÊçÆÔºå‰ΩÜÊòØ‰∏çËÉΩ‰øùËØÅÔºåËØªÊåá‰ª§Âú®ÂÜôÊìç‰Ωú‰πãÂâçÂèëÁîü</li>
<li>ÊúâÂ∫èÊÄß‰πüÂè™ËÉΩ‰øùËØÅÂú®Êú¨Á∫øÁ®ãÂÜÖÁõ∏ÂÖ≥‰ª£Á†Å‰∏çË¢´ÈáçÊñ∞ÊéíÂ∫è</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402175746518.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402175746518"
	
	
></p>
<h4 id="double-checked-locking-ÈóÆÈ¢ò">double-checked locking ÈóÆÈ¢ò</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ª•‰∏äÂÆûÁé∞ÁöÑÁâπÁÇπÔºö</p>
<ul>
<li>ÊáíÊÉ∞ÂÆû‰æãÂåñ</li>
<li>Âà©Áî®synchronizedÂØπgetInstanceÂä†ÈîÅÔºåÈò≤Ê≠¢Á∫øÁ®ãÂèØËßÅÊÄßÈóÆÈ¢ò</li>
</ul>
<blockquote>
<p>**ÈóÆÈ¢òÔºö**ËôΩËØ¥‰øùËØÅ‰∫ÜÁ∫øÁ®ãÂÆâÂÖ®Ôºå‰øùËØÅÂÆû‰æãÂØπË±°Âè™‰ºöÁîüÊàê‰∏Ä‰∏™Ôºå‰ΩÜÊòØÂú®Âçï‰æãÂØπË±°ÁîüÊàêÂêéÔºåÊàëÂ∞±‰∏çÈúÄË¶ÅÂØπÂÖ∂Âä†‰∏äÁ∫øÁ®ãÂÆâÂÖ®ÈîÅ‰∫ÜÔºåÊØè‰∏ÄÊ¨°Ë∞ÉÁî®getInstanceÊñπÊ≥ïÈÉΩ‰ºöË¶Å‰∏äÈîÅÔºå‰ºöÂØºËá¥ÊÄßËÉΩÈôç‰Ωé</p>
</blockquote>
<p><strong>‰∫éÊòØÂ∞±Êúâ‰∫ÜËëóÂêçÁöÑ double-checked lockingÂçï‰æãÊ®°Âºè</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">       <span class="kd">synchronized</span><span class="o">(</span><span class="n">Singleton</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">             <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span> 
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>È¶ñÊ¨°ËÆøÈóÆ‰ºöÂêåÊ≠•Âä†ÈîÅÔºå‰πãÂêé‰ΩøÁî®‰∏ç‰ºö‰ΩøÁî®synchronized</p>
</blockquote>
<p><strong>‰∏äËø∞‰ª£Á†ÅÁúã‰ººÂÆåÁæéÔºå‰ΩÜ‰πüÊòØÊúâÈóÆÈ¢òÁöÑ</strong></p>
<h5 id="getinstanceÂ≠óËäÇÁ†Å">getInstance()Â≠óËäÇÁ†Å</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">JUC</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">Singleton</span> <span class="nf">getInstance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Code</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">       <span class="n">0</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field INSTANCE:LJUC/model/Singleton;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">3</span><span class="o">:</span> <span class="n">ifnonnull</span>     <span class="n">37</span>
</span></span><span class="line"><span class="cl">       <span class="n">6</span><span class="o">:</span> <span class="n">ldc</span>           <span class="err">#</span><span class="n">3</span>                  <span class="c1">// class JUC/model/Singleton Âä†ÈîÅËé∑ÂæóÁ±ªÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">8</span><span class="o">:</span> <span class="n">dup</span>                               <span class="c1">//Á±ªÂØπË±°ÂºïÁî®ÊåáÈíàÂ§çÂà∂‰∏Ä‰ªΩ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">9</span><span class="o">:</span> <span class="n">astore_0</span>                          <span class="c1">//Â≠òÂÇ®‰∏Ä‰ªΩ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">10</span><span class="o">:</span> <span class="n">monitorenter</span>
</span></span><span class="line"><span class="cl">      <span class="n">11</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field INSTANCE:LJUC/model/Singleton;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">14</span><span class="o">:</span> <span class="n">ifnonnull</span>     <span class="n">27</span>
</span></span><span class="line"><span class="cl">      <span class="n">17</span><span class="o">:</span> <span class="k">new</span>           <span class="err">#</span><span class="n">3</span>                  <span class="c1">// class JUC/model/Singleton
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">20</span><span class="o">:</span> <span class="n">dup</span>
</span></span><span class="line"><span class="cl">      <span class="n">21</span><span class="o">:</span> <span class="n">invokespecial</span> <span class="err">#</span><span class="n">4</span>                  <span class="c1">// Method &#34;&lt;init&gt;&#34;:()V
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">24</span><span class="o">:</span> <span class="n">putstatic</span>     <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field INSTANCE:LJUC/model/Singleton;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">27</span><span class="o">:</span> <span class="n">aload_0</span>
</span></span><span class="line"><span class="cl">      <span class="n">28</span><span class="o">:</span> <span class="n">monitorexit</span>
</span></span><span class="line"><span class="cl">      <span class="n">29</span><span class="o">:</span> <span class="k">goto</span>          <span class="n">37</span>
</span></span><span class="line"><span class="cl">      <span class="n">32</span><span class="o">:</span> <span class="n">astore_1</span>
</span></span><span class="line"><span class="cl">      <span class="n">33</span><span class="o">:</span> <span class="n">aload_0</span>
</span></span><span class="line"><span class="cl">      <span class="n">34</span><span class="o">:</span> <span class="n">monitorexit</span>
</span></span><span class="line"><span class="cl">      <span class="n">35</span><span class="o">:</span> <span class="n">aload_1</span>
</span></span><span class="line"><span class="cl">      <span class="n">36</span><span class="o">:</span> <span class="n">athrow</span>
</span></span><span class="line"><span class="cl">      <span class="n">37</span><span class="o">:</span> <span class="n">getstatic</span>     <span class="err">#</span><span class="n">2</span>                  <span class="c1">// Field INSTANCE:LJUC/model/Singleton;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">40</span><span class="o">:</span> <span class="n">areturn</span>
</span></span><span class="line"><span class="cl">    <span class="n">Exception</span> <span class="n">table</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">       <span class="n">from</span>    <span class="n">to</span>  <span class="n">target</span> <span class="n">type</span>
</span></span><span class="line"><span class="cl">          <span class="n">11</span>    <span class="n">29</span>    <span class="n">32</span>   <span class="n">any</span>
</span></span><span class="line"><span class="cl">          <span class="n">32</span>    <span class="n">35</span>    <span class="n">32</span>   <span class="n">any</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>17Ôºönew‰∏Ä‰∏™ÂØπË±°ÂºïÁî®</li>
<li>20ÔºöÂ§çÂà∂ËØ•ÂØπË±°ÂºïÁî®</li>
<li>21ÔºöË∞ÉÁî®ÊûÑÈÄ†ÊñπÊ≥ï</li>
<li>24ÔºöÂ∞ÜÂºïÁî®ÊîæÂÖ•ÈùôÊÄÅÂèòÈáè‰∏≠</li>
</ul>
<blockquote>
<p><strong>Ê≠§Êó∂ ÈóÆÈ¢òÊù•‰∫Ü Áî±‰∫éjvm‰ºòÂåñÁöÑÁªìÊûúÔºå‰ºöÂØºËá¥21Ë°åÊåá‰ª§Âíå24Ë°åÊåá‰ª§ËøõË°åÈáçÊéíÂ∫èÔºåËôΩÁÑ∂ÊòØÂú®synchronizedÈáåÈù¢Ôºå‰ΩÜÊòØÁ¨¨‰∏Ä‰∏™ifËØ≠Âè•ÊòØ‰∏çÂåÖÂê´Âú®synchronizedËØ≠Âè•‰∏≠ÁöÑÔºåÊâÄ‰ª•Â∞±‰ºöÂá∫Áé∞t2Âú®INSTANCEËøòÊ≤°ÂàùÂßãÂåñÔºåÂ∞±Ë¢´ËøîÂõû‰∏Ä‰∏™NULLÂÄº„ÄÇ</strong></p>
</blockquote>
<p>#<strong>Ê≥®</strong>ÔºöËôΩÁÑ∂synchronizedËÉΩ‰øùËØÅÊúâÂ∫èÊÄßÔºå‰ΩÜÊòØÊó†Ê≥ïÊîπÂèòJVMÁöÑÊåá‰ª§ÈáçÊéíÂ∫è‰ºòÂåñ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402183416400.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402183416400"
	
	
></p>
<h5 id="ÈóÆÈ¢òËß£ÂÜ≥">ÈóÆÈ¢òËß£ÂÜ≥</h5>
<p>ÂØπINSTANCEÂä†‰∏ävolatileÂèòÈáè</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public static JUC.model.Singleton getInstance();
</span></span><span class="line"><span class="cl">    Code:
</span></span><span class="line"><span class="cl">    // ----------------------------------------------------&gt; Âä†ÂÖ•ÂØπINSTANCEÂèòÈáèÁöÑËØªÂ±èÈöú
</span></span><span class="line"><span class="cl">       0: getstatic     #2                  // Field INSTANCE:LJUC/model/Singleton;
</span></span><span class="line"><span class="cl">       3: ifnonnull     37
</span></span><span class="line"><span class="cl">       6: ldc           #3                  // class JUC/model/Singleton Âä†ÈîÅËé∑ÂæóÁ±ªÂØπË±°
</span></span><span class="line"><span class="cl">       8: dup                               //Á±ªÂØπË±°ÂºïÁî®ÊåáÈíàÂ§çÂà∂‰∏Ä‰ªΩ
</span></span><span class="line"><span class="cl">       9: astore_0                          //Â≠òÂÇ®‰∏Ä‰ªΩ
</span></span><span class="line"><span class="cl">      10: monitorenter -----------------------&gt; ‰øùËØÅÂéüÂ≠êÊÄßÔºåÂèØËßÅÊÄß
</span></span><span class="line"><span class="cl">      11: getstatic     #2                  // Field INSTANCE:LJUC/model/Singleton;
</span></span><span class="line"><span class="cl">      14: ifnonnull     27
</span></span><span class="line"><span class="cl">      17: new           #3                  // class JUC/model/Singleton
</span></span><span class="line"><span class="cl">      20: dup
</span></span><span class="line"><span class="cl">      21: invokespecial #4                  // Method &#34;&lt;init&gt;&#34;:()V
</span></span><span class="line"><span class="cl">      24: putstatic     #2                  // Field INSTANCE:LJUC/model/Singleton;
</span></span><span class="line"><span class="cl">      //--------------------------------------&gt; Âä†ÂÖ•INSTANCEÂèòÈáèÁöÑÂÜôÂ±èÈöú
</span></span><span class="line"><span class="cl">      27: aload_0
</span></span><span class="line"><span class="cl">      28: monitorexit
</span></span><span class="line"><span class="cl">      29: goto          37
</span></span><span class="line"><span class="cl">      32: astore_1
</span></span><span class="line"><span class="cl">      33: aload_0
</span></span><span class="line"><span class="cl">      34: monitorexit
</span></span><span class="line"><span class="cl">      35: aload_1
</span></span><span class="line"><span class="cl">      36: athrow
</span></span><span class="line"><span class="cl">      37: getstatic     #2                  // Field INSTANCE:LJUC/model/Singleton;
</span></span><span class="line"><span class="cl">      40: areturn
</span></span><span class="line"><span class="cl">    Exception table:
</span></span><span class="line"><span class="cl">       from    to  target type
</span></span><span class="line"><span class="cl">          11    29    32   any
</span></span><span class="line"><span class="cl">          32    35    32   any
</span></span></code></pre></td></tr></table>
</div>
</div><p>**ÊÉÖÂÜµ1Ôºö**t2 getstatic() Ëé∑ÂèñÁöÑÊòØÁ©∫ÂÄºNULLÊ≠§Êó∂‰ºöËøõÂÖ•synchronizedÔºå‰ΩÜÁî±‰∫éAÂ∑≤ÁªèÂä†ÈîÅÔºå‰ºö‰ΩøÂæót2ÈîÅ‰ΩèÔºåÁõ¥Âà∞AËß£ÈîÅÔºåÊ≠§Êó∂INSTANCEÂ∑≤ÁªèËµãÂÄº‰∫ÜÔºåt2Ëé∑ÂèñÊúÄÊñ∞ÁöÑINSTANCEÂπ∂‰∏îËøîÂõû</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402190134854.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402190134854"
	
	
></p>
<p>**ÊÉÖÂÜµ2Ôºö**Ê≠§Êó∂ÁöÑputstatic‰∏ç‰ºöÂú®invokespecialÁöÑÂâçÈù¢ÔºåÂ∞±‰∏ç‰ºöÂá∫Áé∞ÂÖàËµãÂÄºÔºåÂÜçÊûÑÈÄ†ÁöÑÊÉÖÂÜµ‰∫Ü</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402190341247.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402190341247"
	
	
></p>
<h4 id="happens-before">happens-before</h4>
<p>happens-beforeËßÑÂÆö‰∫ÜÂØπÂÖ±‰∫´ÂèòÈáèÁöÑÂÜôÊìç‰ΩúÂØπÂÖ∂‰ªñÁöÑÁ∫øÁ®ãÁöÑËØªÊìç‰ΩúÂèØËßÅÔºåÂÆÉÊòØÂèØËßÅÊÄß‰∏éÊúâÂ∫èÊÄßÁöÑ‰∏ÄÂ•óËßÑÂàôÊÄªÁªìÔºåÊäõÂºÄ‰ª•‰∏ãhappens-beforeËßÑÂàôÔºåJMMÂπ∂‰∏çËÉΩ‰øùËØÅ‰∏Ä‰∏™Á∫øÁ®ãÂØπÂÖ±‰∫´ÂèòÈáèÁöÑÂÜôÔºåÂØπ‰∫éÂÖ∂‰ªñÁ∫øÁ®ãÂØπËØ•ÂÖ±‰∫´ÂèòÈáèÁöÑËØªÂèØËßÅ</p>
<ul>
<li>Á∫øÁ®ãËß£ÈîÅm‰πãÂâçÂØπÂèòÈáèÁöÑÂÜôÔºåÂØπ‰∫éÊé•‰∏ãÊù•ÂØπmÂä†ÈîÅÁöÑÂÖ∂‰ªñÁ∫øÁ®ãÂØπËØ•ÂèòÈáèÁöÑËØªÂèØËßÅ</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402191318405.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402191318405"
	
	
></p>
<ul>
<li>Á∫øÁ®ãÂØπvolatileÂèòÈáèÁöÑÂÜôÔºåÂØπÊé•‰∏ãÊù•ÂÖ∂ÂÆÉÁ∫øÁ®ãÂØπÂèòÈáèÁöÑËØªÂèØËßÅ</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402191508935.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402191508935"
	
	
></p>
<ul>
<li>Á∫øÁ®ãstartÂâçÂØπÂèòÈáèÁöÑÂÜôÔºåÂØπËØ•Á∫øÁ®ãÂºÄÂßãÂêéÂØπËØ•ÂèòÈáèÁöÑËØªÂèØËßÅ</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402191615128.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402191615128"
	
	
></p>
<ul>
<li>Á∫øÁ®ãÁªìÊùüÂâçÂØπÂèòÈáèÁöÑÂÜôÔºåÂØπÂÖ∂‰ªñÁ∫øÁ®ãÂæóÁü•‰ªñÁªìÊùüÂêéÁöÑËØªÂèØËßÅ(ÊØîÂ¶ÇÂÖ∂‰ªñÁ∫øÁ®ãË∞ÉÁî®t1,isAlive()Ôºåt1.join()Á≠âÂæÖ‰ªñÁªìÊùü)</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402191728776.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402191728776"
	
	
></p>
<ul>
<li>Á∫øÁ®ãt1ÊâìÊñ≠t2ÂâçÂØπÂèòÈáèÁöÑÂÜôÔºåÂØπ‰∫éÂÖ∂‰ªñÁ∫øÁ®ãÂæóÁü•t2Ë¢´ÊâìÊñ≠ÂêéÂØπÂèòÈáèÁöÑËØªÂèØËßÅ(ÈÄöËøát2.interruptedÊàñt2.isInterrupted)</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402191935840.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402191935840"
	
	
></p>
<ul>
<li>
<p>ÂØπÂèòÈáèÈªòËÆ§ÂÄºÁöÑÂÜô(0ÔºåfalseÔºånull)ÔºåÂØπÂÖ∂‰ªñÁ∫øÁ®ãÂØπËØ•ÂèòÈáèÂèØËßÅ</p>
</li>
<li>
<p>ÂÖ∑Êúâ‰º†ÈÄíÊÄßÔºåÁî±‰∫éÂÜôÂ±èÈöú‰ºöÂ∞ÜÂÜôÂ±èÈöú‰πãÂâçÁöÑËµãÂÄºÈÉΩÂêåÊ≠•Âà∞‰∏ªÂ≠ò‰∏≠ÔºåÊâÄ‰ª•</p>
</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220402192753344.png"
	
	
	
	loading="lazy"
	
		alt="image-20220402192753344"
	
	
></p>
<h3 id="95-Á∫øÁ®ãÂÆâÂÖ®Âçï‰æã">9.5 Á∫øÁ®ãÂÆâÂÖ®Âçï‰æã</h3>
<p>Âçï‰æãÊ®°ÂºèÊúâÂæàÂ§öÂÆûÁé∞ÊñπÊ≥ïÔºåÈ•øÊ±âÔºåÊáíÊ±âÔºåÈùôÊÄÅÂÜÖÈÉ®Á±ªÔºåÊûö‰∏æÁ±ª</p>
<blockquote>
<p>ÊáíÊ±âÂºèÔºöÁ±ªÂä†ËΩΩ‰∏ç‰ºöÂØºËá¥ËØ•Âçï‰æãÂÆû‰æãÂØπË±°Ë¢´ÂàõÂª∫ÔºåËÄåÊòØÈ¶ñÊ¨°‰ΩøÁî®ËØ•ÂØπË±°Êó∂Êâç‰ºöË¢´ÂàõÂª∫</p>
<p>È•øÊ±âÂºèÔºöÁ±ªÂä†ËΩΩÂ∞±‰ºöÂØºËá¥ËØ•Âçï‰æãÂØπË±°Ë¢´ÂàõÂª∫</p>
</blockquote>
<h5 id="ÂÆûÁé∞1"><strong>ÂÆûÁé∞1Ôºö</strong></h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//ÈóÆÈ¢ò1Ôºö‰∏∫‰ªÄ‰πàÂä†final
</span></span></span><span class="line"><span class="cl"><span class="c1">//ÈóÆÈ¢ò2ÔºöÂ¶ÇÊûúÂÆûÁé∞Â∫èÂàóÂåñÊé•Âè£ÔºåËøòÈúÄË¶ÅÂÅö‰ªÄ‰πàÊù•Èò≤Ê≠¢ÂèçÂ∫èÂàóÂåñÁ†¥ÂùèÂçï‰æã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Singleton2</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ÈóÆÈ¢ò3Ôºö‰∏∫‰ªÄ‰πàËÆæÁΩÆÊú™ÁßÅÊúâÔºüÊòØÂê¶ËÉΩÈò≤Ê≠¢ÂèçÂ∞ÑÂàõÂª∫Êñ∞ÁöÑÂÆû‰æã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="nf">Singleton2</span><span class="o">(){}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ÈóÆÈ¢ò4ÔºöËøô‰πüÂàùÂßãÂåñÊòØÂê¶ËÉΩ‰øùËØÅÂçï‰æãÂØπË±°ÂàõÂª∫Êó∂ÁöÑÁ∫øÁ®ãÂÆâÂÖ®Ôºü
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Singleton2</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ÈóÆÈ¢ò5Ôºö‰∏∫‰ªÄ‰πàÊèêÈ´òÈùôÊÄÅÊñπÊ≥ïËÄå‰∏çÊòØÁõ¥Êé•Â∞ÜINSTANCEËÆæÁΩÆÊú™public.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton2</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ÈóÆÈ¢ò1ÔºöÈò≤Ê≠¢Â≠êÁ±ªÁªßÊâøÔºåÊõ¥ÊîπÊñπÊ≥ïÂØºËá¥Á∫øÁ®ã‰∏çÂÆâÂÖ®</p>
<p>ÈóÆÈ¢ò2ÔºöÁî±‰∫éÂèçÂ∫èÂàóÂåñ‰ºöÂàõÂª∫Êñ∞ÁöÑÂØπË±°ÔºåÊâÄ‰ª•Êàë‰ª¨ÂèØ‰ª•ÈáçÂÜôreadResovleÊù•ËøîÂõûÂéüÊú¨ÁöÑÂçï‰æã</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Object</span> <span class="nf">readResovle</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="n">INSTANCE</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÈóÆÈ¢ò3Ôºö‰∏çËÆ©Â§ñÁïåÂØπË±°Ë∞ÉÁî®ÊûÑÈÄ†ÊñπÊ≥ïÔºåÁ†¥ÂùèÂçï‰æãÊ®°ÂºèÔºå‰∏çËÉΩÈò≤Ê≠¢ÂèçÂ∞Ñ</p>
<p>ÈóÆÈ¢ò4ÔºöÈùôÊÄÅÊàêÂëòÂèòÈáèÁöÑÂàùÂßãÂåñÊòØÂú®Á±ªÂä†ËΩΩÈò∂ÊÆµÂÆåÊàêÁöÑÔºåÁî±JVMÂÆåÊàêÔºå‰∏ç‰ºöÊúâÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò</p>
<p>ÈóÆÈ¢ò5ÔºöÂà©Áî®ÊñπÊ≥ï ÂèØ‰ª•ÂØπÂçï‰æãÂØπË±°ÊúâÊõ¥Â§öÊéßÂà∂ÔºåÁî®ÊñπÊ≥ïÂèØ‰ª•ËøîÂõûÊ≥õÂûãÔºåËøòÂèØ‰ª•ÂÆûÁé∞‰∏Ä‰∏™ÊáíÊÉ∞ÂºèÁöÑÂä†ËΩΩ</p>
</blockquote>
<h5 id="ÂÆûÁé∞2">ÂÆûÁé∞2Ôºö</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//ÈóÆÈ¢ò1ÔºöÊûö‰∏æÂçï‰æãÊòØÂ¶Ç‰ΩïÈôêÂà∂ÂÆû‰æã‰∏™Êï∞ÁöÑ
</span></span></span><span class="line"><span class="cl"><span class="c1">//ÈóÆÈ¢ò2ÔºöÊûö‰∏æÂçï‰æãÊòØÂê¶ÊúâÂπ∂ÂèëÈóÆÈ¢ò
</span></span></span><span class="line"><span class="cl"><span class="c1">//ÈóÆÈ¢ò3ÔºöÊûö‰∏æÂçï‰æãÊòØÂê¶ËÉΩË¢´ÂèçÂ∞ÑÁ†¥ÂùèÂçï‰æã
</span></span></span><span class="line"><span class="cl"><span class="c1">//ÈóÆÈ¢ò4ÔºöÊûö‰∏æÂçï‰æãÊòØÂê¶Ë¢´ÂèçÂ∫èÂàóÂåñÁ†¥ÂùèÂçï‰æã
</span></span></span><span class="line"><span class="cl"><span class="c1">//ÈóÆÈ¢ò5ÔºöÊûö‰∏æÂçï‰æãÂ±û‰∫éÊáíÊ±âÂºèËøòÊòØÈ•øÊ±âÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1">//ÈóÆÈ¢ò6ÔºöÊûö‰∏æÂçï‰æãÂ¶ÇÊûúÂ∏åÊúõÂä†ÂÖ•‰∏Ä‰∫õÂçï‰æãÂàõÂª∫Êó∂ÁöÑÂàùÂßãÂåñÈÄªËæëÂ∫îËØ•Â¶Ç‰ΩïÂÅö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">enum</span> <span class="n">Singleton</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Êûö‰∏æÂèòÈáèÂ≠óËäÇÁ†ÅÊñá‰ª∂</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kd">enum</span> <span class="n">JUC</span><span class="o">/</span><span class="n">model</span><span class="o">/</span><span class="n">SingletonEnum</span> <span class="kd">extends</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Enum</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// compiled from: SingletonEnum.java
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// access flags 0x4019
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="kd">enum</span> <span class="n">LJUC</span><span class="o">/</span><span class="n">model</span><span class="o">/</span><span class="n">SingletonEnum</span><span class="o">;</span> <span class="n">INSTANCE</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ÈóÆÈ¢ò1ÔºöÂàõÂª∫‰∫ÜÂ§öÂ∞ë‰∏™Êûö‰∏æÁ±ªÂûãÔºåÂ∞±ÊúâÂ§öÂ∞ë‰∏™ÂÆû‰æãÂØπË±°</p>
<p>ÈóÆÈ¢ò2ÔºöÊó†Âπ∂ÂèëÈóÆÈ¢òÔºåÂõ†‰∏∫ÊòØÈùôÊÄÅÂèòÈáè</p>
<p>ÈóÆÈ¢ò3ÔºöÊûö‰∏æÁ±ªÂûãÊó†Ê≥ïÁî®ÂèçÂ∞ÑÁ†¥ÂùèÂçï‰æã</p>
<p>ÈóÆÈ¢ò4ÔºöÊûö‰∏æÁ±ªÂûãÈªòËÆ§ÂÆûÁé∞‰∫ÜÂ∫èÂàóÂåñÔºå‰∏ç‰ºöË¢´ÂèçÂ∫èÂàóÁ†¥ÂùèÂçï‰æã</p>
<p>ÈóÆÈ¢ò5ÔºöÈ•øÊ±âÂºè</p>
<p>ÈóÆÈ¢ò6ÔºöÂÜçÊûö‰∏æÁ±ªÈáåÈù¢ÂèØ‰ª•Âä†‰∏Ä‰∫õÊûÑÈÄ†ÊñπÊ≥ï</p>
</blockquote>
<h5 id="ÂÆûÁé∞3">ÂÆûÁé∞3Ôºö</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="nf">Singleton</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">Singleton</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="kd">synchronized</span><span class="o">(</span><span class="n">Singleton</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(</span><span class="n">INSTANCE</span><span class="o">==</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                        <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ÂÆûÁé∞4">ÂÆûÁé∞4Ôºö</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingletonStatic</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">SingletonStatic</span><span class="o">(){</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LazyHolder</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="kd">final</span> <span class="n">SingletonStatic</span> <span class="n">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SingletonStatic</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">SingletonStatic</span> <span class="nf">getInstance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">LazyHolder</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="10-‰øùÊä§ÂÖ±‰∫´ËµÑÊ∫ê-Êó†ÈîÅÂÆûÁé∞">10 ‰øùÊä§ÂÖ±‰∫´ËµÑÊ∫ê-Êó†ÈîÅÂÆûÁé∞</h2>
<h3 id="101-atomicinteger">10.1 AtomicInteger</h3>
<h5 id="account-Êé•Âè£">Account Êé•Âè£</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">Account</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Integer</span> <span class="nf">getBalance</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">withdraw</span><span class="o">(</span><span class="n">Integer</span> <span class="n">balance</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">demo</span><span class="o">(</span><span class="n">Account</span> <span class="n">account</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">&gt;</span> <span class="n">ts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">account</span><span class="o">.</span><span class="na">withdraw</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">Thread</span><span class="o">::</span><span class="n">start</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">t</span><span class="o">-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">getBalance</span><span class="o">()+</span><span class="s">&#34; cost:&#34;</span><span class="o">+(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="o">)/</span><span class="n">1000_000</span><span class="o">+</span><span class="s">&#34; ms&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÊúâÈîÅÊäÄÊúØÂÆûÁé∞ËµÑÊ∫êÂÖ±‰∫´">ÊúâÈîÅÊäÄÊúØÂÆûÁé∞ËµÑÊ∫êÂÖ±‰∫´</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AccountUnsafe</span> <span class="kd">implements</span> <span class="n">Account</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">AccountUnsafe</span><span class="o">(</span><span class="kt">int</span> <span class="n">balance</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">balance</span> <span class="o">=</span> <span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="n">Integer</span> <span class="nf">getBalance</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">withdraw</span><span class="o">(</span><span class="n">Integer</span> <span class="n">balance</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">balance</span> <span class="o">-=</span> <span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="Êó†ÊâÄÊäÄÊúØÂÆûÁé∞ËµÑÊ∫êÂÖ±‰∫´">Êó†ÊâÄÊäÄÊúØÂÆûÁé∞ËµÑÊ∫êÂÖ±‰∫´</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AccountCas</span> <span class="kd">implements</span> <span class="n">Account</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">AccountCas</span><span class="o">(</span><span class="kt">int</span> <span class="n">balance</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">balance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">balance</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getBalance</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">balance</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">withdraw</span><span class="o">(</span><span class="n">Integer</span> <span class="n">balance</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">prev</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">balance</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">prev</span><span class="o">-</span><span class="n">balance</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">balance</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span><span class="n">next</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÁªìÊûúÊØîËæÉ">ÁªìÊûúÊØîËæÉ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0 cost:107 ms //Unsafe
</span></span><span class="line"><span class="cl">0 cost:105 ms //AtomicInteger
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Process finished with exit code 0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="102-cas‰∏évolatile">10.2 CAS‰∏évolatile</h3>
<h4 id="‰∏∫‰ªÄ‰πà-compareandset-ÂèØ‰ª•ÂÆûÁé∞‰∏çÂä†ÈîÅ‰πüËÉΩ‰øùËØÅÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò">‰∏∫‰ªÄ‰πà compareAndSet ÂèØ‰ª•ÂÆûÁé∞‰∏çÂä†ÈîÅ‰πüËÉΩ‰øùËØÅÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢òÔºü</h4>
<blockquote>
<p>compareAndSet ÂèàÁÆÄÁß∞‰∏∫CASÔºåÁî±‰∫é‰ªñÊòØÂéüÂ≠êÊìç‰ΩúÔºåÊâÄ‰ª•ÂèØ‰ª•‰øùËØÅÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò</p>
</blockquote>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220422214037388.png"
	
	
	
	loading="lazy"
	
		alt="image-20220422214037388"
	
	
></p>
<h5 id="ÊµÅÁ®ãËß£Êûê">ÊµÅÁ®ãËß£Êûê</h5>
<ul>
<li>Á∫øÁ®ã1Ëé∑Âèñ ‰ΩôÈ¢ù 100 Âπ∂‰∏î ÂáèÂ∞ë10 Ê≠§Êó∂ÁöÑÂÄº‰∏∫90</li>
<li>Ê≠§Êó∂Á∫øÁ®ã2 Â∑≤ÁªèÂ∞Ü‰ΩôÈ¢ùÂèò‰∏∫‰∫Ü 90</li>
<li>Á∫øÁ®ã1Âà©Áî®cas(100,90)ÂéªÊØîËæÉÔºåÂèëÁé∞Ê≠§Êó∂ÁöÑbalance ‰∏∫ 90 Âíå 100‰∏çÁ¨¶Âêà‰∫éÊòØËøîÂõûfalse</li>
<li>Á∫øÁ®ã1ÈáçÊñ∞Ëé∑Âæó‰ΩôÈ¢ùÂÄº</li>
</ul>
<blockquote>
<p><strong>Ê≥®ÊÑè</strong></p>
<p>ÂÖ∂ÂÆûCASÁöÑÂ∫ïÂ±ÇÊòØlock cmpxchgÊåá‰ª§(x86Êû∂ÊûÑ)ÔºåÂú®ÂçïÊ†∏CPUÂíåÂ§öÊ†∏CPUÈÉΩËÉΩ‰øùËØÅ„ÄêÊØîËæÉ-‰∫§Êç¢„ÄëÁöÑÂéüÂ≠êÊÄß</p>
<ul>
<li><strong>Âú®Â§öÊ†∏Áä∂ÊÄÅ‰∏ãÔºåÊüê‰∏™Ê†∏ÊâßË°åÂà∞Â∏¶ lock ÁöÑÊåá‰ª§Êó∂ÔºåCPU‰ºöËÆ©ÊÄªÁ∫øÈîÅ‰ΩèÔºåÂΩìËøô‰∏™Ê†∏ÊääÊ≠§Êåá‰ª§ÊâßË°åÂÆåÊàêÊó∂ÔºåÊâçÂºÄÂêØÊÄªÁ∫ø</strong>ÔºåËøô‰∏™ËøáÁ®ã‰∏ç‰ºöË¢´ËøõÁ®ãË∞ÉÂ∫¶Êú∫Âà∂ÊâÄÁªôÊâìÊñ≠Ôºå‰øùËØÅ‰∫ÜÂ§ö‰∏™Á∫øÁ®ãÂØπÂÜÖÂ≠òÊìç‰ΩúÁöÑÂáÜÁ°ÆÊÄßÔºåÂéüÂ≠êÊÄß</li>
</ul>
</blockquote>
<h4 id="volatile-‰∏é-cas‰πãÈó¥ÁöÑÂÖ≥Á≥ª">volatile ‰∏é CAS‰πãÈó¥ÁöÑÂÖ≥Á≥ª</h4>
<p>Áî±‰∫éCASÊìç‰ΩúÂøÖÈ°ªË¶ÅËØªÂèñÂΩìÂâçÁöÑÊúÄÊñ∞ÂÄºÔºåÊâÄ‰ª•ÂøÖÈ°ªË¶ÅÂ∞ÜÂΩìÂâçÁöÑÂÄºÂêåÊ≠•Âà∞‰∏ªÂ≠òÔºåÊâçËÉΩ‰øùËØÅÁ∫øÁ®ã‰πãÈó¥ÁöÑÂèØËßÅÊÄßÔºåÊâÄ‰ª•Âú®AtomicInteger‰∏≠ÁöÑvalueÊòØË¢´volatileËøõË°å‰øÆÈ•∞ÁöÑ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicInteger</span> <span class="kd">extends</span> <span class="n">Number</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">6214790243416807050L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// setup to use Unsafe.compareAndSwapInt for updates
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">getUnsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">valueOffset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">valueOffset</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">objectFieldOffset</span>
</span></span><span class="line"><span class="cl">                <span class="o">(</span><span class="n">AtomicInteger</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;value&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="‰∏∫‰ªÄ‰πàÊó†ÈîÅÊïàÁéáÈ´ò">‰∏∫‰ªÄ‰πàÊó†ÈîÅÊïàÁéáÈ´òÔºü</h4>
<ul>
<li>Êó†ÈîÅÊÉÖÂÜµ‰∏ãÔºåÁ∫øÁ®ãÂú®È´òÈÄüËøêË°åÔºåÊó†ÂÅúÊ≠á„ÄÇËÄåÂä†ÈîÅÁöÑÁ∫øÁ®ãÔºå‰ºöÂõ†‰∏∫ËøõÂÖ•‰∏¥ÁïåÂå∫ÂüüÔºåÂÅú‰∏ãÊù•Ôºå‰∏îÂÜçÊ¨°ÂêØÂä®ÈúÄË¶ÅËøõË°å‰∏ä‰∏ãÊñáÂàáÊç¢Ôºå‰ºöÂØºËá¥ÊÄßËÉΩ‰ª£‰ª∑ÊØîËæÉÂ§ß</li>
<li>‰ΩÜÊòØÊó†ÈîÅÊÉÖÂÜµ‰∏ãÔºå‰∏ÄÊó¶Á∫øÁ®ãÁöÑÊï∞ÈáèË∂ÖËøácpuÁöÑÊï∞ÈáèÔºåÂ∞±‰ºöÂØºËá¥Êó†Êó∂Èó¥ÁâáÂèØÂàÜÈÖçÔºåÁ∫øÁ®ãËøòÊòØË¶ÅËøõÂÖ•ÈòªÂ°ûÁä∂ÊÄÅÔºåËøõË°å‰∏ä‰∏ãÊñáÂàáÊç¢</li>
</ul>
<h4 id="casÁöÑÁâπÁÇπ">CASÁöÑÁâπÁÇπ</h4>
<p>ÁªìÂêàCASÂíåvolatileÂèØ‰ª•ÂÆûÁé∞Êó†ÈîÅÂπ∂ÂèëÔºåÈÄÇÁî®‰∫éÁ∫øÁ®ãËæÉÂ∞ëÁöÑÔºåÂ§öÊ†∏CPUÁöÑÂú∫ÊôØ‰∏ã</p>
<ul>
<li>CASÊòØÂü∫‰∫é‰πêËßÇÈîÅÁöÑÊÄùÊÉ≥ÔºöÊúÄ‰πêËßÇÁöÑ‰º∞ËÆ°Ôºå‰∏çÊÄïÂà´ÁöÑÁ∫øÁ®ãÊù•‰øÆÊîπÂÖ±‰∫´ÂèòÈáè„ÄÇ</li>
<li>synchronizedÈááÁî®ÁöÑÊòØÊÇ≤ËßÇÈîÅÁöÑÊÄùÊÉ≥ÔºåÈò≤Ê≠¢ÂÖ∂‰ªñÁ∫øÁ®ãÊù•‰øÆÊîπÂÖ±‰∫´ÂèòÈáè„ÄÇ</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220422223808771.png"
	
	
	
	loading="lazy"
	
		alt="image-20220422223808771"
	
	
></p>
<h2 id="11-ÂéüÂ≠ê">11 ÂéüÂ≠ê</h2>
<h3 id="111-ÂéüÂ≠êÊï¥Êï∞">11.1 ÂéüÂ≠êÊï¥Êï∞</h3>
<ul>
<li>AtomicBoolean</li>
<li>AtomicInteger</li>
<li>AtomicLong</li>
</ul>
<h4 id="‰æãatomicinteger">‰æãÔºöAtomicInteger</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">5</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicInteger</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">());</span> <span class="c1">//i++
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicInteger</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">());</span> <span class="c1">//++i
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicInteger</span><span class="o">.</span><span class="na">updateAndGet</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">*</span> <span class="n">10</span><span class="o">));</span> <span class="c1">//i*10
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="updareandgetÂéüÁêÜ">updareAndGetÂéüÁêÜ</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">updateAndGet</span><span class="o">(</span><span class="n">IntUnaryOperator</span> <span class="n">updateFunction</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">prev</span><span class="o">,</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">prev</span> <span class="o">=</span> <span class="n">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">next</span> <span class="o">=</span> <span class="n">updateFunction</span><span class="o">.</span><span class="na">applyAsInt</span><span class="o">(</span><span class="n">prev</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span> <span class="n">next</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="112-ÂéüÂ≠êÂºïÁî®">11.2 ÂéüÂ≠êÂºïÁî®</h3>
<ul>
<li>AtomicReference</li>
<li>AtomicMarkableReference</li>
<li>AtomicStampedReference</li>
</ul>
<h4 id="abaÈóÆÈ¢ò">ABAÈóÆÈ¢ò</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomReference</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">AtomicReference</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="s">&#34;A&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">String</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">other</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change A-&gt;C {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span><span class="s">&#34;C&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">other</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">String</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change A-&gt;B {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span><span class="s">&#34;B&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">       <span class="o">});</span>
</span></span><span class="line"><span class="cl">       <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">       <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">String</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change B-&gt;A {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span><span class="s">&#34;A&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">       <span class="o">});</span>
</span></span><span class="line"><span class="cl">       <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ÂºïÁî®A‰∏∫AtomicReference</strong></p>
<blockquote>
<p>‰∏ªÁ∫øÁ®ã Â∞ÜÂºïÁî®A Êîπ‰∏∫ ÂºïÁî®C</p>
<p>Á∫øÁ®ã1 Â∞ÜÂºïÁî®A Êîπ‰∏∫ ÂºïÁî®B</p>
<p>Á∫øÁ®ã2 Â∞ÜÂºïÁî®B Êîπ‰∏∫ ÂºïÁî®A</p>
<p>Ê≠§Êó∂ Á∫øÁ®ã1ÂÖàÂêØÂä®ÔºåÂÖ∂Ê¨°Á∫øÁ®ã2ÔºåÂÜç‰∏ªÁ∫øÁ®ã</p>
</blockquote>
<p>Âú®Â¶Ç‰∏äÊÉÖÂÜµÔºå‰∏ªÁ∫øÁ®ãÊó†Ê≥ïÂØüËßâÂà∞ÂºïÁî®AË¢´Êõ¥ÊîπÔºåËôΩÁÑ∂ÂÜçÂπ≥Â∏∏Â∑•‰Ωú‰∏≠Êó†Â§ßÁ¢çÔºå‰ΩÜÊòØÊòØÂ≠òÂú®ÂÆâÂÖ®ÈöêÊÇ£ÁöÑÔºåÊâÄ‰ª•Êàë‰ª¨ÂèØ‰ª•Áî®</p>
<p>AtomicStampedReferenceÊù•Ëß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢ò</p>
<h4 id="atomicstampedreference">AtomicStampedReference</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomReference</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">AtomicStampedReference</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ref</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicStampedReference</span><span class="o">&lt;&gt;(</span><span class="s">&#34;A&#34;</span><span class="o">,</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">String</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">getReference</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">other</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change A-&gt;C {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span><span class="s">&#34;C&#34;</span><span class="o">,</span><span class="n">stamp</span><span class="o">,</span><span class="n">stamp</span><span class="o">+</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">other</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change A-&gt;B {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="na">getReference</span><span class="o">(),</span><span class="s">&#34;B&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span><span class="n">ref</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()+</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">       <span class="o">});</span>
</span></span><span class="line"><span class="cl">       <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">       <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;change B-&gt;A {}&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="na">getReference</span><span class="o">(),</span><span class="s">&#34;A&#34;</span><span class="o">,</span><span class="n">ref</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span><span class="n">ref</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()+</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">       <span class="o">});</span>
</span></span><span class="line"><span class="cl">       <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>AtomicStampedReferenceÂèØ‰ª•ÁªôÂéüÂ≠êÂºïÁî®Âä†‰∏äÁâàÊú¨Âè∑ÔºåÁ°ÆÂÆöÊï¥‰∏™ÂéüÂ≠êÁöÑÂèòÂåñËøáÁ®ã</p>
<h4 id="atomicmarkablereference">AtomicMarkableReference</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220425223520696.png"
	
	
	
	loading="lazy"
	
		alt="image-20220425223520696"
	
	
></p>
<p>Â¶ÇÊûú‰∏çÊÉ≥Áü•ÈÅìÁâàÊú¨Âè∑ÔºåÂè™ÊÉ≥Áü•ÈÅìÊòØÂê¶‰øÆÊîπÔºåÂàôÂèØ‰ª•Áî®AtomicMarkableReference</p>
<h3 id="113-ÂéüÂ≠êÊï∞ÁªÑ">11.3 ÂéüÂ≠êÊï∞ÁªÑ</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomArray</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">demo</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">               <span class="o">()-&gt;</span><span class="k">new</span> <span class="n">AtomicIntegerArray</span><span class="o">(</span><span class="n">10</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">               <span class="o">(</span><span class="n">array</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">               <span class="o">(</span><span class="n">array</span><span class="o">,</span><span class="n">index</span><span class="o">)-&gt;</span><span class="n">array</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(</span><span class="n">index</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">               <span class="n">array</span><span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">array</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">       <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">demo</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">arraySupplier</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Function</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">lengthFun</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">putConsumer</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">printConsumer</span>
</span></span><span class="line"><span class="cl">    <span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">&gt;</span> <span class="n">ts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">T</span> <span class="n">array</span> <span class="o">=</span> <span class="n">arraySupplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">lengthFun</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">array</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">length</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span><span class="n">10000</span> <span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">putConsumer</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">array</span><span class="o">,</span><span class="n">j</span><span class="o">%</span><span class="n">length</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">t</span><span class="o">-&gt;{</span>
</span></span><span class="line"><span class="cl">         <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">         <span class="o">}});</span>
</span></span><span class="line"><span class="cl">        <span class="n">printConsumer</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">array</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="114-ÂéüÂ≠êÊõ¥Êñ∞Âô®">11.4 ÂéüÂ≠êÊõ¥Êñ∞Âô®</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">JUC.g_noLock.Atomic</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicReferenceFieldUpdater</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomFileUpdate</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Student</span> <span class="n">genius</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Student</span><span class="o">(</span><span class="s">&#34;Genius&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AtomicReferenceFieldUpdater</span> <span class="n">updater</span> <span class="o">=</span> <span class="n">AtomicReferenceFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="s">&#34;name&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updater</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">genius</span><span class="o">,</span><span class="s">&#34;Genius&#34;</span><span class="o">,</span><span class="s">&#34;fuck&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">genius</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Student</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Student</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="115-ÂéüÂ≠êÁ¥ØÂä†Âô®">11.5 ÂéüÂ≠êÁ¥ØÂä†Âô®</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">JUC.g_noLock.Atomic</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicLong</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.LongAdder</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.function.Consumer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.function.Supplier</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomSum</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">demo</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                 <span class="o">()-&gt;</span><span class="k">new</span> <span class="n">AtomicLong</span><span class="o">(</span><span class="n">0</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                 <span class="o">(</span><span class="n">adder</span><span class="o">)-&gt;</span><span class="n">adder</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">         <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">demo</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="o">()-&gt;</span><span class="k">new</span> <span class="n">LongAdder</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                <span class="o">(</span><span class="n">adder</span><span class="o">)-&gt;</span><span class="n">adder</span><span class="o">.</span><span class="na">increment</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">demo</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">adderSupplier</span><span class="o">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">T</span> <span class="n">adder</span> <span class="o">=</span> <span class="n">adderSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">&gt;</span> <span class="n">ts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">4</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span><span class="n">50000000</span> <span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">adder</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">Thread</span><span class="o">::</span><span class="n">start</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ts</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">t</span><span class="o">-&gt;{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">t</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="o">)/</span><span class="n">1000_000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>java‰∏∫Á¥ØÂä†Êèê‰æõ‰∫Ü‰∏ìÈó®ÁöÑÁ¥ØÂä†Âô®ÔºåÊïàÊûúÊòØAtomicIntegerÁ¥ØÂä†ÁöÑÂçÅÂÄç</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Atomic_Sum cost: 19332
</span></span><span class="line"><span class="cl">LongAdder_Sum cost: 1041
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÊÄßËÉΩÊèêÂçáÁöÑÂéüÂõ†ÔºöLongAdder‰∏∫ÊØè‰∏Ä‰∏™ThreadÂàÜÈÖç‰∫Ü‰∏Ä‰∏™Á¥ØÂä†ÂçïÂÖÉCell[0]ÔºåÂÜçÁ¥ØÂä†ÁöÑËøáÁ®ã‰∏≠ÔºåÊØè‰∏™Á∫øÁ®ãÂØπËá™Â∑±ÁöÑCell[0]ËøõË°åÊìç‰ΩúÔºåÁ¥ØÂä†ÁªìÊùüÂêéÂÜçÂ∞ÜÁªìÊûúÊ±áÊÄªÔºåÂáèÂ∞ë‰∫ÜCASÂ§±Ë¥•ÁöÑÊ¨°Êï∞Ôºå‰ªéËÄåÊèêÂçá‰∫ÜÊïàÁéá</p>
<h4 id="Ê∫êÁ†Å‰πãlongadder">Ê∫êÁ†Å‰πãLongAdder</h4>
<p>LongAdderÁ±ªÊúâÂá†‰∏™ÂÖ≥ÈîÆÂüü</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//Á¥ØÂä†ÂçïÂÖÉÊï∞ÁªÑÔºåÊáíÊÉ∞ÂàùÂßãÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">Cell</span><span class="o">[]</span> <span class="n">cells</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Âü∫Á°ÄÂÄºÔºåÂ¶ÇÊûúÊ≤°ÊúâÁ´û‰∫âÔºåÂàôÁî®casÁ¥ØÂä†Ëøô‰∏™Âüü
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">base</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Âú®cells ÂàõÂª∫ÊàñÊâ©ÂÆπÊó∂ÔºåÁΩÆ‰∏∫1ÔºåË°®Á§∫Âä†ÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">cellsBusy</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="casÈîÅ">CasÈîÅ</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CasLock</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">lock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">CasLock</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//ÂΩìÊó†‰∫∫Á´û‰∫âÊó∂ÔºåÁ∫øÁ®ãÂç†Áî®ÈîÅÔºå‰∏îÂ∞ÜbusyÊîπ‰∏∫1ÔºåÂΩìÂÖ∂‰ªñÁ∫øÁ®ã‰ΩøÁî®ËØ•ÈîÅÊó∂ÔºåÂ∞Ü‰ºöÂæ™ÁéØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;lock&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">0</span><span class="o">,</span><span class="n">1</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Ë∞ÉÁî®unlock Â∞ÜbusyÊîπ‰∏∫0Ôºå‰ΩøÂÖ∂Ëß£ÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlock</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;unlock&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ÂéüÁêÜ‰πã‰º™ÂÖ±‰∫´">ÂéüÁêÜ‰πã‰º™ÂÖ±‰∫´</h5>
<h6 id="cellÁ±ª">CellÁ±ª</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@sun.misc.Contended</span> 
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Cell</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Cell</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span> <span class="n">value</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">cas</span><span class="o">(</span><span class="kt">long</span> <span class="n">cmp</span><span class="o">,</span> <span class="kt">long</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">UNSAFE</span><span class="o">.</span><span class="na">compareAndSwapLong</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">valueOffset</span><span class="o">,</span> <span class="n">cmp</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Unsafe mechanics
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Unsafe</span> <span class="n">UNSAFE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">valueOffset</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">UNSAFE</span> <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Unsafe</span><span class="o">.</span><span class="na">getUnsafe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ak</span> <span class="o">=</span> <span class="n">Cell</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">valueOffset</span> <span class="o">=</span> <span class="n">UNSAFE</span><span class="o">.</span><span class="na">objectFieldOffset</span>
</span></span><span class="line"><span class="cl">                <span class="o">(</span><span class="n">ak</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;value&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="ÁºìÂ≠ò‰∏éÂÜÖÂ≠òÁöÑÊØîËæÉ">ÁºìÂ≠ò‰∏éÂÜÖÂ≠òÁöÑÊØîËæÉ</h6>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220427210009831.png"
	
	
	
	loading="lazy"
	
		alt="image-20220427210009831"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220427210139575.png"
	
	
	
	loading="lazy"
	
		alt="image-20220427210139575"
	
	
></p>
<p>Áî±‰∏äÂõæÂèØÁü•Ôºå‰ΩøÁî®ÁºìÂ≠òÁöÑÂéüÂõ†ÊòØÂõ†‰∏∫cpuËØªÂèñÂÜÖÂ≠òÁöÑÊó∂Èó¥ÂçÅÂàÜÈïøÔºåÁõ∏ÂØπ‰∫éÁºìÂ≠òÊù•ËØ¥ÊÖ¢ÂæàÂ§ö„ÄÇ</p>
<p>ËÄåÁºìÂ≠ò‰ª•ÁºìÂ≠òË°å‰∏∫Âçï‰ΩçÔºå‰∏Ä‰∏™ÁºìÂ≠òË°å‰∏ÄËà¨ÊòØ‰ª•64byte‰∏∫Âçï‰Ωç(8‰∏™long)„ÄÇ</p>
<p>ÁºìÂ≠òÂπ∂‰∏çÊòØÂçÅÂÖ®ÂçÅÁæéÁöÑÔºåÁºìÂ≠ò‰ºöÂØºËá¥Êï∞ÊçÆÂâØÊú¨ÈóÆÈ¢òÔºå‰πüÂ∞±ÊòØÂèØËÉΩÈÄ†ÊàêÊï∞ÊçÆ‰∏ç‰∏ÄËá¥„ÄÇ</p>
<p>ÂΩì‰∏Ä‰∏™CPUÂØπÁºìÂ≠ò‰∏≠ÁöÑÊï∞ÊçÆËøõË°åÊõ¥Êîπ(Â¶Ç‰∫åÁ∫ßÁºìÂ≠ò)ÔºåÂàôÂè¶‰∏Ä‰∏™CPU‰∏≠ÁöÑ‰∫åÁ∫ßÁºìÂ≠òÁöÑÊï∞ÊçÆÂ∞±ÂøÖÈ°ªË¶ÅÂ§±Êïà„ÄÇ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220427210850571.png"
	
	
	
	loading="lazy"
	
		alt="image-20220427210850571"
	
	
></p>
<p>Âõ†‰∏∫CellÊòØÊï∞ÁªÑÂΩ¢ÂºèÔºåËøûÁª≠Â≠òÊîæÂú®CPU‰∏≠Ôºå‰∏Ä‰∏™CellÂçï‰ΩçÊòØ24Â≠óËäÇ(16byteÂØπË±°Â§¥+8byte long)ÔºåCell[0]ÂíåCell[1]‰∏§‰∏™ÁºìÂ≠òË°åÁöÑÊï∞ÊçÆÂ§ßÂ∞èÊòØ48ÔºåÂèØ‰ª•Â≠òÊîæÂú®‰∏Ä‰∏™<strong>ÁºìÂ≠òË°å</strong>‰∏≠ÔºåÊ≠§Êó∂ÈóÆÈ¢òÊù•‰∫ÜÔºö</p>
<ul>
<li>Core-0 ‰øÆÊîπCell[0]</li>
<li>Core-1 ‰øÆÊîπCell[1]</li>
</ul>
<p>Ê≠§Êó∂‰∏çÁÆ°ÊòØË∞Å‰øÆÊîπ‰∫ÜCellÔºåÈÉΩ‰ºöÂØºËá¥ÂØπÊñπÁöÑÁºìÂ≠òË°åÂ§±ÊïàÔºåÂØºËá¥Cpu-CoreÈúÄË¶ÅÈáçÊñ∞Âà∞ÂÜÖÂ≠ò‰∏≠ÂéªÂØªÊâæÊï∞ÊçÆÔºåÂ§ßÂ§ßÈôç‰Ωé‰∫ÜËØªÂèñÊïàÁéá</p>
<p>@sun.misc.Contended Ê≠§Êó∂ËØ•Ê≥®Ëß£Â∞±ËÉΩÂèëÊå•ÊïàÊûú‰∫ÜÔºåjavaÂØπÊ†áÊ≥®ËØ•Ê≥®Ëß£ÁöÑÂØπË±°ËøõË°åpaddingÂ°´ÂÖÖÔºåÂ∞Ü<strong>128byte</strong>Â°´ÂÖÖÂú®ÂØπË±°ÂêéÈù¢ÔºåËøô‰∏™Êó∂ÂÄôÂ∞±ËÉΩ‰ΩøÂØπË±°‰∏çÂç†Áî®Âêå‰∏ÄÁºìÂ≠òË°å‰∫Ü</p>
<blockquote>
<p>**Ê≥®Ôºö**‰∏∫‰ªÄ‰πàÊòØ128byteÂë¢ÔºåÂõ†‰∏∫ÁºìÂ≠òË°åÁöÑÂ§ßÂ∞èÂú® 32~256‰πãÈó¥Ôºå128ÂèØ‰ª•‰øùËØÅÂè™ËÉΩÊîæ‰∏ã‰∏Ä‰∏™ÁºìÂ≠òË°å</p>
</blockquote>
<h5 id="addÊñπÊ≥ï">addÊñπÊ≥ï</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220428085137816.png"
	
	
	
	loading="lazy"
	
		alt="image-20220428085137816"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Cell</span><span class="o">[]</span> <span class="n">as</span><span class="o">;</span> <span class="kt">long</span> <span class="n">b</span><span class="o">,</span> <span class="n">v</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">;</span> <span class="n">Cell</span> <span class="n">a</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">((</span><span class="n">as</span> <span class="o">=</span> <span class="n">cells</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">casBase</span><span class="o">(</span><span class="n">b</span> <span class="o">=</span> <span class="n">base</span><span class="o">,</span> <span class="n">b</span> <span class="o">+</span> <span class="n">x</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">uncontended</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">as</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">as</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">as</span><span class="o">[</span><span class="n">getProbe</span><span class="o">()</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="o">!(</span><span class="n">uncontended</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">cas</span><span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">            <span class="n">longAccumulate</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">uncontended</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="longaccumlateÊñπÊ≥ï">longAccumlateÊñπÊ≥ï</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">void</span> <span class="nf">longAccumulate</span><span class="o">(</span><span class="kt">long</span> <span class="n">x</span><span class="o">,</span> <span class="n">LongBinaryOperator</span> <span class="n">fn</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">boolean</span> <span class="n">wasUncontended</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">h</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">((</span><span class="n">h</span> <span class="o">=</span> <span class="n">getProbe</span><span class="o">())</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">();</span> <span class="c1">// force initialization
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">h</span> <span class="o">=</span> <span class="n">getProbe</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">wasUncontended</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                <span class="c1">// True if last slot nonempty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Cell</span><span class="o">[]</span> <span class="n">as</span><span class="o">;</span> <span class="n">Cell</span> <span class="n">a</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">;</span> <span class="kt">long</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Â∑≤ÁªèÂàõÂª∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//Âú®Êó†ÈîÅÁä∂ÊÄÅ‰∏ãÈîÅÊòØÂê¶‰∏∫Á©∫Ôºå‰∏îÊßΩÊòØÂê¶Ë¢´Âç†Áî®Ôºå‰∏ç‰∏∫Á©∫‰∏îÊ≤°Ë¢´Âç†Áî®ËøõÂÖ•‰∏ã‰∏ÄÂ±Ç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">as</span> <span class="o">=</span> <span class="n">cells</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">as</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">((</span><span class="n">a</span> <span class="o">=</span> <span class="n">as</span><span class="o">[(</span><span class="n">n</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>       <span class="c1">// Try to attach new Cell
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">Cell</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cell</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>   <span class="c1">// Optimistically create
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">casCellsBusy</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">//Âú®ÊúâÈîÅÁä∂ÊÄÅ‰∏ãÈîÅÊòØÂê¶‰∏∫Á©∫Ôºå‰∏îÊßΩÊòØÂê¶Ë¢´Âç†Áî®Ôºå‰∏ç‰∏∫Á©∫ÂàôÂàõÂª∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kt">boolean</span> <span class="n">created</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span> <span class="o">{</span>               <span class="c1">// Recheck under lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="n">Cell</span><span class="o">[]</span> <span class="n">rs</span><span class="o">;</span> <span class="kt">int</span> <span class="n">m</span><span class="o">,</span> <span class="n">j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="o">((</span><span class="n">rs</span> <span class="o">=</span> <span class="n">cells</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                                <span class="o">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                                <span class="n">rs</span><span class="o">[</span><span class="n">j</span> <span class="o">=</span> <span class="o">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">h</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                                <span class="n">rs</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                                <span class="n">created</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                            <span class="o">}</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">cellsBusy</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">(</span><span class="n">created</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="o">;</span>           <span class="c1">// Slot is now non-empty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">wasUncontended</span><span class="o">)</span>       <span class="c1">// CAS already known to fail
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">wasUncontended</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>      <span class="c1">// Continue after rehash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//ÊßΩ‰Ωç‰∏ç‰∏∫Á©∫ÂàôËøõË°åÁ¥ØÂä†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">cas</span><span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="o">((</span><span class="n">fn</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">fn</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">x</span><span class="o">))))</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Á¥ØÂä†Â§±Ë¥•ÔºåÂàôÁúãÁ∫øÁ®ãÊï∞ÊòØÂê¶Ë∂ÖËøáCPUÁöÑÊ†∏ÂøÉÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">NCPU</span> <span class="o">||</span> <span class="n">cells</span> <span class="o">!=</span> <span class="n">as</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>            <span class="c1">// At max size or stale
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">collide</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">collide</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Êú™Ë∂ÖËøáCPUÁöÑÊ†∏ÂøÉÊï∞ÔºåÂàôËøõË°åÊâ©ÂÆπÔºåÂπ∂‰∏îÂä†ÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">casCellsBusy</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">cells</span> <span class="o">==</span> <span class="n">as</span><span class="o">)</span> <span class="o">{</span>      <span class="c1">// Expand table unless stale
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">Cell</span><span class="o">[]</span> <span class="n">rs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cell</span><span class="o">[</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">rs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">as</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                        <span class="n">cells</span> <span class="o">=</span> <span class="n">rs</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cellsBusy</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">collide</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="o">;</span>                   <span class="c1">// Retry with expanded table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//ÈáçÊñ∞ÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑÊßΩ‰Ωç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">h</span> <span class="o">=</span> <span class="n">advanceProbe</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Êú™ÂàõÂª∫ÔºåÊú™Âä†ÈîÅÔºå‰∏çÂ≠òÂú®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">cellsBusy</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="n">cells</span> <span class="o">==</span> <span class="n">as</span> <span class="o">&amp;&amp;</span> <span class="n">casCellsBusy</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">init</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>                           <span class="c1">// Initialize table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">cells</span> <span class="o">==</span> <span class="n">as</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Cell</span><span class="o">[]</span> <span class="n">rs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cell</span><span class="o">[</span><span class="n">2</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                    <span class="n">rs</span><span class="o">[</span><span class="n">h</span> <span class="o">&amp;</span> <span class="n">1</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cell</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cells</span> <span class="o">=</span> <span class="n">rs</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">init</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">cellsBusy</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">init</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Âä†ÈîÅÂ§±Ë¥•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">casBase</span><span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">base</span><span class="o">,</span> <span class="o">((</span><span class="n">fn</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">v</span> <span class="o">+</span> <span class="n">x</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">fn</span><span class="o">.</span><span class="na">applyAsLong</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">x</span><span class="o">))))</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>                          <span class="c1">// Fall back on using base
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="cellÊú™Â≠òÂú®">CellÊú™Â≠òÂú®</h6>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220428090016999.png"
	
	
	
	loading="lazy"
	
		alt="image-20220428090016999"
	
	
></p>
<h6 id="cellÂ≠òÂú®Êú™ÂàõÂª∫">CellÂ≠òÂú®Êú™ÂàõÂª∫</h6>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220428090622030.png"
	
	
	
	loading="lazy"
	
		alt="image-20220428090622030"
	
	
></p>
<h6 id="cellÂ≠òÂú®Â∑≤ÂàõÂª∫">CellÂ≠òÂú®Â∑≤ÂàõÂª∫</h6>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220428092151435.png"
	
	
	
	loading="lazy"
	
		alt="image-20220428092151435"
	
	
></p>
<h3 id="116-unsafe">11.6 Unsafe</h3>
<h4 id="Ê¶ÇËø∞">Ê¶ÇËø∞</h4>
<p>UnsafeÂØπË±°Êèê‰æõ‰∫ÜÈùûÂ∏∏Â∫ïÂ±ÇÁöÑÔºåÊìç‰ΩúÂÜÖÂ≠òÔºåÁ∫øÁ®ãÁöÑÊñπÊ≥ïÔºåUnsafeÂØπË±°‰∏çËÉΩÁõ¥Êé•Ë∞ÉÁî®ÔºåÂè™ËÉΩÈÄöËøáÂèçÂ∞ÑËé∑Âèñ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">unsafeTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchFieldException</span><span class="o">,</span><span class="n">IllegalAccessException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Field</span> <span class="n">theUnsafe</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;theUnsafe&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">theUnsafe</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span><span class="n">theUnsafe</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">unsafe</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="unsafe-casÊìç‰Ωú">Unsafe CASÊìç‰Ωú</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchFieldException</span><span class="o">,</span><span class="n">IllegalAccessException</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Field</span> <span class="n">theUnsafe</span> <span class="o">=</span> <span class="n">Unsafe</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;theUnsafe&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">theUnsafe</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Unsafe</span> <span class="n">unsafe</span> <span class="o">=</span> <span class="o">(</span><span class="n">Unsafe</span><span class="o">)</span><span class="n">theUnsafe</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">unsafe</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//1 Ëé∑ÂèñÂÅèÁßªÂú∞ÂùÄ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">long</span> <span class="n">idOffset</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">objectFieldOffset</span><span class="o">(</span><span class="n">Teacher</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">nameOffset</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">objectFieldOffset</span><span class="o">(</span><span class="n">Teacher</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">idOffset</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Teacher</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Teacher</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//2 ËøõË°åCASÊìç‰Ωú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">unsafe</span><span class="o">.</span><span class="na">compareAndSwapInt</span><span class="o">(</span><span class="n">t</span><span class="o">,</span><span class="n">idOffset</span><span class="o">,</span><span class="n">0</span><span class="o">,</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">unsafe</span><span class="o">.</span><span class="na">compareAndSwapObject</span><span class="o">(</span><span class="n">t</span><span class="o">,</span><span class="n">nameOffset</span><span class="o">,</span><span class="kc">null</span><span class="o">,</span><span class="s">&#34;Genius&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="12-‰∏çÂèØÂèòÁ±ª">12 ‰∏çÂèØÂèòÁ±ª</h2>
<h3 id="121-‰∏çÂèØÂèòÁ±ªÁöÑËÆæËÆ°">12.1 ‰∏çÂèØÂèòÁ±ªÁöÑËÆæËÆ°</h3>
<p>**ÂÆö‰πâÔºö**‰∏çÂèØÂèòÁ±ªÊåáÁöÑÊòØÔºåËØ•Á±ªÂú®Â§öÁ∫øÁ®ãÁöÑÊÉÖÂÜµ‰∏ãÔºå‰∏ç‰ºöÂõ†‰∏∫ÂÖ∂‰ªñÁ∫øÁ®ãÂèÇ‰∏éÔºåÂØºËá¥Á±ªÁöÑÂÜÖÈÉ®Â±ûÊÄßÈÅ≠Âà∞ÁØ°ÊîπÔºåËÄåÂá∫Áé∞Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò</p>
<p>**‰æãÂ≠êÔºö**String Á±ªÊòØÂ§ßÂÆ∂ÁÜüÁü•ÁöÑ‰∏çÂèØÂèòÁ±ªÔºåÊàë‰ª¨ÂÄüÊ≠§Êù•ÁúãÁúã‰∏çÂèØÂèòÁ±ªËÆæËÆ°ÁöÑË¶ÅÁ¥†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">String</span>
</span></span><span class="line"><span class="cl">    <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span><span class="o">,</span> <span class="n">Comparable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;,</span> <span class="n">CharSequence</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/** The value is used for character storage. */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">char</span> <span class="n">value</span><span class="o">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** Cache the hash code for the string */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">;</span> <span class="c1">// Default to 0
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1-finalÁöÑ‰ΩøÁî®">1. finalÁöÑ‰ΩøÁî®</h4>
<p>Âú®‰∏çÂèØÂèòÁ±ª‰∏≠ÔºåÂ§ßÈÉ®ÂàÜÁöÑÂ±ûÊÄßÔºåÊñπÊ≥ïÔºåÁ±ªÈÉΩÊúâÂä†‰∏äfinalÂâçÁºÄ</p>
<ul>
<li>final‰øÆÈ•∞‰øùËØÅËØ•ÂèòÈáè‰∏∫ÂèØËØªÔºå‰∏çÂèØ‰øÆÈ•∞</li>
<li>final‰øÆÈ•∞Á±ªÔºåÈò≤Ê≠¢Â≠êÁ±ªÁªßÊâøË¶ÜÁõñÁà∂Á±ªÊñπÊ≥ïÔºåÂØºËá¥Áà∂Á±ª‰∏çÂèØÂèòÊÄßÈÅ≠Âà∞Á†¥Âùè</li>
</ul>
<h4 id="2‰øùÊä§ÊÄßÊã∑Ë¥ù">2.‰øùÊä§ÊÄßÊã∑Ë¥ù</h4>
<p>ÂΩìÈÅáÂà∞‰∏Ä‰∫õÂ≠óÁ¨¶‰∏≤‰øÆÊîπÈóÆÈ¢òÊó∂ÔºåÂ∞±‰ºöÂØπÂéüÂÖàÁöÑÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑËøõË°åÊã∑Ë¥ùÔºåÂú®Êã∑Ë¥ùÁöÑÂü∫Á°Ä‰∏äËøõË°å‰øÆÊîπ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">substring</span><span class="o">(</span><span class="kt">int</span> <span class="n">beginIndex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">beginIndex</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">StringIndexOutOfBoundsException</span><span class="o">(</span><span class="n">beginIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">subLen</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">beginIndex</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">subLen</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">StringIndexOutOfBoundsException</span><span class="o">(</span><span class="n">subLen</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">(</span><span class="n">beginIndex</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="k">this</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">beginIndex</span><span class="o">,</span> <span class="n">subLen</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="122-‰∫´ÂÖÉÊ®°Âºè">12.2 ‰∫´ÂÖÉÊ®°Âºè</h3>
<p>ÈÄöËøá‰∏çÂèØÂèòÁ±ªÁöÑÊã∑Ë¥ùÊàë‰ª¨ÂèØ‰ª•ÂèëÁé∞ÔºåÊØèÊ¨°‰øÆÊîπÂ≠óÁ¨¶‰∏≤ÈÉΩË¶ÅÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰ªéËÄåÂØºËá¥ËøáÂ§öÁöÑÂÜÖÂ≠òÊµ™Ë¥πÔºå<strong>ËÄå‰∫´ÂÖÉÊ®°ÂºèÂ∞±ÊòØÈíàÂØπÊúâÈôê‰∏™Êï∞ÁöÑÂêå‰∏ÄÁ±ªÂØπË±°ÂèØÈáçÂ§ç‰ΩøÁî®ÁöÑÂú∫ÊôØÊù•‰ΩøÁî®ÁöÑ</strong></p>
<p><strong>Â∏∏ËßÅÁöÑ‰∫´ÂÖÉÊ®°Âºè‰æãÂ≠êÔºö</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220620160018128.png"
	
	
	
	loading="lazy"
	
		alt="image-20220620160018128"
	
	
></p>
<h3 id="123-Ëá™ÂÆö‰πâËøûÊé•Ê±†">12.3 Ëá™ÂÆö‰πâËøûÊé•Ê±†</h3>
<h4 id="ËøûÊé•Ê±†ÂäüËÉΩ">ËøûÊé•Ê±†ÂäüËÉΩÔºö</h4>
<blockquote>
<p>**1Ôºå**Âú®ËøûÊé•Ê±†‰∏≠‰ºöÊúâ‰∏ÄÂÆöÁöÑÂÆπÈáèÂ§ßÂ∞èÊù•Â≠òÂÇ®Â∑≤ÊúâËøûÊé•(Â∑≤ÁªèÂÆûÁé∞)</p>
<p>**2Ôºå**ÂΩìÊúâÁ∫øÁ®ãË¶ÅËé∑ÂèñËøûÊé•Êó∂ÔºåÂàôÊü•ÁúãËøûÊé•Ê±†‰∏≠ÁöÑÊØè‰∏™ËøûÊé•ÁöÑÁä∂ÊÄÅÔºåÊúâÁ©∫Èó≤Âç≥ÊãøËµ∞ÔºåÊ≤°ÊúâÁ©∫Èó≤ÂàôÁ≠âÂæÖ(Â∑≤ÁªèÂÆûÁé∞)</p>
<p>**3Ôºå**Ë¢´‰ΩøÁî®ÂÆåÁöÑËøûÊé•ÔºåË¶ÅÂΩíÂõûËøûÊé•Ôºå‰∏îÊõ¥ÊîπÁä∂ÊÄÅ(Â∑≤ÁªèÂÆûÁé∞)</p>
<p>**4Ôºå**ËøûÊé•ÁöÑÂä®ÊÄÅÂ¢ûÈïø‰∏éÊî∂Áº©</p>
<p>**5Ôºå**ËøûÊé•‰øùÊ¥ª</p>
<p>**6Ôºå**Á≠âÂæÖË∂ÖÊó∂Â§ÑÁêÜ</p>
<p>**7Ôºå**ÂàÜÂ∏ÉÂºèhash</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">JUC.h_immuteable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">JUC.g_noLock.Atomic.AtomArray</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.Executor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicIntegerArray</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConnectionPool</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">Pool</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pool</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">100</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">getConn</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                try {
</span></span></span><span class="line"><span class="cl"><span class="c1">//                    Thread.sleep(new Random().nextInt(1000));
</span></span></span><span class="line"><span class="cl"><span class="c1">//                }catch (InterruptedException e){
</span></span></span><span class="line"><span class="cl"><span class="c1">//                    e.printStackTrace();
</span></span></span><span class="line"><span class="cl"><span class="c1">//                }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="n">pool</span><span class="o">.</span><span class="na">free</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span><span class="o">(</span><span class="n">topic</span><span class="o">=</span><span class="s">&#34;pool&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Pool</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">poolSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Connection</span> <span class="n">connection</span><span class="o">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AtomicIntegerArray</span> <span class="n">state</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Pool</span><span class="o">(</span><span class="kt">int</span> <span class="n">poolSize</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">poolSize</span> <span class="o">=</span> <span class="n">poolSize</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Connection</span><span class="o">[</span><span class="n">poolSize</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicIntegerArray</span><span class="o">(</span><span class="n">poolSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">poolSize</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">connection</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GeniusConnection</span><span class="o">(</span><span class="s">&#34;connection&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getConn</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="k">this</span><span class="o">.</span><span class="na">poolSize</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="n">0</span><span class="o">,</span><span class="n">1</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">connection</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;get {}&#34;</span><span class="o">,</span><span class="n">conn</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">conn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;no connection wait&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">free</span><span class="o">(</span><span class="n">Connection</span> <span class="n">conn</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">poolSize</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">conn</span> <span class="o">==</span> <span class="n">connection</span><span class="o">[</span><span class="n">i</span><span class="o">]){</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} free&#34;</span><span class="o">,</span><span class="n">conn</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">GeniusConnection</span> <span class="kd">implements</span> <span class="n">Connection</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">GeniusConnection</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;GeniusConncetion{&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;name=&#39;&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="sc">&#39;}&#39;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Statement</span> <span class="nf">createStatement</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="124-finalÂéüÁêÜ">12.4 finalÂéüÁêÜ</h3>
<h4 id="1ËÆæÁΩÆfinalÂèòÈáèÁöÑÂéüÁêÜ">1ÔºåËÆæÁΩÆfinalÂèòÈáèÁöÑÂéüÁêÜ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">killFinal</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">20</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Â≠óËäÇÁ†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public JUC.h_immuteable.killFinal();
</span></span><span class="line"><span class="cl">    Code:
</span></span><span class="line"><span class="cl">       0: aload_0
</span></span><span class="line"><span class="cl">       1: invokespecial #1                  // Method java/lang/Object.&#34;&lt;init&gt;&#34;:()V
</span></span><span class="line"><span class="cl">       4: aload_0
</span></span><span class="line"><span class="cl">       5: bipush        20
</span></span><span class="line"><span class="cl">       7: putfield      #2                  // Field a:I
</span></span><span class="line"><span class="cl">         &lt;-- ÂÜôÂ±èÈöú
</span></span><span class="line"><span class="cl">      10: return
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂèëÁé∞finalÂèòÈáèÁöÑËµãÂÄº‰πü‰ºöÈÄöËøáputfieldÊåá‰ª§ÂÆåÊàêÔºåÂú®putfieldÊåá‰ª§‰πãÂêé‰ºöÂä†ÂÖ•ÂÜôÂ±èÈöúÔºåÈò≤Ê≠¢Âá∫Áé∞‰∏çÂèØËßÅÊÄßÈóÆÈ¢ò</p>
<h4 id="2Ëé∑ÂèñfinalÂèòÈáèÁöÑÂéüÁêÜ">2ÔºåËé∑ÂèñfinalÂèòÈáèÁöÑÂéüÁêÜ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">killFinal</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">20</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">+</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">21</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">useFinal</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">killFinal</span><span class="o">.</span><span class="na">a</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">killFinal</span><span class="o">.</span><span class="na">b</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">killFinal</span><span class="o">.</span><span class="na">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">killFinal</span><span class="o">.</span><span class="na">d</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>final static int a ÁöÑËØªÂèñ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="n">L0</span>
</span></span><span class="line"><span class="cl">    <span class="n">LINENUMBER</span> <span class="n">22</span> <span class="n">L0</span>
</span></span><span class="line"><span class="cl">    <span class="n">GETSTATIC</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="na">out</span> <span class="o">:</span> <span class="n">Ljava</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BIPUSH</span> <span class="n">20</span>
</span></span><span class="line"><span class="cl">    <span class="n">INVOKEVIRTUAL</span> <span class="n">java</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">.</span><span class="na">println</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span><span class="n">V</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âπ∂Ê≤°Êúâ‰ªéÁ±ª‰∏≠ÂèñÂá∫aÂèòÈáèÔºåËÄåÊòØÁõ¥Êé•‰ªéÂ∏∏ÈáèÊ±†ÂèñÂá∫Êï∞Â≠ó20 Êé®ÂÖ•Êìç‰ΩúÊï∞Ê†àÔºåÁõ∏ÂΩì‰∫éÂ§çÂà∂‰∏Ä‰ªΩÊù•ËøõË°åÂ§ÑÁêÜ(Áî±‰∫é -128&lt;a&lt;127 ÊâÄ‰ª•‰∏∫BIPUSH)</p>
</li>
<li>
<p>final static int b ÁöÑËØªÂèñ</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="n">L1</span>
</span></span><span class="line"><span class="cl">    <span class="n">LINENUMBER</span> <span class="n">23</span> <span class="n">L1</span>
</span></span><span class="line"><span class="cl">    <span class="n">GETSTATIC</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="na">out</span> <span class="o">:</span> <span class="n">Ljava</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LDC</span> <span class="o">-</span><span class="n">2147483648</span>
</span></span><span class="line"><span class="cl">    <span class="n">INVOKEVIRTUAL</span> <span class="n">java</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">.</span><span class="na">println</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span><span class="n">V</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‚Äã     ÂíåaÂêåÁêÜÔºåÂè™ÊòØÈááÁî®ÁöÑÊòØLDCÁöÑÊñπÂºè‰ªéÂ∏∏ÈáèÊ±†ÂèñÂá∫ÔºåÊé®ÂÖ•Âà∞Ê†à‰∏≠</p>
<ul>
<li>static int cÁöÑËØªÂèñ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="n">L2</span>
</span></span><span class="line"><span class="cl">    <span class="n">LINENUMBER</span> <span class="n">24</span> <span class="n">L2</span>
</span></span><span class="line"><span class="cl">    <span class="n">GETSTATIC</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="na">out</span> <span class="o">:</span> <span class="n">Ljava</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GETSTATIC</span> <span class="n">JUC</span><span class="o">/</span><span class="n">h_immuteable</span><span class="o">/</span><span class="n">killFinal</span><span class="o">.</span><span class="na">c</span> <span class="o">:</span> <span class="n">I</span>
</span></span><span class="line"><span class="cl">    <span class="n">INVOKEVIRTUAL</span> <span class="n">java</span><span class="o">/</span><span class="n">io</span><span class="o">/</span><span class="n">PrintStream</span><span class="o">.</span><span class="na">println</span> <span class="o">(</span><span class="n">I</span><span class="o">)</span><span class="n">V</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÊôÆÈÄöÂ∏∏ÈáèÁöÑËØªÂèñÂ∞±ÂíåfinalËØªÂèñÊúâ‰∏çÂêåÔºåÊòØ‰ªéÂèòÈáèÁöÑÁ±ª‰∏≠Ôºå‰πüÂ∞±ÊòØ‰ªéÂ†Ü‰∏≠ÂéªÂØªÊâæÔºåÂèñÂá∫ÂêéÔºåÂæóÂà∞ËØ•ÂÄºÔºå<!-- raw HTML omitted -->ÊâÄ‰ª•finalÂèòÈáèÁöÑËØªÂèñ‰ºöË¶ÅÊØîÈùûfinalÂèòÈáèËØªÂèñÊõ¥Âä†ÁöÑÂø´ÈÄü<!-- raw HTML omitted --></p>
<h2 id="13-Á∫øÁ®ãÊ±†">13 Á∫øÁ®ãÊ±†</h2>
<h3 id="131-ÊâãÂÜôÁ∫øÁ®ãÊ±†">13.1 ÊâãÂÜôÁ∫øÁ®ãÊ±†</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220622142058663.png"
	
	
	
	loading="lazy"
	
		alt="image-20220622142058663"
	
	
></p>
<h4 id="1blockingqueue-ÈòªÂ°ûÈòüÂàó">1,BlockingQueue ÈòªÂ°ûÈòüÂàó</h4>
<p>ÂΩìÁ∫øÁ®ãÊ±†‰∏≠Ê†∏ÂøÉË∞ÉÁî®Êï∞Â∑≤Êª°Êó∂ÔºåÂàôÂ∞ÜË¶ÅÊ∑ªÂä†ÁöÑ‰ªªÂä°ÔºåÊîæÂÖ•ÈòªÂ°ûÈòüÂàó‰∏≠ÔºåÁî±‰∫éÂ§öÁ∫øÁ®ãÊìç‰ΩúÔºå<strong>ÊâÄ‰ª•Ë¶Å‰øùËØÅBlockingQueueÊòØÁ∫øÁ®ãÂÆâÂÖ®ÁöÑ</strong>Ôºå<strong>ÂêåÊó∂ÈúÄË¶ÅÁî®Êù°‰ª∂Êù•Áª¥Êä§BlockingQueueÁöÑÊª°ÂëòÁä∂ÊÄÅÂíåÁ©∫Áä∂ÊÄÅ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">BlockQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Deque</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">deque</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Condition</span> <span class="n">fullWaitSet</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Condition</span> <span class="n">emptyWaitSet</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">BlockQueue</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">T</span> <span class="nf">get</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span><span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">deque</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
</span></span><span class="line"><span class="cl">                <span class="kt">long</span> <span class="n">nanos</span> <span class="o">=</span> <span class="n">timeUnit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;‰ªªÂä°ÈòüÂàó‰∏∫Á©∫&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nanos</span> <span class="o">=</span> <span class="n">emptyWaitSet</span><span class="o">.</span><span class="na">awaitNanos</span><span class="o">(</span><span class="n">nanos</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span><span class="o">(</span><span class="n">nanos</span><span class="o">&lt;=</span><span class="n">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">T</span> <span class="n">element</span> <span class="o">=</span> <span class="n">deque</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÂèñÂá∫‰ªªÂä° {}&#34;</span><span class="o">,</span><span class="n">element</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">fullWaitSet</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">element</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tryPut</span><span class="o">(</span><span class="n">T</span> <span class="n">task</span><span class="o">,</span><span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">rejectPolicy</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">deque</span><span class="o">.</span><span class="na">size</span><span class="o">()&gt;=</span><span class="n">capacity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">rejectPolicy</span><span class="o">.</span><span class="na">reject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">deque</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">emptyWaitSet</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="n">T</span> <span class="n">element</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="o">(</span><span class="n">deque</span><span class="o">.</span><span class="na">size</span><span class="o">()&gt;=</span><span class="n">capacity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;‰ªªÂä°ÈòüÂàóÂ∑≤Êª°&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fullWaitSet</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÊîæÂÖ•‰ªªÂä° {}&#34;</span><span class="o">,</span><span class="n">element</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">deque</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">emptyWaitSet</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">deque</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2threadpool-Á∫øÁ®ãÊ±†">2ÔºåThreadPool Á∫øÁ®ãÊ±†</h4>
<h5 id="21-ÊãíÁªùÁ≠ñÁï•">2.1 ÊãíÁªùÁ≠ñÁï•</h5>
<p>ÊãíÁªùÁ≠ñÁï•Âç≥ÔºåÂΩìÊØè‰∏Ä‰∏™‰ªªÂä°Â∑•‰ΩúÊó∂Èó¥ÂçÅÂàÜÈïøÔºåÊ†∏ÂøÉÊï∞Â∑≤Êª°Ôºå‰∏îÈòªÂ°ûÈòüÂàó‰πüÂ∑≤Êª°ÔºåÊ≠§Êó∂putÁöÑËØù‰ºöÂØºËá¥BlockQueueÈïøÊó∂Èó¥Á≠âÂæÖÔºåÊâÄ‰ª•ÔºåÊàë‰ª¨ÈááÁî®ÊãíÁªùÁ≠ñÁï•Êù•ÈíàÂØπÊª°ÂëòÊó∂putÁöÑÊìç‰ΩúÔºåÂπ∂‰∏îÂ∞ÜËØ•ÊãíÁªùÁ≠ñÁï•‰∏ãÊîæÁªôË∞ÉÁî®ËÄÖÂéªÊâßË°å</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FunctionalInterface</span>
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">RejectPolicy</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">reject</span><span class="o">(</span><span class="n">BlockQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">,</span> <span class="n">T</span> <span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>BlockQueue‰∏≠ÁöÑtryput</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">tryPut</span><span class="o">(</span><span class="n">T</span> <span class="n">task</span><span class="o">,</span><span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">rejectPolicy</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">deque</span><span class="o">.</span><span class="na">size</span><span class="o">()&gt;=</span><span class="n">capacity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">rejectPolicy</span><span class="o">.</span><span class="na">reject</span><span class="o">(</span><span class="k">this</span><span class="o">,</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">deque</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">emptyWaitSet</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="22-worker">2.2 worker</h5>
<p>workerÂç≥Á∫øÁ®ãÊ±†‰∏≠Â∑•‰ΩúÁöÑÁ∫øÁ®ãÔºåË¥üË¥£ÂÆåÊàêÂàÜÈÖç‰ªªÂä°‰ª•ÂèäÈòªÂ°ûÈòüÂàóÁöÑ‰ªªÂä°ÔºåÊØèÂÆåÊàê‰∏Ä‰∏™‰ªªÂä°ÂàôËÆæÁΩÆ‰∏∫Á©∫ÔºåÂπ∂‰∏îÂéªÈòªÂ°ûÈòüÂàóÂØªÊâæ‰∏ã‰∏Ä‰∏™‰ªªÂä°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Runnable</span> <span class="n">task</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="nf">Worker</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span><span class="o">(</span><span class="n">task</span><span class="o">!=</span><span class="kc">null</span><span class="o">||(</span><span class="n">task</span><span class="o">=</span><span class="n">taskQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">timeOut</span><span class="o">,</span><span class="n">timeUnit</span><span class="o">))!=</span><span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;‰ªªÂä°ÊâßË°åÁªìÊùü&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">task</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">workers</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{}ÁßªÈô§ Ê≤°Êúâ‰ªªÂä°ÂèØÂÅö&#34;</span><span class="o">,</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="23-Á∫øÁ®ãÊ±†‰ª£Á†Å">2.3 Á∫øÁ®ãÊ±†‰ª£Á†Å</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GeniusThreadPool</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">BlockQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">taskQueue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">poolCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">timeOut</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">rejectPolicy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">GeniusThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">poolCapacity</span><span class="o">,</span><span class="kt">int</span> <span class="n">queueCapacity</span><span class="o">,</span><span class="kt">int</span> <span class="n">timeOut</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">,</span><span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">rejectPolicy</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">poolCapacity</span> <span class="o">=</span> <span class="n">poolCapacity</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">timeOut</span> <span class="o">=</span> <span class="n">timeOut</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">timeUnit</span> <span class="o">=</span> <span class="n">timeUnit</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">rejectPolicy</span> <span class="o">=</span> <span class="n">rejectPolicy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">taskQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BlockQueue</span><span class="o">&lt;&gt;(</span><span class="n">queueCapacity</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">workers</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(</span><span class="n">workers</span><span class="o">.</span><span class="na">size</span><span class="o">()&lt;</span><span class="n">poolCapacity</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                <span class="n">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Ê∑ªÂä†workerÂØπË±° {}&#34;</span><span class="o">,</span> <span class="n">worker</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">worker</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Ê†∏ÂøÉÂ∑≤Êª° Â∞Ütask {} Ê∑ªÂä†ÈòªÂ°ûÈòüÂàó&#34;</span><span class="o">,</span><span class="n">task</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">taskQueue</span><span class="o">.</span><span class="na">tryPut</span><span class="o">(</span><span class="n">task</span><span class="o">,</span><span class="n">rejectPolicy</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="132-threadpoolexecutor">13.2 ThreadPoolExecutor</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220622135849975.png"
	
	
	
	loading="lazy"
	
		alt="image-20220622135849975"
	
	
></p>
<h4 id="1Á∫øÁ®ãÊ±†Áä∂ÊÄÅ">1ÔºåÁ∫øÁ®ãÊ±†Áä∂ÊÄÅ</h4>
<p>Á∫øÁ®ãÊ±†ÁöÑÁä∂ÊÄÅÁî± int ÁöÑÈ´ò3‰ΩçÁªÑÊàêÔºå‰Ωé29‰ΩçÁªÑÊàêÁ∫øÁ®ãÁöÑÊï∞Èáè</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220622140707645.png"
	
	
	
	loading="lazy"
	
		alt="image-20220622140707645"
	
	
></p>
<p><strong>Á∫øÁ®ãÊ±†Áä∂ÊÄÅÁöÑÂ§ßÂ∞èÔºöTERMINATED &gt; TIDIYING &gt; STOP &gt; SHUTDOWN &gt; RUNNING</strong></p>
<p><strong>Á∫øÁ®ãÊ±†Áä∂ÊÄÅÂíåÁ∫øÁ®ãÊ±†Á∫øÁ®ãÊï∞ÈáèÁî±ÂéüÂ≠êÂèòÈáèctlÂ≠òÂÇ®</strong>ÔºåÁ∫øÁ®ãÊ±†Áä∂ÊÄÅ‰πãÊâÄ‰ª•Áî®ËøôÁßçÂêà‰∫å‰∏∫‰∏ÄÁöÑÊñπÂºèÂéªÂ≠òÂÇ®ÔºåÊòØÂõ†‰∏∫Â¶ÇÊûúÂàÜÂà´Áî®‰∏§‰∏™ÂéüÂ≠êÂèòÈáèÂ≠òÂÇ®ÈúÄË¶ÅËøõË°å‰∏§Ê¨°CASÔºåËÄåËøôÊ†∑Â≠êÂè™ÈúÄË¶ÅÊâßË°å‰∏ÄÊ¨°CASÊìç‰Ωú</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicInteger</span> <span class="n">ctl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">ctlOf</span><span class="o">(</span><span class="n">RUNNING</span><span class="o">,</span> <span class="n">0</span><span class="o">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">ctlOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">wc</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="n">rs</span> <span class="o">|</span> <span class="n">wc</span><span class="o">;</span> <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2ÊûÑÈÄ†ÊñπÊ≥ï">2ÔºåÊûÑÈÄ†ÊñπÊ≥ï</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ÂèÇÊï∞‰ªãÁªç"><strong>ÂèÇÊï∞‰ªãÁªç</strong></h5>
<blockquote>
<p>corePoolSizeÔºöÊ†∏ÂøÉÁ∫øÁ®ãÊï∞</p>
<p>maximumPoolSizeÔºöÊúÄÂ§ßÁ∫øÁ®ãÊï∞</p>
<p>keepAliveTimeÔºöÊïëÊÄ•Á∫øÁ®ãÂ≠òÊ¥ªÊó∂Èó¥</p>
<p>unitÔºöÊó∂Èó¥Â§ÑÁêÜ</p>
<p>workQueueÔºö‰ªªÂä°ÈòªÂ°ûÈòüÂàó
threadFactoryÔºöÁ∫øÁ®ãÂ∑•ÂéÇÔºå‰∏∫Á∫øÁ®ãÂèñÂêçÂ≠ó</p>
<p>handlerÔºöÊãíÁªùÁ≠ñÁï•</p>
</blockquote>
<h5 id="ÊïëÊÄ•Á∫øÁ®ã">ÊïëÊÄ•Á∫øÁ®ã:</h5>
<p>**‰ΩúÁî®Ôºö**ÂΩìÊ†∏ÂøÉÁ∫øÁ®ãÂíåÈòªÂ°ûÁ∫øÁ®ãÈÉΩÊª°‰∫ÜÊó∂ÔºåÂÜçÊ¨°Ê∑ªÂä†‰ªªÂä°javaÁ∫øÁ®ãÊ±†‰∏ç‰ºöÂÖàË∞ÉÁî®ÊãíÁªùÁ≠ñÁï•ÔºåËÄåÊòØÂÖàÂºÄËæü‰∏Ä‰∏™ÊïëÊÄ•Á∫øÁ®ãÊù•ÂØπ‰ªªÂä°ËøõË°åÂ§ÑÁêÜÔºåÂΩì‰ªªÂä°ÊâßË°åÂÆåÊØïÂêéÔºåÂ¶ÇÊûúÊïëÊÄ•Á∫øÁ®ãÂà∞ËææÂÆÉÊúÄÂ§ßÂ≠òÊ¥ªÊó∂Èó¥ÔºåÂàôÈîÄÊØÅËØ•Á∫øÁ®ã</p>
<p>**ÊïëÊÄ•Á∫øÁ®ãÁöÑÊï∞ÈáèÔºö**maximumPoolSize - corePoolSize</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220622141300868.png"
	
	
	
	loading="lazy"
	
		alt="image-20220622141300868"
	
	
></p>
<h5 id="ÊãíÁªùÁ≠ñÁï•">ÊãíÁªùÁ≠ñÁï•</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220623013619733.png"
	
	
	
	loading="lazy"
	
		alt="image-20220623013619733"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220623013216541.png"
	
	
	
	loading="lazy"
	
		alt="image-20220623013216541"
	
	
></p>
<h4 id="3Â∑•ÂéÇÊñπÊ≥ïÊûÑÈÄ†Á∫øÁ®ãÊ±†">3ÔºåÂ∑•ÂéÇÊñπÊ≥ïÊûÑÈÄ†Á∫øÁ®ãÊ±†</h4>
<ul>
<li><strong>newFixThreadPool</strong> Âõ∫ÂÆöÂ§ßÂ∞èÁ∫øÁ®ãÊ±†</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newFixedThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">nThreads</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1ÔºåÊ≤°ÊúâÊïëÊÄ•Á∫øÁ®ã</p>
<p>2ÔºåÈòªÂ°ûÈòüÂàóÊú™ËÆæÁΩÆÂ§ßÂ∞èÔºåÂ§ßÂ∞è‚ÄúÊó†Èôê‚Äù</p>
<p>3ÔºåÈÄÇÁî®‰∫é‰ªªÂä°ÈáèÂ∑≤Áü•Ôºå‰ªªÂä°ÈáèÂ§ßÁöÑÁ∫øÁ®ã</p>
</blockquote>
<ul>
<li><strong>newCachedThreadPool</strong> Â∏¶ÁºìÂÜ≤ÁöÑÁ∫øÁ®ãÊ±†</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newCachedThreadPool</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">60L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1ÔºåÂèØ‰ª•Êó†ÈôêÊ¨°ÂàõÂª∫Á∫øÁ®ãÔºå‰∏îÊ†∏ÂøÉÁ∫øÁ®ã‰∏∫0ÔºåÂàô‰ª£Ë°®ÊâÄÊúâÁ∫øÁ®ãÈÉΩÊòØÊïëÊÄ•Á∫øÁ®ãÔºå‰∏îÂ≠òÊ¥ªÊó∂Èó¥‰∏∫60Áßí</p>
<p>2ÔºåSynchronousQueueÈòüÂàóÁöÑÂÆπÈáè‰∏∫0ÔºåÂè™ÊúâÂú®ÊúâÁ∫øÁ®ãÂèñ‰ªªÂä°ÁöÑÊó∂ÂÄôÔºåÊâçËÉΩÊîæÂÖ•‰ªªÂä°ÔºåÁõ∏ÂΩì‰∫é‰∏ÄÊâã‰∫§Èí±Ôºå‰∏ÄÊâã‰∫§Ë¥ß(Â∫ïÂ±ÇÈááÁî®Park/unParkÂÆûÁé∞)</p>
<p>3ÔºåÈÄÇÁî®‰∫é‰ªªÂä°ÈáèÂ∫ûÂ§ßÔºå‰∏îÊØè‰∏™‰ªªÂä°Êó∂Èó¥ËæÉÁü≠ÁöÑÊÉÖÂÜµ</p>
</blockquote>
<ul>
<li><strong>newSingleThreadExecutor</strong> ÂçïÁ∫øÁ®ãÁöÑÁ∫øÁ®ãÊ±†</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="nf">newSingleThreadExecutor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">FinalizableDelegatedExecutorService</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span><span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">0L</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;()));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>1ÔºåËØ•Á∫øÁ®ãÊ±†Âè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãÔºåÁî®Êù•Â§ÑÁêÜÂ§ö‰ªªÂä°ÊéíÈòüÂ§ÑÁêÜÁöÑÊÉÖÂÜµ</p>
<blockquote>
<p><strong>ÂíåÂçïÁ∫øÁ®ãÁöÑÂå∫Âà´</strong></p>
<ul>
<li>ÂΩìÂÖ∂‰∏≠‰∏Ä‰∏™Á∫øÁ®ã‰ªªÂä°Â§±Ë¥•ÂºÇÂ∏∏ÊäõÂá∫ÂêéÔºåËøò‰ºöÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÁ∫øÁ®ãÊù•ÊâßË°å</li>
<li>ExecutorService.newSingleThreadExecutor()Á∫øÁ®ãÊ±†Á∫øÁ®ãÊï∞ÂßãÁªà‰∏∫‰∏ÄÔºå‰∏çÂÖÅËÆ∏‰øÆÊîπ</li>
</ul>
<p><strong>‰∏énewFixThreadExecutor(1)‰∏çÂêåÁöÑÊòØÔºånewSingleThreadExecutor()‰∏≠ÁöÑFinalizableDelegatedExecutorÔºåÊòØË£ÖÈ•∞Âô®Ê®°ÂºèÔºåÂè™Êö¥Èú≤‰∫Ü‰∏Ä‰∫õË∞ÉÁî®ÊñπÊ≥ïÁöÑÊé•Âè£Ôºå‰∏çÂÖÅËÆ∏Êõ¥ÊîπExecutorÂÜÖÈÉ®‰ø°ÊÅØÔºåËÄånewFixThreadExecutorËøîÂõûÁöÑÊòØThreadPoolExecutorÔºåÂèØ‰ª•ÈÄöËøásetCoreCapacityÊù•Êõ¥ÊîπÁ∫øÁ®ãÊï∞Èáè</strong></p>
</blockquote>
<ul>
<li><strong>newScheduledThreadPool</strong>  ÂÆöÊó∂ÊâßË°å‰ªªÂä°Á∫øÁ®ãÊ±†</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">ScheduledExecutorService</span> <span class="nf">newScheduledThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">ScheduledThreadPoolExecutor</span><span class="o">(</span><span class="n">corePoolSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>‰∏éTimerÁöÑÂå∫Âà´</strong>Ôºö</p>
<p>1ÔºåTimerÂçÅÂàÜËÑÜÂº±ÔºåÂΩì‰∏ÄÁ≥ªÂàó‰ªªÂä°‰∏≠Êüê‰∫õ‰ªªÂä°ÁöÑÊó∂Èó¥ÈùûÂ∏∏ÈïøÊàñËÄÖ‰ªªÂä°Âá∫Áé∞ÂºÇÂ∏∏ÈÉΩ‰ºöÂΩ±ÂìçÂà∞ÂêéÁª≠‰ªªÂä°Ôºå‰ΩÜÊòØnewScheduledThreadPoolÂπ∂‰∏ç‰ºö</p>
</blockquote>
<blockquote>
<p><strong>shceduleAtiFixedRate‰∏éscheduleWithFixedDelayÁöÑÂå∫Âà´</strong></p>
<p>‰∏§‰∏™ÊñπÊ≥ïÈÉΩÊòØÂÆöÊó∂Âæ™ÁéØÊâßË°åÊüê‰∏™‰ªªÂä°Ôºå‰∏îÂèÇÊï∞ÊÑè‰πâÈÉΩÁõ∏Âêå</p>
<p>1ÔºåshceduleAtiFixedRate ÁöÑÂª∂Êó∂ÊâßË°åÊó∂Èó¥ ÂèñÂÜ≥‰∫é max(‰ªªÂä°ÊâßË°åÊó∂Èó¥ÔºåÂª∂Êó∂Êó∂Èó¥)</p>
<p>2ÔºåscheduleWithFixedDelay ÁöÑÂª∂Êó∂ÊâßË°åÊó∂Èó¥ ÂèñÂÜ≥‰∫é Âª∂Êó∂Êó∂Èó¥+‰ªªÂä°ÊâßË°åÊó∂Èó¥</p>
</blockquote>
<p><strong>Â∞èÁªÉÊâãÔºöÊØèÂë®Âõõ‰∏ãÂçàÂõõÁÇπÂÆöÊó∂ÊâßË°å‰ªªÂä°</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624174237917.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624174237917"
	
	
></p>
<h4 id="4Êèê‰∫§‰ªªÂä°">4ÔºåÊèê‰∫§‰ªªÂä°</h4>
<ul>
<li><strong>submit</strong></li>
</ul>
<p>Êèê‰∫§‰ªªÂä°ÔºåÂπ∂Á≠âÂæÖËøîÂõûÁªìÊûúÔºåÈááÁî®ÁöÑÊòØ‰øùÊä§ÊÄßÊöÇÂÅúËÆæËÆ°Ê®°Âºè</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">submit</span><span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">task</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>invokeAll</strong></li>
</ul>
<p>Êèê‰∫§‰∏ÄÁ≥ªÂàó‰ªªÂä°ÔºåÁ≠âÂæÖÊèê‰∫§ÁöÑÊâÄÊúâ‰ªªÂä°ÁöÑËøîÂõûÁªìÊûú</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="nf">invokeAll</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>invokeAny</strong></li>
</ul>
<p>Êèê‰∫§‰∏ÄÁ≥ªÂàó‰ªªÂä°ÔºåËøîÂõûÊúÄÂÖàÊâßË°åÂÆåÁöÑ‰ªªÂä°ÁªìÊûúÔºå‰∏îÂÖ∂‰ªñ‰ªªÂä°‰∏ç‰ºöÁªßÁª≠ÊâßË°å‰∏ãÂéª</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">invokeAny</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">tasks</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">ExecutionException</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5ÂÖ≥Èó≠Á∫øÁ®ãÊ±†">5Ôºå<strong>ÂÖ≥Èó≠Á∫øÁ®ãÊ±†</strong></h4>
<ul>
<li><strong>shutdown</strong></li>
</ul>
<blockquote>
<p>Â∞ÜÁ∫øÁ®ãÊ±†ÁöÑÁä∂ÊÄÅËÆæ‰∏∫shutdown</p>
<p>‰∏çÂÜçÊé•ÂèóÊñ∞ÁöÑ‰ªªÂä°</p>
<p>Â∑≤Êèê‰∫§ÁöÑ‰ªªÂä°‰ºö‰∏ÄÁõ¥ÊâßË°åÂÆå</p>
<p>Ë∞ÉÁî®Á∫øÁ®ã‰∏ç‰ºöÁ≠âÂæÖ‰ªªÂä°ÂÖ®ÈÉ®ÊâßË°åÂÆå</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkShutdownAccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Â∞ÜÁ∫øÁ®ãÊ±†Áä∂ÊÄÅËÆæÁΩÆ‰∏∫shutdown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">advanceRunState</span><span class="o">(</span><span class="n">SHUTDOWN</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ÊâìÊñ≠Á©∫Èó≤Á∫øÁ®ã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">interruptIdleWorkers</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">onShutdown</span><span class="o">();</span> <span class="c1">// hook for ScheduledThreadPoolExecutor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Â∞ùËØïÁªàÁªìÁ∫øÁ®ã(Ê≤°Êúâ‰ªªÂä°Êó∂Á´ãÂç≥ÁªàÁªìÔºåÊúâ‰ªªÂä°Â≠òÂú®‰πü‰∏ç‰ºöÁ≠âÂæÖ)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tryTerminate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>shutdownNow</strong></li>
</ul>
<blockquote>
<p>Â∞ÜÁ∫øÁ®ãÊ±†ÁöÑÁä∂ÊÄÅÂèò‰∏∫STOP</p>
<p>‰∏çÂÜçÊé•ÂèóÊñ∞ÁöÑ‰ªªÂä°ÔºåÂ∑≤Êèê‰∫§ÁöÑ‰ªªÂä°‰πü‰∏çÂÜçÊâßË°åÔºåÂπ∂‰∏îËøîÂõûÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°</p>
<p>Ê≠£Âú®ÊâßË°åÁöÑ‰ªªÂä°Áî®interruptËøõË°åÊâìÊñ≠</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="nf">shutdownNow</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">tasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkShutdownAccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//‰øÆÊîπÁ∫øÁ®ãÊ±†Áä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">advanceRunState</span><span class="o">(</span><span class="n">STOP</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ÊâìÊñ≠ÊâÄÊúâÁ∫øÁ®ã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">interruptWorkers</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ËøîÂõûÈòüÂàó‰∏≠ÁöÑ‰ªªÂä°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tasks</span> <span class="o">=</span> <span class="n">drainQueue</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Â∞ùËØïÁªàÁªì
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tryTerminate</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tasks</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂÖ∂‰ªñÊñπÊ≥ï</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="c1">//‰∏çÂú®RUNNINGÁä∂ÊÄÅ‰∏ãÁöÑÁ∫øÁ®ãÊ±†ËøîÂõûTrue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isShutdown</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//Á∫øÁ®ãÊ±†ÊòØÂê¶‰∏∫Terminating   
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isTerminating</span><span class="o">()</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//Ë∞ÉÁî®shutdownÂêéÔºåË∞ÉÁî®Á∫øÁ®ãÂπ∂‰∏ç‰ºöÁ≠âÂæÖÁ∫øÁ®ãÊ±†‰∏≠‰ªªÂä°ÊâßË°åÔºåÊ≠§Êó∂ÂèØ‰ª•Ë∞ÉÁî®awaitTerminationËøõË°åÁ≠âÂæÖ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">awaitTermination</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="133-ÂàõÂª∫Á∫øÁ®ãÊ±†Â§öÂ∞ë‰∏™Á∫øÁ®ãÂêàÈÄÇÂë¢">13.3 ÂàõÂª∫Á∫øÁ®ãÊ±†Â§öÂ∞ë‰∏™Á∫øÁ®ãÂêàÈÄÇÂë¢</h3>
<ul>
<li>ËøáÂ∞è‰ºöÂØºËá¥Á®ãÂ∫è‰∏çËÉΩÂÖÖÂàÜÂà©Áî®Á≥ªÁªüËµÑÊ∫êÔºåÂØºËá¥È••È•ø</li>
<li>ËøáÂ§ß‰ºöÂØºËá¥Êõ¥Â§öÁöÑÁ∫øÁ®ã‰∏ä‰∏ãÊñáÂàáÊç¢ÔºåÂç†Áî®Êõ¥Â§öÂÜÖÂ≠ò</li>
</ul>
<h4 id="1cpuÂØÜÈõÜÂûãËøêÁÆó">1ÔºåCPUÂØÜÈõÜÂûãËøêÁÆó</h4>
<p>ÈááÁî® cpuÊ†∏Êï∞+1 ËÉΩÂ§üÂÆûÁé∞ÊúÄ‰ºòÁöÑCPUÂà©Áî®ÁéáÔºå+1ÊòØ‰øùËØÅÂΩìÂâçÁ∫øÁ®ãÁî±‰∫éÈ°µÊïÖÈöúÊàñÂÖ∂‰ªñÂéüÂõ†ÂØºËá¥ÊöÇÂÅúÊó∂ÔºåÈ¢ùÂ§ñÁöÑÁ∫øÁ®ãËÉΩÈ°∂Êõø‰∏äÂéª„ÄÇ</p>
<h4 id="2ioÂØÜÈõÜÂûãËøêÁÆó">2ÔºåI/OÂØÜÈõÜÂûãËøêÁÆó</h4>
<p>CPU‰∏çÊÄªÂ§Ñ‰∫éÁπÅÂøôÁä∂ÊÄÅÔºåÊØîÂ¶ÇÊï∞ÊçÆÂ∫ìÂ¢ûÂà†Êü•ÊîπÔºåRFCÊ°ÜÊû∂Ë∞ÉÁî®ÔºåI/0Êìç‰ΩúÔºåÊ≠§Êó∂‰Ω†ÁöÑCPUÂ∞±‰ºöÈó≤‰∏ãÊù•„ÄÇ</p>
<p><strong>ÁªèÈ™åÂÖ¨ÂºèÂ¶Ç‰∏ãÔºö</strong></p>
<blockquote>
<p>Á∫øÁ®ãÊï∞ = Ê†∏Êï∞ * ÊúüÊúõCPUÂà©Áî®Áéá * ÊÄªÊó∂Èó¥(CPUËÆ°ÁÆóÊó∂Èó¥+Á≠âÂæÖÊó∂Èó¥) / CPUËÆ°ÁÆóÊó∂Èó¥</p>
</blockquote>
<p>‰æãÂ¶ÇÔºö4Ê†∏CPUËÆ°ÁÆóÊó∂Èó¥ÊòØ50%ÔºåÂÖ∂ÂÆÉÁ≠âÂæÖÊó∂Èó¥ÊòØ50%ÔºåÊúüÊúõcpuË¢´100%Âà©Áî®</p>
<p>4*100% *100%/ 50% = 8</p>
<h3 id="134-tomcatÁ∫øÁ®ãÊ±†">13.4 TomcatÁ∫øÁ®ãÊ±†</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624180953828.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624180953828"
	
	
></p>
<ul>
<li>LimitLatchÁî®Êù•ÈôêÂà∂ÊµÅÈáèÔºåÊéßÂà∂ÊúÄÂ§ßËøûÊé•Êï∞</li>
<li>AccpetorË¥üË¥£Êé•ÂèóÊñ∞ÁöÑsocketËøûÊé•</li>
<li>PollerÂè™Ë¥üË¥£ÁõëÂê¨socket channleÊòØÂê¶Êúâ „ÄêÂèØËØªI/O‰∫ã‰ª∂„Äë</li>
<li>‰∏ÄÊó¶ËØªÂèñÔºåÊää‰∫ã‰ª∂Â∞ÅË£ÖÊàê„ÄêsocketProcessor„Äë‰∫§ÁªôExcutorÁ∫øÁ®ãÊ±†Â§ÑÁêÜ</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624181202589.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624181202589"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624181231465.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624181231465"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624180500536.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624180500536"
	
	
></p>
<p><strong>TomcatÊïëÊÄ•Á∫øÁ®ãÂéüÁêÜÊõ¥Êîπ</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220624180557243.png"
	
	
	
	loading="lazy"
	
		alt="image-20220624180557243"
	
	
></p>
<h3 id="135-forkjoin">13.5 Fork/Join</h3>
<h4 id="1Ê¶ÇÂøµ">1ÔºåÊ¶ÇÂøµ</h4>
<p>Fork/JoinÈááÁî®ÁöÑÊòØ‰∏ÄÁßç<strong>ÂàÜÊ≤ªÁöÑÊÄùÊÉ≥</strong>ÔºåÊää‰∏Ä‰∏™‰ªªÂä°ÊãÜËß£‰∏∫Â§ö‰∏™‰ªªÂä°ÔºåÂà©Áî®Â§öÁ∫øÁ®ãÊù•ËøõË°åÊãÜËß£ÔºåÂêàÂπ∂ÔºåÊèêÈ´òËøêÁÆóÊïàÁéá</p>
<h2 id="14-juc">14 JUC</h2>
<h3 id="141-aqs">14.1 AQS</h3>
<h4 id="1Ê¶ÇËø∞">1,Ê¶ÇËø∞</h4>
<p>ÂÖ®Áß∞ÊòØAbstractQueuedSynchronizedrÔºå‰∏éÈòªÂ°ûÂºèÈîÅÁõ∏ÂÖ≥ÁöÑÂêåÊ≠•Âô®Â∑•ÂÖ∑ÁöÑÊ°ÜÊû∂</p>
<p>ÁâπÁÇπÔºö</p>
<ul>
<li>Áî®stateÊù•‰ª£Ë°®ËµÑÊ∫êÁä∂ÊÄÅÔºåÂ≠êÁ±ªÂÆö‰πâÂ¶Ç‰ΩïÁª¥Êä§Ëøô‰∏™Áä∂ÊÄÅÔºåÊéßÂà∂Â¶Ç‰ΩïËé∑ÂèñÈîÅÔºåÈáäÊîæÈîÅ</li>
</ul>
<blockquote>
<p><strong>AQSÂÆö‰πâ‰∏§ÁßçËµÑÊ∫êÂÖ±‰∫´ÊñπÂºè</strong></p>
<p>ExclusiveÔºàÁã¨Âç†ÔºâÔºöÂè™Êúâ‰∏Ä‰∏™Á∫øÁ®ãËÉΩÊâßË°åÔºåÂ¶ÇReentrantLock„ÄÇÂèàÂèØÂàÜ‰∏∫ÂÖ¨Âπ≥ÈîÅÂíåÈùûÂÖ¨Âπ≥ÈîÅÔºö</p>
<ul>
<li>ÂÖ¨Âπ≥ÈîÅÔºöÊåâÁÖßÁ∫øÁ®ãÂú®ÈòüÂàó‰∏≠ÁöÑÊéíÈòüÈ°∫Â∫èÔºåÂÖàÂà∞ËÄÖÂÖàÊãøÂà∞ÈîÅ</li>
<li>ÈùûÂÖ¨Âπ≥ÈîÅÔºöÂΩìÁ∫øÁ®ãË¶ÅËé∑ÂèñÈîÅÊó∂ÔºåÊó†ËßÜÈòüÂàóÈ°∫Â∫èÁõ¥Êé•ÂéªÊä¢ÈîÅÔºåË∞ÅÊä¢Âà∞Â∞±ÊòØË∞ÅÁöÑ</li>
</ul>
<p>ShareÔºàÂÖ±‰∫´ÔºâÔºöÂ§ö‰∏™Á∫øÁ®ãÂèØÂêåÊó∂ÊâßË°åÔºåÂ¶ÇSemaphore/CountDownLatch„ÄÇSemaphore„ÄÅCountDownLatch„ÄÅ CyclicBarrier„ÄÅReadWriteLock Êàë‰ª¨ÈÉΩ‰ºöÂú®ÂêéÈù¢ËÆ≤Âà∞„ÄÇ</p>
</blockquote>
<ul>
<li>Êèê‰æõ‰∫ÜÂü∫‰∫éFIFOÁöÑÁ≠âÂæÖÈòüÂàóÔºåÁ±ª‰ºº‰∫éMonitorÁöÑEntryList</li>
<li>Êù°‰ª∂ÂèòÈáèÊù•ÂÆûÁé∞Á≠âÂæÖÔºåÂî§ÈÜíÊú∫Âà∂ÔºåÊîØÊåÅÂ§ö‰∏™Êù°‰ª∂ÂèòÈáèÔºåÁ±ª‰ºº‰∫éMonitorÁöÑWaitSet</li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220625203233523.png"
	
	
	
	loading="lazy"
	
		alt="image-20220625203233523"
	
	
></p>
<h3 id="142reentrantlock">14.2ÔºåReentrantLock</h3>
<p><strong>Áõ∏ÂØπ‰∫ésynchronizedÂÆÉÂÖ∑Â§áÂ¶Ç‰∏ãÁâπÁÇπ</strong></p>
<ul>
<li>ÂèØ‰∏≠Êñ≠</li>
<li>ËÆæÁΩÆË∂ÖÊó∂Êó∂Èó¥</li>
<li>ÂèØ‰ª•ËÆæÁΩÆ‰∏∫ÂÖ¨Âπ≥ÈîÅ</li>
<li>ÊîØÊåÅÂ§ö‰∏™Êù°‰ª∂ÂèòÈáè</li>
</ul>
<p><strong>‰∏ésynchronized‰∏ÄÊ†∑ÔºåÊîØÊåÅÂèØÈáçÂÖ•</strong></p>
<h5 id="ËØ≠Ê≥ï">ËØ≠Ê≥ï</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ReentrantLock</span> <span class="n">reentrantLock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">reentrantLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//‰∏¥ÁïåÂå∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">reentrantLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÂèØÈáçÂÖ•">ÂèØÈáçÂÖ•</h4>
<p>ÂèØÈáçÂÖ•ÊòØÊåáÂêå‰∏Ä‰∏™Á∫øÁ®ãÂ¶ÇÊûúÈ¶ñÊ¨°Ëé∑Âæó‰∫ÜËøôÊääÈîÅÔºåÈÇ£‰πàÂõ†‰∏∫ÂÆÉÊòØËøôÊääÈîÅÁöÑÊã•ÊúâËÄÖÔºåÂõ†Ê≠§ÊúâÊùÉÂà©ÂÜçÊ¨°Ëé∑ÂæóËøôÊääÈîÅÔºåÂ¶ÇÊûúÊòØ‰∏çÂèØÈáçÂÖ•ÈîÅÔºåÈÇ£‰πàÁ¨¨‰∫åÊ¨°Ëé∑ÂæóÈîÅÊó∂ÔºåËá™Â∑±‰πü‰ºöË¢´ÈîÅÊå°‰Ωè</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">static</span> <span class="n">ReentrantLock</span> <span class="n">Lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">method1</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">           <span class="n">Lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;come in&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">method2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">           <span class="n">Lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;come in2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÂèØÊâìÊñ≠">ÂèØÊâìÊñ≠</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Â∞ùËØïËé∑ÂèñÈîÅ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Ê≤°ÊúâËé∑ÂæóÈîÅ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Ëé∑ÂèñÈîÅ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sleeper</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÊâìÊñ≠t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÈîÅË∂ÖÊó∂">ÈîÅË∂ÖÊó∂</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Â∞ùËØïËé∑ÂæóÈîÅ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="o">(!</span><span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Ëé∑Âèñ‰∏çÂà∞ÈîÅ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Ëé∑ÂæóÂà∞ÈîÅ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">},</span><span class="s">&#34;t1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;ÈáäÊîæ‰∫ÜÈîÅ&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">22:51:45.783 [t1] DEBUG JUC.e_ReentrantLock.lockWait - Â∞ùËØïËé∑ÂæóÈîÅ
</span></span><span class="line"><span class="cl">22:51:46.797 [main] DEBUG JUC.e_ReentrantLock.lockWait - ÈáäÊîæ‰∫ÜÈîÅ
</span></span><span class="line"><span class="cl">22:51:46.797 [t1] DEBUG JUC.e_ReentrantLock.lockWait - Ëé∑ÂæóÂà∞ÈîÅ
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="locktrylock">lock.tryLock():</h5>
<blockquote>
<p>timeout=0Ê≤°Ëé∑ÂèñÈîÅÔºåÁõ¥Êé•ËøîÂõû</p>
<p>timeout&gt;0Ê≤°Ëé∑ÂèñÈîÅÔºåÁ≠âÂæÖtimeoutÊó∂Èó¥ÔºåÂÜçËøîÂõû</p>
</blockquote>
<h4 id="ÂÖ¨Âπ≥ÈîÅ">ÂÖ¨Âπ≥ÈîÅ</h4>
<p>ÁÆÄ‰ªãÔºöÂ§ö‰∏™Á∫øÁ®ãÊåâÁÖßÁî≥ËØ∑ÈîÅÁöÑÈ°∫Â∫èÂéªËé∑ÂæóÈîÅÔºåÁ∫øÁ®ã‰ºöÁõ¥Êé•ËøõÂÖ•ÈòüÂàóÂéªÊéíÈòüÔºåÊ∞∏ËøúÈÉΩÊòØÈòüÂàóÁöÑÁ¨¨‰∏Ä‰ΩçÊâçËÉΩÂæóÂà∞ÈîÅ„ÄÇ</p>
<p>ReentrantLock ÈªòËÆ§‰∏∫‰∏çÂÖ¨Âπ≥ÁöÑ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="nf">ReentrantLock</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">fair</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sync</span> <span class="o">=</span> <span class="n">fair</span> <span class="o">?</span> <span class="k">new</span> <span class="n">FairSync</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="n">NonfairSync</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>*<em>Ê≥®ÔºöÂÖ¨Âπ≥ÈîÅ‰ºöÈôç‰ΩéÂπ∂ÂèëÂ∫¶</em></p>
<h4 id="Êù°‰ª∂ÂèòÈáè">Êù°‰ª∂ÂèòÈáè</h4>
<p>ReentrantLockÁöÑÊù°‰ª∂ÂèòÈáèÊØîsynchronizedÂº∫Â§ß‰πãÂ§ÑÂú®‰∫éÔºåÂÆÉÊîØÊåÅÂ§ö‰∏™Êù°‰ª∂ÂèòÈáè</p>
<h5 id="‰ΩøÁî®ÊµÅÁ®ã">‰ΩøÁî®ÊµÅÁ®ã</h5>
<ul>
<li>awaitÂâçÈúÄË¶ÅËé∑ÂèñÈîÅ</li>
<li>awaitÊâßË°åÂêéÔºå‰ºöÈáäÊîæÈîÅÔºåËøõÂÖ•conditionObjectÁ≠âÂæÖ</li>
<li>awaitÁöÑÁ∫øÁ®ãÂî§ÈÜíÂêéÔºåÈáçÊñ∞Á´û‰∫âlockÈîÅ</li>
<li>Á´û‰∫âlockÈîÅÊàêÂäüÂêéÔºå‰ªéawaitÂêéÁªßÁª≠ÊâßË°å</li>
</ul>
<h3 id="143-ÂéüÁêÜ">14.3 ÂéüÁêÜ</h3>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220625205626823.png"
	
	
	
	loading="lazy"
	
		alt="image-20220625205626823"
	
	
></p>
<h4 id="1Âä†ÈîÅ‰ª•ÂèäÁ´û‰∫âÈîÅ">1ÔºåÂä†ÈîÅ‰ª•ÂèäÁ´û‰∫âÈîÅ</h4>
<ul>
<li><strong>Âú®Ê≤°ÊúâÁ∫øÁ®ãÁ´û‰∫âÈîÅÊó∂</strong></li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626172830834.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626172830834"
	
	
></p>
<p>ThreadÁ∫øÁ®ãÂ∞ÜstateËÆæÁΩÆ‰∏∫1Ôºå‰∏îEXCThreadÂèò‰∏∫Thread-0</p>
<ul>
<li><strong>Á¨¨‰∏Ä‰∏™Á´û‰∫âÂá∫Áé∞Êó∂</strong></li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626173058819.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626173058819"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">1</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">acquire</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ºöÂÖàÈááÁî®CASÊù•Âà§Êñ≠ÊòØÂê¶ËÉΩËé∑ÂèñÈîÅÔºåCASÂ§±Ë¥•ÂêéË∞ÉÁî®acquire(1)ÊñπÊ≥ï</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">acquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acquireQueued</span><span class="o">(</span><span class="n">addWaiter</span><span class="o">(</span><span class="n">Node</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">),</span> <span class="n">arg</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">selfInterrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>acquireÊ≠§Êó∂Ëøò‰ºöË∞ÉÁî®‰∏ÄÊ¨°tryAcquire()ÔºåÂÜçËøõË°å‰∏ÄÊ¨°CASÊù•ÂÅöÊúÄÂêé‰∏ÄÊ¨°Êå£ÊâéÔºåÁúãÊòØÂê¶ËÉΩËé∑ÂèñÈîÅÔºå<strong>Â¶ÇÊûúÊó†Ê≥ïËé∑ÂèñÂàôËøõÂÖ•acquireQueuedÈÄªËæëÂ∞ÜËØ•Á∫øÁ®ãÂ∞ÅË£ÖÊàê‰∏Ä‰∏™NodeÂä†ÂÖ•FIFOÈòüÂàó‰∏≠</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626174055812.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626174055812"
	
	
></p>
<blockquote>
<p>Âú®FIFOÈòüÂàó‰∏≠</p>
<ul>
<li>ÈªÑËâ≤ÁöÑ‰∏âËßíÂΩ¢‰ª£Ë°®ÂΩìÂâçNodeÁöÑwaitStatusÁä∂ÊÄÅÔºå0‰ª£Ë°®Ê≠£Â∏∏</li>
<li>Âú®ÈòªÂ°ûÈòüÂàó‰∏≠‰ºöÊúâ‰∏Ä‰∏™Null NodeËäÇÁÇπÔºåÂΩì‰ΩúÂì®ÂÖµËäÇÁÇπ‰ΩøÁî®</li>
<li>NodeÂàõÂª∫ÊòØÊáíÊÉ∞ÁöÑ</li>
</ul>
</blockquote>
<ul>
<li><strong>acquireQueued</strong> <strong>ÈÄªËæë</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">acquireQueued</span><span class="o">(</span><span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">failed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">failed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">interrupted</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parkAndCheckInterrupt</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">failed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ÂÜçËøõÂÖ•acquireQueuedÈÄªËæë‰πãÂêéÔºå‰ºöÂÖàÂà§Êñ≠ËØ•ËäÇÁÇπÁöÑ‰∏ä‰∏Ä‰∏™ËäÇÁÇπÊòØÂê¶‰∏∫Â§¥ËäÇÁÇπÔºåÂ¶ÇÊûú‰∏∫Â§¥ËäÇÁÇπÔºåÂàôÂÜçÊ¨°Â∞ùËØïËé∑Âèñ„ÄÇ</p>
<p>Â¶ÇÊûúËé∑ÂèñÂ§±Ë¥•ÔºåÂàôËøõÂÖ•shouldParkAfterFailedAcquireÈÄªËæëÔºåÂ∞ÜÂâçÊúüÁöÑNodeËäÇÁÇπÁöÑwaitStatusËÆæÁΩÆ‰∏∫-1Ôºå‰∏îËøôÊ¨°ËøîÂõûfalse„ÄÇ</p>
<p>-1ÁöÑËäÇÁÇπ‰ª£Ë°®Ë¥üË¥£Âî§ÈÜíÂÖ∂ÂêéÁªßnode.nextËäÇÁÇπÁöÑ‰ªªÂä°</p>
</blockquote>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626182806742.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626182806742"
	
	
></p>
<p>shouldParkAfterFailedAcquireÊâßË°åÂÆåÊØïÂêé‰ºöÂÜçÊ¨°ÊâßË°å‰∏ÄÈÅçtryAcquireÔºåÂ¶ÇÊûúÂÜçÊ¨°Ëé∑ÂèñÂ§±Ë¥•ÔºåÂàôËøõÂÖ•shouldParkAfterFailedAcquire</p>
<p>ÔºåÊ≠§Êó∂ËøîÂõûtrueÔºåÂç≥ËøõÂÖ•ÈòªÂ°ûÁä∂ÊÄÅ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626183038234.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626183038234"
	
	
></p>
<p>ÁªèÂéÜÂ§öÊ¨°Á´û‰∫âÂêéÔºåÂèòÊàêÂ¶Ç‰∏ãËøô‰∏™Ê†∑Â≠ê</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626183323473.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626183323473"
	
	
></p>
<h4 id="2Ëß£ÈîÅÊµÅÁ®ã">2ÔºåËß£ÈîÅÊµÅÁ®ã</h4>
<ul>
<li><strong>ÂΩìThread-0ÊâßË°åÁªìÊùüÂêéÔºå‰ºöË∞ÉÁî®unlockÔºåÈáäÊîæËµÑÊ∫ê</strong></li>
</ul>
<p>releaseÈÄªËæë</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">tryRelease</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">unparkSuccessor</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ê≠§Êó∂‰ºöÂÖàËøõË°åtryReleaseÊù•Â∞ùËØïËß£ÈîÅÔºåËß£ÈîÅÊàêÂäüÂêéÔºå‰ºöÂ∞ÜÂΩìÂâçÊâßË°åÁ∫øÁ®ãËÆæ‰∏∫nullÔºåÂêåÊó∂Ë∞ÉÁî®unparkSuccessorÊù•Âî§ÈÜíÂêéÁªßÁ∫øÁ®ã</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626184408218.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626184408218"
	
	
></p>
<ul>
<li><strong>unparkSuccessorÂî§ÈÜíÂêéÁªßÁ∫øÁ®ã</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">unparkSuccessor</span><span class="o">(</span><span class="n">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">waitStatus</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">ws</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">s</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">s</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Node</span> <span class="n">t</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span> <span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">node</span><span class="o">;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">thread</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÈòüÂàóÁ∫øÁ®ã(Ê≤°ÊúâÁ´û‰∫â)ÔºåÂä†ÈîÅÊàêÂäü</strong></li>
</ul>
<p>exclusiveOwnerThreadËÆæÁΩÆ‰∏∫Thread-1Ôºåstate=1</p>
<p>headÊåáÂêëÂàöÂàöÁöÑThread-1ËäÇÁÇπÔºåÂπ∂Â∞ÜNode.threadËÆæ‰∏∫nullÔºå‰πãÂâçÁöÑËäÇÁÇπÁ¶ªÂºÄÈòüÂàóÔºåË¢´GCÂõûÊî∂</p>
<p>Ê≠§Êó∂‰ºöÊâæÂà∞Á¶ªheadÊúÄËøëÁöÑ‰∏Ä‰∏™NodeËäÇÁÇπÔºåË∞ÉÁî®unparkÊù•Âî§ÈÜíÂêéÁªßÁ∫øÁ®ãÔºåÂΩìÂêéÁªßÁ∫øÁ®ãË¢´Âî§ÈÜíÂêéÔºå‰ºöËøõË°åÂä†ÈîÅ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626184634884.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626184634884"
	
	
></p>
<ul>
<li><strong>Âä†ÈîÅÂ§±Ë¥•ÔºåÊúâÂÖ∂‰ªñÁ∫øÁ®ãÊù•Á´û‰∫â(ÈùûÂÖ¨Âπ≥ÈîÅ)</strong></li>
</ul>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/image-20220626222937304.png"
	
	
	
	loading="lazy"
	
		alt="image-20220626222937304"
	
	
></p>
<p>Thread-1ÂÜçÊ¨°ËøõÂÖ•acquireQueuedÊµÅÁ®ãÔºåËé∑ÂèñÈîÅÂ§±Ë¥•ÔºåÈáçÊñ∞ËøõÂÖ•park</p>
<h4 id="3ÂèØÈáçÂÖ•">3ÔºåÂèØÈáçÂÖ•</h4>
<ul>
<li><strong>‰∏çÂÖ¨Âπ≥ÈîÅÂèØÈáçÂÖ•</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">nonfairTryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">acquires</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Ê≠§Êó∂ÈáçÂÖ•ÁöÑËØùÔºåÂàôstate++
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">nextc</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="c1">// overflow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setState</span><span class="o">(</span><span class="n">nextc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryRelease</span><span class="o">(</span><span class="kt">int</span> <span class="n">releases</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Ëß£ÈîÅÊó∂ÔºåËÄÉËôëÂà∞ÂèØÈáçÂÖ•Ôºåstate--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">()</span> <span class="o">-</span> <span class="n">releases</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">!=</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalMonitorStateException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">free</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">free</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">setState</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">free</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4ÂèØÊâìÊñ≠">4ÔºåÂèØÊâìÊñ≠</h4>
<ul>
<li><strong>‰∏çÂèØÊâìÊñ≠Ê®°Âºè</strong></li>
</ul>
<p>‰∏çÂèØÊâìÊñ≠Ê®°Âºè‰∏ãÁöÑÁ∫øÁ®ãÂèØ‰ª•Ë¢´Â§ñÁïåÁ∫øÁ®ãÊâìÊñ≠Ôºå‰ΩÜÊòØÂπ∂‰∏ç‰ºöÂõ†‰∏∫ÊâìÊñ≠ËÄåÈÄÄÂá∫ÈòªÂ°ûÈòüÂàóÁã¨Á´ãËøêË°å</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">parkAndCheckInterrupt</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>  <span class="c1">//ÈòªÂ°ûÁöÑÁ∫øÁ®ãÔºåË¢´Â§ñÁïåÁ∫øÁ®ãÊâìÊñ≠ÈòªÂ°û
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//Ê≠§Êó∂Ë∞ÉÁî®interruptedÊñπÊ≥ïÔºåËøîÂõûtrueÔºåÂêåÊó∂Ê∏ÖÈô§ÊâìÊñ≠Ê†áËÆ∞(parkÂè™ËÉΩparkÔºåÊ≤°Ë¢´ÊâìÊñ≠ÁöÑÁ∫øÁ®ãÔºåÊñπ‰æø‰∏ãÊ¨°Âæ™ÁéØÂêéÊâìÊñ≠)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">acquireQueued</span><span class="o">(</span><span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">failed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">failed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//ËøîÂõûË¢´ÊâìÊñ≠ÁöÑÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">interrupted</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parkAndCheckInterrupt</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//Ë¢´ÊâìÊñ≠ÁöÑÁ∫øÁ®ãÂ∞ÜÊ†áËÆ∞ËÆæ‰∏∫Á©∫ÔºåÊ≠§Êó∂Á∫øÁ®ãÂπ∂Ê≤°ÊúâÂá∫ÈòªÂ°ûÈòüÂàóÁã¨Á´ãËøêË°åÔºåËÄåÊòØÁªßÁª≠Á´û‰∫âÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//1 ÔºåÁ´û‰∫âÂ§±Ë¥• --&gt; parkAndCheckInterrupt ÁªßÁª≠ÈòªÂ°û
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//2 ÔºåÁ´û‰∫âÊàêÂäü --&gt; return interrupted
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">failed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">acquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acquireQueued</span><span class="o">(</span><span class="n">addWaiter</span><span class="o">(</span><span class="n">Node</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">),</span> <span class="n">arg</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Ëã•ÊâìÊñ≠Ê†áËÆ∞‰∏∫trueÔºåÂàôÂú®ÊâìÊñ≠‰∏ÄÊ¨°ÔºåÂ∞ÜÊâìÊñ≠Ê†áËÆ∞ËÆæ‰∏∫trueÔºåÁõÆÁöÑÊòØÈò≤Ê≠¢ÂÜç‰πãÂêéËøêË°å‰∏≠ÔºåÂÜçÊ¨°Ë¢´ÈòªÂ°û
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">selfInterrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">selfInterrupt</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÂèØÊâìÊñ≠Ê®°Âºè</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doAcquireInterruptibly</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">addWaiter</span><span class="o">(</span><span class="n">Node</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">failed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">failed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parkAndCheckInterrupt</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//Âú®Ëá™Ë∫´Ë¢´ÊâìÊñ≠ÂêéÔºåÁõ¥Êé•ÊäõÂá∫ÂºÇÂ∏∏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">throw</span> <span class="k">new</span> <span class="n">InterruptedException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">failed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5ÂÖ¨Âπ≥ÈîÅ">5Ôºå<strong>ÂÖ¨Âπ≥ÈîÅ</strong></h4>
<p>‰∏éÈùûÂÖ¨Âπ≥ÈîÅ‰∏çÂêåÁöÑÊòØÔºåÈùûÂÖ¨Âπ≥ÈîÅ‰∏≠Á∫øÁ®ãÂà∞Êù•Âç≥ÂèØÁ´û‰∫âÈîÅÔºå<strong>ËÄåÂÖ¨Âπ≥ÈîÅ‰∏≠</strong>Ôºå<strong>Á∫øÁ®ãÂà∞Êù•ÂÖàË¶ÅÂà§Êñ≠ÈòªÂ°ûÈòüÂàóÊòØÂê¶ÊúâÂÖ∂‰ªñÈòüÂàóÊàñËÄÖÂà∞Êù•Á∫øÁ®ã‰∏∫ÈòªÂ°ûÈòüÂàóÁ¨¨‰∫åÂêç</strong>ÔºåÂç≥ÂèØÁ´û‰∫âÈîÅ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">hasQueuedPredecessors</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="n">compareAndSetState</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">acquires</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">nextc</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setState</span><span class="o">(</span><span class="n">nextc</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">hasQueuedPredecessors</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">t</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">s</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">h</span> <span class="o">!=</span> <span class="n">t</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">s</span><span class="o">.</span><span class="na">thread</span> <span class="o">!=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="6Êù°‰ª∂ÂèòÈáèÂÆûÁé∞ÂéüÁêÜ">6ÔºåÊù°‰ª∂ÂèòÈáèÂÆûÁé∞ÂéüÁêÜ</h4>
<h5 id="await">await</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">InterruptedException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Â∞ÜnodeÊ∑ªÂä†Âà∞Êù°‰ª∂Á≠âÂæÖÈòüÂàó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">addConditionWaiter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//fullyReleaseÊòØËé∑ÂèñÂà∞ÈîÅÁöÑÂÖ®ÈÉ®ÂèØÈáçÂÖ•Ê¨°Êï∞ÔºåÂπ∂Â∞ÜstateËÆæ‰∏∫0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">savedState</span> <span class="o">=</span> <span class="n">fullyRelease</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">interruptMode</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(!</span><span class="n">isOnSyncQueue</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">((</span><span class="n">interruptMode</span> <span class="o">=</span> <span class="n">checkInterruptWhileWaiting</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">acquireQueued</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">savedState</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">interruptMode</span> <span class="o">!=</span> <span class="n">THROW_IE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">interruptMode</span> <span class="o">=</span> <span class="n">REINTERRUPT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">nextWaiter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">// clean up if cancelled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">unlinkCancelledWaiters</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">interruptMode</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">reportInterruptAfterWait</span><span class="o">(</span><span class="n">interruptMode</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Â∞ÜThread-0ÊîæÂÖ•ConditionObjectÁöÑWaiterÂèåÂêëÈìæË°®‰∏≠ÔºåÂπ∂Â∞ÜNodeÁä∂ÊÄÅËÆæÁΩÆ‰∏∫-2</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627180030683.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>ÈÄöËøáfullyReleaseÔºåÂ∞ÜÂéüÊú¨ÁöÑThread-0ÁöÑÈîÅ(‰∏çÁÆ°ÊòØÂê¶ÈáçÂÖ•)ÁªôÈáäÊîæÔºåÂêåÊó∂Â∞ÜThread-1Âî§ÈÜíÔºå‰ΩøÁî®ÈîÅ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627181750914.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>Thread-0ÈòªÂ°û</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627181807434.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="signal">signal</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">signal</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">isHeldExclusively</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalMonitorStateException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">first</span> <span class="o">=</span> <span class="n">firstWaiter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">first</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">doSignal</span><span class="o">(</span><span class="n">first</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âî§ÈÜíConditionObject‰∏≠ÁöÑ<strong>Á¨¨‰∏Ä‰∏™Á∫øÁ®ã</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627182247140.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doSignal</span><span class="o">(</span><span class="n">Node</span> <span class="n">first</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span> <span class="o">(</span><span class="n">firstWaiter</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">nextWaiter</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">lastWaiter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">first</span><span class="o">.</span><span class="na">nextWaiter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">transferForSignal</span><span class="o">(</span><span class="n">first</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">             <span class="o">(</span><span class="n">first</span> <span class="o">=</span> <span class="n">firstWaiter</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Â∞ÜÁ¨¨‰∏Ä‰∏™Node‰ªéÈìæË°®‰∏≠Âà†Èô§Ôºå<strong>ÂêåÊó∂ËΩ¨Êç¢Âà∞ÈîÅÁöÑÈòªÂ°ûÈòüÂàó‰∏≠</strong>ÔºåËΩ¨Êç¢Â§±Ë¥•ÁöÑËØù(ÊúâÂèØËÉΩÊòØË¢´Â§ñÁïåÁ∫øÁ®ãÊâìÊñ≠Âî§ÈÜí)ÔºåÂàôÂî§ÈÜí‰∏ã‰∏Ä‰∏™Á∫øÁ®ãËäÇÁÇπÔºåÈáçÂ§ç‰∏äËø∞Ê≠•È™§</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627182407119.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>ÂΩìÊàêÂäüÂä†ÂÖ•Âà∞ÈòªÂ°ûÈòüÂàó‰∏≠Êó∂ÔºåÂ∞ÜÂâç‰∏Ä‰∏™ËäÇÁÇπÁöÑÁöÑÁä∂ÊÄÅËÆæÁΩÆ‰∏∫-1</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220627202714677.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h3 id="144-reentrantreadwritelock">14.4 ReentrantReadWriteLock</h3>
<p>**ÈîÅÁöÑÂú∫ÊôØÔºö**Âú®ËØªÂèñÊìç‰ΩúÂ§ö‰∫éÂÜôÊìç‰ΩúÁöÑÊÉÖÂÜµ‰∏ãÔºåÂØπÂ§ßÈáèËØªÊìç‰ΩúÁöÑÂä†ÈîÅÔºåÂèçËÄå‰ºöÂØºËá¥Á≥ªÁªüÊÄßËÉΩ‰∏ãÈôçÔºå‰∫éÊòØ‰æøÂ∞ÜËØªÂÜôÈîÅÂàÜÁ¶ªÔºåÊù•ËøõË°åËÆæËÆ°</p>
<h4 id="ÁâπÊÄß">ÁâπÊÄßÔºö</h4>
<ul>
<li>**Âü∫Êú¨ÂéüÂàôÔºö**ËØªËØªÂÖ±‰∫´ÔºåËØªÂÜô‰∫íÊñ•ÔºåÂÜôÁ∫øÁ®ãÂè™ÂÖÅËÆ∏Â≠òÂú®‰∏Ä‰∏™</li>
<li>ËØªÈîÅÊ≤°ÊúâÊù°‰ª∂ÂèòÈáèÔºåÂÜôÈîÅÊã•ÊúâÊù°‰ª∂ÂèòÈáè</li>
<li>ËØªÈîÅ‰∏çÂèØ‰ª•ÂçáÁ∫ß‰∏∫ÂÜôÈîÅ(‰∏çËÉΩËøõË°åÈîÅÂçáÁ∫ß)ÔºåÂÜôÈîÅÂèØ‰ª•ÈôçÁ∫ß‰∏∫ËØªÈîÅ(ËÉΩËøõË°åÈîÅÈôçÁ∫ß)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">cacheInvalid</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">lockLevelDown</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(!</span><span class="n">cacheInvalid</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">           <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="n">writeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">if</span><span class="o">(!</span><span class="n">cacheInvalid</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                   <span class="n">data</span> <span class="o">=</span> <span class="s">&#34;Genius&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                   <span class="n">cacheInvalid</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">               <span class="o">}</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">               <span class="c1">//ËøõË°åÈîÅÈôçÁ∫ßÔºåÂΩìÂÜôÈîÅÈáäÊîæÂºÄÂêéÔºåÂÖ∂‰ªñËØªÈîÅÂèØ‰ª•ÂÖ±‰∫´ÁºìÂ≠ò
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">               <span class="n">writeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;data {}&#34;</span><span class="o">,</span><span class="n">data</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="Â∫îÁî®ÁºìÂ≠òÊõ¥Êñ∞">Â∫îÁî®ÔºöÁºìÂ≠òÊõ¥Êñ∞</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220628160551021.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220628160830658.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220628203354099.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h4 id="ÂéüÁêÜ-2">ÂéüÁêÜÔºö</h4>
<p>ReentrantReadWriteLockÊú¨Ë¥®‰∏äËøòÊòØ‰ΩøÁî®ÁöÑÂêå‰∏Ä‰∏™ÂêåÊ≠•Âô®Ôºå‰ΩÜÊòØÊúâ‰∏Ä‰∏™ÁâπÊÆäËÆæËÆ°ÁöÑ‰∏ÄÁÇπÔºå<strong>read lockÂíåwrite lock‰ΩøÁî®ÁöÑÊòØÂêå‰∏Ä‰∏™stateÔºåÂç≥read lock‰ΩøÁî®stateÁöÑÈ´ò16‰ΩçÔºåwrite lock‰ΩøÁî®stateÁöÑ‰Ωé16‰Ωç</strong></p>
<blockquote>
<p><strong>readLockËé∑ÂèñÈîÅÁöÑÁä∂ÊÄÅÊòØÔºö state &raquo;&gt;16 Êó†Áä∂ÊÄÅÂè≥ÁßªÂä®16‰Ωç</strong></p>
<p><strong>writeLockËé∑ÂèñÈîÅÁöÑÁä∂ÊÄÅÊòØÔºöstate &amp; (1&laquo;16-1)ÔºåÂ∞ÜÈ´ò‰ΩçË°•0</strong></p>
</blockquote>
<h5 id="t1-wlock-t2-rlock">t1 w.lock t2 r.lock</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Walkthrough:
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 1. If read count nonzero or write count nonzero
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    and owner is a different thread, fail.
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 2. If count would saturate, fail. (This can only
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    happen if count is already nonzero.)
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 3. Otherwise, this thread is eligible for lock if
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    it is either a reentrant acquire or
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    queue policy allows it. If so, update state
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    and set owner.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>  <span class="c1">//Ëé∑ÂèñÂΩìÂâçÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">exclusiveCount</span><span class="o">(</span><span class="n">c</span><span class="o">);</span> <span class="c1">//‰∏é‰Ωé15‰Ωç1 Âç≥c&amp;(1&lt;&lt;16)-1ÔºåÂà§Êñ≠ÊòØÂê¶‰∏∫ÂÜôÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span><span class="c1">//Áä∂ÊÄÅ‰∏ç‰∏∫0ÔºåÂç≥Â∑≤ÁªèË¢´Âä†ÈîÅÔºåËøõÂÖ•Âà§Êñ≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">==</span> <span class="n">0</span> <span class="o">||</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">            1Ôºåw==0 ‰ª£Ë°®Âä†ÁöÑÊòØËØªÈîÅÔºåËØªÂÜô‰∫íÊñ•ÔºåËøîÂõûfalse
</span></span></span><span class="line"><span class="cl"><span class="cm">            2Ôºåw!=0 ‰ª£Ë°®Âä†ÁöÑÊòØÂÜôÈîÅÔºåÂà§Êñ≠ÊåÅÊúâÈîÅÁöÑÁ∫øÁ®ãÊòØÂê¶‰∏∫Êú¨Á∫øÁ®ãÔºåËã•‰∏∫Êú¨Á∫øÁ®ãÔºåÂàôÈîÅÂèØÈáçÂÖ•Âä†ÈîÅÊàêÂäü
</span></span></span><span class="line"><span class="cl"><span class="cm">            **/</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">+</span> <span class="n">exclusiveCount</span><span class="o">(</span><span class="n">acquires</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">MAX_COUNT</span><span class="o">)</span><span class="c1">// ÂèØÈáçÂÖ•ÈîÅÊòØÂê¶ËææÂà∞‰∏äÈôêÂà∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="o">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Reentrant acquire
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">setState</span><span class="o">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//c==0ÁöÑËØù‰ª£Ë°®Ê≤°Êúâ‰∫∫Âä†ÈîÅÔºåÊ≠§Êó∂Áî±‰∫éÈùûÂÖ¨Âπ≥ÈîÅÔºåwriterShouldBlock()ÂßãÁªàËøîÂõûfalseÔºåÂà§Êñ≠ÊòØÂê¶ËÉΩÊ≠£Â∏∏CASÔºåÂ¶ÇÊûúÂèØ‰ª•ËØ¥ÊòéÊ≤°ÊúâÁ´û‰∫âÔºåÂç†Áî®ÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*state=0ÊâçËÉΩËµ∞Âà∞Ê≠§Â§ÑÔºåwriterShouldBlock()ÊòØÁî®Êù•Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÊéíÈòü
</span></span></span><span class="line"><span class="cl"><span class="cm">            ÈùûÂÖ¨Âπ≥ÈîÅÔºö
</span></span></span><span class="line"><span class="cl"><span class="cm">                Áõ¥Êé•ËøîÂõûfalseÔºåÁÑ∂Âêé‰ΩøÁî®CASÊù•‰øÆÊîπstateÔºåÂ¶ÇÊûú‰øÆÊîπÊàêÂäüÂàôËØ¥ÊòéÊãøÂà∞ÈîÅ‰∫Ü
</span></span></span><span class="line"><span class="cl"><span class="cm">                ÈÇ£‰πàÂèØ‰ª•ÁªßÁª≠Â∞ÜÁã¨Âç†ÈîÅÁöÑÊåÅÊúâÁ∫øÁ®ãËÆæÁΩÆ‰∏∫ÂΩìÂâçÁ∫øÁ®ã„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">            ÂÖ¨Âπ≥ÈîÅÔºö
</span></span></span><span class="line"><span class="cl"><span class="cm">                ÂÖ¨Âπ≥ÈîÅ‰ºöË∞ÉÁî®hasQueuedPredecessors()ÔºåËøô‰∏™ÊñπÊ≥ïÊòØÂà§Êñ≠ÂÖ•Âè£Á≠âÂæÖÈòüÂàó
</span></span></span><span class="line"><span class="cl"><span class="cm">                ‰∏≠ÊòØÂê¶ÊúâÁ∫øÁ®ãÂú®Á≠âÂæÖÈîÅ„ÄÇÂ¶ÇÊûúÊ≤°ÊúâÁ∫øÁ®ãÁ≠âÂæÖÊàñËÄÖÁ≠âÂæÖÈòüÂàó‰∏≠ÊéíÂú®ÊúÄÂâçËæπÁöÑÊòØÂΩìÂâç
</span></span></span><span class="line"><span class="cl"><span class="cm">                Á∫øÁ®ãÔºåÈÇ£‰πàÂèØ‰ª•ÁªßÁª≠ËøõË°åÂêéËæπÁöÑCASÊìç‰ΩúÔºåÂê¶ÂàôËøîÂõûfalse„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">writerShouldBlock</span><span class="o">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>1Ôºâ t1Áî≥ËØ∑WÈîÅÔºåÊ≠§Êó∂state‰∏∫0ÊâÄ‰ª•Ëá™ÁÑ∂ËÄåÁÑ∂ÂèØ‰ª•Áî≥ËØ∑Âà∞WÈîÅ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629152144091.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<blockquote>
<p>tryAcquireShared ËøîÂõûÂÄº</p>
<p>val=-1 ‰ª£Ë°®Ëé∑ÂèñÈîÅÂ§±Ë¥•</p>
<p>val=1‰ª£Ë°®Ëé∑ÂèñÈîÅÊàêÂäü</p>
<p>val&gt;1 ‰ª£Ë°®Ëé∑ÂèñÈîÅÊàêÂäüÂπ∂Âî§ÈÜívalÊï∞ÈáèÁöÑÁ∫øÁ®ã</p>
</blockquote>
<p>Ê≥®Ôºö</p>
<blockquote>
<p>ÂÖ±‰∫´ÈîÅ‰ºö‰∏∫ÊØè‰∏™Ëé∑ÂèñReadLockÁöÑÁ∫øÁ®ãÂàõÂª∫‰∏Ä‰∏™HoldCounterÊù•ËÆ∞ÂΩïËØ•Á∫øÁ®ãÁöÑÁ∫øÁ®ãIDÂíåËé∑ÂèñReadLockÁöÑÊ¨°Êï∞(ÂåÖÊã¨ÈáçÂÖ•)„ÄÇÂπ∂Â∞ÜËøô‰∏™HoldCounterÂØπË±°‰øùÂ≠òÂú®Á∫øÁ®ãËá™Â∑±ÁöÑThreadLocal‰∏≠„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ThreadLocalHoldCounter</span> <span class="n">readHolds</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">HoldCounter</span> <span class="n">cachedHoldCounter</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">tryAcquireShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">exclusiveCount</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">getExclusiveOwnerThread</span><span class="o">()</span> <span class="o">!=</span> <span class="n">current</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Âà§Êñ≠ÊòØÂê¶‰∏∫ÂÜôÈîÅÔºå‰∏îÊòØÂê¶ÂèØ‰ª•ËøõË°åÈîÅÈôçÁ∫ß
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sharedCount</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">readerShouldBlock</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">&lt;</span> <span class="n">MAX_COUNT</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">compareAndSetState</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">c</span> <span class="o">+</span> <span class="n">SHARED_UNIT</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/**ËÆæËÆ°ËÄÖËÄÉËôëÂà∞Âè™Êúâ‰∏Ä‰∏™Á∫øÁ®ã‰ΩøÁî®ËØªÈîÅÈáçÂÖ•ÁöÑÊÉÖÂÜµÔºåËøô‰∏™Êó∂ÂÄô‰∏ç‰ΩøÁî®ThreadLocalÈáåÈù¢ÁöÑHoldCounterËøôÊ†∑‰ºöÊ∂àËÄóÊÄßËÉΩÔºå‰æø‰ΩøÁî®reentrantLock‰∏≠ÁöÑfirstReaderHoldCountÊù•ËÆ∞ÂΩï**/</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstReader</span> <span class="o">=</span> <span class="n">current</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstReaderHoldCount</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">firstReader</span> <span class="o">==</span> <span class="n">current</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstReaderHoldCount</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Â§ö‰∏™Á∫øÁ®ãÊù•Áî≥ËØ∑ËØªÈîÅ‰ºöÂà∞Ëøô‰∏ÄÊ≠•Ôºå‰ªécacheHoldCounter‰∏≠Êãø
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">HoldCounter</span> <span class="n">rh</span> <span class="o">=</span> <span class="n">cachedHoldCounter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">              1,Â¶ÇÊûúrh.tid == getThreadId(current) ËØ¥ÊòéÊãøËøá‰∏§Ê¨°
</span></span></span><span class="line"><span class="cl"><span class="cm">              2,Â¶ÇÊûúrh.tid != getThreadId(current) ËØ¥ÊòéÁºìÂ≠òÂ§±ÊïàÔºåÈáçÊñ∞‰ªéThreadLocalÈáåÈù¢ÂèñÂá∫HoldCounterÔºåÂπ∂‰∏î‰øÆÊîπÁºìÂ≠ò
</span></span></span><span class="line"><span class="cl"><span class="cm">              **/</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">rh</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">rh</span><span class="o">.</span><span class="na">tid</span> <span class="o">!=</span> <span class="n">getThreadId</span><span class="o">(</span><span class="n">current</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">cachedHoldCounter</span> <span class="o">=</span> <span class="n">rh</span> <span class="o">=</span> <span class="n">readHolds</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">rh</span><span class="o">.</span><span class="na">count</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">readHolds</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">rh</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">rh</span><span class="o">.</span><span class="na">count</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">fullTryAcquireShared</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3ÔºâÊ≠§Êó∂t2Áî≥ËØ∑RÈîÅÔºåÊ≠§Êó∂state‰Ωé‰Ωç16‰∏ç‰∏∫0Ôºå‰ª£Ë°®Â∑≤ÁªèÊúâÂÜôÈîÅÔºå‰∏î‰∏ç‰∏∫Ëá™Â∑±Âä†ÁöÑÂÜôÈîÅÔºåÊ≠§Êó∂ËøîÂõû-1ËøõÂÖ•ÈòªÂ°ûÈòüÂàó</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629162813304.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doAcquireShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">addWaiter</span><span class="o">(</span><span class="n">Node</span><span class="o">.</span><span class="na">SHARED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">failed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">tryAcquireShared</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">setHeadAndPropagate</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">r</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">interrupted</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">selfInterrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">failed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">parkAndCheckInterrupt</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">failed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>4ÔºâÊ∑ªÂä†‰∏§‰∏™SHAREDËäÇÁÇπÔºå‰∏îÂÜçÊ¨°ËøõË°åtryAcquireÔºåÂ¶ÇÊûúÂ§±Ë¥•ÔºåÂàôÈòªÂ°û</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629163024140.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="t3-rlock-t4-wlock">t3 r.lock t4 w.lock</h5>
<p>5ÔºâËøôÁßçÁä∂ÊÄÅ‰∏ãÔºåÂÅáËÆæÂèàÊúât3Âä†ËØªÈîÅÂíåt4Âä†ÂÜôÈîÅÔºåÊ≠§Êó∂t1‰ªçÁÑ∂ÊåÅÊúâÈîÅÔºåÂ∞±‰ºöËøõÂÖ•Â¶Ç‰∏ãÁä∂ÊÄÅ</p>
<blockquote>
<p>Ê≥®Ôºö</p>
<p>ÂÜôÈîÅÂä†ÁöÑÊòØEX NodeËäÇÁÇπ</p>
<p>ËØªÈîÅÂä†ÁöÑÊòØ Shared NodeËäÇÁÇπ</p>
</blockquote>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629165342912.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="t1-wunlock">t1 w.unlock</h5>
<p>6ÔºâÊ≠§Êó∂t1‰ºöÈáäÊîæÈîÅÔºåÂ¶ÇÊûúÈáäÊîæÊàêÂäüÔºåÂàô‰ºöÂî§ÈÜíÂêéÁª≠Á∫øÁ®ã(ÂíåreentrantLockÂéüÁêÜ‰∏ÄËá¥s)</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629165743754.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>7ÔºâÊ≠§Êó∂t2Ë¢´t1Âî§ÈÜíÂêéÊä¢Âç†Âà∞ÈîÅ(Êó†Á´û‰∫âÁöÑÊÉÖÂÜµ‰∏ã)ÔºåÊ≠§Êó∂Â∞ÜËá™Â∑±ÁöÑËäÇÁÇπËÆæÁΩÆ‰∏∫Â§¥ËäÇÁÇπÔºåÊ≠§Êó∂Âπ∂Ê≤°ÊúâÁªìÊùüÔºå<strong>‰ªñ‰ºöË∞ÉÁî®</strong></p>
<p><strong>setHeadAndPropagate(node, r)ÊñπÊ≥ïÔºåÊù•Âî§ÈÜíÂêéÁª≠ÊâÄÊúâ‰∏∫sharedÁªìÁÇπÁöÑÁ∫øÁ®ã</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">setHeadAndPropagate</span><span class="o">(</span><span class="n">Node</span> <span class="n">node</span><span class="o">,</span> <span class="kt">int</span> <span class="n">propagate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span> <span class="c1">// Record old head for check below
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">propagate</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">||</span> <span class="n">h</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">h</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">h</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span> <span class="n">s</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">s</span><span class="o">.</span><span class="na">isShared</span><span class="o">())</span><span class="c1">//Âî§ÈÜíÂêéÁª≠‰∏∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">doReleaseShared</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172132623.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doReleaseShared</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Node</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">h</span> <span class="o">!=</span> <span class="n">tail</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="na">waitStatus</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">==</span> <span class="n">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(!</span><span class="n">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">,</span> <span class="n">0</span><span class="o">))</span> <span class="c1">//Ê≠§Êó∂Â∞ÜËäÇÁÇπÁöÑÁä∂ÊÄÅËÆæÁΩÆ‰∏∫0ÔºàÁõÆÁöÑÊòØ‰∏∫‰∫ÜÈò≤Ê≠¢ÊúâÂÖ∂‰ªñÁ∫øÁ®ãÂπ≤Êâ∞ÔºåÂ¶ÇÊûúÊúâÁ∫øÁ®ãËøõÊù•ÂèëÁé∞ÊòØ-1‰ºöÂÜçÂî§ÈÜí‰∏ÄÊ¨°) ‰∏çÊòØÂæàÊáÇ???
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">continue</span><span class="o">;</span>            <span class="c1">// loop to recheck cases
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">unparkSuccessor</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">==</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                         <span class="o">!</span><span class="n">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">h</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">Node</span><span class="o">.</span><span class="na">PROPAGATE</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="o">;</span>                <span class="c1">// loop on failed CAS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="n">head</span><span class="o">)</span>                   <span class="c1">// loop if head changed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>8Ôºâ<strong>Ê≠§Êó∂t2ÁöÑËäÇÁÇπÁä∂ÊÄÅË¢´ËÆæÁΩÆ‰∏∫0Ôºå‰∏ît3Ë¢´t2Âî§ÈÜíÔºåt3ÈáçÂ§çt2ÁöÑËøáÁ®ãËé∑ÂèñÈîÅÂπ∂‰∏îÂî§ÈÜíÂêéÁªßsharedËäÇÁÇπ</strong></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172159274.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>9ÔºâÂêéÁªßËäÇÁÇπ‰∏∫Ex ÊâÄ‰ª•Âî§ÈÜíÁªìÊùüÔºåt2Ôºåt3Âç†ÊúâÈîÅÔºå‰∏îÁä∂ÊÄÅ‰∏∫2_0</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172523758.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="t2-runlock-t3-runlock">t2 r.unlock() t3 r.unlock()</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryReleaseShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ÈáçÂÖ•ËØªÈîÅËß£ÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">firstReader</span> <span class="o">==</span> <span class="n">current</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// assert firstReaderHoldCount &gt; 0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">firstReaderHoldCount</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstReader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="n">firstReaderHoldCount</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">HoldCounter</span> <span class="n">rh</span> <span class="o">=</span> <span class="n">cachedHoldCounter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">rh</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">rh</span><span class="o">.</span><span class="na">tid</span> <span class="o">!=</span> <span class="n">getThreadId</span><span class="o">(</span><span class="n">current</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">rh</span> <span class="o">=</span> <span class="n">readHolds</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">rh</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">readHolds</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="n">unmatchedUnlockException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">--</span><span class="n">rh</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Ëß£ÈîÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">SHARED_UNIT</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">nextc</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//ÂèØÈáçÂÖ•ÈîÅÂÖ®ÈÉ®Ëß£ÈîÅÂàôËøîÂõûtrue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="n">nextc</span> <span class="o">==</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>10ÔºâÊ≠§Êó∂t3Ëß£ÈîÅÔºàÊ≠£Â∏∏ÊµÅÁ®ãËß£ÈîÅÔºâÔºåstateÂáè‰∏∫1Ôºåread lockÂπ∂Ê≤°ÊúâË¢´ÂÖ®ÈÉ®Ëß£ÈîÅÔºå‰∏çÂî§ÈÜíÂêéÁª≠Á∫øÁ®ã</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172219244.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>11ÔºâÊ≠§Êó∂t2Ëß£ÈîÅÔºåstateÂáè‰∏∫0Ôºåread lockË¢´ÂÖ®ÈÉ®Ëß£ÈîÅÔºåÂî§ÈÜíÂêéÁª≠Á∫øÁ®ã</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172601718.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>12Ôºât4ËäÇÁÇπË¢´Âî§ÈÜíÊàêÂäüÔºåËé∑ÂèñËØªÈîÅ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629172813609.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h4 id="ÊµÅÁ®ãÂõæ-1">ÊµÅÁ®ãÂõæ</h4>
<h5 id="ËØªÈîÅ">ËØªÈîÅ</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629175402029.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h5 id="ÂÜôÈîÅ">ÂÜôÈîÅ</h5>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629175424219.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h3 id="145-stampedlock">14.5 StampedLock</h3>
<p>Áî±‰∫éReentrantReadWriteLockÁöÑÈúÄË¶ÅÂä†ÈîÅÊù•ÂÆûÁé∞ËØªËØªÂπ∂ÂèëÔºåËØªÂÜôÂπ∂ÂèëÔºåÊÄßËÉΩËÇØÂÆö‰∏çÂ¶Ç‰∏çÂä†ÈîÅÁöÑÂπ∂ÂèëÁä∂ÊÄÅÔºåÊ≠§Êó∂StampedLockÂèØ‰ª•ÂÆåÁæéËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºå‰ªñÊã•ÊúâÊõ¥È´òÁöÑÊÄßËÉΩÔºåÊØè‰∏ÄÊ¨°‰ΩøÁî®ËØªÈîÅÂíåÂÜôÈîÅÈÉΩÂøÖÈ°ªË¶ÅÈÖçÂêà‰∏Ä‰∏™„ÄêÊà≥„Äë</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220629180846760.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220630101437965.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h4 id="stampedlockÊÄßËÉΩÊØîreadwritelockÂ•ΩÁöÑÂéüÂõ†">StampedLockÊÄßËÉΩÊØîReadWriteLockÂ•ΩÁöÑÂéüÂõ†</h4>
<ul>
<li><strong>ReadWriteLockÔºåÊúâÂ§ßÈáèËØªÊìç‰ΩúÊó∂Ôºå‰ºöÂØºËá¥ÂÜôÊìç‰ΩúÈ••È•øÔºå‰∏ÄÁõ¥Ëé∑Âèñ‰∏çÂà∞ÈîÅÔºåËÄåStampedLockÈááÁî®‰πêËßÇËØªÁöÑÊñπÂºèÔºåÂç≥‰ΩøÂú®Â§ßÈáèËØªÊìç‰Ωú‰∏ã‰πüÊòØÂèØ‰ª•Ëé∑ÂèñÂÜôÈîÅÁöÑ</strong></li>
<li><strong>ReadWriteLockÁöÑËØªÊìç‰ΩúÔºåÊØè‰∏ÄÊ¨°ÈÉΩÈúÄË¶ÅCASÊõ¥ÊîπstateÔºå‰ΩÜÊòØStampedLock‰πêËßÇËØªÁöÑÊñπÂºèÊó†ÈúÄ‰ΩøÁî®CASÔºåÂèØ‰ª•Ëé∑ÂæóÊõ¥È´òÁöÑÊÄßËÉΩ</strong></li>
</ul>
<h4 id="ÂéüÁêÜ-3">ÂéüÁêÜ</h4>
<h5 id="stampedlockÁöÑÁä∂ÊÄÅ">StampedLockÁöÑÁä∂ÊÄÅ</h5>
<blockquote>
<p>StampedLockÂíåReadWriteLockÁöÑÁä∂ÊÄÅÂΩ¢ÂºèÂ∑Æ‰∏çÂ§öÔºå‰πüÊòØÈááÁî®<strong>ÂêåÊ≠•Áä∂ÊÄÅÊåâ‰ΩçÂàáÂàÜ</strong></p>
<p><strong>64‰Ωçstate Áä∂ÊÄÅÂàáÂàÜ</strong></p>
<p>0~7‰ΩçÔºöËØªÈîÅËé∑ÂèñÊï∞ÈáèÂç≥Áä∂ÊÄÅ ÔºàÂèØÂ≠òÊîæ128‰∏™ËØªÈîÅÔºåË∂ÖËøá‰∏äÈôêÁî®readOverFlowÊù•Â≠òÂÇ®)</p>
<p>8‰ΩçÔºöÂÜôÈîÅÁöÑÁä∂ÊÄÅ</p>
<p>8~64‰ΩçÔºöÂÜôÈîÅÁöÑÊï∞Èáè</p>
<p><strong>ÂÜôÈîÅ‰ΩøÁî®Áä∂ÊÄÅ</strong></p>
<blockquote>
<p>Ê≠§Â§ÑËÄÉËôëÂà∞‰∫ÜABAÈóÆÈ¢ò</p>
<ol>
<li>Ê£ÄÊü•ÊòØÂê¶ÊúâÂÜôÈîÅÔºåstate Á¨¨ 8 ‰Ωç‰∏∫ 0ÔºåÊ≤°ÊúâÂÜôÈîÅÔºåÊã∑Ë¥ùÊï∞ÊçÆÔºõ</li>
<li>Ê£ÄÊü•ÊòØÂê¶ÊúâÁ∫øÁ®ãËé∑ÂèñËøáÂÜôÈîÅÔºåstate Á¨¨ 8 ‰Ωç‰∏∫ 0ÔºåÊ≤°ÊúâÁ∫øÁ®ãËé∑ÂèñËøáÔºåÁõ¥Êé•‰ΩøÁî®ÂéüÊù•Êã∑Ë¥ùÁöÑÊï∞ÊçÆ„ÄÇ</li>
</ol>
<p>Á¨¨‰∏ÄÊ¨°Ê£ÄÊü• state Á¨¨ 8 ‰Ωç‰∏∫ 0 ‰πãÂêéÔºåÊúâÁ∫øÁ®ãËé∑ÂèñÂÜôÈîÅ‰øÆÊîπÊï∞ÊçÆÂπ∂ÈáäÊîæ‰∫ÜÂÜôÈîÅÔºåÈÇ£‰πà‰πãÂêéÂú®Ê£ÄÊü•ÊòØÂê¶ÊúâÁ∫øÁ®ãËé∑ÂèñËøáÂÜôÈîÅÊó∂ state Á¨¨ 8 ‰ΩçËøòÊòØ 0ÔºåËÆ§‰∏∫Ê≤°ÊúâÁ∫øÁ®ãËé∑ÂèñËøáÂÜôÈîÅÔºåÂèØËÉΩÂØºËá¥Êï∞ÊçÆ‰∏ç‰∏ÄËá¥„ÄÇ</p>
</blockquote>
<p>Âõ†Ê≠§ÂÜôÈîÅÁöÑÁä∂ÊÄÅÂçÅÂàÜÂ∑ßÂ¶ôÔºåÂΩìËé∑ÂèñÂÜôÈîÅÊó∂ÔºåÂ∞ÜstateÁöÑÁ¨¨8‰ΩçËÆæÁΩÆ‰∏∫1ÔºåÈáäÊîæÂÜôÈîÅÊó∂Âú®stateÁ¨¨8‰Ωç+1ÔºåÊ≠§Êó∂Âç≥ÂêåÊ≠•‰∫ÜÂÜôÈîÅÊï∞ÈáèÔºåÂèàÊîπÂèò‰∫ÜÂÜôÈîÅÁä∂ÊÄÅ</p>
</blockquote>
<h4 id="ÈîÅÁä∂ÊÄÅÁõ∏ÂÖ≥Â±ûÊÄß">ÈîÅÁä∂ÊÄÅÁõ∏ÂÖ≥Â±ûÊÄß</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// ‰∏Ä‰∏™Âçï‰ΩçÁöÑËØªÈîÅ        0000... 0000 0000 0001
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">RUNIT</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>   
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// ‰∏Ä‰∏™Âçï‰ΩçÁöÑÂÜôÈîÅ        0000... 0000 1000 0000                
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">WBIT</span> <span class="o">=</span> <span class="n">1L</span> <span class="o">&lt;&lt;</span> <span class="n">LG_READERS</span><span class="o">;</span>   
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// ËØªÁä∂ÊÄÅÊ†áËØÜ            0000... 0000 0111 1111  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">RBITS</span> <span class="o">=</span> <span class="n">WBIT</span> <span class="o">-</span> <span class="n">1L</span><span class="o">;</span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// ËØªÈîÅÊúÄÂ§ßÊï∞Èáè          0000... 0000 0111 1110           
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">RFULL</span> <span class="o">=</span> <span class="n">RBITS</span> <span class="o">-</span> <span class="n">1L</span><span class="o">;</span>    
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// Áî®‰∫éËé∑ÂèñËØªÂÜôÁä∂ÊÄÅ      0000... 0000 1111 1111       
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">ABITS</span> <span class="o">=</span> <span class="n">RBITS</span> <span class="o">|</span> <span class="n">WBIT</span><span class="o">;</span>  
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">//                       1111... 1111 1000 0000       
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">SBITS</span> <span class="o">=</span> <span class="o">~</span><span class="n">RBITS</span><span class="o">;</span>               
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// ÈîÅstateÂàùÂßãÂÄºÔºå0000... 0001 0000 0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">ORIGIN</span> <span class="o">=</span> <span class="n">WBIT</span> <span class="o">&lt;&lt;</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cm">/** ÈîÅÈòüÂàóÁä∂ÊÄÅÔºå ÂΩìÂ§Ñ‰∫éÂÜôÊ®°ÂºèÊó∂Á¨¨8‰Ωç‰∏∫1ÔºåËØªÊ®°ÂºèÊó∂Ââç7‰∏∫‰∏∫1-126
</span></span></span><span class="line"><span class="cl"><span class="cm">ÔºàÈôÑÂä†ÁöÑreaderOverflowÁî®‰∫éÂΩìËØªËÄÖË∂ÖËøá126Êó∂Ôºâ */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">state</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cm">/** Â∞ÜstateË∂ÖËøá RFULL=126ÁöÑÂÄºÊîæÂà∞readerOverflowÂ≠óÊÆµ‰∏≠ */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">transient</span> <span class="kt">int</span> <span class="n">readerOverflow</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ËäÇÁÇπ">ËäÇÁÇπ</h4>
<p>StampedLockdÁöÑÁ≠âÂæÖÈòüÂàóÂíåAQSÂ∑Æ‰∏çÂ§öÔºåÂè™ÊòØÂ§ö‰∫Ü‰∏Ä‰∏™Ê†àÊù•‰øùÂ≠òËØªÁ∫øÁ®ã</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// ÁªìÁÇπÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WAITING</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">CANCELLED</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// ÁªìÁÇπÁöÑËØªÂÜôÊ®°Âºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">RMODE</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WMODE</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cm">/** Wait nodes */</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WNode</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">prev</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">cowait</span><span class="o">;</span> <span class="c1">// ËØªÊ®°Âºè‰ΩøÁî®ËØ•ÁªìÁÇπÂΩ¢ÊàêÊ†à
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">volatile</span> <span class="n">Thread</span> <span class="n">thread</span><span class="o">;</span> <span class="c1">// non-null while possibly parked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">status</span><span class="o">;</span> <span class="c1">// 0, WAITING, or CANCELLED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">mode</span><span class="o">;</span> <span class="c1">// RMODE or WMODE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 
</span></span><span class="line"><span class="cl">    <span class="n">WNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">m</span><span class="o">,</span> <span class="n">WNode</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">mode</span> <span class="o">=</span> <span class="n">m</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="cm">/** CLHÈòüÂ§¥ÁªìÁÇπ */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">whead</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/** CLHÈòüÂ∞æÁªìÁÇπ */</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">WNode</span> <span class="n">wtail</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="Ëá™ÊóãÊ¨°Êï∞‰ºòÂåñ">Ëá™ÊóãÊ¨°Êï∞‰ºòÂåñ</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220630103039693.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h4 id="Ê≥®ÊÑè">Ê≥®ÊÑè</h4>
<ol>
<li>ÈúÄË¶ÅÁâπÂà´Ê≥®ÊÑèÔºåÈÇ£Â∞±ÊòØÔºöÂ¶ÇÊûúÁ∫øÁ®ãÈòªÂ°ûÂú® StampedLock ÁöÑ readLock() ÊàñËÄÖ writeLock() ‰∏äÊó∂ÔºåÊ≠§Êó∂Ë∞ÉÁî®ËØ•ÈòªÂ°ûÁ∫øÁ®ãÁöÑ interrupt() ÊñπÊ≥ïÔºå‰ºöÂØºËá¥ CPU È£ôÂçá„ÄÇ‰æãÂ¶Ç‰∏ãÈù¢ÁöÑ‰ª£Á†Å‰∏≠ÔºåÁ∫øÁ®ã T1 Ëé∑ÂèñÂÜôÈîÅ‰πãÂêéÂ∞ÜËá™Â∑±ÈòªÂ°ûÔºåÁ∫øÁ®ã T2 Â∞ùËØïËé∑ÂèñÊÇ≤ËßÇËØªÈîÅÔºå‰πü‰ºöÈòªÂ°ûÔºõÂ¶ÇÊûúÊ≠§Êó∂Ë∞ÉÁî®Á∫øÁ®ã T2 ÁöÑ interrupt() ÊñπÊ≥ïÊù•‰∏≠Êñ≠Á∫øÁ®ã T2 ÁöÑËØùÔºå‰Ω†‰ºöÂèëÁé∞Á∫øÁ®ã T2 ÊâÄÂú® CPU ‰ºöÈ£ôÂçáÂà∞ 100%„ÄÇ</li>
<li>StampedLock ÊîØÊåÅÈîÅÁöÑÈôçÁ∫ßÔºàÈÄöËøá tryConvertToReadLock() ÊñπÊ≥ïÂÆûÁé∞ÔºâÂíåÂçáÁ∫ßÔºàÈÄöËøá tryConvertToWriteLock() ÊñπÊ≥ïÂÆûÁé∞ÔºâÔºå‰ΩÜÊòØÂª∫ËÆÆ‰Ω†Ë¶ÅÊÖéÈáç‰ΩøÁî®„ÄÇ‰∏ãÈù¢ÁöÑ‰ª£Á†Å‰πüÊ∫êËá™ Java ÁöÑÂÆòÊñπÁ§∫‰æãÔºåÈöêËóè‰∫Ü‰∏Ä‰∏™ BugÔºåÂ∞±ÊòØÂú®ÈîÅÂçáÁ∫ßÊàêÂäüÁöÑÊó∂ÂÄôÔºåÊúÄÂêéÊ≤°ÊúâÈáäÊîæÊúÄÊñ∞ÁöÑÂÜôÈîÅÔºåÂèØ‰ª•Âú®ifÂùóÁöÑbreak‰∏äÂä†‰∏™stamp=wsËøõË°åÈáäÊîæ„ÄÇ</li>
</ol>
<h3 id="146-semaphore">14.6 Semaphore</h3>
<p>‰ø°Âè∑ÈáèÔºåÁî®Êù•ÈôêÂà∂ËÉΩÂêåÊó∂ËÆøÈóÆÂÖ±‰∫´ËµÑÊ∫êÁöÑÁ∫øÁ®ã‰∏äÈôê</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Semaphore</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Semaphore</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">10</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">           <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">semaphore</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">               <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Thread {}&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">               <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">           <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">},</span><span class="s">&#34;t&#34;</span><span class="o">+</span><span class="n">i</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="semaphoreÂ∫îÁî®">SemaphoreÂ∫îÁî®</h4>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220630141110941.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p><em><strong>Âú®ÈôêÊµÅÊñπÈù¢Âπ∂‰∏çÂíãÊ†∑ÔºåÊúÄÂ•ΩËøòÊòØÈááÁî®ÂàÜÂ∏ÉÂºèÈîÅ</strong></em>g</p>
<h5 id="Êõ¥ÊîπÊï∞ÊçÆÂ∫ìËøûÊé•Ê±†">Êõ¥ÊîπÊï∞ÊçÆÂ∫ìËøûÊé•Ê±†</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Connection</span> <span class="nf">getConn2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">semaphore</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="k">this</span><span class="o">.</span><span class="na">poolSize</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="n">0</span><span class="o">,</span><span class="n">1</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">connection</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;get {}&#34;</span><span class="o">,</span><span class="n">conn</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">conn</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">free2</span><span class="o">(</span><span class="n">Connection</span> <span class="n">conn</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">poolSize</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">conn</span> <span class="o">==</span> <span class="n">connection</span><span class="o">[</span><span class="n">i</span><span class="o">]){</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} free&#34;</span><span class="o">,</span><span class="n">conn</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÂéüÁêÜ-4">ÂéüÁêÜ</h4>
<p>SemaphoreÂ∞±Á±ª‰ºº‰∫éÂÅúËΩ¶Âú∫ÔºåÂºÄÊîæÂ§öÂ∞ëËµÑÊ∫êÔºåstateÂ∞±ÊúâÂ§öÂ∞ëÔºåÊØèÊúâ‰∏Ä‰∏™Á∫øÁ®ãËé∑ÂèñËµÑÊ∫êÊó∂ÔºåstateÂáè1ÔºåÁõ¥Âà∞&lt;0ÁöÑÊó∂ÂÄôÔºåÁ∫øÁ®ãÂú®Ëé∑ÂèñÂç≥ËøõÂÖ•ÈòªÂ°ûÈòüÂàóÔºåÊÄª‰ΩìÁöÑËß£ÈîÅÂíåÂä†ÈîÅËøáÁ®ãËøòÊòØÂíåReadWriteLock‰∏ÄÊ†∑„ÄÇ</p>
<p>Âä†ÈîÅÔºåCAS stateÔºå‰∏ç‰∏∫0ÊãøÂà∞ÈîÅÔºå‰∏∫0ËøõÂÖ•ÈòªÂ°û„ÄÇ</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220630141908241.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<p>Ëß£ÈîÅÔºåÈáäÊîæËµÑÊ∫êÔºåstateÂä†‰∏ÄÔºåÂπ∂‰∏îÂî§ÈÜíÂêéÁªßÁ∫øÁ®ã</p>
<p><img src="https://mynoteimages.oss-cn-hangzhou.aliyuncs.com/20220630151849964.png"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<h3 id="147-countdownlatch">14.7 CountdownLatch</h3>
<p>Áî®‰∫éÁ≠âÂæÖÂ§ö‰∏™Á∫øÁ®ã‰ªªÂä°ÂÖ±ÂêåÊâßË°åÁªìÊùüÔºåËøõË°åÂêåÊ≠•ÁöÑ‰∏Ä‰∏™ÈîÅÔºåstate=nÔºåÂàô‰ª£Ë°®Êúân‰∏™Á∫øÁ®ãÊ≠£Âú®ÊâßË°åÔºåÁ∫øÁ®ãÊâßË°åÂÆåÊØïË∞ÉÁî®CountDown()ÊñπÊ≥ïÊù•Â∞Üstate-1ÔºåÂΩìstate‰∏∫0Êó∂ÔºåÁ≠âÂæÖÁ∫øÁ®ãÁªìÊùüÁ≠âÂæÖÔºåË¢´Âî§ÈÜí„ÄÇ</p>
<h4 id="‰∏∫‰ªÄ‰πà‰∏çÁî®join">‰∏∫‰ªÄ‰πà‰∏çÁî®Join</h4>
<p>JoinÈúÄË¶ÅÁ≠âÂæÖÁ∫øÁ®ãÁîüÂëΩÂë®ÊúüÁªìÊùüÔºåÊâç‰ºöÂºÄÂßãÊâßË°å‰ªªÂä°ÔºåËÄå‰∏Ä‰∏™Á∫øÁ®ãÂèØËÉΩË¶ÅÂÆåÊàêÂ§öÈ°π‰ªªÂä°ÔºåÂèØËÉΩÈúÄË¶ÅÂêåÊ≠•ÁöÑËøáÁ®ãÂèëÁîüÂú®‰∏≠ÈÄîÔºåÊ≠§Êó∂Â∞±Êó†Ê≥ï‰ΩøÁî®Join</p>
<h4 id="Â∫îÁî®-1">Â∫îÁî®</h4>
<h5 id="Á≠âÂæÖÂ§ö‰∏™Á∫øÁ®ãÂáÜÂ§áÂÆåÊØï">Á≠âÂæÖÂ§ö‰∏™Á∫øÁ®ãÂáÜÂ§áÂÆåÊØï</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ExecutorService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span><span class="o">[]</span> <span class="n">all</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">10</span><span class="o">];</span>
</span></span><span class="line"><span class="cl"><span class="n">CountDownLatch</span> <span class="n">countDownLatch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">10</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span><span class="n">100</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">100</span><span class="o">)+</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">all</span><span class="o">[</span><span class="n">flag</span><span class="o">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="s">&#34;%&#34;</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&#34;\r&#34;</span><span class="o">+</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">all</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">countDownLatch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="n">countDownLatch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;Game Start&#34;</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="Á≠âÂæÖÂ§ö‰∏™ËøúÁ®ãË∞ÉÁî®ÁªìÊùü">Á≠âÂæÖÂ§ö‰∏™ËøúÁ®ãË∞ÉÁî®ÁªìÊùü</h5>
<h3 id="148-cyclicbarrier">14.8 CyclicBarrier</h3>
<p>Âà©Áî®‰∏Ä‰∏™ËÆ°Êï∞Âô®ÔºåÊù•ËÆ∞ÂΩïÈòªÂ°ûÁöÑÁ∫øÁ®ãÊï∞ÔºåÊØèÊúâ‰∏Ä‰∏™ÈòªÂ°ûÁöÑÁ∫øÁ®ãËøõÂÖ•ÔºåÂ∞Ü‰ºöÂáèÂ∞ëcountÔºåÂΩìcountÂáèÂ∞ë‰∏∫0Êó∂ÔºåÂàôÂ∞ÜÂî§ÈÜíÊâÄÊúâÈòªÂ°ûÁ∫øÁ®ãÔºå‰ª•ÂèäË∞ÉÁî®Ëá™Ë∫´ÁöÑRunnableÁ∫øÁ®ã(Â¶ÇÊûúÊúâÁöÑËØù)ÔºåÂÖ±ÂêåÂêë‰∏ãÊâßË°å</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">int</span> <span class="nf">dowait</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">timed</span><span class="o">,</span> <span class="kt">long</span> <span class="n">nanos</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">BrokenBarrierException</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">TimeoutException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lock</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">Generation</span> <span class="n">g</span> <span class="o">=</span> <span class="n">generation</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">g</span><span class="o">.</span><span class="na">broken</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">BrokenBarrierException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">breakBarrier</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">InterruptedException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">--</span><span class="n">count</span><span class="o">;</span><span class="c1">//Ëá™ÂáèÂà§Êñ≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//ÂΩìindex==0;Âî§ÈÜíÊâÄÊúâÁöÑÈòªÂ°ûÁ∫øÁ®ã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span> 
</span></span><span class="line"><span class="cl">            <span class="kt">boolean</span> <span class="n">ranAction</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">command</span> <span class="o">=</span> <span class="n">barrierCommand</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">command</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">command</span><span class="o">.</span><span class="na">run</span><span class="o">();</span><span class="c1">//ÊâßË°åCyclicBarrierÁöÑ‰ªªÂä°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">ranAction</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">nextGeneration</span><span class="o">();</span><span class="c1">//Â∞ÜcountÊÅ¢Â§çÔºåÂπ∂‰∏îÂî§ÈÜíÊâÄÊúâÁ∫øÁ®ã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">ranAction</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">breakBarrier</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Ëá™ÊóãÈòªÂ°û
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(!</span><span class="n">timed</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">trip</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">nanos</span> <span class="o">&gt;</span> <span class="n">0L</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nanos</span> <span class="o">=</span> <span class="n">trip</span><span class="o">.</span><span class="na">awaitNanos</span><span class="o">(</span><span class="n">nanos</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ie</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">g</span> <span class="o">==</span> <span class="n">generation</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">g</span><span class="o">.</span><span class="na">broken</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">breakBarrier</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="n">ie</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">g</span><span class="o">.</span><span class="na">broken</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">BrokenBarrierException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">g</span> <span class="o">!=</span> <span class="n">generation</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">timed</span> <span class="o">&amp;&amp;</span> <span class="n">nanos</span> <span class="o">&lt;=</span> <span class="n">0L</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">breakBarrier</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">TimeoutException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="Â∫îÁî®-2">Â∫îÁî®</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ExecutorService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">CyclicBarrier</span> <span class="n">cyclicBarrier</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CyclicBarrier</span><span class="o">(</span><span class="n">2</span><span class="o">,()-&gt;{</span>
</span></span><span class="line"><span class="cl">    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;GO GO GO&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">3</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} start&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">cyclicBarrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} end&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="o">|</span> <span class="n">BrokenBarrierException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} start&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">cyclicBarrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;{} end&#34;</span><span class="o">,</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="o">|</span> <span class="n">BrokenBarrierException</span> <span class="n">e</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/juc/">JUC</a>
        
            <a href="/tags/java/">Java</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed Genius 1942</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/innodb/">
        
        
            <div class="article-image">
                <img src="/p/innodb/_hu8c1e6e7c956faffb6e0fe62077ace01b_532582_3a6d5485b7dbe4b83eee044c2bee2f17.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post InnoDB"
                        
                        data-hash="md5-Tsd9OVywVPg9MBHescMPmQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">InnoDB</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2022 Genius
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#1-Âπ∂ÂèëÁºñÁ®ã">1 Âπ∂ÂèëÁºñÁ®ã</a>
      <ol>
        <li><a href="#11-Âπ∂ÂèëÁºñÁ®ãÁöÑ‰ºòÁº∫ÁÇπ">1.1 Âπ∂ÂèëÁºñÁ®ãÁöÑ‰ºòÁº∫ÁÇπ</a>
          <ol>
            <li><a href="#‰ºòÁÇπ">‰ºòÁÇπÔºö</a></li>
            <li><a href="#Áº∫ÁÇπ">Áº∫ÁÇπÔºö</a></li>
          </ol>
        </li>
        <li><a href="#12-Âπ∂ÂèëÁºñÁ®ã‰∏âË¶ÅÁ¥†">1.2 Âπ∂ÂèëÁºñÁ®ã‰∏âË¶ÅÁ¥†</a>
          <ol>
            <li><a href="#Âπ∂ÂèëÁºñÁ®ã‰∏âË¶ÅÁ¥†">Âπ∂ÂèëÁºñÁ®ã‰∏âË¶ÅÁ¥†</a></li>
            <li><a href="#Âá∫Áé∞ÂÆâÂÖ®ÈóÆÈ¢òÁöÑÂéüÂõ†">Âá∫Áé∞ÂÆâÂÖ®ÈóÆÈ¢òÁöÑÂéüÂõ†Ôºö</a></li>
            <li><a href="#‰∏ä‰∏ãÊñáÂàáÊç¢">‰∏ä‰∏ãÊñáÂàáÊç¢</a></li>
          </ol>
        </li>
        <li><a href="#13-‰ªÄ‰πàÊòØÂ§öÁ∫øÁ®ã">1.3 ‰ªÄ‰πàÊòØÂ§öÁ∫øÁ®ã</a></li>
      </ol>
    </li>
    <li><a href="#2-ËøõÁ®ã‰∏éÁ∫øÁ®ãÁöÑ‰ªãÁªç">2 ËøõÁ®ã‰∏éÁ∫øÁ®ãÁöÑ‰ªãÁªç</a>
      <ol>
        <li><a href="#21-ËøõÁ®ã‰∏éÁ∫øÁ®ã">2.1 ËøõÁ®ã‰∏éÁ∫øÁ®ã</a>
          <ol>
            <li><a href="#ËøõÁ®ã">ËøõÁ®ã</a></li>
            <li><a href="#Á∫øÁ®ã">Á∫øÁ®ã</a></li>
            <li><a href="#ËøõÁ®ã‰∏éÁ∫øÁ®ãÁöÑÂå∫Âà´">ËøõÁ®ã‰∏éÁ∫øÁ®ãÁöÑÂå∫Âà´</a></li>
            <li><a href="#‰∫åËÄÖÂØπÊØî">‰∫åËÄÖÂØπÊØî</a></li>
          </ol>
        </li>
        <li><a href="#22-Âπ∂Ë°åÂíåÂπ∂Âèë">2.2 Âπ∂Ë°åÂíåÂπ∂Âèë</a>
          <ol>
            <li><a href="#Âπ∂Ë°å">Âπ∂Ë°å</a></li>
            <li><a href="#Âπ∂Âèë">Âπ∂Âèë</a></li>
          </ol>
        </li>
        <li><a href="#23-ÂêåÊ≠•‰∏éÂºÇÊ≠•">2.3 ÂêåÊ≠•‰∏éÂºÇÊ≠•</a>
          <ol>
            <li><a href="#ÂêåÊ≠•">ÂêåÊ≠•</a></li>
            <li><a href="#ÂºÇÊ≠•">ÂºÇÊ≠•</a></li>
          </ol>
        </li>
        <li><a href="#24-ÊÄùËÄÉ">2.4 ÊÄùËÄÉ</a>
          <ol>
            <li><a href="#Â§öÁ∫øÁ®ã‰∏ÄÂÆöËÉΩÊèêÂçáÁ®ãÂ∫èËøêË°åÊïàÁéáÂêó">Â§öÁ∫øÁ®ã‰∏ÄÂÆöËÉΩÊèêÂçáÁ®ãÂ∫èËøêË°åÊïàÁéáÂêóÔºü</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#3-javaÁ∫øÁ®ã">3 JavaÁ∫øÁ®ã</a>
      <ol>
        <li><a href="#31-ÂàõÂª∫ÂíåËøêË°åÁ∫øÁ®ã">3.1 ÂàõÂª∫ÂíåËøêË°åÁ∫øÁ®ã</a>
          <ol>
            <li><a href="#threadÂàõÂª∫">ThreadÂàõÂª∫</a></li>
            <li><a href="#runnableÂàõÂª∫">RunnableÂàõÂª∫</a></li>
            <li><a href="#lambdaÁÆÄÂåñ">LambdaÁÆÄÂåñ</a></li>
            <li><a href="#futuretaskÂàõÂª∫">FutureTaskÂàõÂª∫</a></li>
            <li><a href="#runnableÂíåcallableÁöÑÂå∫Âà´">RunnableÂíåCallableÁöÑÂå∫Âà´</a></li>
          </ol>
        </li>
        <li><a href="#32-threadrunnableÊ∫êÁ†ÅÂéüÁêÜ">3.2 ThreadÔºåRunnableÊ∫êÁ†ÅÂéüÁêÜ</a>
          <ol>
            <li><a href="#new-thread">new Thread()</a></li>
          </ol>
        </li>
        <li><a href="#33-javaËøõÁ®ãÊü•Áúã">3.3 JavaËøõÁ®ãÊü•Áúã</a>
          <ol>
            <li><a href="#windowsËøõÁ®ãÊü•ÁúãÂëΩ‰ª§">WindowsËøõÁ®ãÊü•ÁúãÂëΩ‰ª§</a></li>
            <li><a href="#‰ΩøÁî®jconsoleÊù•ËøõË°åËøõÁ®ãÊü•ÁúãËøõÁ®ã‰ø°ÊÅØ">‰ΩøÁî®JconsoleÊù•ËøõË°åËøõÁ®ãÊü•ÁúãËøõÁ®ã‰ø°ÊÅØ</a></li>
          </ol>
        </li>
        <li><a href="#34-Á∫øÁ®ãËøêË°åÂéüÁêÜ">3.4 Á∫øÁ®ãËøêË°åÂéüÁêÜ</a>
          <ol>
            <li><a href="#Ê†àÂ∏ß‰∏çÂ§öËØ¥‰∫ÜcsdnÊúâÁ¨îËÆ∞">Ê†àÂ∏ß‰∏çÂ§öËØ¥‰∫ÜÔºåCSDNÊúâÁ¨îËÆ∞</a></li>
            <li><a href="#Á∫øÁ®ã‰∏ä‰∏ãÊñáÂàáÊç¢">Á∫øÁ®ã‰∏ä‰∏ãÊñáÂàáÊç¢</a></li>
          </ol>
        </li>
        <li><a href="#35-Á∫øÁ®ãÊñπÊ≥ïËØ¶Ëß£start--run">3.5 Á∫øÁ®ãÊñπÊ≥ïËØ¶Ëß£:start &amp; run</a>
          <ol>
            <li><a href="#runÊñπÊ≥ï">runÊñπÊ≥ï</a></li>
            <li><a href="#startÊñπÊ≥ï">startÊñπÊ≥ï</a></li>
            <li><a href="#start0Â∫ïÂ±ÇÊ∫êÁ†Å"><strong>start0Â∫ïÂ±ÇÊ∫êÁ†Å</strong></a></li>
          </ol>
        </li>
        <li><a href="#36-Á∫øÁ®ãÊñπÊ≥ïËØ¶Ëß£-sleep‰∏éyield">3.6 Á∫øÁ®ãÊñπÊ≥ïËØ¶Ëß£: sleep‰∏éyield</a>
          <ol>
            <li><a href="#sleep-Ê∫êÁ†ÅËß£Êûê">sleep Ê∫êÁ†ÅËß£Êûê</a></li>
            <li><a href="#yield-Ê∫êÁ†ÅËß£Êûê">yield Ê∫êÁ†ÅËß£Êûê</a></li>
            <li><a href="#Âú®java‰∏≠sleepÂíåyieldÁöÑÂå∫Âà´"><strong>Âú®Java‰∏≠SleepÂíåyieldÁöÑÂå∫Âà´</strong></a></li>
            <li><a href="#Á∫øÁ®ã‰ºòÂÖàÁ∫ß">Á∫øÁ®ã‰ºòÂÖàÁ∫ß</a></li>
          </ol>
        </li>
        <li><a href="#37-Ê°à‰æã-Èò≤Ê≠¢cpuÂç†Áî®100">3.7 Ê°à‰æã-Èò≤Ê≠¢CPUÂç†Áî®100%</a></li>
        <li><a href="#38-join">3.8 Join</a>
          <ol>
            <li><a href="#ËÉΩ‰∏çËÉΩÁî®sleep‰∏∫‰ªÄ‰πà">ËÉΩ‰∏çËÉΩÁî®sleepÔºü‰∏∫‰ªÄ‰πàÔºü</a></li>
            <li><a href="#join">Join</a></li>
            <li><a href="#joinÂéüÁêÜ">JoinÂéüÁêÜ</a></li>
          </ol>
        </li>
        <li><a href="#39-interrupt-ÊñπÊ≥ïËØ¶Ëß£">3.9 interrupt ÊñπÊ≥ïËØ¶Ëß£</a>
          <ol>
            <li><a href="#ÊâìÊñ≠sleepwaitjoinÁ∫øÁ®ã">ÊâìÊñ≠sleepÔºåwaitÔºåjoinÁ∫øÁ®ã</a></li>
          </ol>
        </li>
        <li><a href="#310-‰∏§Èò∂ÊÆµÁªàÊ≠¢Ê®°Âºè">3.10 ‰∏§Èò∂ÊÆµÁªàÊ≠¢Ê®°Âºè</a>
          <ol>
            <li><a href="#ÈîôËØØÊÄùË∑Ø">ÈîôËØØÊÄùË∑Ø</a></li>
            <li><a href="#Ê≠£Á°ÆÊÄùË∑Ø">Ê≠£Á°ÆÊÄùË∑Ø</a></li>
          </ol>
        </li>
        <li><a href="#311-parkunpark">3.11 Park&amp;UnPark</a>
          <ol>
            <li><a href="#ÁâπÁÇπ">ÁâπÁÇπ</a></li>
            <li><a href="#ÂéüÁêÜ">ÂéüÁêÜ</a></li>
            <li><a href="#ÊµÅÁ®ãÂõæ">ÊµÅÁ®ãÂõæ</a></li>
          </ol>
        </li>
        <li><a href="#312-ÂÆàÊä§Á∫øÁ®ã">3.12 ÂÆàÊä§Á∫øÁ®ã</a>
          <ol>
            <li></li>
            <li><a href="#ÂÆàÊä§Á∫øÁ®ãÂíåÁî®Êà∑Á∫øÁ®ãÊúâ‰ªÄ‰πàÂå∫Âà´Âë¢">ÂÆàÊä§Á∫øÁ®ãÂíåÁî®Êà∑Á∫øÁ®ãÊúâ‰ªÄ‰πàÂå∫Âà´Âë¢Ôºü</a></li>
          </ol>
        </li>
        <li><a href="#313-Á∫øÁ®ãÁä∂ÊÄÅ">3.13 Á∫øÁ®ãÁä∂ÊÄÅ</a>
          <ol>
            <li><a href="#‰∫îÁßçÁä∂ÊÄÅ">‰∫îÁßçÁä∂ÊÄÅ</a></li>
            <li><a href="#ÂÖ≠ÁßçÁä∂ÊÄÅ">ÂÖ≠ÁßçÁä∂ÊÄÅ</a></li>
            <li><a href="#javaÈááÁî®ÁöÑÁ∫øÁ®ãË∞ÉÂ∫¶ÁÆóÊ≥ï">JavaÈááÁî®ÁöÑÁ∫øÁ®ãË∞ÉÂ∫¶ÁÆóÊ≥ï</a></li>
            <li><a href="#‰ªÄ‰πàÊòØÁ∫øÁ®ãË∞ÉÂ∫¶Âô®thread-schedulerÂíåÊó∂Èó¥ÂàÜÁâátime-slicing-">‰ªÄ‰πàÊòØÁ∫øÁ®ãË∞ÉÂ∫¶Âô®(Thread Scheduler)ÂíåÊó∂Èó¥ÂàÜÁâá(Time Slicing )Ôºü</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#4-ÂÖ±‰∫´Ê®°Âûã‰πãÁÆ°Á®ã">4 ÂÖ±‰∫´Ê®°Âûã‰πãÁÆ°Á®ã</a>
      <ol>
        <li><a href="#41-‰∏ä‰∏ãÊñáÂàáÊç¢ÈóÆÈ¢ò">4.1 ‰∏ä‰∏ãÊñáÂàáÊç¢ÈóÆÈ¢ò</a></li>
        <li><a href="#42-‰∏¥ÁïåÂå∫critical-section">4.2 ‰∏¥ÁïåÂå∫Critical Section</a>
          <ol>
            <li><a href="#Á´ûÊÄÅÊù°‰ª∂">Á´ûÊÄÅÊù°‰ª∂</a></li>
          </ol>
        </li>
        <li><a href="#43-synchronized-Ëß£ÂÜ≥ÊñπÊ°à">4.3 synchronized Ëß£ÂÜ≥ÊñπÊ°à</a>
          <ol>
            <li></li>
          </ol>
        </li>
        <li><a href="#44-ÂèòÈáèÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÂàÜÊûê">4.4 ÂèòÈáèÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÂàÜÊûê</a>
          <ol>
            <li><a href="#Â±ÄÈÉ®ÂèòÈáèÁ∫øÁ®ãÂÆâÂÖ®ÂàÜÊûê">Â±ÄÈÉ®ÂèòÈáèÁ∫øÁ®ãÂÆâÂÖ®ÂàÜÊûê</a></li>
          </ol>
        </li>
        <li><a href="#45-Â∏∏ËßÅÁöÑÁ∫øÁ®ãÂÆâÂÖ®Á±ª">4.5 Â∏∏ËßÅÁöÑÁ∫øÁ®ãÂÆâÂÖ®Á±ª</a>
          <ol>
            <li><a href="#‰∏çÂèØÂèòÁ±ªÁ∫øÁ®ãÂÆâÂÖ®ÊÄß">‰∏çÂèØÂèòÁ±ªÁ∫øÁ®ãÂÆâÂÖ®ÊÄß</a></li>
          </ol>
        </li>
        <li><a href="#46-Ê°à‰æã">4.6 Ê°à‰æã</a>
          <ol>
            <li><a href="#Èì∂Ë°åËΩ¨Èí±">Èì∂Ë°åËΩ¨Èí±</a></li>
          </ol>
        </li>
        <li><a href="#47-monitorÊ¶ÇÂøµ">4.7 MonitorÊ¶ÇÂøµ</a>
          <ol>
            <li><a href="#javaÂØπË±°Â§¥">JavaÂØπË±°Â§¥</a></li>
            <li><a href="#monitorÈîÅ">Monitor(ÈîÅ)</a></li>
            <li><a href="#synchronizedÂ≠óËäÇÁ†ÅËß£Êûê">synchronizedÂ≠óËäÇÁ†ÅËß£Êûê</a></li>
          </ol>
        </li>
        <li><a href="#48-ËΩªÈáèÁ∫ßÈîÅ">4.8 ËΩªÈáèÁ∫ßÈîÅ</a></li>
        <li><a href="#49-ÈîÅËÜ®ËÉÄ">4.9 ÈîÅËÜ®ËÉÄ</a></li>
        <li><a href="#410-Ëá™Êóã‰ºòÂåñÂ§öÊ†∏cpu">4.10 Ëá™Êóã‰ºòÂåñ(Â§öÊ†∏CPU)</a></li>
        <li><a href="#411-ÂÅèÂêëÈîÅ">4.11 ÂÅèÂêëÈîÅ</a>
          <ol>
            <li><a href="#ÂÅèÂêëÈîÅËé∑ÂèñËøáÁ®ã">ÂÅèÂêëÈîÅËé∑ÂèñËøáÁ®ã</a></li>
            <li><a href="#ÂÅèÂêëÁä∂ÊÄÅ">ÂÅèÂêëÁä∂ÊÄÅ</a></li>
            <li><a href="#ÂÅèÂêëÈîÅÊí§ÈîÄ">ÂÅèÂêëÈîÅÊí§ÈîÄ</a></li>
            <li><a href="#ÊâπÈáèÈáçÂÅèÂêë">ÊâπÈáèÈáçÂÅèÂêë</a></li>
            <li><a href="#ÊâπÈáèÊí§ÈîÄ">ÊâπÈáèÊí§ÈîÄ</a></li>
          </ol>
        </li>
        <li><a href="#412-ÈîÅÁ≤óÂåñ">4.12 ÈîÅÁ≤óÂåñ</a></li>
        <li><a href="#413-ÈîÅÊ∂àÈô§">4.13 ÈîÅÊ∂àÈô§</a></li>
        <li><a href="#414-Ê¥ªË∑ÉÊÄß">4.14 Ê¥ªË∑ÉÊÄß</a>
          <ol>
            <li><a href="#Ê≠ªÈîÅ">Ê≠ªÈîÅ</a></li>
            <li><a href="#Âì≤Â≠¶ÂÆ∂ÈóÆÈ¢ò">Âì≤Â≠¶ÂÆ∂ÈóÆÈ¢ò</a></li>
            <li><a href="#Ê¥ªÈîÅ">Ê¥ªÈîÅ</a></li>
            <li><a href="#È••È•ø">È••È•ø</a></li>
          </ol>
        </li>
        <li><a href="#415-‰ªéÊ∫êÁ†ÅÂéªÁúãsynchronized">4.15 ‰ªéÊ∫êÁ†ÅÂéªÁúãsynchronized</a>
          <ol>
            <li><a href="#monitorÁªìÊûÑ">monitorÁªìÊûÑ</a></li>
            <li><a href="#monitorenterinterpeterruntimecpp">monitorenter(interpeterRuntime.cpp)</a></li>
            <li><a href="#ÂÅèÂêëÈîÅÁéØËäÇ">ÂÅèÂêëÈîÅÁéØËäÇ</a></li>
            <li><a href="#ËΩªÈáèÁ∫ßÈîÅÁéØËäÇ">ËΩªÈáèÁ∫ßÈîÅÁéØËäÇ</a></li>
            <li><a href="#ÈáçÈáèÁ∫ßÈîÅÁéØËäÇ">ÈáçÈáèÁ∫ßÈîÅÁéØËäÇ</a></li>
          </ol>
        </li>
        <li><a href="#51-ÂéüÁêÜ‰πã-wait--notify">5.1 ÂéüÁêÜ‰πã wait / notify</a>
          <ol>
            <li><a href="#api‰ªãÁªçÂè™ËÉΩÂú®ÂêåÊ≠•‰ª£Á†ÅÂùó‰ΩøÁî®">API‰ªãÁªçÔºàÂè™ËÉΩÂú®ÂêåÊ≠•‰ª£Á†ÅÂùó‰ΩøÁî®Ôºâ</a></li>
            <li><a href="#‰∏∫‰ªÄ‰πà-wait-notifyÂíå-notifyallÂøÖÈ°ªÂú®ÂêåÊ≠•ÊñπÊ≥ïÊàñËÄÖÂêåÊ≠•Âùó‰∏≠Ë¢´Ë∞ÉÁî®">‰∏∫‰ªÄ‰πà wait(), notify()Âíå notifyAll()ÂøÖÈ°ªÂú®ÂêåÊ≠•ÊñπÊ≥ïÊàñËÄÖÂêåÊ≠•Âùó‰∏≠Ë¢´Ë∞ÉÁî®Ôºü</a></li>
          </ol>
        </li>
        <li><a href="#52-wait-notifyÁöÑÊ≠£Á°ÆÂßøÂäø">5.2 wait notifyÁöÑÊ≠£Á°ÆÂßøÂäø</a>
          <ol>
            <li><a href="#sleep-Âíå-wait-ÁöÑÂå∫Âà´">sleep() Âíå wait() ÁöÑÂå∫Âà´</a></li>
            <li><a href="#ÂÖ±ÂêåÁÇπ">ÂÖ±ÂêåÁÇπÔºö</a></li>
            <li><a href="#step1">step1:</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#ÂêåÊ≠•Ê®°Âºè‰πã‰øùÊä§ÊÄßÊöÇÂÅú">ÂêåÊ≠•Ê®°Âºè‰πã‰øùÊä§ÊÄßÊöÇÂÅú</a>
      <ol>
        <li><a href="#ÂÆö‰πâ">ÂÆö‰πâ</a>
          <ol>
            <li><a href="#Ë¶ÅÁÇπ">Ë¶ÅÁÇπ</a></li>
          </ol>
        </li>
        <li><a href="#ÂÆûÁé∞">ÂÆûÁé∞</a>
          <ol>
            <li><a href="#guardedobjectÁ±ªÂÆûÁé∞">GuardedObjectÁ±ªÂÆûÁé∞</a></li>
            <li><a href="#‰øùÊä§ÊÄßÊöÇÂÅúÊ®°ÂºèÂÆûÁé∞">‰øùÊä§ÊÄßÊöÇÂÅúÊ®°ÂºèÂÆûÁé∞</a></li>
            <li><a href="#‰øùÊä§ÊÄßÊöÇÂÅúÊ®°Âºè‰ºòÂåñ">‰øùÊä§ÊÄßÊöÇÂÅúÊ®°Âºè‰ºòÂåñ</a></li>
            <li><a href="#‰øùÊä§ÊÄßÊöÇÂÅúÊ®°Âºè‰ºòÂåñ2">‰øùÊä§ÊÄßÊöÇÂÅúÊ®°Âºè‰ºòÂåñ2</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#ÂºÇÊ≠•Ê®°Âºè‰πãÁîü‰∫ßËÄÖÊ∂àË¥πËÄÖ">ÂºÇÊ≠•Ê®°Âºè‰πãÁîü‰∫ßËÄÖ/Ê∂àË¥πËÄÖ</a>
      <ol>
        <li><a href="#ÂÆö‰πâ-1">ÂÆö‰πâ</a>
          <ol>
            <li><a href="#Ë¶ÅÁÇπ-1">Ë¶ÅÁÇπ</a></li>
            <li><a href="#ÂÆûÁé∞-1">ÂÆûÁé∞</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#6-Á∫øÁ®ãÂàáÊç¢">6 Á∫øÁ®ãÂàáÊç¢</a>
      <ol>
        <li><a href="#61-ÈáçÊñ∞ÁêÜËß£Á∫øÁ®ãÁä∂ÊÄÅËΩ¨Êç¢">6.1 ÈáçÊñ∞ÁêÜËß£Á∫øÁ®ãÁä∂ÊÄÅËΩ¨Êç¢</a>
          <ol>
            <li><a href="#ÊÉÖÂÜµ1-new----runnable">ÊÉÖÂÜµ1 NEW &ndash;&gt; RUNNABLE</a></li>
            <li><a href="#ÊÉÖÂÜµ2-runnable-----waiting">ÊÉÖÂÜµ2 RUNNABLE &lt;&mdash;&gt; WAITING</a></li>
            <li><a href="#ÊÉÖÂÜµ3-runnable-----waiting">ÊÉÖÂÜµ3 RUNNABLE &lt;&mdash;&gt; WAITING</a></li>
            <li><a href="#ÊÉÖÂÜµ4-runnable----waiting">ÊÉÖÂÜµ4 RUNNABLE &lt;&ndash;&gt; WAITING</a></li>
            <li><a href="#ÊÉÖÂÜµ5-runnable----timed_waiting">ÊÉÖÂÜµ5 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</a></li>
            <li><a href="#ÊÉÖÂÜµ6-runnable----timed_waiting">ÊÉÖÂÜµ6 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</a></li>
            <li><a href="#ÊÉÖÂÜµ7-runnable----timed_waiting">ÊÉÖÂÜµ7 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</a></li>
            <li><a href="#ÊÉÖÂÜµ8-runnable----timed_waiting">ÊÉÖÂÜµ8 RUNNABLE &lt;&ndash;&gt; TIMED_WAITING</a></li>
            <li><a href="#ÊÉÖÂÜµ9-runnable----terminated">ÊÉÖÂÜµ9 RUNNABLE &lt;&ndash;&gt; TERMINATED</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#8-ÂêåÊ≠•Ê®°Âºè‰πãÈ°∫Â∫èÊéßÂà∂">8 ÂêåÊ≠•Ê®°Âºè‰πãÈ°∫Â∫èÊéßÂà∂</a>
      <ol>
        <li>
          <ol>
            <li><a href="#Âõ∫ÂÆöËøêË°åÈ°∫Â∫è">Âõ∫ÂÆöËøêË°åÈ°∫Â∫è</a></li>
            <li><a href="#‰∫§ÊõøËæìÂá∫">‰∫§ÊõøËæìÂá∫</a></li>
            <li><a href="#wait-notifyÁâàÊú¨">wait-notifyÁâàÊú¨</a></li>
            <li><a href="#await-signalÁâàÊú¨">await-signalÁâàÊú¨</a></li>
            <li><a href="#park-unparkÁâàÊú¨">park-unparkÁâàÊú¨</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#9-ÂÖ±‰∫´Ê®°Âûã‰πãÂÜÖÂ≠ò">9 ÂÖ±‰∫´Ê®°Âûã‰πãÂÜÖÂ≠ò</a>
      <ol>
        <li><a href="#91-javaÂÜÖÂ≠òÊ®°Âûã">9.1 JavaÂÜÖÂ≠òÊ®°Âûã</a>
          <ol>
            <li><a href="#ÁÆÄ‰ªã">ÁÆÄ‰ªã</a></li>
          </ol>
        </li>
        <li><a href="#92-ÂèØËßÅÊÄß">9.2 ÂèØËßÅÊÄß</a>
          <ol>
            <li><a href="#ÁÆÄ‰ªã-1"><strong>ÁÆÄ‰ªãÔºö</strong></a></li>
            <li><a href="#ÂÆö‰πâ-2">ÂÆö‰πâ:</a></li>
            <li><a href="#ÈóÆÈ¢ò">ÈóÆÈ¢ò</a></li>
            <li><a href="#ÁªìÊûú">ÁªìÊûú</a></li>
            <li><a href="#ÂéüÁêÜ-1">ÂéüÁêÜ</a></li>
            <li><a href="#Ëß£ÂÜ≥ÊñπÊ≥ï">Ëß£ÂÜ≥ÊñπÊ≥ï</a></li>
            <li><a href="#synchronized-vs-volatile">Synchronized vs Volatile</a></li>
            <li><a href="#‰ΩøÁî®volatileÁöÑ‰∏§Èò∂ÊÆµÁªàÊ≠¢Ê®°Âºè">‰ΩøÁî®volatileÁöÑ‰∏§Èò∂ÊÆµÁªàÊ≠¢Ê®°Âºè</a></li>
            <li><a href="#ÂêåÊ≠•Ê®°Âºè‰πãbalking">ÂêåÊ≠•Ê®°Âºè‰πãBalking</a></li>
          </ol>
        </li>
        <li><a href="#93-ÊúâÂ∫èÊÄß">9.3 ÊúâÂ∫èÊÄß</a>
          <ol>
            <li><a href="#‰ªÄ‰πàÊòØÊåá‰ª§ÈáçÊéí">‰ªÄ‰πàÊòØ„ÄêÊåá‰ª§ÈáçÊéí„ÄëÔºü</a></li>
            <li><a href="#‰∏∫‰ªÄ‰πàË¶ÅÊúâÊåá‰ª§ÈáçÊéíËøô‰∏ÄÁâπÊÄßÂë¢">‰∏∫‰ªÄ‰πàË¶ÅÊúâ„ÄêÊåá‰ª§ÈáçÊéí„ÄëËøô‰∏ÄÁâπÊÄßÂë¢Ôºü</a></li>
            <li><a href="#ËØ°ÂºÇÁöÑÁªìÊûú">ËØ°ÂºÇÁöÑÁªìÊûú</a></li>
          </ol>
        </li>
        <li><a href="#94-volatile-ÂéüÁêÜ">9.4 volatile ÂéüÁêÜ</a>
          <ol>
            <li><a href="#Â¶Ç‰Ωï‰øùËØÅÂèØËßÅÊÄß">Â¶Ç‰Ωï‰øùËØÅÂèØËßÅÊÄß</a></li>
            <li><a href="#Â¶Ç‰Ωï‰øùËØÅÊúâÂ∫èÊÄß">Â¶Ç‰Ωï‰øùËØÅÊúâÂ∫èÊÄß</a></li>
            <li><a href="#double-checked-locking-ÈóÆÈ¢ò">double-checked locking ÈóÆÈ¢ò</a></li>
            <li><a href="#happens-before">happens-before</a></li>
          </ol>
        </li>
        <li><a href="#95-Á∫øÁ®ãÂÆâÂÖ®Âçï‰æã">9.5 Á∫øÁ®ãÂÆâÂÖ®Âçï‰æã</a>
          <ol>
            <li></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#10-‰øùÊä§ÂÖ±‰∫´ËµÑÊ∫ê-Êó†ÈîÅÂÆûÁé∞">10 ‰øùÊä§ÂÖ±‰∫´ËµÑÊ∫ê-Êó†ÈîÅÂÆûÁé∞</a>
      <ol>
        <li><a href="#101-atomicinteger">10.1 AtomicInteger</a>
          <ol>
            <li></li>
            <li><a href="#ÊúâÈîÅÊäÄÊúØÂÆûÁé∞ËµÑÊ∫êÂÖ±‰∫´">ÊúâÈîÅÊäÄÊúØÂÆûÁé∞ËµÑÊ∫êÂÖ±‰∫´</a></li>
            <li><a href="#Êó†ÊâÄÊäÄÊúØÂÆûÁé∞ËµÑÊ∫êÂÖ±‰∫´">Êó†ÊâÄÊäÄÊúØÂÆûÁé∞ËµÑÊ∫êÂÖ±‰∫´</a></li>
            <li><a href="#ÁªìÊûúÊØîËæÉ">ÁªìÊûúÊØîËæÉ</a></li>
          </ol>
        </li>
        <li><a href="#102-cas‰∏évolatile">10.2 CAS‰∏évolatile</a>
          <ol>
            <li><a href="#‰∏∫‰ªÄ‰πà-compareandset-ÂèØ‰ª•ÂÆûÁé∞‰∏çÂä†ÈîÅ‰πüËÉΩ‰øùËØÅÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò">‰∏∫‰ªÄ‰πà compareAndSet ÂèØ‰ª•ÂÆûÁé∞‰∏çÂä†ÈîÅ‰πüËÉΩ‰øùËØÅÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢òÔºü</a></li>
            <li><a href="#volatile-‰∏é-cas‰πãÈó¥ÁöÑÂÖ≥Á≥ª">volatile ‰∏é CAS‰πãÈó¥ÁöÑÂÖ≥Á≥ª</a></li>
            <li><a href="#‰∏∫‰ªÄ‰πàÊó†ÈîÅÊïàÁéáÈ´ò">‰∏∫‰ªÄ‰πàÊó†ÈîÅÊïàÁéáÈ´òÔºü</a></li>
            <li><a href="#casÁöÑÁâπÁÇπ">CASÁöÑÁâπÁÇπ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#11-ÂéüÂ≠ê">11 ÂéüÂ≠ê</a>
      <ol>
        <li><a href="#111-ÂéüÂ≠êÊï¥Êï∞">11.1 ÂéüÂ≠êÊï¥Êï∞</a>
          <ol>
            <li><a href="#‰æãatomicinteger">‰æãÔºöAtomicInteger</a></li>
          </ol>
        </li>
        <li><a href="#112-ÂéüÂ≠êÂºïÁî®">11.2 ÂéüÂ≠êÂºïÁî®</a>
          <ol>
            <li><a href="#abaÈóÆÈ¢ò">ABAÈóÆÈ¢ò</a></li>
            <li><a href="#atomicstampedreference">AtomicStampedReference</a></li>
            <li><a href="#atomicmarkablereference">AtomicMarkableReference</a></li>
          </ol>
        </li>
        <li><a href="#113-ÂéüÂ≠êÊï∞ÁªÑ">11.3 ÂéüÂ≠êÊï∞ÁªÑ</a></li>
        <li><a href="#114-ÂéüÂ≠êÊõ¥Êñ∞Âô®">11.4 ÂéüÂ≠êÊõ¥Êñ∞Âô®</a></li>
        <li><a href="#115-ÂéüÂ≠êÁ¥ØÂä†Âô®">11.5 ÂéüÂ≠êÁ¥ØÂä†Âô®</a>
          <ol>
            <li><a href="#Ê∫êÁ†Å‰πãlongadder">Ê∫êÁ†Å‰πãLongAdder</a></li>
          </ol>
        </li>
        <li><a href="#116-unsafe">11.6 Unsafe</a>
          <ol>
            <li><a href="#Ê¶ÇËø∞">Ê¶ÇËø∞</a></li>
            <li><a href="#unsafe-casÊìç‰Ωú">Unsafe CASÊìç‰Ωú</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#12-‰∏çÂèØÂèòÁ±ª">12 ‰∏çÂèØÂèòÁ±ª</a>
      <ol>
        <li><a href="#121-‰∏çÂèØÂèòÁ±ªÁöÑËÆæËÆ°">12.1 ‰∏çÂèØÂèòÁ±ªÁöÑËÆæËÆ°</a>
          <ol>
            <li><a href="#1-finalÁöÑ‰ΩøÁî®">1. finalÁöÑ‰ΩøÁî®</a></li>
            <li><a href="#2‰øùÊä§ÊÄßÊã∑Ë¥ù">2.‰øùÊä§ÊÄßÊã∑Ë¥ù</a></li>
          </ol>
        </li>
        <li><a href="#122-‰∫´ÂÖÉÊ®°Âºè">12.2 ‰∫´ÂÖÉÊ®°Âºè</a></li>
        <li><a href="#123-Ëá™ÂÆö‰πâËøûÊé•Ê±†">12.3 Ëá™ÂÆö‰πâËøûÊé•Ê±†</a>
          <ol>
            <li><a href="#ËøûÊé•Ê±†ÂäüËÉΩ">ËøûÊé•Ê±†ÂäüËÉΩÔºö</a></li>
          </ol>
        </li>
        <li><a href="#124-finalÂéüÁêÜ">12.4 finalÂéüÁêÜ</a>
          <ol>
            <li><a href="#1ËÆæÁΩÆfinalÂèòÈáèÁöÑÂéüÁêÜ">1ÔºåËÆæÁΩÆfinalÂèòÈáèÁöÑÂéüÁêÜ</a></li>
            <li><a href="#2Ëé∑ÂèñfinalÂèòÈáèÁöÑÂéüÁêÜ">2ÔºåËé∑ÂèñfinalÂèòÈáèÁöÑÂéüÁêÜ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#13-Á∫øÁ®ãÊ±†">13 Á∫øÁ®ãÊ±†</a>
      <ol>
        <li><a href="#131-ÊâãÂÜôÁ∫øÁ®ãÊ±†">13.1 ÊâãÂÜôÁ∫øÁ®ãÊ±†</a>
          <ol>
            <li><a href="#1blockingqueue-ÈòªÂ°ûÈòüÂàó">1,BlockingQueue ÈòªÂ°ûÈòüÂàó</a></li>
            <li><a href="#2threadpool-Á∫øÁ®ãÊ±†">2ÔºåThreadPool Á∫øÁ®ãÊ±†</a></li>
          </ol>
        </li>
        <li><a href="#132-threadpoolexecutor">13.2 ThreadPoolExecutor</a>
          <ol>
            <li><a href="#1Á∫øÁ®ãÊ±†Áä∂ÊÄÅ">1ÔºåÁ∫øÁ®ãÊ±†Áä∂ÊÄÅ</a></li>
            <li><a href="#2ÊûÑÈÄ†ÊñπÊ≥ï">2ÔºåÊûÑÈÄ†ÊñπÊ≥ï</a></li>
            <li><a href="#3Â∑•ÂéÇÊñπÊ≥ïÊûÑÈÄ†Á∫øÁ®ãÊ±†">3ÔºåÂ∑•ÂéÇÊñπÊ≥ïÊûÑÈÄ†Á∫øÁ®ãÊ±†</a></li>
            <li><a href="#4Êèê‰∫§‰ªªÂä°">4ÔºåÊèê‰∫§‰ªªÂä°</a></li>
            <li><a href="#5ÂÖ≥Èó≠Á∫øÁ®ãÊ±†">5Ôºå<strong>ÂÖ≥Èó≠Á∫øÁ®ãÊ±†</strong></a></li>
          </ol>
        </li>
        <li><a href="#133-ÂàõÂª∫Á∫øÁ®ãÊ±†Â§öÂ∞ë‰∏™Á∫øÁ®ãÂêàÈÄÇÂë¢">13.3 ÂàõÂª∫Á∫øÁ®ãÊ±†Â§öÂ∞ë‰∏™Á∫øÁ®ãÂêàÈÄÇÂë¢</a>
          <ol>
            <li><a href="#1cpuÂØÜÈõÜÂûãËøêÁÆó">1ÔºåCPUÂØÜÈõÜÂûãËøêÁÆó</a></li>
            <li><a href="#2ioÂØÜÈõÜÂûãËøêÁÆó">2ÔºåI/OÂØÜÈõÜÂûãËøêÁÆó</a></li>
          </ol>
        </li>
        <li><a href="#134-tomcatÁ∫øÁ®ãÊ±†">13.4 TomcatÁ∫øÁ®ãÊ±†</a></li>
        <li><a href="#135-forkjoin">13.5 Fork/Join</a>
          <ol>
            <li><a href="#1Ê¶ÇÂøµ">1ÔºåÊ¶ÇÂøµ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#14-juc">14 JUC</a>
      <ol>
        <li><a href="#141-aqs">14.1 AQS</a>
          <ol>
            <li><a href="#1Ê¶ÇËø∞">1,Ê¶ÇËø∞</a></li>
          </ol>
        </li>
        <li><a href="#142reentrantlock">14.2ÔºåReentrantLock</a>
          <ol>
            <li></li>
            <li><a href="#ÂèØÈáçÂÖ•">ÂèØÈáçÂÖ•</a></li>
            <li><a href="#ÂèØÊâìÊñ≠">ÂèØÊâìÊñ≠</a></li>
            <li><a href="#ÈîÅË∂ÖÊó∂">ÈîÅË∂ÖÊó∂</a></li>
            <li><a href="#ÂÖ¨Âπ≥ÈîÅ">ÂÖ¨Âπ≥ÈîÅ</a></li>
            <li><a href="#Êù°‰ª∂ÂèòÈáè">Êù°‰ª∂ÂèòÈáè</a></li>
          </ol>
        </li>
        <li><a href="#143-ÂéüÁêÜ">14.3 ÂéüÁêÜ</a>
          <ol>
            <li><a href="#1Âä†ÈîÅ‰ª•ÂèäÁ´û‰∫âÈîÅ">1ÔºåÂä†ÈîÅ‰ª•ÂèäÁ´û‰∫âÈîÅ</a></li>
            <li><a href="#2Ëß£ÈîÅÊµÅÁ®ã">2ÔºåËß£ÈîÅÊµÅÁ®ã</a></li>
            <li><a href="#3ÂèØÈáçÂÖ•">3ÔºåÂèØÈáçÂÖ•</a></li>
            <li><a href="#4ÂèØÊâìÊñ≠">4ÔºåÂèØÊâìÊñ≠</a></li>
            <li><a href="#5ÂÖ¨Âπ≥ÈîÅ">5Ôºå<strong>ÂÖ¨Âπ≥ÈîÅ</strong></a></li>
            <li><a href="#6Êù°‰ª∂ÂèòÈáèÂÆûÁé∞ÂéüÁêÜ">6ÔºåÊù°‰ª∂ÂèòÈáèÂÆûÁé∞ÂéüÁêÜ</a></li>
          </ol>
        </li>
        <li><a href="#144-reentrantreadwritelock">14.4 ReentrantReadWriteLock</a>
          <ol>
            <li><a href="#ÁâπÊÄß">ÁâπÊÄßÔºö</a></li>
            <li><a href="#Â∫îÁî®ÁºìÂ≠òÊõ¥Êñ∞">Â∫îÁî®ÔºöÁºìÂ≠òÊõ¥Êñ∞</a></li>
            <li><a href="#ÂéüÁêÜ-2">ÂéüÁêÜÔºö</a></li>
            <li><a href="#ÊµÅÁ®ãÂõæ-1">ÊµÅÁ®ãÂõæ</a></li>
          </ol>
        </li>
        <li><a href="#145-stampedlock">14.5 StampedLock</a>
          <ol>
            <li><a href="#stampedlockÊÄßËÉΩÊØîreadwritelockÂ•ΩÁöÑÂéüÂõ†">StampedLockÊÄßËÉΩÊØîReadWriteLockÂ•ΩÁöÑÂéüÂõ†</a></li>
            <li><a href="#ÂéüÁêÜ-3">ÂéüÁêÜ</a></li>
            <li><a href="#ÈîÅÁä∂ÊÄÅÁõ∏ÂÖ≥Â±ûÊÄß">ÈîÅÁä∂ÊÄÅÁõ∏ÂÖ≥Â±ûÊÄß</a></li>
            <li><a href="#ËäÇÁÇπ">ËäÇÁÇπ</a></li>
            <li><a href="#Ëá™ÊóãÊ¨°Êï∞‰ºòÂåñ">Ëá™ÊóãÊ¨°Êï∞‰ºòÂåñ</a></li>
            <li><a href="#Ê≥®ÊÑè">Ê≥®ÊÑè</a></li>
          </ol>
        </li>
        <li><a href="#146-semaphore">14.6 Semaphore</a>
          <ol>
            <li><a href="#semaphoreÂ∫îÁî®">SemaphoreÂ∫îÁî®</a></li>
            <li><a href="#ÂéüÁêÜ-4">ÂéüÁêÜ</a></li>
          </ol>
        </li>
        <li><a href="#147-countdownlatch">14.7 CountdownLatch</a>
          <ol>
            <li><a href="#‰∏∫‰ªÄ‰πà‰∏çÁî®join">‰∏∫‰ªÄ‰πà‰∏çÁî®Join</a></li>
            <li><a href="#Â∫îÁî®-1">Â∫îÁî®</a></li>
          </ol>
        </li>
        <li><a href="#148-cyclicbarrier">14.8 CyclicBarrier</a>
          <ol>
            <li><a href="#Â∫îÁî®-2">Â∫îÁî®</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
